<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor datab√°ze</title>
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a8a;
            --primary-dark: #0f1f33;
            --accent: #e67e22;
            --accent-light: #f39c4d;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f1c40f;
            --bg: #f8f9fa;
            --bg-card: #ffffff;
            --text: #2c3e50;
            --text-muted: #7f8c8d;
            --border: #dce1e6;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            --radius: 8px;
            --radius-lg: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }
        .skip-link { position: absolute; top: -40px; left: 0; background: var(--primary); color: white; padding: 8px 16px; z-index: 1000; text-decoration: none; }
        .skip-link:focus { top: 0; }
        header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 1rem 2rem; }
        .header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        .header-title { font-size: 1.5rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { font-family: inherit; font-size: 0.9rem; padding: 0.5rem 1rem; border: 2px solid transparent; border-radius: var(--radius); cursor: pointer; display: inline-flex; align-items: center; gap: 0.4rem; transition: all 0.2s ease; text-decoration: none; }
        .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-primary:hover, .btn-primary:focus { background: var(--accent-light); }
        .btn-secondary { background: white; color: var(--primary); border-color: var(--border); }
        .btn-secondary:hover, .btn-secondary:focus { background: var(--bg); border-color: var(--primary); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #2ecc71; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #e74c3c; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.85rem; }
        .btn-icon { padding: 0.4rem; min-width: 32px; justify-content: center; }
        button:focus, .btn:focus { outline: 3px solid var(--accent); outline-offset: 2px; }

        /* Table Tabs */
        .table-tabs { display: flex; gap: 0; flex-wrap: wrap; align-items: flex-end; }
        .table-tab { padding: 0.6rem 1.2rem; background: rgba(255,255,255,0.1); border: none; border-radius: var(--radius) var(--radius) 0 0; cursor: pointer; color: rgba(255,255,255,0.8); font-weight: 500; transition: all 0.2s; }
        .table-tab:hover { background: rgba(255,255,255,0.2); color: white; }
        .table-tab.active { background: var(--bg); color: var(--primary); }
        .table-tab.management-tab { background: rgba(230,126,34,0.3); margin-left: auto; }
        .table-tab.management-tab.active { background: var(--accent); color: white; }
        .table-tab.classification-tab { background: rgba(155,89,182,0.3); margin-left: auto; }
        .table-tab.classification-tab.active { background: #9b59b6; color: white; }
        .table-tab.management-tab { margin-left: 0; }

        main { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); margin-bottom: 1.5rem; overflow: hidden; }
        .card-header { background: var(--bg); padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .card-header h2 { font-size: 1.1rem; font-weight: 600; color: var(--primary); }
        .card-body { padding: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.3rem; font-weight: 500; }
        input[type="text"], input[type="number"], input[type="date"], input[type="search"], textarea, select {
            width: 100%; padding: 0.6rem 0.8rem; border: 2px solid var(--border); border-radius: var(--radius); font-family: inherit; font-size: 1rem; transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30,58,95,0.1); }
        textarea { min-height: 100px; resize: vertical; }
        .checkbox-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        .checkbox-group label { margin-bottom: 0; cursor: pointer; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th, td { padding: 0.8rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg); font-weight: 600; color: var(--primary); white-space: nowrap; cursor: pointer; user-select: none; }
        th:hover { background: #e8ecef; }
        th.sorted-asc::after { content: " ‚ñ≤"; font-size: 0.7rem; }
        th.sorted-desc::after { content: " ‚ñº"; font-size: 0.7rem; }
        th.no-sort { cursor: default; }
        th.no-sort:hover { background: var(--bg); }
        tr:hover { background: rgba(30,58,95,0.02); }
        .actions-cell { white-space: nowrap; display: flex; gap: 0.3rem; }

        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-backdrop[hidden] { display: none; }
        .modal { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); width: 100%; max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { background: var(--primary); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.2rem; font-weight: 600; }
        .modal-close { background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; line-height: 1; }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.5rem; background: var(--bg); }

        .filters-section { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: var(--bg); border-radius: var(--radius); }
        .filter-item { min-width: 150px; flex: 1; max-width: 250px; }
        .filter-item label { font-size: 0.85rem; color: var(--text-muted); }
        .filter-item select { padding: 0.4rem 0.6rem; }
        .search-box { position: relative; flex: 2; min-width: 200px; }
        .search-box input { padding-left: 2.5rem; }
        .search-box::before { content: "üîç"; position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%); font-size: 0.9rem; }

        details { margin-top: 1rem; }
        summary { cursor: pointer; padding: 0.8rem 1rem; background: var(--bg); border-radius: var(--radius); font-weight: 500; color: var(--primary); list-style: none; display: flex; align-items: center; gap: 0.5rem; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: "‚ñ∂"; font-size: 0.7rem; transition: transform 0.2s; }
        details[open] summary::before { transform: rotate(90deg); }
        .column-toggles { padding: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; background: white; border: 1px solid var(--border); border-top: none; border-radius: 0 0 var(--radius) var(--radius); }

        .field-list { border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .field-item { display: flex; align-items: center; gap: 1rem; padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); background: white; }
        .field-item:last-child { border-bottom: none; }
        .field-item-info { flex: 1; }
        .field-item-name { font-weight: 600; color: var(--primary); }
        .field-item-meta { font-size: 0.85rem; color: var(--text-muted); }
        .field-item-actions { display: flex; gap: 0.3rem; }
        .move-buttons { display: flex; flex-direction: column; gap: 2px; }
        .move-buttons button { padding: 0.2rem 0.4rem; font-size: 0.75rem; }

        .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        .badge-primary { background: var(--primary-light); color: white; }
        .badge-filter { background: var(--accent); color: white; }

        .record-link { color: var(--primary); text-decoration: underline; cursor: pointer; background: none; border: none; font: inherit; padding: 0; display: inline; text-align: left; }
        .record-link:hover, .record-link:focus { color: var(--accent); outline: none; }

        .empty-state { text-align: center; padding: 3rem 1.5rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }

        .language-selector select { width: auto; padding: 0.4rem 0.6rem; background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.3); }
        .language-selector select option { color: var(--text); }
        .quick-create-selector select { width: auto; padding: 0.4rem 0.6rem; background: rgba(39,174,96,0.3); color: white; border-color: rgba(255,255,255,0.3); cursor: pointer; }
        .quick-create-selector select option { color: var(--text); }

        .record-count { font-size: 0.9rem; color: var(--text-muted); padding: 0.5rem 0; }
        .record-count strong { color: var(--primary); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Sub tabs for management */
        .sub-tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 1.5rem; }
        .sub-tab { padding: 0.8rem 1.5rem; background: transparent; border: none; border-bottom: 3px solid transparent; margin-bottom: -2px; cursor: pointer; font-weight: 500; color: var(--text-muted); transition: all 0.2s; }
        .sub-tab:hover { color: var(--primary); }
        .sub-tab.active { color: var(--primary); border-bottom-color: var(--accent); }
        .sub-content { display: none; }
        .sub-content.active { display: block; }

        .view-field { margin-bottom: 1.2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .view-field:last-child { border-bottom: none; margin-bottom: 0; }
        .view-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem; }
        .view-field-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .view-field-value { font-size: 1rem; color: var(--text); }
        .view-field-value.empty { font-style: italic; color: var(--text-muted); }
        .copy-field-btn { padding: 0.15rem 0.4rem; font-size: 0.75rem; }

        /* Collections and Tags */
        .tag-badge, .collection-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.15rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            margin: 0.1rem;
            text-decoration: none;
            color: white;
            cursor: pointer;
            white-space: nowrap;
        }
        .tag-badge:hover, .collection-badge:hover { opacity: 0.85; }
        .tag-badge { background: #e74c3c; }
        .collection-badge { background: #4a90d9; }
        .badges-cell { display: flex; flex-wrap: wrap; gap: 0.2rem; }
        .checkbox-list { display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; }
        .checkbox-list label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .checkbox-list .color-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .record-badges { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .record-badges-section { margin-bottom: 0.5rem; }
        .record-badges-section strong { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .related-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .related-group { margin-bottom: 1rem; }
        .related-group-title { font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .related-list { list-style: none; padding: 0; margin: 0 0 0 1rem; }
        .related-list li { padding: 0.25rem 0; }
        .related-table-name { font-size: 0.8rem; color: var(--text-muted); }
        .collection-view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .filters-row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; }
        .date-input-group { display: flex; gap: 0.5rem; }
        .date-input-group .date-picker { flex: 1; min-width: 140px; }
        .date-input-group .date-text { width: 110px; font-family: monospace; text-align: center; }
        
        /* Collections and Tags grid */
        .collections-grid, .tags-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .collection-card, .tag-card { border: 1px solid var(--border); border-radius: 8px; padding: 1rem; background: var(--card-bg); cursor: pointer; transition: box-shadow 0.2s, transform 0.1s; }
        .collection-card:hover, .tag-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .collection-card-header, .tag-card-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
        .collection-card-color { width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0; }
        .collection-card-name, .tag-card-name { font-weight: 600; font-size: 1.1rem; flex: 1; }
        .collection-card-count, .tag-card-count { font-size: 0.85rem; color: var(--text-muted); }
        .collection-card-desc { font-size: 0.9rem; color: var(--text-muted); margin-top: 0.5rem; max-height: 3em; overflow: hidden; text-overflow: ellipsis; }
        
        /* Record badges section */
        .record-classification { margin-bottom: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.03); border-radius: 8px; }
        .record-classification-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .record-classification-row:last-child { margin-bottom: 0; }
        .record-classification-label { font-weight: 600; font-size: 0.85rem; color: var(--text-muted); min-width: 70px; }
        .record-classification-items { display: flex; flex-wrap: wrap; gap: 0.25rem; flex: 1; }
        .add-classification-btn { padding: 0.15rem 0.5rem; font-size: 0.75rem; border-radius: 1rem; }
        
        /* Collection/Tag detail view */
        .collection-detail-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .collection-detail-color { width: 48px; height: 48px; border-radius: 50%; }
        .collection-detail-info { flex: 1; }
        .collection-detail-name { font-size: 1.5rem; font-weight: 600; margin: 0; }
        .collection-detail-count { color: var(--text-muted); }
        .collection-detail-desc { margin: 1rem 0; padding: 1rem; background: rgba(0,0,0,0.03); border-radius: 8px; }
        .collection-members-list { list-style: none; padding: 0; margin: 0; }
        .collection-members-list li { padding: 0.5rem 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .collection-members-list li:last-child { border-bottom: none; }
        .member-table-name { font-size: 0.8rem; color: var(--text-muted); margin-left: 0.5rem; }
        .remove-badge-btn { background: transparent; border: none; color: white; cursor: pointer; padding: 0 0.25rem; margin-left: 0.25rem; font-size: 0.7rem; opacity: 0.7; }
        .remove-badge-btn:hover { opacity: 1; }
        .collection-badge, .tag-badge { display: inline-flex; align-items: center; }
        .children-list { list-style: none; padding: 0; }
        .children-list li { padding: 0.3rem 0; }

        /* Markdown styles */
        .markdown-content { line-height: 1.7; }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { margin: 1rem 0 0.5rem; color: var(--primary); }
        .markdown-content h1 { font-size: 1.5rem; }
        .markdown-content h2 { font-size: 1.3rem; }
        .markdown-content h3 { font-size: 1.1rem; }
        .markdown-content p { margin-bottom: 0.8rem; }
        .markdown-content ul, .markdown-content ol { margin: 0.5rem 0 0.5rem 1.5rem; }
        .markdown-content li { margin-bottom: 0.3rem; }
        .markdown-content code { background: var(--bg); padding: 0.2rem 0.4rem; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 0.9em; }
        .markdown-content pre { background: var(--bg); padding: 1rem; border-radius: var(--radius); overflow-x: auto; margin: 0.5rem 0; }
        .markdown-content pre code { background: none; padding: 0; }
        .markdown-content blockquote { border-left: 4px solid var(--accent); padding-left: 1rem; margin: 0.5rem 0; color: var(--text-muted); }
        .markdown-content a { color: var(--primary); }
        .markdown-content strong { font-weight: 600; }
        .markdown-content em { font-style: italic; }
        .markdown-content hr { border: none; border-top: 1px solid var(--border); margin: 1rem 0; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .stat-card { background: var(--bg); padding: 1.5rem; border-radius: var(--radius); text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; }

        /* Generator */
        .field-buttons { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.5rem; }
        .field-btn { padding: 0.3rem 0.6rem; font-size: 0.8rem; background: var(--primary-light); color: white; border: none; border-radius: var(--radius); cursor: pointer; }
        .field-btn:hover { background: var(--primary); }
        .generator-output { background: var(--bg); padding: 1rem; border-radius: var(--radius); font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; margin-top: 1rem; }

        /* Radio group */
        .radio-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .radio-group label { display: flex; align-items: center; gap: 0.3rem; cursor: pointer; }
        .radio-group input { width: 18px; height: 18px; }

        /* Export/Import tabs */
        .format-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .format-tab { padding: 0.5rem 1rem; background: var(--bg); border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; }
        .format-tab.active { background: var(--primary); color: white; border-color: var(--primary); }

        .inline-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        /* Group styles */
        .group-header th { 
            background: var(--bg); 
            padding: 0; 
            text-align: left;
            border-top: 2px solid var(--border);
        }
        .group-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            text-align: left;
        }
        .group-toggle:hover { background: rgba(0,0,0,0.05); }
        .group-toggle:focus { outline: 2px solid var(--primary); outline-offset: -2px; }
        .group-icon { font-size: 0.75rem; width: 1rem; }
        
        /* URL link styles */
        .url-link { color: var(--primary); text-decoration: underline; }
        .url-link:hover { color: var(--secondary); }

        /* Structure modal styles */
        .structure-modal { max-width: 900px; width: 95vw; max-height: 90vh; display: flex; flex-direction: column; }
        .structure-modal .modal-body { flex: 1; overflow: hidden; padding: 0; }
        .structure-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg); }
        .structure-tab { flex: 1; padding: 0.75rem; border: none; background: none; cursor: pointer; font-size: 0.95rem; border-bottom: 3px solid transparent; }
        .structure-tab:hover { background: rgba(0,0,0,0.05); }
        .structure-tab.active { border-bottom-color: var(--primary); font-weight: 600; }
        .structure-body { height: 60vh; }
        .structure-content { display: none; height: 100%; overflow: auto; padding: 1rem; }
        .structure-content.active { display: block; }
        
        /* Tree styles */
        .tree-root { list-style: none; padding: 0; margin: 0; }
        .tree-item { margin: 0.25rem 0; }
        .tree-toggle { background: none; border: none; cursor: pointer; padding: 0.25rem; margin-right: 0.25rem; font-size: 0.8rem; width: 1.5rem; color: var(--text-muted); }
        .tree-toggle:hover { color: var(--primary); }
        .tree-toggle.empty { visibility: hidden; }
        .tree-link { color: var(--primary); text-decoration: none; }
        .tree-link:hover { text-decoration: underline; }
        .tree-count { color: var(--text-muted); font-size: 0.85rem; margin-left: 0.25rem; }
        .tree-table { color: var(--text-muted); font-size: 0.85rem; margin-left: 0.25rem; }
        .tree-children { list-style: none; padding-left: 1.5rem; margin: 0; border-left: 1px dashed var(--border); margin-left: 0.75rem; }
        .tree-children.collapsed { display: none; }
        .tree-load-more { color: var(--primary); cursor: pointer; font-style: italic; padding: 0.25rem 0; }
        .tree-load-more:hover { text-decoration: underline; }
        .tree-empty { color: var(--text-muted); font-style: italic; }
        
        /* Graph styles */
        #structureGraphContainer { width: 100%; height: 100%; overflow: auto; }
        .graph-svg { display: block; }
        .graph-node { cursor: pointer; }
        .graph-node rect { fill: var(--card-bg); stroke: var(--border); stroke-width: 1.5px; rx: 4; }
        .graph-node:hover rect { stroke: var(--primary); stroke-width: 2px; }
        .graph-node text { font-size: 12px; fill: var(--text); }
        .graph-link { fill: none; stroke: var(--border); stroke-width: 1.5px; }
        
        /* Bulk selection styles */
        .bulk-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .bulk-actions-bar { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: var(--primary); color: white; border-radius: 8px; margin-bottom: 1rem; flex-wrap: wrap; }
        .bulk-actions-bar .bulk-count { font-weight: 600; margin-right: 0.5rem; }
        .bulk-actions-bar .btn { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white; }
        .bulk-actions-bar .btn:hover { background: rgba(255,255,255,0.3); }
        .bulk-actions-bar .btn-danger { background: rgba(231,76,60,0.8); }
        .bulk-actions-bar .btn-danger:hover { background: rgba(231,76,60,1); }
        .bulk-deselect { background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; padding: 0.25rem; margin-left: auto; }
        .bulk-deselect:hover { opacity: 0.8; }
        th.checkbox-col, td.checkbox-col { width: 40px; text-align: center; }
        
        /* Bulk edit rows */
        .bulk-edit-row { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; }
        .bulk-edit-row-header { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
        .bulk-edit-row-header select { flex: 1; }
        .bulk-edit-row-header .bulk-edit-remove-row { padding: 0.25rem 0.5rem; }
        .bulk-edit-value-container { margin-top: 0.5rem; }
        .bulk-edit-value-container input, .bulk-edit-value-container select, .bulk-edit-value-container textarea { width: 100%; }
        
        /* View record sections */
        .view-record-section { margin-bottom: 1.5rem; }
        .view-record-section-title { font-size: 1rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem; }

        @media (max-width: 768px) {
            header { padding: 1rem; }
            main { padding: 1rem; }
            .card-body { padding: 1rem; }
            .modal { max-height: 95vh; }
            .table-tabs { flex-wrap: nowrap; overflow-x: auto; }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link" data-i18n="skipToContent">P≈ôeskoƒçit na hlavn√≠ obsah</a>

    <header>
        <div class="header-top">
            <div class="header-title">
                <span data-i18n="appName">Editor datab√°ze</span>
            </div>
            <div class="header-actions">
                <button type="button" class="btn btn-success" id="btnSaveWiki" style="display:none;"><span aria-hidden="true">üì§</span> <span data-i18n="saveToWiki">Ulo≈æit na wiki</span></button>
                <button type="button" class="btn btn-secondary" id="btnNew"><span aria-hidden="true">üìÑ</span> <span data-i18n="newDb">Nov√°</span></button>
                <button type="button" class="btn btn-secondary" id="btnLoad"><span aria-hidden="true">üìÇ</span> <span data-i18n="load">Naƒç√≠st</span></button>
                <button type="button" class="btn btn-primary" id="btnSave"><span aria-hidden="true">üíæ</span> <span data-i18n="save">Ulo≈æit</span></button>
                <button type="button" class="btn btn-secondary" id="btnCopyJson"><span aria-hidden="true">üìã</span> <span data-i18n="copyJson">Kop√≠rovat JSON</span></button>
                <button type="button" class="btn btn-secondary" id="btnPasteJson"><span aria-hidden="true">üì•</span> <span data-i18n="pasteJson">Vlo≈æit JSON</span></button>
                <div class="quick-create-selector">
                    <select id="quickCreateSelect" aria-label="Rychl√© vytvo≈ôen√≠ z√°znamu">
                        <option value="" data-i18n="quickCreate">‚ûï Nov√Ω z√°znam...</option>
                    </select>
                </div>
                <div class="language-selector">
                    <select id="langSelect" aria-label="Jazyk">
                        <option value="cs">üá®üáø ƒåe≈°tina</option>
                        <option value="en">üá¨üáß English</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="table-tabs" id="tableTabs"></div>
        <input type="file" id="fileInput" accept=".jsondb" hidden>
    </header>

    <main id="main-content">
        <div id="tableContents"></div>

        <!-- Classification Section (Zat≈ô√≠dƒõn√≠) -->
        <div class="tab-content" id="classification-content">
            <div class="sub-tabs">
                <button type="button" class="sub-tab active" data-subtab="class-collections" data-i18n="collections">Kolekce</button>
                <button type="button" class="sub-tab" data-subtab="class-tags" data-i18n="tags">Tagy</button>
            </div>

            <!-- Collections Sub-tab -->
            <div class="sub-content active" id="class-collections">
                <div class="card">
                    <div class="card-header">
                        <h2 data-i18n="collections">Kolekce</h2>
                        <button type="button" class="btn btn-success" id="btnAddCollection"><span aria-hidden="true">‚ûï</span> <span data-i18n="addCollection">P≈ôidat kolekci</span></button>
                    </div>
                    <div class="card-body">
                        <div class="collections-grid" id="collectionsList"></div>
                        <div id="emptyCollections" class="empty-state" hidden>
                            <div class="empty-state-icon">üìÅ</div>
                            <p data-i18n="noCollections">Zat√≠m nem√°te ≈æ√°dn√© kolekce.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tags Sub-tab -->
            <div class="sub-content" id="class-tags">
                <div class="card">
                    <div class="card-header">
                        <h2 data-i18n="tags">Tagy</h2>
                        <button type="button" class="btn btn-success" id="btnAddTag"><span aria-hidden="true">‚ûï</span> <span data-i18n="addTag">P≈ôidat tag</span></button>
                    </div>
                    <div class="card-body">
                        <div class="tags-grid" id="tagsList"></div>
                        <div id="emptyTags" class="empty-state" hidden>
                            <div class="empty-state-icon">üè∑Ô∏è</div>
                            <p data-i18n="noTags">Zat√≠m nem√°te ≈æ√°dn√© tagy.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Management Section -->
        <div class="tab-content" id="management-content">
            <div class="sub-tabs">
                <button type="button" class="sub-tab active" data-subtab="sub-database" data-i18n="database">Datab√°ze</button>
                <button type="button" class="sub-tab" data-subtab="sub-tables" data-i18n="tables">Tabulky</button>
                <button type="button" class="sub-tab" data-subtab="sub-tools" data-i18n="tools">N√°stroje</button>
            </div>

            <!-- Database Sub-tab -->
            <div class="sub-content active" id="sub-database">
                <div class="card">
                    <div class="card-header"><h2 data-i18n="databaseSettings">Nastaven√≠ datab√°ze</h2></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="dbNameInput" data-i18n="dbName">N√°zev datab√°ze</label>
                            <input type="text" id="dbNameInput" placeholder="N√°zev datab√°ze">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tables Sub-tab -->
            <div class="sub-content" id="sub-tables">
                <div class="card">
                    <div class="card-header">
                        <h2 data-i18n="tablesList">Seznam tabulek</h2>
                        <button type="button" class="btn btn-success" id="btnAddTable"><span aria-hidden="true">‚ûï</span> <span data-i18n="addTable">P≈ôidat tabulku</span></button>
                    </div>
                    <div class="card-body">
                        <div class="field-list" id="tablesList"></div>
                        <div id="emptyTables" class="empty-state" hidden>
                            <div class="empty-state-icon">üìÅ</div>
                            <p data-i18n="noTables">Zat√≠m nem√°te ≈æ√°dn√© tabulky.</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="fieldsCard" hidden>
                    <div class="card-header">
                        <h2><span data-i18n="fieldsFor">Pole pro tabulku:</span> <span id="fieldsTableName"></span></h2>
                        <button type="button" class="btn btn-success" id="btnAddField"><span aria-hidden="true">‚ûï</span> <span data-i18n="addField">P≈ôidat pole</span></button>
                    </div>
                    <div class="card-body">
                        <div class="field-list" id="fieldList"></div>
                        <div id="emptyFields" class="empty-state" hidden>
                            <div class="empty-state-icon">üìù</div>
                            <p data-i18n="noFields">Zat√≠m nem√°te definov√°na ≈æ√°dn√° pole.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tools Sub-tab -->
            <div class="sub-content" id="sub-tools">
                <div class="card">
                    <div class="card-header"><h2 data-i18n="statistics">Statistiky</h2></div>
                    <div class="card-body">
                        <div class="stats-grid" id="statsGrid"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h2 data-i18n="textGenerator">Generov√°n√≠ textu</h2></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="generatorTable" data-i18n="selectTable">Vyberte tabulku</label>
                            <select id="generatorTable"></select>
                        </div>
                        <div class="form-group">
                            <label data-i18n="insertField">Vlo≈æit pole:</label>
                            <div class="field-buttons" id="generatorFieldButtons"></div>
                        </div>
                        <div class="form-group">
                            <label for="generatorTemplate" data-i18n="template">≈†ablona (pou≈æijte {n√°zev_pole})</label>
                            <textarea id="generatorTemplate" rows="4" placeholder="P≈ô√≠klad: {Jm√©no} m√° {Vƒõk} let."></textarea>
                        </div>
                        <div class="form-group">
                            <label data-i18n="recordsToGenerate">Z√°znamy:</label>
                            <div class="radio-group">
                                <label><input type="radio" name="genRecords" value="all" checked> <span data-i18n="allRecords">V≈°echny</span></label>
                                <label><input type="radio" name="genRecords" value="filtered"> <span data-i18n="filteredRecords">Filtrovan√©</span></label>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="btnGenerate"><span aria-hidden="true">‚ö°</span> <span data-i18n="generate">Generovat</span></button>
                        <div class="generator-output" id="generatorOutput" hidden></div>
                        <div class="inline-actions" style="margin-top: 0.5rem;">
                            <button type="button" class="btn btn-sm btn-secondary" id="btnCopyGenerated" hidden><span aria-hidden="true">üìã</span> <span data-i18n="copy">Kop√≠rovat</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Table Modal -->
    <div class="modal-backdrop" id="tableModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="tableModalTitle" data-i18n="addTable">P≈ôidat tabulku</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="tableName" data-i18n="tableName">N√°zev tabulky</label>
                    <input type="text" id="tableName" required>
                </div>
                <input type="hidden" id="tableId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnSaveTable" data-i18n="save">Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- Field Modal -->
    <div class="modal-backdrop" id="fieldModal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h2 id="fieldModalTitle" data-i18n="addField">P≈ôidat pole</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="fieldName" data-i18n="fieldName">N√°zev pole</label>
                    <input type="text" id="fieldName" required>
                </div>
                <div class="form-group">
                    <label for="fieldType" data-i18n="fieldType">Typ pole</label>
                    <select id="fieldType">
                        <option value="text">Text</option>
                        <option value="textarea">V√≠ce≈ô√°dkov√Ω text / Markdown</option>
                        <option value="number">ƒå√≠slo</option>
                        <option value="date">Datum</option>
                        <option value="url">URL odkaz</option>
                        <option value="boolean">Ano/Ne</option>
                        <option value="select">V√Ωbƒõr ze seznamu</option>
                        <option value="composite">Slo≈æen√Ω</option>
                        <option value="parent">Nad≈ôazen√Ω z√°znam</option>
                        <option value="children">Pod≈ô√≠zen√© z√°znamy</option>
                    </select>
                </div>
                <div class="form-group" id="fieldOptionsGroup" hidden>
                    <label for="fieldOptions" data-i18n="selectOptions">Hodnoty (oddƒõlen√© ƒç√°rkou)</label>
                    <input type="text" id="fieldOptions">
                </div>
                <div class="form-group" id="compositeTemplateGroup" hidden>
                    <label data-i18n="compositeFields">Vlo≈æit pole:</label>
                    <div class="field-buttons" id="compositeFieldButtons"></div>
                    <label for="compositeTemplate" data-i18n="compositeTemplate">≈†ablona slo≈æen√©ho pole</label>
                    <textarea id="compositeTemplate" rows="2" placeholder="{Pole1} - {Pole2}"></textarea>
                </div>
                <div class="form-group" id="targetTableGroup" hidden>
                    <label for="targetTable" data-i18n="targetTable">C√≠lov√° tabulka</label>
                    <select id="targetTable"></select>
                </div>
                <div class="form-group" id="parentFieldGroup" hidden>
                    <label for="parentField" data-i18n="parentFieldSelect">Pole odkazuj√≠c√≠ zpƒõt</label>
                    <select id="parentField"></select>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="fieldPrimary">
                    <label for="fieldPrimary" data-i18n="fieldPrimary">Prim√°rn√≠ (n√°zev z√°znamu)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="fieldFilter">
                    <label for="fieldFilter" data-i18n="fieldFilter">Povolit filtrov√°n√≠</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="fieldGroup">
                    <label for="fieldGroup" data-i18n="fieldGroup">Seskupovat z√°znamy</label>
                </div>
                <input type="hidden" id="fieldId">
                <input type="hidden" id="fieldTableId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnSaveField" data-i18n="save">Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- Record Modal -->
    <div class="modal-backdrop" id="recordModal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h2 id="recordModalTitle" data-i18n="addRecord">P≈ôidat z√°znam</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body"><form id="recordForm"></form></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnSaveRecord" data-i18n="save">Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- View Record Modal -->
    <div class="modal-backdrop" id="viewRecordModal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h2 id="viewRecordModalTitle">Z√°znam</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body" id="viewRecordContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
                <button type="button" class="btn btn-secondary" id="btnStructureFromView"><span aria-hidden="true">üå≥</span> <span data-i18n="structure">Struktura</span></button>
                <button type="button" class="btn btn-primary" id="btnEditFromView" data-i18n="edit">Upravit</button>
            </div>
        </div>
    </div>

    <!-- Collection Modal -->
    <div class="modal-backdrop" id="collectionModal" hidden>
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="collectionModalTitle" data-i18n="addCollection">P≈ôidat kolekci</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="collectionName" data-i18n="collectionName">N√°zev kolekce</label>
                    <input type="text" id="collectionName">
                </div>
                <div class="form-group">
                    <label for="collectionColor" data-i18n="color">Barva</label>
                    <input type="color" id="collectionColor" value="#4a90d9" style="width: 60px; height: 36px;">
                </div>
                <div class="form-group">
                    <label for="collectionDescription" data-i18n="collectionDescription">Popis kolekce</label>
                    <textarea id="collectionDescription" rows="5" placeholder="Markdown podporov√°n..."></textarea>
                </div>
                <input type="hidden" id="collectionId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnSaveCollection" data-i18n="save">Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- Tag Modal -->
    <div class="modal-backdrop" id="tagModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="tagModalTitle" data-i18n="addTag">P≈ôidat tag</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="tagName" data-i18n="tagName">N√°zev tagu</label>
                    <input type="text" id="tagName">
                </div>
                <div class="form-group">
                    <label for="tagColor" data-i18n="color">Barva</label>
                    <input type="color" id="tagColor" value="#e74c3c" style="width: 60px; height: 36px;">
                </div>
                <input type="hidden" id="tagId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnSaveTag" data-i18n="save">Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- View Collection Modal -->
    <div class="modal-backdrop" id="viewCollectionModal" hidden>
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="viewCollectionModalTitle">Kolekce</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body" id="viewCollectionContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
                <button type="button" class="btn btn-danger" id="btnDeleteCollectionFromView" data-i18n="delete">Smazat</button>
                <button type="button" class="btn btn-primary" id="btnEditCollectionFromView" data-i18n="edit">Upravit</button>
            </div>
        </div>
    </div>

    <!-- View Tag Modal -->
    <div class="modal-backdrop" id="viewTagModal" hidden>
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="viewTagModalTitle">Tag</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body" id="viewTagContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
                <button type="button" class="btn btn-danger" id="btnDeleteTagFromView" data-i18n="delete">Smazat</button>
                <button type="button" class="btn btn-primary" id="btnEditTagFromView" data-i18n="edit">Upravit</button>
            </div>
        </div>
    </div>

    <!-- Add To Collection Modal -->
    <div class="modal-backdrop" id="addToCollectionModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 data-i18n="addToCollection">P≈ôidat do kolekce</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="selectCollection">Vyberte kolekci</label>
                    <select id="addToCollectionSelect" style="width: 100%;"></select>
                </div>
                <div class="inline-actions" style="margin-top: 0.5rem;">
                    <button type="button" class="btn btn-sm btn-success" id="btnQuickCreateCollection"><span aria-hidden="true">‚ûï</span> <span data-i18n="createNewCollection">Vytvo≈ôit novou kolekci</span></button>
                </div>
                <input type="hidden" id="addToCollectionRecordId">
                <input type="hidden" id="addToCollectionTableId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnConfirmAddToCollection" data-i18n="addToCollection">P≈ôidat do kolekce</button>
            </div>
        </div>
    </div>

    <!-- Add Tag Modal -->
    <div class="modal-backdrop" id="addTagToRecordModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 data-i18n="assignTags">P≈ôi≈ôadit tagy</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="selectTag">Vyberte tag</label>
                    <select id="addTagSelect" style="width: 100%;"></select>
                </div>
                <div class="inline-actions" style="margin-top: 0.5rem;">
                    <button type="button" class="btn btn-sm btn-success" id="btnQuickCreateTag"><span aria-hidden="true">‚ûï</span> <span data-i18n="createNewTag">Vytvo≈ôit nov√Ω tag</span></button>
                </div>
                <input type="hidden" id="addTagRecordId">
                <input type="hidden" id="addTagTableId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnConfirmAddTag" data-i18n="assignTags">P≈ôi≈ôadit tag</button>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div class="modal-backdrop" id="bulkEditModal" hidden>
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h2 data-i18n="bulkEditFields">Hromadn√° √∫prava pol√≠</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div id="bulkEditFieldsContainer"></div>
                <button type="button" class="btn btn-secondary btn-sm" id="btnAddBulkField" style="margin-top: 0.5rem;">‚ûï <span data-i18n="addAnotherField">P≈ôidat dal≈°√≠ pole</span></button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnApplyBulkEdit" data-i18n="apply">Pou≈æ√≠t</button>
            </div>
        </div>
    </div>

    <!-- Bulk Add to Collection Modal -->
    <div class="modal-backdrop" id="bulkAddToCollectionModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 data-i18n="addToCollection">P≈ôidat do kolekce</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="selectCollection">Vyberte kolekci</label>
                    <select id="bulkCollectionSelect"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnApplyBulkCollection" data-i18n="add">P≈ôidat</button>
            </div>
        </div>
    </div>

    <!-- Bulk Add Tag Modal -->
    <div class="modal-backdrop" id="bulkAddTagModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 data-i18n="addTag">P≈ôidat tag</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="selectTag">Vyberte tag</label>
                    <select id="bulkTagSelect"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnApplyBulkTag" data-i18n="add">P≈ôidat</button>
            </div>
        </div>
    </div>

    <!-- Structure Modal -->
    <div class="modal-backdrop" id="structureModal" hidden>
        <div class="modal structure-modal">
            <div class="modal-header">
                <h2 id="structureModalTitle">üå≥ Struktura</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="structure-tabs">
                <button type="button" class="structure-tab active" data-structure-tab="text">üìù <span data-i18n="textView">Textov√Ω pohled</span></button>
                <button type="button" class="structure-tab" data-structure-tab="graph">üîÄ <span data-i18n="graphView">Grafick√Ω pohled</span></button>
            </div>
            <div class="modal-body structure-body">
                <div class="structure-content active" id="structure-text">
                    <div id="structureTreeContainer"></div>
                </div>
                <div class="structure-content" id="structure-graph">
                    <div id="structureGraphContainer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-backdrop" id="confirmModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="confirmModalTitle" data-i18n="confirm">Potvrzen√≠</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body"><p id="confirmMessage"></p></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-danger" id="btnConfirmYes" data-i18n="delete">Smazat</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-backdrop" id="exportModal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h2 id="exportModalTitle" data-i18n="export">Export</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="format">Form√°t:</label>
                    <div class="format-tabs">
                        <button type="button" class="format-tab active" data-format="csv">CSV (ƒç√°rka)</button>
                        <button type="button" class="format-tab" data-format="tsv">TSV (tabul√°tor)</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="exportOutput" data-i18n="exportData">Data k exportu:</label>
                    <textarea id="exportOutput" rows="10" readonly style="font-family: monospace;"></textarea>
                </div>
                <div class="inline-actions">
                    <button type="button" class="btn btn-primary" id="btnExportCopy"><span aria-hidden="true">üìã</span> <span data-i18n="copy">Kop√≠rovat</span></button>
                    <button type="button" class="btn btn-success" id="btnExportFile"><span aria-hidden="true">üíæ</span> <span data-i18n="saveFile">Ulo≈æit soubor</span></button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-backdrop" id="importModal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h2 id="importModalTitle" data-i18n="import">Import</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="format">Form√°t:</label>
                    <div class="format-tabs" id="importFormatTabs">
                        <button type="button" class="format-tab active" data-format="csv">CSV (ƒç√°rka)</button>
                        <button type="button" class="format-tab" data-format="tsv">TSV (tabul√°tor)</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="importFile" data-i18n="loadFile">Naƒç√≠st soubor:</label>
                    <input type="file" id="importFile" accept=".csv,.tsv,.txt">
                </div>
                <div class="form-group">
                    <label for="importInput" data-i18n="orPasteData">Nebo vlo≈æte data:</label>
                    <textarea id="importInput" rows="8" style="font-family: monospace;" placeholder="Vlo≈æte CSV/TSV data..."></textarea>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="importHasHeader" checked>
                    <label for="importHasHeader" data-i18n="hasHeader">Prvn√≠ ≈ô√°dek obsahuje n√°zvy sloupc≈Ø</label>
                </div>
                <div id="importPreview"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnDoImport" data-i18n="import">Importovat</button>
            </div>
        </div>
    </div>

    <!-- Paste JSON Modal (fallback for mobile) -->
    <div class="modal-backdrop" id="pasteJsonModal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="pasteJson">Vlo≈æit JSON</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="pasteJsonInput" data-i18n="pasteJsonHere">Vlo≈æte JSON datab√°ze:</label>
                    <textarea id="pasteJsonInput" rows="12" style="font-family: monospace; font-size: 0.85rem;" placeholder='{"meta":{"name":"..."},"tables":[...]}'></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnDoPasteJson" data-i18n="load">Naƒç√≠st</button>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            cs: {
                skipToContent: "P≈ôeskoƒçit na obsah", appName: "Editor datab√°ze", dbName: "N√°zev datab√°ze", newDb: "Nov√°", load: "Naƒç√≠st", save: "Ulo≈æit",
                copyJson: "Kop√≠rovat JSON", pasteJson: "Vlo≈æit JSON", pasteJsonHere: "Vlo≈æte JSON datab√°ze:", jsonCopied: "JSON zkop√≠rov√°n do schr√°nky.", jsonPasted: "JSON naƒçten.",
                saveToWiki: "Ulo≈æit na wiki", wikiSaved: "Ulo≈æeno na wiki.", wikiSaveError: "Chyba p≈ôi ukl√°d√°n√≠:", wikiSaving: "Ukl√°d√°m...",
                export: "Export", import: "Import", database: "Datab√°ze", tables: "Tabulky", tools: "N√°stroje",
                databaseSettings: "Nastaven√≠ datab√°ze", tablesList: "Seznam tabulek", addTable: "P≈ôidat tabulku",
                noTables: "Zat√≠m nem√°te ≈æ√°dn√© tabulky.", fieldsFor: "Pole pro tabulku:", addField: "P≈ôidat pole",
                noFields: "Zat√≠m nem√°te definov√°na ≈æ√°dn√° pole.", statistics: "Statistiky", textGenerator: "Generov√°n√≠ textu",
                selectTable: "Vyberte tabulku", insertField: "Vlo≈æit pole:", template: "≈†ablona (pou≈æijte {n√°zev_pole})",
                recordsToGenerate: "Z√°znamy:", allRecords: "V≈°echny", filteredRecords: "Filtrovan√©", generate: "Generovat",
                copy: "Kop√≠rovat", tableName: "N√°zev tabulky", cancel: "Zru≈°it", fieldName: "N√°zev pole", fieldType: "Typ pole",
                selectOptions: "Hodnoty (oddƒõlen√© ƒç√°rkou)", targetTable: "C√≠lov√° tabulka", parentFieldSelect: "Pole odkazuj√≠c√≠ zpƒõt",
                fieldPrimary: "Prim√°rn√≠ (n√°zev z√°znamu)", fieldFilter: "Povolit filtrov√°n√≠", addRecord: "P≈ôidat z√°znam",
                close: "Zav≈ô√≠t", edit: "Upravit", confirm: "Potvrzen√≠", delete: "Smazat", format: "Form√°t:",
                exportData: "Data k exportu:", saveFile: "Ulo≈æit soubor", loadFile: "Naƒç√≠st soubor:",
                orPasteData: "Nebo vlo≈æte data:", hasHeader: "Prvn√≠ ≈ô√°dek obsahuje n√°zvy sloupc≈Ø",
                searchPlaceholder: "Hledat...", columnVisibility: "Zobrazen√≠ sloupc≈Ø", actions: "Akce",
                noRecords: "Zat√≠m nem√°te ≈æ√°dn√© z√°znamy.", allValues: "V≈°echny hodnoty", noValue: "(bez hodnoty)",
                yes: "Ano", no: "Ne", noParent: "≈Ω√°dn√Ω", noChildren: "≈Ω√°dn√© pod≈ô√≠zen√© z√°znamy",
                confirmDeleteRecord: "Smazat tento z√°znam?", confirmDeleteField: "Smazat toto pole?",
                confirmDeleteTable: "Smazat tuto tabulku?", confirmNewDb: "Vytvo≈ôit novou datab√°zi?",
                jsonCopied: "Zkop√≠rov√°no.", jsonInvalid: "Neplatn√Ω JSON.", importSuccess: "Importov√°no: {count} nov√Ωch, {updated} aktualizovan√Ωch.",
                totalTables: "Tabulek celkem", totalRecords: "Z√°znam≈Ø celkem", recordsInTable: "Z√°znam≈Ø v {name}",
                management: "Spr√°va", rowsPreview: "N√°hled ({count} ≈ô√°dk≈Ø)", selectField: "-- Vyberte --",
                recordsShowing: "Zobrazeno: {filtered} / {total}", typeText: "Text", typeTextarea: "V√≠ce≈ô√°dkov√Ω text / Markdown",
                typeNumber: "ƒå√≠slo", typeDate: "Datum", typeBoolean: "Ano/Ne", typeSelect: "V√Ωbƒõr ze seznamu",
                typeParent: "Nad≈ôazen√Ω z√°znam", typeChildren: "Pod≈ô√≠zen√© z√°znamy", typeComposite: "Slo≈æen√Ω", typeUrl: "URL odkaz", editTable: "Upravit", editField: "Upravit pole",
                compositeFields: "Vlo≈æit pole:", compositeTemplate: "≈†ablona slo≈æen√©ho pole", createNew: "Vytvo≈ôit nov√Ω", fieldGroup: "Seskupovat z√°znamy", groupCollapsed: "sbaleno", groupExpanded: "rozbaleno", addChild: "P≈ôidat pod≈ô√≠zen√Ω", copyField: "Kop√≠rovat", copiedToClipboard: "Zkop√≠rov√°no do schr√°nky",
                collections: "Kolekce", tags: "Tagy", addCollection: "P≈ôidat kolekci", addTag: "P≈ôidat tag", collectionName: "N√°zev kolekce", tagName: "N√°zev tagu", color: "Barva", noCollections: "Zat√≠m nem√°te ≈æ√°dn√© kolekce.", noTags: "Zat√≠m nem√°te ≈æ√°dn√© tagy.", collectionMembers: "z√°znam≈Ø", confirmDeleteCollection: "Smazat tuto kolekci?", confirmDeleteTag: "Smazat tento tag?", addToCollection: "P≈ôidat do kolekce", removeFromCollection: "Odebrat z kolekce", assignTags: "P≈ôi≈ôadit tagy", relatedRecords: "Souvisej√≠c√≠ z√°znamy", inCollection: "V kolekci", withTag: "S tagem", allCollections: "V≈°echny kolekce", allTags: "V≈°echny tagy", viewCollection: "Zobrazit kolekci", collectionContents: "Obsah kolekce", backToTables: "Zpƒõt na tabulky", recordsInCollection: "Z√°znamy v kolekci", noRecordsInCollection: "Kolekce neobsahuje ≈æ√°dn√© z√°znamy.", fromTable: "z tabulky", manageCollections: "Spravovat kolekce", manageTags: "Spravovat tagy", classification: "Zat≈ô√≠dƒõn√≠", description: "Popis", collectionDescription: "Popis kolekce", selectCollection: "Vyberte kolekci", selectTag: "Vyberte tag", createNewCollection: "Vytvo≈ôit novou kolekci", createNewTag: "Vytvo≈ôit nov√Ω tag", removeFromThisCollection: "Odebrat z t√©to kolekce", removeThisTag: "Odebrat tento tag", collectionDetails: "Podrobnosti kolekce", tagDetails: "Podrobnosti tagu", editCollection: "Upravit kolekci", editTag: "Upravit tag", recordsWithTag: "Z√°znamy s tagem", quickCreate: "‚ûï Nov√Ω z√°znam...", structure: "Struktura", textView: "Textov√Ω pohled", graphView: "Grafick√Ω pohled", showStructure: "Zobrazit strukturu", noDescendants: "Tento z√°znam nem√° ≈æ√°dn√© pod≈ô√≠zen√© z√°znamy.", loadMore: "Naƒç√≠st v√≠ce...", loadAll: "Naƒç√≠st v≈°echny", descendants: "potomk≈Ø", selectedRecords: "vybr√°no", bulkEditField: "Upravit pole", clearSelection: "Zru≈°it v√Ωbƒõr", selectAll: "Vybrat v≈°e", newValue: "Nov√° hodnota", apply: "Pou≈æ√≠t", confirmBulkDelete: "Opravdu smazat {count} z√°znam≈Ø?", addedToCollection: "P≈ôid√°no {count} z√°znam≈Ø do kolekce.", addedTag: "Tag p≈ôid√°n k {count} z√°znam≈Øm.", recordFields: "Pole z√°znamu", bulkEditFields: "Hromadn√° √∫prava pol√≠", addAnotherField: "P≈ôidat dal≈°√≠ pole"
            },
            en: {
                skipToContent: "Skip to content", appName: "Database Editor", dbName: "Database name", newDb: "New", load: "Load", save: "Save",
                copyJson: "Copy JSON", pasteJson: "Paste JSON", pasteJsonHere: "Paste database JSON:", jsonCopied: "JSON copied to clipboard.", jsonPasted: "JSON loaded.",
                saveToWiki: "Save to Wiki", wikiSaved: "Saved to wiki.", wikiSaveError: "Error saving:", wikiSaving: "Saving...",
                export: "Export", import: "Import", database: "Database", tables: "Tables", tools: "Tools",
                databaseSettings: "Database Settings", tablesList: "Tables List", addTable: "Add Table",
                noTables: "No tables yet.", fieldsFor: "Fields for table:", addField: "Add Field",
                noFields: "No fields defined yet.", statistics: "Statistics", textGenerator: "Text Generator",
                selectTable: "Select table", insertField: "Insert field:", template: "Template (use {field_name})",
                recordsToGenerate: "Records:", allRecords: "All", filteredRecords: "Filtered", generate: "Generate",
                copy: "Copy", tableName: "Table Name", cancel: "Cancel", fieldName: "Field Name", fieldType: "Field Type",
                selectOptions: "Values (comma-separated)", targetTable: "Target Table", parentFieldSelect: "Back-reference field",
                fieldPrimary: "Primary (record name)", fieldFilter: "Enable filtering", addRecord: "Add Record",
                close: "Close", edit: "Edit", confirm: "Confirmation", delete: "Delete", format: "Format:",
                exportData: "Export data:", saveFile: "Save File", loadFile: "Load file:",
                orPasteData: "Or paste data:", hasHeader: "First row contains column names",
                searchPlaceholder: "Search...", columnVisibility: "Column Visibility", actions: "Actions",
                noRecords: "No records yet.", allValues: "All values", noValue: "(no value)",
                yes: "Yes", no: "No", noParent: "None", noChildren: "No child records",
                confirmDeleteRecord: "Delete this record?", confirmDeleteField: "Delete this field?",
                confirmDeleteTable: "Delete this table?", confirmNewDb: "Create new database?",
                jsonCopied: "Copied.", jsonInvalid: "Invalid JSON.", importSuccess: "Imported: {count} new, {updated} updated.",
                totalTables: "Total tables", totalRecords: "Total records", recordsInTable: "Records in {name}",
                management: "Spr√°va", rowsPreview: "Preview ({count} rows)", selectField: "-- Select --",
                recordsShowing: "Showing: {filtered} / {total}", typeText: "Text", typeTextarea: "Multi-line text / Markdown",
                typeNumber: "Number", typeDate: "Date", typeBoolean: "Yes/No", typeSelect: "Select from list",
                typeParent: "Parent record", typeChildren: "Child records", typeComposite: "Composite", typeUrl: "URL link", editTable: "Edit", editField: "Edit field",
                compositeFields: "Insert field:", compositeTemplate: "Composite field template", createNew: "Create new", fieldGroup: "Group records", groupCollapsed: "collapsed", groupExpanded: "expanded", addChild: "Add child", copyField: "Copy", copiedToClipboard: "Copied to clipboard",
                collections: "Collections", tags: "Tags", addCollection: "Add collection", addTag: "Add tag", collectionName: "Collection name", tagName: "Tag name", color: "Color", noCollections: "You have no collections yet.", noTags: "You have no tags yet.", collectionMembers: "records", confirmDeleteCollection: "Delete this collection?", confirmDeleteTag: "Delete this tag?", addToCollection: "Add to collection", removeFromCollection: "Remove from collection", assignTags: "Assign tags", relatedRecords: "Related records", inCollection: "In collection", withTag: "With tag", allCollections: "All collections", allTags: "All tags", viewCollection: "View collection", collectionContents: "Collection contents", backToTables: "Back to tables", recordsInCollection: "Records in collection", noRecordsInCollection: "Collection contains no records.", fromTable: "from table", manageCollections: "Manage collections", manageTags: "Manage tags", classification: "Classification", description: "Description", collectionDescription: "Collection description", selectCollection: "Select collection", selectTag: "Select tag", createNewCollection: "Create new collection", createNewTag: "Create new tag", removeFromThisCollection: "Remove from this collection", removeThisTag: "Remove this tag", collectionDetails: "Collection details", tagDetails: "Tag details", editCollection: "Edit collection", editTag: "Edit tag", recordsWithTag: "Records with tag", quickCreate: "‚ûï New record...", structure: "Structure", textView: "Text view", graphView: "Graph view", showStructure: "Show structure", noDescendants: "This record has no child records.", loadMore: "Load more...", loadAll: "Load all", descendants: "descendants", selectedRecords: "selected", bulkEditField: "Edit field", clearSelection: "Clear selection", selectAll: "Select all", newValue: "New value", apply: "Apply", confirmBulkDelete: "Delete {count} records?", addedToCollection: "Added {count} records to collection.", addedTag: "Tag added to {count} records.", recordFields: "Record fields", bulkEditFields: "Bulk edit fields", addAnotherField: "Add another field"
            }
        };

        let currentLang = localStorage.getItem('db-editor-lang') || 'cs';
        let database = { meta: { name: 'Nov√° datab√°ze', columnVisibility: {}, groupStates: {}, collections: [], tags: [] }, tables: [] };
        let activeTableId = null;
        let activeTab = 'management';
        let quickCreateMode = false;
        let activeManagementTab = 'database';
        let tableFilters = {};
        let tableSearches = {};
        let tableSorts = {};
        let collectionFilter = null;
        let tagFilter = null;
        let selectedRecords = {}; // { tableId: Set of recordIds }
        let editingFieldTableId = null;
        let currentRecordId = null;
        let currentRecordTableId = null;
        let confirmCallback = null;
        let exportFormat = 'csv';
        let importFormat = 'csv';

        const generateId = () => 'id_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        const t = (key, r = {}) => { let s = translations[currentLang]?.[key] || key; for (const [k, v] of Object.entries(r)) s = s.replace(`{${k}}`, v); return s; };
        const escapeHtml = s => s == null ? '' : String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        const getTableById = id => database.tables.find(tb => tb.id === id);
        const getRecordById = (tId, rId) => getTableById(tId)?.records.find(r => r.id === rId);
        function getPrimaryFieldValue(table, record) { 
            const pf = table.fields.find(f => f.primary); 
            if (!pf) return `#${record.id.substr(0, 6)}`;
            if (pf.type === 'composite') return evaluateCompositeField(table, pf, record) || `#${record.id.substr(0, 6)}`;
            return record.values[pf.id] ? record.values[pf.id] : `#${record.id.substr(0, 6)}`; 
        }
        const getChildRecords = (tableId, recordId) => { const ch = []; database.tables.forEach(tb => { tb.fields.filter(f => f.type === 'parent' && f.targetTableId === tableId).forEach(field => { tb.records.forEach(rec => { if (rec.values[field.id] === recordId) ch.push({ table: tb, record: rec, field }); }); }); }); return ch; };

        function updateDocumentTitle() {
            const dbName = database.meta.name;
            const table = getTableById(activeTableId);
            const tableName = table?.name || '';
            let title = t('appName');
            if (dbName && dbName.trim()) {
                title = (currentLang === 'cs' ? 'Datab√°ze: ' : 'Database: ') + dbName;
                if (tableName && activeTab !== 'management') {
                    title += ' | ' + tableName;
                }
            }
            document.title = title;
        }

        function autoSave() {
            try {
                localStorage.setItem('db-editor-autosave', JSON.stringify(database));
                localStorage.setItem('db-editor-autosave-tab', activeTab);
            } catch (e) {
                console.warn('Auto-save failed:', e);
            }
        }

        function loadAutoSave() {
            try {
                const saved = localStorage.getItem('db-editor-autosave');
                if (saved) {
                    const data = JSON.parse(saved);
                    database = { 
                        meta: { 
                            name: data.meta?.name || '', 
                            columnVisibility: data.meta?.columnVisibility || {},
                            groupStates: data.meta?.groupStates || {},
                            collections: data.meta?.collections || [],
                            tags: data.meta?.tags || []
                        }, 
                        tables: data.tables || [] 
                    };
                    const savedTab = localStorage.getItem('db-editor-autosave-tab');
                    if (savedTab && (savedTab === 'management' || getTableById(savedTab))) {
                        activeTab = savedTab;
                        activeTableId = savedTab !== 'management' ? savedTab : (database.tables[0]?.id || null);
                    } else {
                        activeTab = database.tables.length > 0 ? database.tables[0].id : 'management';
                        activeTableId = database.tables[0]?.id || null;
                    }
                    return true;
                }
            } catch (e) {
                console.warn('Auto-load failed:', e);
            }
            return false;
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = t(el.getAttribute('data-i18n')));
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = t(el.getAttribute('data-i18n-placeholder')));
            document.documentElement.lang = currentLang;
        }

        function openModal(id) { document.getElementById(id).hidden = false; document.body.style.overflow = 'hidden'; }
        function closeModal(id) { 
            document.getElementById(id).hidden = true; 
            document.body.style.overflow = ''; 
            if (id === 'recordModal') quickCreateMode = false;
        }
        function confirmAction(msg, cb) { document.getElementById('confirmMessage').textContent = msg; confirmCallback = cb; openModal('confirmModal'); }

        // Simple Markdown parser
        function parseMarkdown(text) {
            if (!text) return '';
            let html = escapeHtml(text);
            // Code blocks
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Headers
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            // Bold and italic
            html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            html = html.replace(/___(.+?)___/g, '<strong><em>$1</em></strong>');
            html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
            html = html.replace(/_(.+?)_/g, '<em>$1</em>');
            // Blockquotes
            html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
            // Links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            // Horizontal rule
            html = html.replace(/^---$/gm, '<hr>');
            // Unordered lists
            html = html.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            // Ordered lists
            html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            // Paragraphs
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            html = '<p>' + html + '</p>';
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[123]>)/g, '$1');
            html = html.replace(/(<\/h[123]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1');
            html = html.replace(/(<\/ul>)<\/p>/g, '$1');
            html = html.replace(/<p>(<blockquote>)/g, '$1');
            html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');
            html = html.replace(/<p>(<pre>)/g, '$1');
            html = html.replace(/(<\/pre>)<\/p>/g, '$1');
            html = html.replace(/<p>(<hr>)<\/p>/g, '$1');
            return html;
        }

        function renderTableTabs() {
            const container = document.getElementById('tableTabs');
            let html = database.tables.map(tb => 
                `<button type="button" class="table-tab ${activeTab === tb.id ? 'active' : ''}" data-table-id="${tb.id}">${escapeHtml(tb.name)}</button>`
            ).join('');
            html += `<button type="button" class="table-tab classification-tab ${activeTab === 'classification' ? 'active' : ''}" data-table-id="classification">üè∑Ô∏è ${t('classification')}</button>`;
            html += `<button type="button" class="table-tab management-tab ${activeTab === 'management' ? 'active' : ''}" data-table-id="management">‚öôÔ∏è ${t('management')}</button>`;
            container.innerHTML = html;
        }
        
        // Bulk selection functions
        function getSelectedRecords(tableId) {
            return selectedRecords[tableId] || new Set();
        }
        
        function getSelectedCount(tableId) {
            return getSelectedRecords(tableId).size;
        }
        
        function toggleSelectAll(tableId, checked) {
            const table = getTableById(tableId);
            if (!table) return;
            if (!selectedRecords[tableId]) selectedRecords[tableId] = new Set();
            
            // Get currently filtered records
            const filtered = table._filteredRecords || table.records;
            if (checked) {
                filtered.forEach(r => selectedRecords[tableId].add(r.id));
            } else {
                filtered.forEach(r => selectedRecords[tableId].delete(r.id));
            }
            renderTableContent(tableId);
        }
        
        function toggleSelectRow(tableId, recordId, checked) {
            if (!selectedRecords[tableId]) selectedRecords[tableId] = new Set();
            if (checked) {
                selectedRecords[tableId].add(recordId);
            } else {
                selectedRecords[tableId].delete(recordId);
            }
            renderTableContent(tableId);
        }
        
        function clearSelection(tableId) {
            if (selectedRecords[tableId]) {
                selectedRecords[tableId].clear();
            }
            renderTableContent(tableId);
        }
        
        function renderBulkActionsBar(tableId) {
            const count = getSelectedCount(tableId);
            if (count === 0) return '';
            
            return `<div class="bulk-actions-bar">
                <span class="bulk-count">${count} ${t('selectedRecords')}</span>
                <button type="button" class="btn btn-sm bulk-edit-field-btn" data-table="${tableId}">‚úèÔ∏è ${t('bulkEditField')}</button>
                <button type="button" class="btn btn-sm bulk-add-collection-btn" data-table="${tableId}">üìÅ ${t('addToCollection')}</button>
                <button type="button" class="btn btn-sm bulk-add-tag-btn" data-table="${tableId}">üè∑Ô∏è ${t('addTag')}</button>
                <button type="button" class="btn btn-sm btn-danger bulk-delete-btn" data-table="${tableId}">üóëÔ∏è ${t('delete')}</button>
                <button type="button" class="bulk-deselect" data-table="${tableId}" title="${t('clearSelection')}">‚úï</button>
            </div>`;
        }
        
        // Bulk edit field
        let bulkEditTableId = null;
        
        function openBulkEditModal(tableId) {
            bulkEditTableId = tableId;
            const table = getTableById(tableId);
            if (!table) return;
            
            // Clear and add first row
            document.getElementById('bulkEditFieldsContainer').innerHTML = '';
            addBulkEditRow();
            openModal('bulkEditModal');
        }
        
        let bulkEditRowCounter = 0;
        
        function addBulkEditRow() {
            const table = getTableById(bulkEditTableId);
            if (!table) return;
            
            const editableFields = table.fields.filter(f => f.type !== 'children' && f.type !== 'composite');
            const rowId = ++bulkEditRowCounter;
            
            let optionsHtml = `<option value="">${t('selectField')}</option>`;
            editableFields.forEach(f => {
                optionsHtml += `<option value="${f.id}">${escapeHtml(f.name)}</option>`;
            });
            
            const rowHtml = `<div class="bulk-edit-row" data-row="${rowId}">
                <div class="bulk-edit-row-header">
                    <select class="bulk-edit-field-select" data-row="${rowId}">${optionsHtml}</select>
                    <button type="button" class="btn btn-sm btn-danger bulk-edit-remove-row" data-row="${rowId}" title="${t('remove')}">‚úï</button>
                </div>
                <div class="bulk-edit-value-container" data-row="${rowId}"></div>
            </div>`;
            
            document.getElementById('bulkEditFieldsContainer').insertAdjacentHTML('beforeend', rowHtml);
        }
        
        function removeBulkEditRow(rowId) {
            const row = document.querySelector(`.bulk-edit-row[data-row="${rowId}"]`);
            if (row) row.remove();
            
            // Ensure at least one row
            if (document.querySelectorAll('.bulk-edit-row').length === 0) {
                addBulkEditRow();
            }
        }
        
        function updateBulkEditValueInput(rowId) {
            const select = document.querySelector(`.bulk-edit-field-select[data-row="${rowId}"]`);
            const container = document.querySelector(`.bulk-edit-value-container[data-row="${rowId}"]`);
            if (!select || !container) return;
            
            const fieldId = select.value;
            const table = getTableById(bulkEditTableId);
            if (!table || !fieldId) {
                container.innerHTML = '';
                return;
            }
            
            const field = table.fields.find(f => f.id === fieldId);
            if (!field) return;
            
            let inputHtml = '';
            const inputId = `bulkEditValue_${rowId}`;
            switch (field.type) {
                case 'text':
                    inputHtml = `<input type="text" id="${inputId}" class="bulk-edit-value" data-row="${rowId}">`;
                    break;
                case 'textarea':
                    inputHtml = `<textarea id="${inputId}" class="bulk-edit-value" data-row="${rowId}" rows="2"></textarea>`;
                    break;
                case 'number':
                    inputHtml = `<input type="number" id="${inputId}" class="bulk-edit-value" data-row="${rowId}" step="any">`;
                    break;
                case 'date':
                    inputHtml = `<input type="date" id="${inputId}" class="bulk-edit-value" data-row="${rowId}">`;
                    break;
                case 'url':
                    inputHtml = `<input type="url" id="${inputId}" class="bulk-edit-value" data-row="${rowId}" placeholder="https://">`;
                    break;
                case 'boolean':
                    inputHtml = `<select id="${inputId}" class="bulk-edit-value" data-row="${rowId}"><option value="true">${t('yes')}</option><option value="false">${t('no')}</option></select>`;
                    break;
                case 'select':
                    const opts = (field.options || '').split(',').map(o => o.trim()).filter(o => o);
                    inputHtml = `<select id="${inputId}" class="bulk-edit-value" data-row="${rowId}"><option value="">-- ${t('selectField')} --</option>${opts.map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`;
                    break;
                case 'parent':
                    const tt = getTableById(field.targetTableId);
                    if (tt) {
                        inputHtml = `<select id="${inputId}" class="bulk-edit-value" data-row="${rowId}"><option value="">${t('noParent')}</option>${tt.records.map(r => `<option value="${r.id}">${escapeHtml(getPrimaryFieldValue(tt, r))}</option>`).join('')}</select>`;
                    }
                    break;
                default:
                    inputHtml = `<input type="text" id="${inputId}" class="bulk-edit-value" data-row="${rowId}">`;
            }
            
            container.innerHTML = inputHtml;
        }
        
        function applyBulkEdit() {
            const table = getTableById(bulkEditTableId);
            if (!table) return;
            
            // Collect all field changes
            const changes = [];
            document.querySelectorAll('.bulk-edit-row').forEach(row => {
                const rowId = row.dataset.row;
                const select = row.querySelector('.bulk-edit-field-select');
                const valueEl = row.querySelector('.bulk-edit-value');
                
                if (!select || !select.value) return;
                
                const fieldId = select.value;
                const field = table.fields.find(f => f.id === fieldId);
                if (!field) return;
                
                let value = valueEl ? valueEl.value : '';
                if (field.type === 'boolean') {
                    value = value === 'true';
                } else if (field.type === 'number') {
                    value = value ? parseFloat(value) : null;
                }
                
                changes.push({ fieldId, value });
            });
            
            if (changes.length === 0) {
                closeModal('bulkEditModal');
                return;
            }
            
            // Apply changes to all selected records
            const selected = getSelectedRecords(bulkEditTableId);
            selected.forEach(recordId => {
                const record = getRecordById(bulkEditTableId, recordId);
                if (record) {
                    changes.forEach(({ fieldId, value }) => {
                        record.values[fieldId] = value;
                    });
                }
            });
            
            closeModal('bulkEditModal');
            clearSelection(bulkEditTableId);
            autoSave();
        }
        
        // Bulk add to collection
        function openBulkAddToCollectionModal(tableId) {
            bulkEditTableId = tableId;
            if (!database.meta.collections || database.meta.collections.length === 0) {
                alert(t('noCollections'));
                return;
            }
            
            let optionsHtml = `<option value="">${t('selectCollection')}</option>`;
            database.meta.collections.forEach(col => {
                optionsHtml += `<option value="${col.id}">${escapeHtml(col.name)}</option>`;
            });
            
            document.getElementById('bulkCollectionSelect').innerHTML = optionsHtml;
            openModal('bulkAddToCollectionModal');
        }
        
        function applyBulkAddToCollection() {
            const colId = document.getElementById('bulkCollectionSelect').value;
            if (!colId) return;
            
            const col = database.meta.collections?.find(c => c.id === colId);
            if (!col) return;
            
            if (!col.members) col.members = [];
            
            const selected = getSelectedRecords(bulkEditTableId);
            let added = 0;
            selected.forEach(recordId => {
                // Skip if already in collection
                if (!col.members.some(m => m.tableId === bulkEditTableId && m.recordId === recordId)) {
                    col.members.push({ tableId: bulkEditTableId, recordId });
                    added++;
                }
            });
            
            closeModal('bulkAddToCollectionModal');
            clearSelection(bulkEditTableId);
            autoSave();
            alert(t('addedToCollection', { count: added }));
        }
        
        // Bulk add tag
        function openBulkAddTagModal(tableId) {
            bulkEditTableId = tableId;
            if (!database.meta.tags || database.meta.tags.length === 0) {
                alert(t('noTags'));
                return;
            }
            
            let optionsHtml = `<option value="">${t('selectTag')}</option>`;
            database.meta.tags.forEach(tag => {
                optionsHtml += `<option value="${tag.id}">${escapeHtml(tag.name)}</option>`;
            });
            
            document.getElementById('bulkTagSelect').innerHTML = optionsHtml;
            openModal('bulkAddTagModal');
        }
        
        function applyBulkAddTag() {
            const tagId = document.getElementById('bulkTagSelect').value;
            if (!tagId) return;
            
            const selected = getSelectedRecords(bulkEditTableId);
            let added = 0;
            selected.forEach(recordId => {
                const record = getRecordById(bulkEditTableId, recordId);
                if (record) {
                    if (!record.tags) record.tags = [];
                    if (!record.tags.includes(tagId)) {
                        record.tags.push(tagId);
                        added++;
                    }
                }
            });
            
            closeModal('bulkAddTagModal');
            clearSelection(bulkEditTableId);
            autoSave();
            alert(t('addedTag', { count: added }));
        }
        
        // Bulk delete
        function bulkDelete(tableId) {
            const count = getSelectedCount(tableId);
            if (count === 0) return;
            
            showConfirm(t('confirmBulkDelete', { count }), () => {
                const table = getTableById(tableId);
                if (!table) return;
                
                const selected = getSelectedRecords(tableId);
                table.records = table.records.filter(r => !selected.has(r.id));
                
                // Remove from collections
                if (database.meta.collections) {
                    database.meta.collections.forEach(col => {
                        if (col.members) {
                            col.members = col.members.filter(m => !(m.tableId === tableId && selected.has(m.recordId)));
                        }
                    });
                }
                
                clearSelection(tableId);
                autoSave();
            });
        }

        function updateQuickCreateOptions() {
            const select = document.getElementById('quickCreateSelect');
            let html = `<option value="">${t('quickCreate')}</option>`;
            database.tables.forEach(tb => {
                html += `<option value="${tb.id}">${escapeHtml(tb.name)}</option>`;
            });
            select.innerHTML = html;
        }

        function renderTableContent(tableId) {
            const container = document.getElementById('tableContents');
            const table = getTableById(tableId);
            if (!table) { container.innerHTML = ''; return; }

            const filters = tableFilters[tableId] || {};
            const searchQuery = tableSearches[tableId] || '';
            const sort = tableSorts[tableId] || { field: null, dir: 'asc' };
            const cv = database.meta.columnVisibility[tableId] || {};
            const visibleFields = table.fields.filter(f => {
                if (cv[f.id] === false) return false;
                if (f.type === 'children' && cv[f.id] !== true) return false; // children mus√≠ b√Ωt explicitnƒõ povoleno
                return true;
            });

            // Build filters HTML
            let filtersHtml = `<div class="search-box"><input type="search" class="table-search" data-table="${tableId}" placeholder="${t('searchPlaceholder')}" value="${escapeHtml(searchQuery)}"></div>`;
            table.fields.filter(f => f.filter && f.type !== 'children').forEach(f => {
                const vals = new Set(); let hasEmpty = false;
                table.records.forEach(r => { const v = r.values[f.id]; if (v == null || v === '') hasEmpty = true; else vals.add(String(v)); });
                const sorted = Array.from(vals).sort();
                const cv = filters[f.id] || '';
                filtersHtml += `<div class="filter-item"><label>${escapeHtml(f.name)}</label><select class="table-filter" data-table="${tableId}" data-field="${f.id}"><option value="">${t('allValues')}</option>${hasEmpty ? `<option value="__null__" ${cv === '__null__' ? 'selected' : ''}>${t('noValue')}</option>` : ''}${sorted.map(v => `<option value="${escapeHtml(v)}" ${cv === v ? 'selected' : ''}>${f.type === 'boolean' ? (v === 'true' ? t('yes') : t('no')) : escapeHtml(v)}</option>`).join('')}</select></div>`;
            });
            
            // Collection filter
            if (database.meta.collections?.length > 0) {
                const colFilterVal = collectionFilter || '';
                filtersHtml += `<div class="filter-item"><label>${t('inCollection')}</label><select class="collection-filter" data-table="${tableId}"><option value="">${t('allCollections')}</option>${database.meta.collections.map(col => `<option value="${col.id}" ${colFilterVal === col.id ? 'selected' : ''}>${escapeHtml(col.name)}</option>`).join('')}</select></div>`;
            }
            
            // Tag filter
            if (database.meta.tags?.length > 0) {
                const tagFilterVal = tagFilter || '';
                filtersHtml += `<div class="filter-item"><label>${t('withTag')}</label><select class="tag-filter" data-table="${tableId}"><option value="">${t('allTags')}</option>${database.meta.tags.map(tag => `<option value="${tag.id}" ${tagFilterVal === tag.id ? 'selected' : ''}>${escapeHtml(tag.name)}</option>`).join('')}</select></div>`;
            }

            // Filter records
            let filtered = table.records.filter(r => {
                for (const [fid, fv] of Object.entries(filters)) {
                    if (!fv) continue;
                    const v = r.values[fid];
                    if (fv === '__null__') { if (v != null && v !== '') return false; }
                    else { if (String(v) !== fv) return false; }
                }
                if (searchQuery) {
                    const sq = searchQuery.toLowerCase();
                    if (!table.fields.some(f => { const v = r.values[f.id]; return v != null && String(v).toLowerCase().includes(sq); })) return false;
                }
                // Collection filter
                if (collectionFilter) {
                    const col = database.meta.collections?.find(c => c.id === collectionFilter);
                    if (!col || !col.members?.some(m => m.tableId === tableId && m.recordId === r.id)) return false;
                }
                // Tag filter
                if (tagFilter) {
                    if (!r.tags || !r.tags.includes(tagFilter)) return false;
                }
                return true;
            });

            // Sort
            if (sort.field) {
                const sf = table.fields.find(f => f.id === sort.field);
                filtered.sort((a, b) => {
                    let va, vb;
                    if (sf?.type === 'composite') {
                        va = evaluateCompositeField(table, sf, a);
                        vb = evaluateCompositeField(table, sf, b);
                    } else {
                        va = a.values[sort.field] ?? '';
                        vb = b.values[sort.field] ?? '';
                    }
                    if (sf?.type === 'number') { va = parseFloat(va) || 0; vb = parseFloat(vb) || 0; }
                    else if (sf?.type === 'date') { va = new Date(va).getTime() || 0; vb = new Date(vb).getTime() || 0; }
                    else { va = String(va).toLowerCase(); vb = String(vb).toLowerCase(); }
                    if (va < vb) return sort.dir === 'asc' ? -1 : 1;
                    if (va > vb) return sort.dir === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Column toggles - include Collections and Tags
            const showCollections = cv['__collections__'] !== false;
            const showTags = cv['__tags__'] !== false;
            
            let togglesHtml = table.fields.map(f => {
                const isVisible = f.type === 'children' ? cv[f.id] === true : cv[f.id] !== false;
                return `<div class="checkbox-group"><input type="checkbox" class="col-toggle" data-table="${tableId}" data-field="${f.id}" ${isVisible ? 'checked' : ''}><label>${escapeHtml(f.name)}</label></div>`;
            }).join('');
            togglesHtml += `<div class="checkbox-group"><input type="checkbox" class="col-toggle" data-table="${tableId}" data-field="__collections__" ${showCollections ? 'checked' : ''}><label>${t('collections')}</label></div>`;
            togglesHtml += `<div class="checkbox-group"><input type="checkbox" class="col-toggle" data-table="${tableId}" data-field="__tags__" ${showTags ? 'checked' : ''}><label>${t('tags')}</label></div>`;

            // Table HTML
            let tableHtml = '';
            const groupField = table.fields.find(f => f.group);
            const groupStates = database.meta.groupStates?.[tableId] || {};
            
            // Helper to render Collections and Tags cells
            const renderCollectionsCell = (recordId) => {
                if (!showCollections) return '';
                const cols = getRecordCollections(tableId, recordId);
                if (cols.length === 0) return '<td>-</td>';
                return `<td class="badges-cell">${cols.map(c => `<a href="#" class="collection-badge" style="background:${c.color || '#4a90d9'}" data-action="viewCollection" data-collection="${c.id}">${escapeHtml(c.name)}</a>`).join('')}</td>`;
            };
            const renderTagsCell = (recordId) => {
                if (!showTags) return '';
                const tgs = getRecordTags(tableId, recordId);
                if (tgs.length === 0) return '<td>-</td>';
                return `<td class="badges-cell">${tgs.map(tg => `<a href="#" class="tag-badge" style="background:${tg.color || '#e74c3c'}" data-action="viewTag" data-tag="${tg.id}">${escapeHtml(tg.name)}</a>`).join('')}</td>`;
            };
            
            if (table.fields.length === 0) {
                tableHtml = `<div class="empty-state"><div class="empty-state-icon">üìù</div><p>${t('noFields')}</p></div>`;
            } else if (filtered.length === 0) {
                tableHtml = `<div class="empty-state"><div class="empty-state-icon">üìã</div><p>${t('noRecords')}</p></div>`;
            } else if (groupField) {
                // Grouped view
                const selected = selectedRecords[tableId] || new Set();
                const allSelected = filtered.length > 0 && filtered.every(r => selected.has(r.id));
                let headerCells = `<th class="checkbox-col no-sort"><input type="checkbox" class="bulk-checkbox bulk-select-all" data-table="${tableId}" ${allSelected ? 'checked' : ''} title="${t('selectAll')}"></th>`;
                headerCells += visibleFields.map(f => {
                    const isSorted = sort.field === f.id;
                    const cls = isSorted ? (sort.dir === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                    return `<th class="${cls}" data-table="${tableId}" data-field="${f.id}">${escapeHtml(f.name)}</th>`;
                }).join('');
                if (showCollections) headerCells += `<th class="no-sort">${t('collections')}</th>`;
                if (showTags) headerCells += `<th class="no-sort">${t('tags')}</th>`;
                headerCells += `<th class="no-sort">${t('actions')}</th>`;

                // Group records by groupField value
                const groups = new Map();
                filtered.forEach(r => {
                    let groupKey = r.values[groupField.id] ?? '';
                    let groupDisplay = groupKey;
                    
                    if (groupField.type === 'parent' && groupKey) {
                        const tt = getTableById(groupField.targetTableId);
                        const pr = tt ? getRecordById(groupField.targetTableId, groupKey) : null;
                        groupDisplay = pr && tt ? getPrimaryFieldValue(tt, pr) : groupKey;
                    } else if (groupField.type === 'boolean') {
                        groupDisplay = groupKey ? t('yes') : t('no');
                        groupKey = String(groupKey);
                    } else if (groupKey === '' || groupKey === null || groupKey === undefined) {
                        groupKey = '__empty__';
                        groupDisplay = t('noValue');
                    }
                    
                    if (!groups.has(groupKey)) groups.set(groupKey, { display: groupDisplay, records: [] });
                    groups.get(groupKey).records.push(r);
                });

                // Sort groups by display name
                const sortedGroups = Array.from(groups.entries()).sort((a, b) => {
                    if (a[0] === '__empty__') return 1;
                    if (b[0] === '__empty__') return -1;
                    return String(a[1].display).localeCompare(String(b[1].display), currentLang);
                });

                let groupedHtml = '';
                const colCount = visibleFields.length + (showCollections ? 1 : 0) + (showTags ? 1 : 0) + 2; // +2 for checkbox and actions
                
                sortedGroups.forEach(([groupKey, group]) => {
                    const isCollapsed = groupStates[groupKey] === true;
                    const groupId = `group_${tableId}_${groupKey.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    
                    groupedHtml += `<tbody class="record-group">`;
                    groupedHtml += `<tr class="group-header">
                        <th colspan="${colCount}" scope="colgroup">
                            <button type="button" class="group-toggle" data-table="${tableId}" data-group="${escapeHtml(groupKey)}" aria-expanded="${!isCollapsed}" aria-controls="${groupId}">
                                <span class="group-icon" aria-hidden="true">${isCollapsed ? '‚ñ∂' : '‚ñº'}</span>
                                ${escapeHtml(group.display)} (${group.records.length})
                            </button>
                        </th>
                    </tr>`;
                    
                    if (!isCollapsed) {
                        group.records.forEach(r => {
                            const isSelected = selected.has(r.id);
                            const cells = visibleFields.map(f => `<td>${formatFieldValue(table, f, r.values[f.id], r)}</td>`).join('');
                            groupedHtml += `<tr id="${groupId}"><td class="checkbox-col"><input type="checkbox" class="bulk-checkbox bulk-select-row" data-table="${tableId}" data-record="${r.id}" ${isSelected ? 'checked' : ''}></td>${cells}${renderCollectionsCell(r.id)}${renderTagsCell(r.id)}<td class="actions-cell"><button type="button" class="btn btn-sm btn-secondary btn-icon view-record-btn" data-table="${tableId}" data-record="${r.id}" title="${t('view')}">üëÅÔ∏è</button><button type="button" class="btn btn-sm btn-secondary btn-icon edit-record-btn" data-table="${tableId}" data-record="${r.id}" title="${t('edit')}">‚úèÔ∏è</button><button type="button" class="btn btn-sm btn-danger btn-icon delete-record-btn" data-table="${tableId}" data-record="${r.id}" title="${t('delete')}">üóëÔ∏è</button></td></tr>`;
                        });
                    }
                    groupedHtml += `</tbody>`;
                });

                tableHtml = `<div class="table-wrapper"><table><thead><tr>${headerCells}</tr></thead>${groupedHtml}</table></div>`;
            } else {
                // Normal view without grouping
                const selected = selectedRecords[tableId] || new Set();
                const allSelected = filtered.length > 0 && filtered.every(r => selected.has(r.id));
                let headerCells = `<th class="checkbox-col no-sort"><input type="checkbox" class="bulk-checkbox bulk-select-all" data-table="${tableId}" ${allSelected ? 'checked' : ''} title="${t('selectAll')}"></th>`;
                headerCells += visibleFields.map(f => {
                    const isSorted = sort.field === f.id;
                    const cls = isSorted ? (sort.dir === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                    return `<th class="${cls}" data-table="${tableId}" data-field="${f.id}">${escapeHtml(f.name)}</th>`;
                }).join('');
                if (showCollections) headerCells += `<th class="no-sort">${t('collections')}</th>`;
                if (showTags) headerCells += `<th class="no-sort">${t('tags')}</th>`;
                headerCells += `<th class="no-sort">${t('actions')}</th>`;

                const bodyRows = filtered.map(r => {
                    const isSelected = selected.has(r.id);
                    const cells = visibleFields.map(f => `<td>${formatFieldValue(table, f, r.values[f.id], r)}</td>`).join('');
                    return `<tr><td class="checkbox-col"><input type="checkbox" class="bulk-checkbox bulk-select-row" data-table="${tableId}" data-record="${r.id}" ${isSelected ? 'checked' : ''}></td>${cells}${renderCollectionsCell(r.id)}${renderTagsCell(r.id)}<td class="actions-cell"><button type="button" class="btn btn-sm btn-secondary btn-icon view-record-btn" data-table="${tableId}" data-record="${r.id}" title="${t('view')}">üëÅÔ∏è</button><button type="button" class="btn btn-sm btn-secondary btn-icon edit-record-btn" data-table="${tableId}" data-record="${r.id}" title="${t('edit')}">‚úèÔ∏è</button><button type="button" class="btn btn-sm btn-danger btn-icon delete-record-btn" data-table="${tableId}" data-record="${r.id}" title="${t('delete')}">üóëÔ∏è</button></td></tr>`;
                }).join('');

                tableHtml = `<div class="table-wrapper"><table><thead><tr>${headerCells}</tr></thead><tbody>${bodyRows}</tbody></table></div>`;
            }

            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2>${escapeHtml(table.name)}</h2>
                        <div class="inline-actions">
                            <button type="button" class="btn btn-sm btn-secondary export-table-btn" data-table="${tableId}"><span aria-hidden="true">üì§</span> ${t('export')}</button>
                            <button type="button" class="btn btn-sm btn-secondary import-table-btn" data-table="${tableId}"><span aria-hidden="true">üì•</span> ${t('import')}</button>
                            <button type="button" class="btn btn-success add-record-btn" data-table="${tableId}"><span aria-hidden="true">‚ûï</span> ${t('addRecord')}</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="filters-section">${filtersHtml}</div>
                        ${renderBulkActionsBar(tableId)}
                        <div class="record-count">${t('recordsShowing', { filtered: filtered.length, total: table.records.length })}</div>
                        ${tableHtml}
                        <details><summary>${t('columnVisibility')}</summary><div class="column-toggles">${togglesHtml}</div></details>
                    </div>
                </div>
            `;

            // Store filtered records for generator
            table._filteredRecords = filtered;
        }

        function formatFieldValue(table, field, value, record) {
            // For composite and children, value is computed, not stored
            if (field.type !== 'composite' && field.type !== 'children' && (value == null || value === '')) {
                return '<span class="view-field-value empty">-</span>';
            }
            switch (field.type) {
                case 'boolean': return value ? t('yes') : t('no');
                case 'date': try { return new Date(value).toLocaleDateString(currentLang); } catch { return escapeHtml(value); }
                case 'textarea': return `<span title="${escapeHtml(value)}">${escapeHtml(value.length > 50 ? value.substr(0, 50) + '...' : value)}</span>`;
                case 'url': 
                    const urlText = value.length > 40 ? value.substr(0, 40) + '...' : value;
                    return `<a href="${escapeHtml(value)}" target="_blank" rel="noopener noreferrer" class="url-link">${escapeHtml(urlText)}</a>`;
                case 'parent':
                    const tt = getTableById(field.targetTableId);
                    const pr = tt ? getRecordById(field.targetTableId, value) : null;
                    if (pr && tt) return `<a href="#" class="record-link" data-action="view" data-table="${field.targetTableId}" data-record="${value}">${escapeHtml(getPrimaryFieldValue(tt, pr))}</a>`;
                    return `<span class="view-field-value empty">${t('noParent')}</span>`;
                case 'children':
                    const ch = getChildRecords(table.id, record.id).filter(c => {
                        if (field.targetTableId && c.table.id !== field.targetTableId) return false;
                        if (field.parentFieldId && c.field.id !== field.parentFieldId) return false;
                        return true;
                    });
                    if (ch.length === 0) return `<span class="view-field-value empty">${t('noChildren')}</span>`;
                    return ch.map(c => `<a href="#" class="record-link" data-action="view" data-table="${c.table.id}" data-record="${c.record.id}">${escapeHtml(getPrimaryFieldValue(c.table, c.record))}</a>`).join(', ');
                case 'composite':
                    const compVal = evaluateCompositeField(table, field, record);
                    if (field.primary) return `<a href="#" class="record-link" data-action="view" data-table="${table.id}" data-record="${record.id}">${escapeHtml(compVal)}</a>`;
                    return escapeHtml(compVal);
                default:
                    if (field.primary) return `<a href="#" class="record-link" data-action="view" data-table="${table.id}" data-record="${record.id}">${escapeHtml(String(value))}</a>`;
                    return escapeHtml(String(value));
            }
        }

        function evaluateCompositeField(table, field, record) {
            if (!field.compositeTemplate) return '';
            let result = field.compositeTemplate;
            table.fields.forEach(f => {
                if (f.id === field.id) return; // skip self
                let val = record.values[f.id] ?? '';
                if (f.type === 'boolean') val = val ? t('yes') : t('no');
                else if (f.type === 'date' && val) try { val = new Date(val).toLocaleDateString(currentLang); } catch {}
                else if (f.type === 'parent' && val) {
                    const tt = getTableById(f.targetTableId);
                    const pr = tt ? getRecordById(f.targetTableId, val) : null;
                    val = pr && tt ? getPrimaryFieldValue(tt, pr) : val;
                }
                result = result.replace(new RegExp(`\\{${f.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\}`, 'g'), val);
            });
            return result;
        }

        function renderManagement() {
            document.getElementById('management-content').classList.add('active');
            document.getElementById('tableContents').innerHTML = '';
            renderTablesList();
            renderStats();
            renderGeneratorTable();
            renderCollectionsList();
            renderTagsList();
            document.getElementById('dbNameInput').value = database.meta.name;
        }

        function renderCollectionsList() {
            if (!database.meta.collections) database.meta.collections = [];
            const container = document.getElementById('collectionsList');
            const empty = document.getElementById('emptyCollections');
            if (database.meta.collections.length === 0) { container.innerHTML = ''; empty.hidden = false; return; }
            empty.hidden = true;
            container.innerHTML = database.meta.collections.map(col => {
                const count = col.members?.length || 0;
                const descPreview = col.description ? escapeHtml(col.description.substring(0, 100)) + (col.description.length > 100 ? '...' : '') : '';
                return `
                <div class="collection-card" data-collection="${col.id}">
                    <div class="collection-card-header">
                        <div class="collection-card-color" style="background: ${col.color || '#4a90d9'}"></div>
                        <div class="collection-card-name">${escapeHtml(col.name)}</div>
                        <div class="collection-card-count">${count} ${t('collectionMembers')}</div>
                    </div>
                    ${descPreview ? `<div class="collection-card-desc">${descPreview}</div>` : ''}
                </div>`;
            }).join('');
        }

        function renderTagsList() {
            if (!database.meta.tags) database.meta.tags = [];
            const container = document.getElementById('tagsList');
            const empty = document.getElementById('emptyTags');
            if (database.meta.tags.length === 0) { container.innerHTML = ''; empty.hidden = false; return; }
            empty.hidden = true;
            container.innerHTML = database.meta.tags.map(tag => {
                // Count records with this tag
                let count = 0;
                database.tables.forEach(tb => {
                    tb.records.forEach(r => {
                        if (r.tags && r.tags.includes(tag.id)) count++;
                    });
                });
                return `
                <div class="tag-card" data-tag="${tag.id}">
                    <div class="tag-card-header">
                        <div class="collection-card-color" style="background: ${tag.color || '#e74c3c'}"></div>
                        <div class="tag-card-name">${escapeHtml(tag.name)}</div>
                        <div class="tag-card-count">${count} ${t('collectionMembers')}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderTablesList() {
            const container = document.getElementById('tablesList');
            const empty = document.getElementById('emptyTables');
            if (database.tables.length === 0) { container.innerHTML = ''; empty.hidden = false; document.getElementById('fieldsCard').hidden = true; return; }
            empty.hidden = true;
            container.innerHTML = database.tables.map((tb, i) => `
                <div class="field-item">
                    <div class="move-buttons">
                        <button type="button" class="btn btn-sm btn-secondary btn-icon move-table-btn" data-table="${tb.id}" data-dir="-1" ${i === 0 ? 'disabled' : ''}>‚ñ≤</button>
                        <button type="button" class="btn btn-sm btn-secondary btn-icon move-table-btn" data-table="${tb.id}" data-dir="1" ${i === database.tables.length - 1 ? 'disabled' : ''}>‚ñº</button>
                    </div>
                    <div class="field-item-info">
                        <div class="field-item-name">${escapeHtml(tb.name)}</div>
                        <div class="field-item-meta">${tb.fields.length} pol√≠, ${tb.records.length} z√°znam≈Ø</div>
                    </div>
                    <div class="field-item-actions">
                        <button type="button" class="btn btn-sm btn-secondary show-fields-btn" data-table="${tb.id}">üìã Pole</button>
                        <button type="button" class="btn btn-sm btn-secondary edit-table-btn" data-table="${tb.id}">‚úèÔ∏è</button>
                        <button type="button" class="btn btn-sm btn-danger delete-table-btn" data-table="${tb.id}">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function showFieldsForTable(tableId) {
            editingFieldTableId = tableId;
            const table = getTableById(tableId);
            if (!table) return;
            document.getElementById('fieldsCard').hidden = false;
            document.getElementById('fieldsTableName').textContent = table.name;
            renderFieldList();
        }

        function renderFieldList() {
            const table = getTableById(editingFieldTableId);
            const container = document.getElementById('fieldList');
            const empty = document.getElementById('emptyFields');
            if (!table || table.fields.length === 0) { container.innerHTML = ''; empty.hidden = false; return; }
            empty.hidden = true;
            const typeNames = { text: t('typeText'), textarea: t('typeTextarea'), number: t('typeNumber'), date: t('typeDate'), url: t('typeUrl'), boolean: t('typeBoolean'), select: t('typeSelect'), composite: t('typeComposite'), parent: t('typeParent'), children: t('typeChildren') };
            container.innerHTML = table.fields.map((f, i) => {
                const badges = [];
                if (f.primary) badges.push('<span class="badge badge-primary">Prim√°rn√≠</span>');
                if (f.filter) badges.push('<span class="badge badge-filter">Filtr</span>');
                let targetInfo = '';
                if ((f.type === 'parent' || f.type === 'children') && f.targetTableId) {
                    const tt = getTableById(f.targetTableId);
                    targetInfo = ` ‚Üí ${tt?.name || '?'}`;
                }
                return `
                    <div class="field-item">
                        <div class="move-buttons">
                            <button type="button" class="btn btn-sm btn-secondary btn-icon move-field-btn" data-field="${f.id}" data-dir="-1" ${i === 0 ? 'disabled' : ''}>‚ñ≤</button>
                            <button type="button" class="btn btn-sm btn-secondary btn-icon move-field-btn" data-field="${f.id}" data-dir="1" ${i === table.fields.length - 1 ? 'disabled' : ''}>‚ñº</button>
                        </div>
                        <div class="field-item-info">
                            <div class="field-item-name">${escapeHtml(f.name)}</div>
                            <div class="field-item-meta">${typeNames[f.type] || f.type}${targetInfo} ${f.type === 'select' ? `(${escapeHtml(f.options || '')})` : ''} ${badges.join(' ')}</div>
                        </div>
                        <div class="field-item-actions">
                            <button type="button" class="btn btn-sm btn-secondary edit-field-btn" data-field="${f.id}">‚úèÔ∏è</button>
                            <button type="button" class="btn btn-sm btn-danger delete-field-btn" data-field="${f.id}">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderStats() {
            const totalRecords = database.tables.reduce((sum, tb) => sum + tb.records.length, 0);
            let html = `<div class="stat-card"><div class="stat-value">${database.tables.length}</div><div class="stat-label">${t('totalTables')}</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${totalRecords}</div><div class="stat-label">${t('totalRecords')}</div></div>`;
            database.tables.forEach(tb => {
                html += `<div class="stat-card"><div class="stat-value">${tb.records.length}</div><div class="stat-label">${t('recordsInTable', { name: tb.name })}</div></div>`;
            });
            document.getElementById('statsGrid').innerHTML = html;
        }

        function renderGeneratorTable() {
            const sel = document.getElementById('generatorTable');
            sel.innerHTML = database.tables.map(tb => `<option value="${tb.id}">${escapeHtml(tb.name)}</option>`).join('');
            updateGeneratorFields();
        }

        function updateGeneratorFields() {
            const tableId = document.getElementById('generatorTable').value;
            const table = getTableById(tableId);
            const container = document.getElementById('generatorFieldButtons');
            if (!table) { container.innerHTML = ''; return; }
            container.innerHTML = table.fields.filter(f => f.type !== 'children').map(f => `<button type="button" class="field-btn" data-field="{${f.name}}">{${escapeHtml(f.name)}}</button>`).join('');
        }

        function generateText() {
            const tableId = document.getElementById('generatorTable').value;
            const table = getTableById(tableId);
            const template = document.getElementById('generatorTemplate').value;
            const useFiltered = document.querySelector('input[name="genRecords"]:checked').value === 'filtered';
            if (!table || !template) return;

            const records = useFiltered && table._filteredRecords ? table._filteredRecords : table.records;
            const output = records.map(r => {
                let line = template;
                table.fields.forEach(f => {
                    let val = r.values[f.id] ?? '';
                    if (f.type === 'boolean') val = val ? t('yes') : t('no');
                    else if (f.type === 'date' && val) try { val = new Date(val).toLocaleDateString(currentLang); } catch {}
                    else if (f.type === 'parent' && val) {
                        const tt = getTableById(f.targetTableId);
                        const pr = tt ? getRecordById(f.targetTableId, val) : null;
                        val = pr && tt ? getPrimaryFieldValue(tt, pr) : val;
                    }
                    line = line.replace(new RegExp(`\\{${f.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\}`, 'g'), val);
                });
                return line;
            }).join('\n');

            document.getElementById('generatorOutput').textContent = output;
            document.getElementById('generatorOutput').hidden = false;
            document.getElementById('btnCopyGenerated').hidden = false;
        }

        function switchTab(tabId) {
            activeTab = tabId;
            document.querySelectorAll('.table-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.table-tab[data-table-id="${tabId}"]`)?.classList.add('active');
            document.getElementById('management-content').classList.remove('active');
            document.getElementById('classification-content').classList.remove('active');
            document.getElementById('tableContents').innerHTML = '';
            
            if (tabId === 'management') {
                renderManagement();
            } else if (tabId === 'classification') {
                renderClassification();
            } else {
                activeTableId = tabId;
                renderTableContent(tabId);
            }
        }
        
        function renderClassification() {
            document.getElementById('classification-content').classList.add('active');
            renderCollectionsList();
            renderTagsList();
        }

        // Table Modal
        function openTableModal(tableId = null) {
            document.getElementById('tableName').value = '';
            document.getElementById('tableId').value = '';
            if (tableId) {
                const tb = getTableById(tableId);
                if (tb) { document.getElementById('tableModalTitle').textContent = t('editTable'); document.getElementById('tableId').value = tb.id; document.getElementById('tableName').value = tb.name; }
            } else { document.getElementById('tableModalTitle').textContent = t('addTable'); }
            openModal('tableModal');
        }

        function saveTable() {
            const id = document.getElementById('tableId').value;
            const name = document.getElementById('tableName').value.trim();
            if (!name) return;
            if (id) { const tb = getTableById(id); if (tb) tb.name = name; }
            else { database.tables.push({ id: generateId(), name, fields: [], records: [] }); }
            closeModal('tableModal');
            renderAll();
        }

        // Collection Modal
        function openCollectionModal(collectionId = null) {
            if (!database.meta.collections) database.meta.collections = [];
            document.getElementById('collectionName').value = '';
            document.getElementById('collectionColor').value = '#4a90d9';
            document.getElementById('collectionDescription').value = '';
            document.getElementById('collectionId').value = '';
            if (collectionId) {
                const col = database.meta.collections.find(c => c.id === collectionId);
                if (col) {
                    document.getElementById('collectionModalTitle').textContent = t('editCollection');
                    document.getElementById('collectionId').value = col.id;
                    document.getElementById('collectionName').value = col.name;
                    document.getElementById('collectionColor').value = col.color || '#4a90d9';
                    document.getElementById('collectionDescription').value = col.description || '';
                }
            } else {
                document.getElementById('collectionModalTitle').textContent = t('addCollection');
            }
            openModal('collectionModal');
        }

        function saveCollection() {
            if (!database.meta.collections) database.meta.collections = [];
            const id = document.getElementById('collectionId').value;
            const name = document.getElementById('collectionName').value.trim();
            const color = document.getElementById('collectionColor').value;
            const description = document.getElementById('collectionDescription').value;
            if (!name) return;
            if (id) {
                const col = database.meta.collections.find(c => c.id === id);
                if (col) { col.name = name; col.color = color; col.description = description; }
            } else {
                database.meta.collections.push({ id: generateId(), name, color, description, members: [] });
            }
            closeModal('collectionModal');
            renderCollectionsList();
        }

        function deleteCollection(collectionId) {
            confirmAction(t('confirmDeleteCollection'), () => {
                database.meta.collections = database.meta.collections.filter(c => c.id !== collectionId);
                closeModal('viewCollectionModal');
                renderCollectionsList();
            });
        }

        let currentViewCollectionId = null;
        
        function viewCollectionDetails(collectionId) {
            const col = database.meta.collections?.find(c => c.id === collectionId);
            if (!col) return;
            currentViewCollectionId = collectionId;
            
            document.getElementById('viewCollectionModalTitle').innerHTML = `üìÅ <span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:${col.color || '#4a90d9'};vertical-align:middle;margin-right:8px;"></span>${escapeHtml(col.name)}`;
            
            let html = '';
            
            // Description
            if (col.description) {
                html += `<div class="collection-detail-desc"><div class="markdown-content">${parseMarkdown(col.description)}</div></div>`;
            }
            
            // Members grouped by table
            html += `<h3>${t('recordsInCollection')} (${col.members?.length || 0})</h3>`;
            if (!col.members || col.members.length === 0) {
                html += `<p style="color: var(--text-muted); font-style: italic;">${t('noRecordsInCollection')}</p>`;
            } else {
                // Group by table
                const byTable = {};
                col.members.forEach(m => {
                    if (!byTable[m.tableId]) byTable[m.tableId] = [];
                    byTable[m.tableId].push(m.recordId);
                });
                
                Object.entries(byTable).forEach(([tableId, recordIds]) => {
                    const table = getTableById(tableId);
                    if (!table) return;
                    
                    html += `<h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">${escapeHtml(table.name)}</h4>`;
                    html += '<ul class="collection-members-list">';
                    recordIds.forEach(recordId => {
                        const record = getRecordById(tableId, recordId);
                        if (!record) return;
                        html += `<li>
                            <span><a href="#" class="record-link" data-action="viewFromCollection" data-table="${tableId}" data-record="${recordId}">${escapeHtml(getPrimaryFieldValue(table, record))}</a></span>
                            <button type="button" class="btn btn-sm btn-danger remove-from-collection-btn" data-collection="${collectionId}" data-table="${tableId}" data-record="${recordId}" title="${t('removeFromCollection')}">‚úï</button>
                        </li>`;
                    });
                    html += '</ul>';
                });
            }
            
            document.getElementById('viewCollectionContent').innerHTML = html;
            openModal('viewCollectionModal');
        }

        let currentViewTagId = null;
        
        function viewTagDetails(tagId) {
            const tag = database.meta.tags?.find(t => t.id === tagId);
            if (!tag) return;
            currentViewTagId = tagId;
            
            document.getElementById('viewTagModalTitle').innerHTML = `üè∑Ô∏è <span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:${tag.color || '#e74c3c'};vertical-align:middle;margin-right:8px;"></span>${escapeHtml(tag.name)}`;
            
            // Find all records with this tag, grouped by table
            const byTable = {};
            let totalCount = 0;
            database.tables.forEach(tb => {
                tb.records.forEach(r => {
                    if (r.tags && r.tags.includes(tagId)) {
                        if (!byTable[tb.id]) byTable[tb.id] = { table: tb, records: [] };
                        byTable[tb.id].records.push(r);
                        totalCount++;
                    }
                });
            });
            
            let html = `<h3>${t('recordsWithTag')} (${totalCount})</h3>`;
            if (totalCount === 0) {
                html += `<p style="color: var(--text-muted); font-style: italic;">${t('noRecords')}</p>`;
            } else {
                Object.values(byTable).forEach(({ table, records }) => {
                    html += `<h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">${escapeHtml(table.name)}</h4>`;
                    html += '<ul class="collection-members-list">';
                    records.forEach(record => {
                        html += `<li>
                            <span><a href="#" class="record-link" data-action="viewFromTag" data-table="${table.id}" data-record="${record.id}">${escapeHtml(getPrimaryFieldValue(table, record))}</a></span>
                            <button type="button" class="btn btn-sm btn-danger remove-tag-btn" data-tag="${tagId}" data-table="${table.id}" data-record="${record.id}" title="${t('removeThisTag')}">‚úï</button>
                        </li>`;
                    });
                    html += '</ul>';
                });
            }
            
            document.getElementById('viewTagContent').innerHTML = html;
            openModal('viewTagModal');
        }

        // Tag Modal
        function openTagModal(tagId = null) {
            if (!database.meta.tags) database.meta.tags = [];
            document.getElementById('tagName').value = '';
            document.getElementById('tagColor').value = '#e74c3c';
            document.getElementById('tagId').value = '';
            if (tagId) {
                const tag = database.meta.tags.find(t => t.id === tagId);
                if (tag) {
                    document.getElementById('tagModalTitle').textContent = t('editTable');
                    document.getElementById('tagId').value = tag.id;
                    document.getElementById('tagName').value = tag.name;
                    document.getElementById('tagColor').value = tag.color || '#e74c3c';
                }
            } else {
                document.getElementById('tagModalTitle').textContent = t('addTag');
            }
            openModal('tagModal');
        }

        function saveTag() {
            if (!database.meta.tags) database.meta.tags = [];
            const id = document.getElementById('tagId').value;
            const name = document.getElementById('tagName').value.trim();
            const color = document.getElementById('tagColor').value;
            if (!name) return;
            if (id) {
                const tag = database.meta.tags.find(t => t.id === id);
                if (tag) { tag.name = name; tag.color = color; }
            } else {
                database.meta.tags.push({ id: generateId(), name, color });
            }
            closeModal('tagModal');
            renderTagsList();
        }

        function deleteTag(tagId) {
            confirmAction(t('confirmDeleteTag'), () => {
                database.meta.tags = database.meta.tags.filter(t => t.id !== tagId);
                // Remove tag from all records
                database.tables.forEach(tb => {
                    tb.records.forEach(r => {
                        if (r.tags) r.tags = r.tags.filter(t => t !== tagId);
                    });
                });
                renderTagsList();
            });
        }

        // Add to collection modal
        let addToCollectionContext = { tableId: null, recordId: null };
        
        function openAddToCollectionModal(tableId, recordId) {
            addToCollectionContext = { tableId, recordId };
            document.getElementById('addToCollectionTableId').value = tableId;
            document.getElementById('addToCollectionRecordId').value = recordId;
            
            const select = document.getElementById('addToCollectionSelect');
            const existingCollections = getRecordCollections(tableId, recordId);
            const existingIds = existingCollections.map(c => c.id);
            
            // Filter out collections the record is already in
            const availableCollections = (database.meta.collections || []).filter(c => !existingIds.includes(c.id));
            
            if (availableCollections.length === 0) {
                select.innerHTML = `<option value="">${t('noCollections')}</option>`;
            } else {
                select.innerHTML = `<option value="">-- ${t('selectCollection')} --</option>` + 
                    availableCollections.map(col => `<option value="${col.id}">${escapeHtml(col.name)}</option>`).join('');
            }
            
            openModal('addToCollectionModal');
        }
        
        function confirmAddToCollection() {
            const collectionId = document.getElementById('addToCollectionSelect').value;
            if (!collectionId) return;
            
            const { tableId, recordId } = addToCollectionContext;
            toggleCollectionMembership(collectionId, tableId, recordId, true);
            closeModal('addToCollectionModal');
            
            // Refresh view if open
            if (currentRecordId === recordId && currentRecordTableId === tableId) {
                viewRecord(tableId, recordId);
            }
        }

        // Add tag to record modal
        let addTagContext = { tableId: null, recordId: null };
        
        function openAddTagModal(tableId, recordId) {
            addTagContext = { tableId, recordId };
            document.getElementById('addTagTableId').value = tableId;
            document.getElementById('addTagRecordId').value = recordId;
            
            const select = document.getElementById('addTagSelect');
            const existingTags = getRecordTags(tableId, recordId);
            const existingIds = existingTags.map(t => t.id);
            
            // Filter out tags the record already has
            const availableTags = (database.meta.tags || []).filter(t => !existingIds.includes(t.id));
            
            if (availableTags.length === 0) {
                select.innerHTML = `<option value="">${t('noTags')}</option>`;
            } else {
                select.innerHTML = `<option value="">-- ${t('selectTag')} --</option>` + 
                    availableTags.map(tag => `<option value="${tag.id}">${escapeHtml(tag.name)}</option>`).join('');
            }
            
            openModal('addTagToRecordModal');
        }
        
        function confirmAddTag() {
            const tagId = document.getElementById('addTagSelect').value;
            if (!tagId) return;
            
            const { tableId, recordId } = addTagContext;
            toggleTagAssignment(tagId, tableId, recordId, true);
            closeModal('addTagToRecordModal');
            
            // Refresh view if open
            if (currentRecordId === recordId && currentRecordTableId === tableId) {
                viewRecord(tableId, recordId);
            }
        }

        function toggleCollectionMembership(collectionId, tableId, recordId, add) {
            const col = database.meta.collections.find(c => c.id === collectionId);
            if (!col) return;
            if (!col.members) col.members = [];
            
            if (add) {
                if (!col.members.some(m => m.tableId === tableId && m.recordId === recordId)) {
                    col.members.push({ tableId, recordId });
                }
            } else {
                col.members = col.members.filter(m => !(m.tableId === tableId && m.recordId === recordId));
            }
        }

        function toggleTagAssignment(tagId, tableId, recordId, add) {
            const record = getRecordById(tableId, recordId);
            if (!record) return;
            if (!record.tags) record.tags = [];
            
            if (add) {
                if (!record.tags.includes(tagId)) {
                    record.tags.push(tagId);
                }
            } else {
                record.tags = record.tags.filter(t => t !== tagId);
            }
        }

        // Get collections for a record
        function getRecordCollections(tableId, recordId) {
            if (!database.meta.collections) return [];
            return database.meta.collections.filter(col => 
                col.members?.some(m => m.tableId === tableId && m.recordId === recordId)
            );
        }

        // Get tags for a record
        function getRecordTags(tableId, recordId) {
            if (!database.meta.tags) return [];
            const record = getRecordById(tableId, recordId);
            if (!record || !record.tags) return [];
            return database.meta.tags.filter(tag => record.tags.includes(tag.id));
        }

        // Structure view functions
        let structureRootTableId = null;
        let structureRootRecordId = null;
        let structureExpandedNodes = new Set();
        let structureLoadedAll = new Set();
        const STRUCTURE_MAX_DEPTH = 4;
        const STRUCTURE_MAX_ITEMS = 10;
        
        function getDirectChildren(tableId, recordId) {
            // Find all records that have this record as parent
            const children = [];
            database.tables.forEach(tb => {
                tb.fields.filter(f => f.type === 'parent').forEach(parentField => {
                    tb.records.forEach(r => {
                        if (r.values[parentField.id] === recordId) {
                            children.push({ table: tb, record: r, parentField });
                        }
                    });
                });
            });
            return children;
        }
        
        function countAllDescendants(tableId, recordId, visited = new Set()) {
            const key = `${tableId}_${recordId}`;
            if (visited.has(key)) return 0; // Prevent cycles
            visited.add(key);
            
            const children = getDirectChildren(tableId, recordId);
            let count = children.length;
            children.forEach(child => {
                count += countAllDescendants(child.table.id, child.record.id, visited);
            });
            return count;
        }
        
        function openStructureModal(tableId, recordId) {
            structureRootTableId = tableId;
            structureRootRecordId = recordId;
            structureExpandedNodes = new Set();
            structureLoadedAll = new Set();
            
            const table = getTableById(tableId);
            const record = getRecordById(tableId, recordId);
            if (!table || !record) return;
            
            const name = getPrimaryFieldValue(table, record);
            document.getElementById('structureModalTitle').innerHTML = `üå≥ ${t('structure')}: ${escapeHtml(name)}`;
            
            renderStructureTree();
            renderStructureGraph();
            openModal('structureModal');
        }
        
        function renderStructureTree() {
            const container = document.getElementById('structureTreeContainer');
            const table = getTableById(structureRootTableId);
            const record = getRecordById(structureRootTableId, structureRootRecordId);
            
            if (!table || !record) {
                container.innerHTML = `<p class="tree-empty">${t('noDescendants')}</p>`;
                return;
            }
            
            const children = getDirectChildren(structureRootTableId, structureRootRecordId);
            if (children.length === 0) {
                container.innerHTML = `<p class="tree-empty">${t('noDescendants')}</p>`;
                return;
            }
            
            const rootKey = `${structureRootTableId}_${structureRootRecordId}`;
            structureExpandedNodes.add(rootKey); // Root is always expanded
            
            let html = '<ul class="tree-root">';
            html += renderTreeNode(structureRootTableId, structureRootRecordId, 0, true);
            html += '</ul>';
            
            container.innerHTML = html;
        }
        
        function renderTreeNode(tableId, recordId, depth, isRoot = false) {
            const table = getTableById(tableId);
            const record = getRecordById(tableId, recordId);
            if (!table || !record) return '';
            
            const key = `${tableId}_${recordId}`;
            const children = getDirectChildren(tableId, recordId);
            const totalDescendants = countAllDescendants(tableId, recordId);
            const hasChildren = children.length > 0;
            const isExpanded = structureExpandedNodes.has(key);
            const showAll = structureLoadedAll.has(key);
            const name = getPrimaryFieldValue(table, record);
            
            let html = '';
            
            if (!isRoot) {
                html += '<li class="tree-item">';
                html += `<button type="button" class="tree-toggle ${hasChildren ? '' : 'empty'}" data-key="${key}" data-table="${tableId}" data-record="${recordId}">${hasChildren ? (isExpanded ? '‚ñº' : '‚ñ∂') : ''}</button>`;
                html += `<a href="#" class="tree-link" data-action="viewFromStructure" data-table="${tableId}" data-record="${recordId}">${escapeHtml(name)}</a>`;
                html += `<span class="tree-table">(${escapeHtml(table.name)})</span>`;
                if (totalDescendants > 0) {
                    html += `<span class="tree-count">[${totalDescendants} ${t('descendants')}]</span>`;
                }
            }
            
            if (hasChildren && (isExpanded || isRoot)) {
                const maxDepthReached = depth >= STRUCTURE_MAX_DEPTH && !showAll;
                const itemsToShow = showAll ? children.length : Math.min(children.length, STRUCTURE_MAX_ITEMS);
                
                html += `<ul class="tree-children ${isExpanded || isRoot ? '' : 'collapsed'}">`;
                
                for (let i = 0; i < itemsToShow; i++) {
                    const child = children[i];
                    if (maxDepthReached) {
                        // Just show item without children
                        const childName = getPrimaryFieldValue(child.table, child.record);
                        const childDescendants = countAllDescendants(child.table.id, child.record.id);
                        html += '<li class="tree-item">';
                        html += `<button type="button" class="tree-toggle empty"></button>`;
                        html += `<a href="#" class="tree-link" data-action="viewFromStructure" data-table="${child.table.id}" data-record="${child.record.id}">${escapeHtml(childName)}</a>`;
                        html += `<span class="tree-table">(${escapeHtml(child.table.name)})</span>`;
                        if (childDescendants > 0) {
                            html += `<span class="tree-count">[${childDescendants} ${t('descendants')}]</span>`;
                        }
                        html += '</li>';
                    } else {
                        html += renderTreeNode(child.table.id, child.record.id, depth + 1);
                    }
                }
                
                if (children.length > STRUCTURE_MAX_ITEMS && !showAll) {
                    html += `<li class="tree-item"><span class="tree-load-more" data-key="${key}" data-action="loadAll">... ${t('loadAll')} (${children.length - STRUCTURE_MAX_ITEMS} ${t('loadMore').replace('...', '')})</span></li>`;
                }
                
                html += '</ul>';
            }
            
            if (!isRoot) {
                html += '</li>';
            }
            
            return html;
        }
        
        function toggleTreeNode(key, tableId, recordId) {
            if (structureExpandedNodes.has(key)) {
                structureExpandedNodes.delete(key);
            } else {
                structureExpandedNodes.add(key);
            }
            renderStructureTree();
        }
        
        function loadAllTreeItems(key) {
            structureLoadedAll.add(key);
            renderStructureTree();
        }
        
        function renderStructureGraph() {
            const container = document.getElementById('structureGraphContainer');
            const table = getTableById(structureRootTableId);
            const record = getRecordById(structureRootTableId, structureRootRecordId);
            
            if (!table || !record) {
                container.innerHTML = `<p class="tree-empty">${t('noDescendants')}</p>`;
                return;
            }
            
            // Build tree data structure
            const treeData = buildTreeData(structureRootTableId, structureRootRecordId, 0, new Set());
            
            if (!treeData.children || treeData.children.length === 0) {
                container.innerHTML = `<p class="tree-empty">${t('noDescendants')}</p>`;
                return;
            }
            
            // Calculate tree layout
            const nodeWidth = 150;
            const nodeHeight = 30;
            const levelGap = 180;
            const nodeGap = 10;
            
            // Assign positions
            const positions = [];
            let maxY = 0;
            
            function assignPositions(node, x, y) {
                node.x = x;
                node.y = y;
                positions.push(node);
                maxY = Math.max(maxY, y);
                
                if (node.children && node.children.length > 0) {
                    const childX = x + levelGap;
                    let currentY = y - ((node.children.length - 1) * (nodeHeight + nodeGap)) / 2;
                    
                    node.children.forEach(child => {
                        assignPositions(child, childX, currentY);
                        currentY += nodeHeight + nodeGap;
                    });
                }
            }
            
            // First pass: calculate subtree heights
            function calcSubtreeHeight(node) {
                if (!node.children || node.children.length === 0) {
                    node.subtreeHeight = nodeHeight;
                    return node.subtreeHeight;
                }
                let totalHeight = 0;
                node.children.forEach(child => {
                    totalHeight += calcSubtreeHeight(child) + nodeGap;
                });
                totalHeight -= nodeGap;
                node.subtreeHeight = Math.max(nodeHeight, totalHeight);
                return node.subtreeHeight;
            }
            
            function assignPositions2(node, x, yStart, yEnd) {
                const yMid = (yStart + yEnd) / 2;
                node.x = x;
                node.y = yMid;
                positions.push(node);
                maxY = Math.max(maxY, yEnd);
                
                if (node.children && node.children.length > 0) {
                    const childX = x + levelGap;
                    let currentY = yStart;
                    
                    node.children.forEach(child => {
                        const childEnd = currentY + child.subtreeHeight;
                        assignPositions2(child, childX, currentY, childEnd);
                        currentY = childEnd + nodeGap;
                    });
                }
            }
            
            calcSubtreeHeight(treeData);
            assignPositions2(treeData, 40, 40, 40 + treeData.subtreeHeight);
            
            // Calculate SVG size
            const maxX = Math.max(...positions.map(p => p.x)) + nodeWidth + 40;
            const svgHeight = maxY + 40;
            const svgWidth = Math.max(maxX, 400);
            
            // Generate table colors
            const tableColors = {};
            const colorPalette = ['#3498db', '#e74c3c', '#2ecc71', '#9b59b6', '#f39c12', '#1abc9c', '#e67e22', '#34495e'];
            let colorIndex = 0;
            database.tables.forEach(tb => {
                tableColors[tb.id] = colorPalette[colorIndex % colorPalette.length];
                colorIndex++;
            });
            
            // Build SVG
            let svg = `<svg class="graph-svg" width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}">`;
            
            // Draw links first (behind nodes)
            function drawLinks(node) {
                if (node.children) {
                    node.children.forEach(child => {
                        const startX = node.x + nodeWidth;
                        const startY = node.y + nodeHeight / 2;
                        const endX = child.x;
                        const endY = child.y + nodeHeight / 2;
                        const midX = (startX + endX) / 2;
                        svg += `<path class="graph-link" d="M${startX},${startY} C${midX},${startY} ${midX},${endY} ${endX},${endY}"/>`;
                        drawLinks(child);
                    });
                }
            }
            drawLinks(treeData);
            
            // Draw nodes
            positions.forEach(node => {
                const color = tableColors[node.tableId] || '#3498db';
                const textWidth = Math.min(node.name.length * 7, nodeWidth - 10);
                const displayName = node.name.length > 20 ? node.name.substring(0, 18) + '...' : node.name;
                
                svg += `<g class="graph-node" data-table="${node.tableId}" data-record="${node.recordId}">`;
                svg += `<rect x="${node.x}" y="${node.y}" width="${nodeWidth}" height="${nodeHeight}" style="stroke: ${color}"/>`;
                svg += `<text x="${node.x + 8}" y="${node.y + nodeHeight/2 + 4}" style="fill: ${color}">${escapeHtml(displayName)}</text>`;
                svg += '</g>';
            });
            
            svg += '</svg>';
            container.innerHTML = svg;
        }
        
        function buildTreeData(tableId, recordId, depth, visited) {
            const key = `${tableId}_${recordId}`;
            if (visited.has(key)) return null; // Prevent cycles
            visited.add(key);
            
            const table = getTableById(tableId);
            const record = getRecordById(tableId, recordId);
            if (!table || !record) return null;
            
            const node = {
                tableId,
                recordId,
                name: getPrimaryFieldValue(table, record),
                tableName: table.name,
                children: []
            };
            
            // Limit depth for graph
            if (depth < STRUCTURE_MAX_DEPTH) {
                const children = getDirectChildren(tableId, recordId);
                // Limit items for graph
                const itemsToShow = Math.min(children.length, STRUCTURE_MAX_ITEMS);
                for (let i = 0; i < itemsToShow; i++) {
                    const child = children[i];
                    const childNode = buildTreeData(child.table.id, child.record.id, depth + 1, new Set(visited));
                    if (childNode) {
                        node.children.push(childNode);
                    }
                }
            }
            
            return node;
        }

        // View collection contents
        function openFieldModal(fieldId = null) {
            const table = getTableById(editingFieldTableId);
            if (!table) return;
            document.getElementById('fieldName').value = '';
            document.getElementById('fieldType').value = 'text';
            document.getElementById('fieldOptions').value = '';
            document.getElementById('compositeTemplate').value = '';
            document.getElementById('fieldPrimary').checked = false;
            document.getElementById('fieldFilter').checked = false;
            document.getElementById('fieldGroup').checked = false;
            document.getElementById('fieldId').value = '';
            document.getElementById('fieldTableId').value = editingFieldTableId;
            document.getElementById('fieldOptionsGroup').hidden = true;
            document.getElementById('compositeTemplateGroup').hidden = true;
            document.getElementById('targetTableGroup').hidden = true;
            document.getElementById('parentFieldGroup').hidden = true;
            populateTargetTableSelect();
            if (fieldId) {
                const f = table.fields.find(x => x.id === fieldId);
                if (f) {
                    document.getElementById('fieldModalTitle').textContent = t('editField');
                    document.getElementById('fieldId').value = f.id;
                    document.getElementById('fieldName').value = f.name;
                    document.getElementById('fieldType').value = f.type;
                    document.getElementById('fieldOptions').value = f.options || '';
                    document.getElementById('compositeTemplate').value = f.compositeTemplate || '';
                    document.getElementById('fieldPrimary').checked = f.primary;
                    document.getElementById('fieldFilter').checked = f.filter;
                    document.getElementById('fieldGroup').checked = f.group;
                    if (f.type === 'select') document.getElementById('fieldOptionsGroup').hidden = false;
                    if (f.type === 'composite') {
                        document.getElementById('compositeTemplateGroup').hidden = false;
                        populateCompositeFieldButtons();
                    }
                    if (f.type === 'parent' || f.type === 'children') {
                        document.getElementById('targetTableGroup').hidden = false;
                        populateTargetTableSelect(f.targetTableId);
                        if (f.type === 'children') {
                            document.getElementById('parentFieldGroup').hidden = false;
                            populateParentFieldSelect(f.targetTableId, f.parentFieldId);
                        }
                    }
                }
            } else { document.getElementById('fieldModalTitle').textContent = t('addField'); }
            openModal('fieldModal');
        }

        function populateTargetTableSelect(selId = '') {
            document.getElementById('targetTable').innerHTML = `<option value="">${t('selectField')}</option>` + database.tables.map(tb => `<option value="${tb.id}" ${tb.id === selId ? 'selected' : ''}>${escapeHtml(tb.name)}</option>`).join('');
        }

        function populateParentFieldSelect(targetTableId, selId = '') {
            const sel = document.getElementById('parentField');
            const tt = getTableById(targetTableId);
            if (!tt) { sel.innerHTML = `<option value="">${t('selectField')}</option>`; return; }
            const pfs = tt.fields.filter(f => f.type === 'parent' && f.targetTableId === editingFieldTableId);
            sel.innerHTML = `<option value="">${t('selectField')}</option>` + pfs.map(f => `<option value="${f.id}" ${f.id === selId ? 'selected' : ''}>${escapeHtml(f.name)}</option>`).join('');
        }

        function populateCompositeFieldButtons() {
            const table = getTableById(editingFieldTableId);
            const container = document.getElementById('compositeFieldButtons');
            if (!table) { container.innerHTML = ''; return; }
            const currentFieldId = document.getElementById('fieldId').value;
            container.innerHTML = table.fields.filter(f => f.id !== currentFieldId && f.type !== 'children' && f.type !== 'composite').map(f => `<button type="button" class="field-btn" data-field="{${f.name}}">{${escapeHtml(f.name)}}</button>`).join('');
        }

        function saveField() {
            const tableId = document.getElementById('fieldTableId').value;
            const table = getTableById(tableId);
            if (!table) return;
            const id = document.getElementById('fieldId').value;
            const name = document.getElementById('fieldName').value.trim();
            const type = document.getElementById('fieldType').value;
            const options = document.getElementById('fieldOptions').value.trim();
            const compositeTemplate = document.getElementById('compositeTemplate').value;
            const primary = document.getElementById('fieldPrimary').checked;
            const filter = document.getElementById('fieldFilter').checked;
            const group = document.getElementById('fieldGroup').checked;
            const targetTableId = document.getElementById('targetTable').value;
            const parentFieldId = document.getElementById('parentField').value;
            if (!name) return;
            if (primary) table.fields.forEach(f => f.primary = false);
            if (group) table.fields.forEach(f => f.group = false); // jen jedno pole m≈Ø≈æe b√Ωt pro seskupov√°n√≠
            if (id) {
                const f = table.fields.find(x => x.id === id);
                if (f) { f.name = name; f.type = type; f.options = options; f.compositeTemplate = compositeTemplate; f.primary = primary; f.filter = filter; f.group = group; f.targetTableId = targetTableId; f.parentFieldId = parentFieldId; }
            } else {
                table.fields.push({ id: generateId(), name, type, options, compositeTemplate, primary, filter, group, targetTableId, parentFieldId });
            }
            closeModal('fieldModal');
            renderFieldList();
            renderTableTabs();
        }

        // Record Modal
        function openRecordModal(tableId, recordId = null) {
            const table = getTableById(tableId);
            if (!table) return;
            currentRecordTableId = tableId;
            currentRecordId = recordId;
            document.getElementById('recordModalTitle').textContent = recordId ? `${t('edit')}: ${table.name}` : `${t('addRecord')}: ${table.name}`;
            const record = recordId ? getRecordById(tableId, recordId) : null;
            document.getElementById('recordForm').innerHTML = table.fields.filter(f => f.type !== 'children').map(f => buildFormField(table, f, record?.values[f.id] ?? '', record)).join('');
            openModal('recordModal');
        }

        function buildFormField(table, field, value, record) {
            const id = `record_${field.id}`;
            let input = '';
            switch (field.type) {
                case 'text': input = `<input type="text" id="${id}" value="${escapeHtml(value)}">`; break;
                case 'textarea': input = `<textarea id="${id}" rows="5">${escapeHtml(value)}</textarea>`; break;
                case 'number': input = `<input type="number" id="${id}" value="${escapeHtml(value)}" step="any">`; break;
                case 'date': input = `<div class="date-input-group"><input type="date" id="${id}" value="${escapeHtml(value)}" class="date-picker"><input type="text" id="${id}_text" value="${escapeHtml(value)}" placeholder="yyyy-mm-dd" pattern="\\d{4}-\\d{2}-\\d{2}" class="date-text" title="Form√°t: yyyy-mm-dd"></div>`; break;
                case 'url': input = `<input type="url" id="${id}" value="${escapeHtml(value)}" placeholder="https://">`; break;
                case 'boolean': return `<div class="form-group"><div class="checkbox-group"><input type="checkbox" id="${id}" ${value ? 'checked' : ''}><label for="${id}">${escapeHtml(field.name)}</label></div></div>`;
                case 'select':
                    const opts = (field.options || '').split(',').map(o => o.trim()).filter(o => o);
                    input = `<select id="${id}"><option value="">-- ${t('selectField')} --</option>${opts.map(o => `<option value="${escapeHtml(o)}" ${value === o ? 'selected' : ''}>${escapeHtml(o)}</option>`).join('')}</select>`;
                    break;
                case 'composite':
                    const compVal = record ? evaluateCompositeField(table, field, record) : '';
                    input = `<input type="text" id="${id}" value="${escapeHtml(compVal)}" readonly disabled style="background: var(--bg); cursor: not-allowed;">`;
                    break;
                case 'parent':
                    const tt = getTableById(field.targetTableId);
                    const ros = tt ? tt.records.filter(r => r.id !== currentRecordId).map(r => ({ id: r.id, name: getPrimaryFieldValue(tt, r) })) : [];
                    input = `<div style="display: flex; gap: 0.5rem;"><select id="${id}" style="flex: 1;"><option value="">${t('noParent')}</option>${ros.map(o => `<option value="${o.id}" ${value === o.id ? 'selected' : ''}>${escapeHtml(o.name)}</option>`).join('')}</select><button type="button" class="btn btn-sm btn-success create-parent-btn" data-field="${field.id}" data-target-table="${field.targetTableId}" title="${t('createNew')}">‚ûï</button></div>`;
                    break;
            }
            return `<div class="form-group"><label for="${id}">${escapeHtml(field.name)}</label>${input}</div>`;
        }

        // Variables for nested record creation
        let pendingParentCreation = null;

        function saveFormState() {
            const table = getTableById(currentRecordTableId);
            if (!table) return null;
            const values = {};
            table.fields.filter(f => f.type !== 'children' && f.type !== 'composite').forEach(f => {
                const el = document.getElementById(`record_${f.id}`);
                if (!el) return;
                if (f.type === 'boolean') values[f.id] = el.checked;
                else if (f.type === 'number') values[f.id] = el.value ? parseFloat(el.value) : null;
                else values[f.id] = el.value;
            });
            return { tableId: currentRecordTableId, recordId: currentRecordId, values };
        }

        function restoreFormState(state, newParentId, parentFieldId) {
            if (!state) return;
            currentRecordTableId = state.tableId;
            currentRecordId = state.recordId;
            const table = getTableById(state.tableId);
            if (!table) return;
            // Merge saved values with new parent ID
            if (newParentId && parentFieldId) {
                state.values[parentFieldId] = newParentId;
            }
            const record = state.recordId ? getRecordById(state.tableId, state.recordId) : { values: state.values };
            document.getElementById('recordModalTitle').textContent = state.recordId ? t('edit') : t('addRecord');
            document.getElementById('recordForm').innerHTML = table.fields.filter(f => f.type !== 'children').map(f => {
                const val = state.values[f.id] !== undefined ? state.values[f.id] : (record?.values[f.id] ?? '');
                return buildFormField(table, f, val, record);
            }).join('');
            openModal('recordModal');
        }

        function createParentRecord(targetTableId, parentFieldId) {
            // Save current form state
            pendingParentCreation = {
                formState: saveFormState(),
                parentFieldId: parentFieldId
            };
            // Open new record modal for target table
            closeModal('recordModal');
            openRecordModal(targetTableId, null);
        }

        function createChildRecord(targetTableId, parentFieldId, parentRecordId) {
            // Remember to return to view modal after saving
            pendingChildCreation = {
                returnToTableId: currentRecordTableId,
                returnToRecordId: currentRecordId
            };
            // Close view modal and open new record modal with pre-filled parent
            closeModal('viewRecordModal');
            openRecordModalWithParent(targetTableId, parentFieldId, parentRecordId);
        }

        function openRecordModalWithParent(tableId, parentFieldId, parentRecordId) {
            const table = getTableById(tableId);
            if (!table) return;
            currentRecordTableId = tableId;
            currentRecordId = null;
            document.getElementById('recordModalTitle').textContent = t('addRecord');
            // Create a temporary record object with pre-filled parent
            const prefilledValues = {};
            prefilledValues[parentFieldId] = parentRecordId;
            document.getElementById('recordForm').innerHTML = table.fields.filter(f => f.type !== 'children').map(f => {
                const val = prefilledValues[f.id] ?? '';
                return buildFormField(table, f, val, null);
            }).join('');
            openModal('recordModal');
        }

        function saveRecord() {
            const table = getTableById(currentRecordTableId);
            if (!table) return;
            const values = {};
            table.fields.filter(f => f.type !== 'children' && f.type !== 'composite').forEach(f => {
                const el = document.getElementById(`record_${f.id}`);
                if (!el) return;
                if (f.type === 'boolean') values[f.id] = el.checked;
                else if (f.type === 'number') values[f.id] = el.value ? parseFloat(el.value) : null;
                else values[f.id] = el.value;
            });
            let newRecordId = null;
            if (currentRecordId) { 
                const r = getRecordById(currentRecordTableId, currentRecordId); 
                if (r) r.values = values; 
            } else {
                newRecordId = generateId();
                table.records.push({ id: newRecordId, values });
            }
            closeModal('recordModal');
            
            // Check if we were creating a parent record
            if (pendingParentCreation) {
                const pending = pendingParentCreation;
                pendingParentCreation = null;
                restoreFormState(pending.formState, newRecordId, pending.parentFieldId);
                return;
            }
            
            // Quick create mode - just close modal, don't change view
            if (quickCreateMode) {
                quickCreateMode = false;
                currentRecordId = null;
                currentRecordTableId = null;
                autoSave();
                return;
            }
            
            currentRecordId = null;
            if (activeTab !== 'management' && activeTab !== 'classification') renderTableContent(currentRecordTableId);
            else renderStats();
            currentRecordTableId = null;
        }

        function viewRecord(tableId, recordId) {
            const table = getTableById(tableId);
            const record = getRecordById(tableId, recordId);
            if (!table || !record) return;
            currentRecordTableId = tableId;
            currentRecordId = recordId;
            document.getElementById('viewRecordModalTitle').innerHTML = `üìù ${escapeHtml(table.name)}: ${escapeHtml(getPrimaryFieldValue(table, record))}`;
            
            // Build fields HTML
            let fieldsHtml = table.fields.map(f => {
                const v = record.values[f.id];
                let dv = '';
                let rawValue = ''; // Pro kop√≠rov√°n√≠
                let isEmpty = false;
                
                switch (f.type) {
                    case 'boolean': 
                        dv = v ? t('yes') : t('no'); 
                        rawValue = dv;
                        break;
                    case 'date': 
                        if (v) {
                            dv = new Date(v).toLocaleDateString(currentLang);
                            rawValue = dv;
                        } else {
                            isEmpty = true;
                        }
                        break;
                    case 'textarea': 
                        if (v) {
                            dv = `<div class="markdown-content">${parseMarkdown(v)}</div>`;
                            rawValue = v;
                        } else {
                            isEmpty = true;
                        }
                        break;
                    case 'url': 
                        if (v) {
                            dv = `<a href="${escapeHtml(v)}" target="_blank" rel="noopener noreferrer" class="url-link">${escapeHtml(v)}</a>`;
                            rawValue = v;
                        } else {
                            isEmpty = true;
                        }
                        break;
                    case 'composite': 
                        const compVal = evaluateCompositeField(table, f, record);
                        if (compVal) {
                            dv = escapeHtml(compVal).replace(/\n/g, '<br>');
                            rawValue = compVal;
                        } else {
                            isEmpty = true;
                        }
                        break;
                    case 'parent':
                        const tt = getTableById(f.targetTableId);
                        const pr = v && tt ? getRecordById(f.targetTableId, v) : null;
                        if (pr && tt) {
                            const parentName = getPrimaryFieldValue(tt, pr);
                            dv = `<a href="#" class="record-link" data-action="viewInModal" data-table="${f.targetTableId}" data-record="${v}">${escapeHtml(parentName)}</a>`;
                            rawValue = parentName;
                        } else {
                            isEmpty = true;
                        }
                        break;
                    case 'children':
                        const ch = getChildRecords(tableId, recordId).filter(c => { if (f.targetTableId && c.table.id !== f.targetTableId) return false; if (f.parentFieldId && c.field.id !== f.parentFieldId) return false; return true; });
                        if (ch.length > 0) {
                            dv = `<ul class="children-list">${ch.map(c => `<li><a href="#" class="record-link" data-action="viewInModal" data-table="${c.table.id}" data-record="${c.record.id}">${escapeHtml(getPrimaryFieldValue(c.table, c.record))}</a></li>`).join('')}</ul>`;
                            rawValue = ch.map(c => getPrimaryFieldValue(c.table, c.record)).join('\n');
                        } else {
                            isEmpty = true;
                        }
                        // Add button to create new child if targetTableId and parentFieldId are set
                        if (f.targetTableId && f.parentFieldId) {
                            if (isEmpty) dv = '';
                            dv += `<button type="button" class="btn btn-sm btn-success create-child-btn" data-target-table="${f.targetTableId}" data-parent-field="${f.parentFieldId}" data-parent-record="${recordId}" style="margin-top: 0.5rem;"><span aria-hidden="true">‚ûï</span> ${t('addChild')}</button>`;
                            isEmpty = false; // V≈ædy zobrazit kv≈Øli tlaƒç√≠tku
                        }
                        break;
                    default: 
                        if (v != null && v !== '') {
                            dv = escapeHtml(String(v));
                            rawValue = String(v);
                        } else {
                            isEmpty = true;
                        }
                }
                
                // Skr√Ωt pr√°zdn√° pole (kromƒõ children s tlaƒç√≠tkem)
                if (isEmpty) return '';
                
                // Tlaƒç√≠tko pro kop√≠rov√°n√≠ (ne pro children)
                const copyBtn = f.type !== 'children' && rawValue ? `<button type="button" class="btn btn-sm btn-secondary copy-field-btn" data-value="${escapeHtml(rawValue)}" title="${t('copyField')}">üìã</button>` : '';
                
                return `<div class="view-field"><div class="view-field-header"><span class="view-field-label">${escapeHtml(f.name)}</span>${copyBtn}</div><div class="view-field-value">${dv}</div></div>`;
            }).join('');
            
            // Collections and Tags section  
            const collections = getRecordCollections(tableId, recordId);
            const tags = getRecordTags(tableId, recordId);
            
            // Section: Record fields
            let contentHtml = '<div class="view-record-section">';
            contentHtml += `<div class="view-record-section-title">üìã ${t('recordFields')}</div>`;
            contentHtml += fieldsHtml || `<p style="color: var(--text-muted); font-style: italic;">${t('noFields')}</p>`;
            contentHtml += '</div>';
            
            // Section: Classification (Collections & Tags)
            contentHtml += '<div class="view-record-section">';
            contentHtml += `<div class="view-record-section-title">üè∑Ô∏è ${t('classification')}</div>`;
            contentHtml += '<div class="record-classification">';
            
            // Collections row
            contentHtml += '<div class="record-classification-row">';
            contentHtml += `<span class="record-classification-label">${t('collections')}:</span>`;
            contentHtml += '<div class="record-classification-items">';
            if (collections.length > 0) {
                collections.forEach(col => {
                    contentHtml += `<span class="collection-badge" style="background: ${col.color || '#4a90d9'}">
                        <a href="#" class="collection-link" data-collection="${col.id}" style="color: white; text-decoration: none;">${escapeHtml(col.name)}</a>
                        <button type="button" class="remove-badge-btn" data-action="removeFromCollection" data-collection="${col.id}" data-table="${tableId}" data-record="${recordId}" title="${t('removeFromCollection')}">‚úï</button>
                    </span>`;
                });
            }
            contentHtml += `<button type="button" class="btn btn-sm btn-success add-classification-btn open-add-collection-btn" data-table="${tableId}" data-record="${recordId}">‚ûï</button>`;
            contentHtml += '</div></div>';
            
            // Tags row
            contentHtml += '<div class="record-classification-row">';
            contentHtml += `<span class="record-classification-label">${t('tags')}:</span>`;
            contentHtml += '<div class="record-classification-items">';
            if (tags.length > 0) {
                tags.forEach(tag => {
                    contentHtml += `<span class="tag-badge" style="background: ${tag.color || '#e74c3c'}">
                        <a href="#" class="tag-link" data-tag="${tag.id}" style="color: white; text-decoration: none;">${escapeHtml(tag.name)}</a>
                        <button type="button" class="remove-badge-btn" data-action="removeTag" data-tag="${tag.id}" data-table="${tableId}" data-record="${recordId}" title="${t('removeThisTag')}">‚úï</button>
                    </span>`;
                });
            }
            contentHtml += `<button type="button" class="btn btn-sm btn-success add-classification-btn open-add-tag-btn" data-table="${tableId}" data-record="${recordId}">‚ûï</button>`;
            contentHtml += '</div></div>';
            
            contentHtml += '</div></div>';
            
            // Section: Related records (from collections)
            if (collections.length > 0) {
                let hasRelated = false;
                let relatedContent = '';
                collections.forEach(col => {
                    const otherMembers = col.members?.filter(m => !(m.tableId === tableId && m.recordId === recordId)) || [];
                    if (otherMembers.length > 0) {
                        hasRelated = true;
                        relatedContent += `<div class="related-group">`;
                        relatedContent += `<div class="related-group-title"><span class="color-dot" style="background: ${col.color || '#4a90d9'}"></span>${escapeHtml(col.name)}</div>`;
                        relatedContent += '<ul class="related-list">';
                        otherMembers.forEach(m => {
                            const relTable = getTableById(m.tableId);
                            const relRecord = relTable ? getRecordById(m.tableId, m.recordId) : null;
                            if (relTable && relRecord) {
                                relatedContent += `<li><a href="#" class="record-link" data-action="viewInModal" data-table="${m.tableId}" data-record="${m.recordId}">${escapeHtml(getPrimaryFieldValue(relTable, relRecord))}</a> <span class="related-table-name">(${escapeHtml(relTable.name)})</span></li>`;
                            }
                        });
                        relatedContent += '</ul></div>';
                    }
                });
                if (hasRelated) {
                    contentHtml += '<div class="view-record-section">';
                    contentHtml += `<div class="view-record-section-title">üîó ${t('relatedRecords')}</div>`;
                    contentHtml += relatedContent;
                    contentHtml += '</div>';
                }
            }
            
            document.getElementById('viewRecordContent').innerHTML = contentHtml;
            openModal('viewRecordModal');
        }

        // Export/Import
        function openExportModal(tableId) {
            if (!tableId) { alert('Nejd≈ô√≠ve vyberte tabulku.'); return; }
            activeTableId = tableId;
            exportFormat = 'csv';
            document.querySelectorAll('#exportModal .format-tab').forEach(t => t.classList.toggle('active', t.dataset.format === 'csv'));
            updateExportOutput();
            openModal('exportModal');
        }

        function updateExportOutput() {
            const table = getTableById(activeTableId);
            if (!table) return;
            const delim = exportFormat === 'csv' ? ',' : '\t';
            const fields = table.fields.filter(f => f.type !== 'children' && f.type !== 'parent');
            const escD = (s, d) => { s = String(s); return s.includes(d) || s.includes('"') || s.includes('\n') ? '"' + s.replace(/"/g, '""') + '"' : s; };
            let csv = fields.map(f => escD(f.name, delim)).join(delim) + '\n';
            table.records.forEach(r => { csv += fields.map(f => { let v = r.values[f.id] ?? ''; if (f.type === 'boolean') v = v ? t('yes') : t('no'); return escD(v, delim); }).join(delim) + '\n'; });
            document.getElementById('exportOutput').value = csv;
        }

        function openImportModal(tableId) {
            if (!tableId) { alert('Nejd≈ô√≠ve vyberte tabulku.'); return; }
            activeTableId = tableId;
            importFormat = 'csv';
            document.querySelectorAll('#importModal .format-tab').forEach(t => t.classList.toggle('active', t.dataset.format === 'csv'));
            document.getElementById('importFile').value = '';
            document.getElementById('importInput').value = '';
            document.getElementById('importPreview').innerHTML = '';
            openModal('importModal');
        }

        function parseDelimited(text, delim) {
            const lines = []; let cur = '', inQ = false;
            for (let i = 0; i < text.length; i++) { const c = text[i]; if (c === '"') { if (inQ && text[i + 1] === '"') { cur += '"'; i++; } else inQ = !inQ; } else if ((c === '\n' || c === '\r') && !inQ) { if (cur || lines.length > 0) lines.push(cur); cur = ''; if (c === '\r' && text[i + 1] === '\n') i++; } else cur += c; }
            if (cur) lines.push(cur);
            return lines.map(line => { const cells = []; let cell = '', iq = false; for (let i = 0; i < line.length; i++) { const ch = line[i]; if (ch === '"') { if (iq && line[i + 1] === '"') { cell += '"'; i++; } else iq = !iq; } else if (ch === delim && !iq) { cells.push(cell); cell = ''; } else cell += ch; } cells.push(cell); return cells; });
        }

        function doImport() {
            const table = getTableById(activeTableId);
            if (!table) return;
            const text = document.getElementById('importInput').value;
            if (!text.trim()) return;
            const delim = importFormat === 'csv' ? ',' : '\t';
            const hasHeader = document.getElementById('importHasHeader').checked;
            const rows = parseDelimited(text, delim);
            const dataRows = hasHeader ? rows.slice(1) : rows;
            const fields = table.fields.filter(f => f.type !== 'children' && f.type !== 'parent');
            const primaryField = fields.find(f => f.primary);
            const primaryFieldIndex = primaryField ? fields.indexOf(primaryField) : -1;
            let countNew = 0, countUpdated = 0;
            
            dataRows.forEach(row => {
                if (row.every(c => !c.trim())) return;
                const values = {};
                row.forEach((c, i) => {
                    if (i < fields.length) {
                        const f = fields[i];
                        if (f.type === 'number') values[f.id] = c ? parseFloat(c.replace(',', '.')) : null;
                        else if (f.type === 'boolean') values[f.id] = c.toLowerCase() === t('yes').toLowerCase() || c === '1' || c.toLowerCase() === 'true';
                        else values[f.id] = c;
                    }
                });
                
                // Upsert: najdi existuj√≠c√≠ z√°znam podle prim√°rn√≠ho pole
                let existingRecord = null;
                if (primaryField && values[primaryField.id]) {
                    existingRecord = table.records.find(r => r.values[primaryField.id] === values[primaryField.id]);
                }
                
                if (existingRecord) {
                    // Aktualizuj existuj√≠c√≠ z√°znam
                    Object.assign(existingRecord.values, values);
                    countUpdated++;
                } else {
                    // Vytvo≈ô nov√Ω z√°znam
                    table.records.push({ id: generateId(), values });
                    countNew++;
                }
            });
            closeModal('importModal');
            alert(t('importSuccess', { count: countNew, updated: countUpdated }));
            renderTableContent(activeTableId);
        }

        // File operations
        function createNewDatabase() {
            confirmAction(t('confirmNewDb'), () => {
                database = { meta: { name: '', columnVisibility: {}, groupStates: {}, collections: [], tags: [] }, tables: [] };
                activeTab = 'management';
                activeTableId = null;
                tableFilters = {};
                tableSearches = {};
                tableSorts = {};
                collectionFilter = null;
                tagFilter = null;
                renderAll();
            });
        }

        function loadDatabase() { document.getElementById('fileInput').click(); }

        function handleFileLoad(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => { try { loadDatabaseFromJson(JSON.parse(ev.target.result)); } catch { alert(t('jsonInvalid')); } };
            reader.readAsText(file);
            e.target.value = '';
        }

        function loadDatabaseFromJson(data) {
            database = { 
                meta: { 
                    name: data.meta?.name || '', 
                    columnVisibility: data.meta?.columnVisibility || {},
                    groupStates: data.meta?.groupStates || {},
                    collections: data.meta?.collections || [],
                    tags: data.meta?.tags || []
                }, 
                tables: data.tables || [] 
            };
            activeTab = database.tables.length > 0 ? database.tables[0].id : 'management';
            activeTableId = database.tables[0]?.id || null;
            tableFilters = {};
            tableSearches = {};
            tableSorts = {};
            collectionFilter = null;
            tagFilter = null;
            document.getElementById('dbNameInput').value = database.meta.name;
            renderAll();
        }

        function saveDatabase() {
            database.meta.name = document.getElementById('dbNameInput')?.value || database.meta.name;
            updateDocumentTitle();
            const blob = new Blob([JSON.stringify(database, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = (database.meta.name || 'database') + '.jsondb';
            a.click();
        }

        async function copyJsonToClipboard() {
            database.meta.name = document.getElementById('dbNameInput')?.value || database.meta.name;
            try {
                await navigator.clipboard.writeText(JSON.stringify(database, null, 2));
                alert(t('jsonCopied'));
            } catch {
                const ta = document.createElement('textarea');
                ta.value = JSON.stringify(database, null, 2);
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                alert(t('jsonCopied'));
            }
        }

        async function pasteJsonFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                const data = JSON.parse(text);
                loadDatabaseFromJson(data);
                alert(t('jsonPasted'));
            } catch (e) {
                // Clipboard API failed - open modal as fallback
                document.getElementById('pasteJsonInput').value = '';
                openModal('pasteJsonModal');
            }
        }

        function doPasteJson() {
            const text = document.getElementById('pasteJsonInput').value.trim();
            if (!text) return;
            try {
                const data = JSON.parse(text);
                loadDatabaseFromJson(data);
                closeModal('pasteJsonModal');
                alert(t('jsonPasted'));
            } catch (e) {
                alert(t('jsonInvalid') + '\n' + e.message);
            }
        }

        function renderAll() {
            renderTableTabs();
            updateQuickCreateOptions();
            if (activeTab === 'management') renderManagement();
            else if (activeTab === 'classification') renderClassification();
            else renderTableContent(activeTab);
            applyTranslations();
            updateDocumentTitle();
            autoSave();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const langSelect = document.getElementById('langSelect');
            langSelect.value = currentLang;
            langSelect.addEventListener('change', e => { currentLang = e.target.value; localStorage.setItem('db-editor-lang', currentLang); renderAll(); });

            // Quick create select
            document.getElementById('quickCreateSelect').addEventListener('change', e => {
                const tableId = e.target.value;
                if (tableId) {
                    quickCreateMode = true;
                    openRecordModal(tableId);
                    e.target.value = ''; // Reset select
                }
            });

            document.getElementById('tableTabs').addEventListener('click', e => {
                const tab = e.target.closest('.table-tab');
                if (tab) switchTab(tab.dataset.tableId);
            });

            document.querySelectorAll('.sub-tab').forEach(tab => tab.addEventListener('click', () => {
                document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.sub-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.subtab).classList.add('active');
            }));

            document.getElementById('dbNameInput').addEventListener('input', e => {
                database.meta.name = e.target.value;
                updateDocumentTitle();
            });

            document.getElementById('btnNew').addEventListener('click', createNewDatabase);
            document.getElementById('btnLoad').addEventListener('click', loadDatabase);
            document.getElementById('fileInput').addEventListener('change', handleFileLoad);
            document.getElementById('btnSave').addEventListener('click', saveDatabase);
            document.getElementById('btnCopyJson').addEventListener('click', copyJsonToClipboard);
            document.getElementById('btnPasteJson').addEventListener('click', pasteJsonFromClipboard);

            document.getElementById('btnAddTable').addEventListener('click', () => openTableModal());
            document.getElementById('btnSaveTable').addEventListener('click', saveTable);
            document.getElementById('btnAddField').addEventListener('click', () => openFieldModal());
            document.getElementById('btnSaveField').addEventListener('click', saveField);
            document.getElementById('btnSaveRecord').addEventListener('click', saveRecord);
            document.getElementById('btnEditFromView').addEventListener('click', () => { closeModal('viewRecordModal'); openRecordModal(currentRecordTableId, currentRecordId); });
            document.getElementById('btnStructureFromView').addEventListener('click', () => { openStructureModal(currentRecordTableId, currentRecordId); });
            
            // Bulk edit modal
            // Bulk edit modal - dynamic rows
            document.getElementById('btnAddBulkField').addEventListener('click', addBulkEditRow);
            document.getElementById('bulkEditFieldsContainer').addEventListener('change', e => {
                const select = e.target.closest('.bulk-edit-field-select');
                if (select) {
                    updateBulkEditValueInput(select.dataset.row);
                }
            });
            document.getElementById('bulkEditFieldsContainer').addEventListener('click', e => {
                const removeBtn = e.target.closest('.bulk-edit-remove-row');
                if (removeBtn) {
                    removeBulkEditRow(removeBtn.dataset.row);
                }
            });
            document.getElementById('btnApplyBulkEdit').addEventListener('click', applyBulkEdit);
            document.getElementById('btnApplyBulkCollection').addEventListener('click', applyBulkAddToCollection);
            document.getElementById('btnApplyBulkTag').addEventListener('click', applyBulkAddTag);
            document.getElementById('btnConfirmYes').addEventListener('click', () => { closeModal('confirmModal'); if (confirmCallback) { confirmCallback(); confirmCallback = null; } });

            document.getElementById('fieldType').addEventListener('change', e => {
                const t = e.target.value;
                document.getElementById('fieldOptionsGroup').hidden = t !== 'select';
                document.getElementById('compositeTemplateGroup').hidden = t !== 'composite';
                document.getElementById('targetTableGroup').hidden = t !== 'parent' && t !== 'children';
                document.getElementById('parentFieldGroup').hidden = t !== 'children';
                if (t === 'parent' || t === 'children') populateTargetTableSelect();
                if (t === 'composite') populateCompositeFieldButtons();
            });
            document.getElementById('targetTable').addEventListener('change', e => { if (document.getElementById('fieldType').value === 'children') populateParentFieldSelect(e.target.value); });

            // Composite field buttons
            document.getElementById('compositeFieldButtons').addEventListener('click', e => {
                if (e.target.classList.contains('field-btn')) {
                    const ta = document.getElementById('compositeTemplate');
                    const start = ta.selectionStart, end = ta.selectionEnd;
                    const text = ta.value;
                    ta.value = text.substring(0, start) + e.target.dataset.field + text.substring(end);
                    ta.focus();
                    ta.setSelectionRange(start + e.target.dataset.field.length, start + e.target.dataset.field.length);
                }
            });

            document.getElementById('generatorTable').addEventListener('change', updateGeneratorFields);
            document.getElementById('generatorFieldButtons').addEventListener('click', e => {
                if (e.target.classList.contains('field-btn')) {
                    const ta = document.getElementById('generatorTemplate');
                    const start = ta.selectionStart, end = ta.selectionEnd;
                    const text = ta.value;
                    ta.value = text.substring(0, start) + e.target.dataset.field + text.substring(end);
                    ta.focus();
                    ta.setSelectionRange(start + e.target.dataset.field.length, start + e.target.dataset.field.length);
                }
            });
            document.getElementById('btnGenerate').addEventListener('click', generateText);
            document.getElementById('btnCopyGenerated').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('generatorOutput').textContent); alert(t('jsonCopied')); });

            // Collections and Tags
            document.getElementById('btnAddCollection').addEventListener('click', () => openCollectionModal());
            document.getElementById('btnSaveCollection').addEventListener('click', saveCollection);
            document.getElementById('btnAddTag').addEventListener('click', () => openTagModal());
            document.getElementById('btnSaveTag').addEventListener('click', saveTag);
            
            // View/Edit/Delete collection from modal
            document.getElementById('btnEditCollectionFromView').addEventListener('click', () => {
                closeModal('viewCollectionModal');
                openCollectionModal(currentViewCollectionId);
            });
            document.getElementById('btnDeleteCollectionFromView').addEventListener('click', () => {
                deleteCollection(currentViewCollectionId);
            });
            
            // View/Edit/Delete tag from modal
            document.getElementById('btnEditTagFromView').addEventListener('click', () => {
                closeModal('viewTagModal');
                openTagModal(currentViewTagId);
            });
            document.getElementById('btnDeleteTagFromView').addEventListener('click', () => {
                deleteTag(currentViewTagId);
                closeModal('viewTagModal');
            });
            
            // Add to collection modal
            document.getElementById('btnConfirmAddToCollection').addEventListener('click', confirmAddToCollection);
            document.getElementById('btnQuickCreateCollection').addEventListener('click', () => {
                closeModal('addToCollectionModal');
                openCollectionModal();
            });
            
            // Add tag modal
            document.getElementById('btnConfirmAddTag').addEventListener('click', confirmAddTag);
            document.getElementById('btnQuickCreateTag').addEventListener('click', () => {
                closeModal('addTagToRecordModal');
                openTagModal();
            });

            // Export modal
            document.querySelectorAll('#exportModal .format-tab').forEach(tab => tab.addEventListener('click', () => {
                exportFormat = tab.dataset.format;
                document.querySelectorAll('#exportModal .format-tab').forEach(t => t.classList.toggle('active', t === tab));
                updateExportOutput();
            }));
            document.getElementById('btnExportCopy').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('exportOutput').value); alert(t('jsonCopied')); });
            document.getElementById('btnExportFile').addEventListener('click', () => {
                const table = getTableById(activeTableId);
                const blob = new Blob([document.getElementById('exportOutput').value], { type: 'text/csv' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${table?.name || 'export'}.${exportFormat}`;
                a.click();
            });

            // Import modal
            document.querySelectorAll('#importModal .format-tab').forEach(tab => tab.addEventListener('click', () => {
                importFormat = tab.dataset.format;
                document.querySelectorAll('#importModal .format-tab').forEach(t => t.classList.toggle('active', t === tab));
            }));
            document.getElementById('importFile').addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = ev => { document.getElementById('importInput').value = ev.target.result; };
                reader.readAsText(file);
            });
            document.getElementById('btnDoImport').addEventListener('click', doImport);
            document.getElementById('btnDoPasteJson').addEventListener('click', doPasteJson);

            // Delegation for dynamic elements
            document.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;

                if (target.classList.contains('edit-table-btn')) openTableModal(target.dataset.table);
                if (target.classList.contains('delete-table-btn')) confirmAction(t('confirmDeleteTable'), () => { database.tables = database.tables.filter(tb => tb.id !== target.dataset.table); if (activeTab === target.dataset.table) activeTab = 'management'; renderAll(); });
                if (target.classList.contains('move-table-btn')) {
                    const i = database.tables.findIndex(tb => tb.id === target.dataset.table);
                    const ni = i + parseInt(target.dataset.dir);
                    if (ni >= 0 && ni < database.tables.length) { [database.tables[i], database.tables[ni]] = [database.tables[ni], database.tables[i]]; renderAll(); }
                }
                if (target.classList.contains('show-fields-btn')) showFieldsForTable(target.dataset.table);
                if (target.classList.contains('edit-field-btn')) openFieldModal(target.dataset.field);
                if (target.classList.contains('delete-field-btn')) confirmAction(t('confirmDeleteField'), () => { const table = getTableById(editingFieldTableId); if (table) { table.fields = table.fields.filter(f => f.id !== target.dataset.field); table.records.forEach(r => delete r.values[target.dataset.field]); } renderFieldList(); });
                if (target.classList.contains('move-field-btn')) {
                    const table = getTableById(editingFieldTableId);
                    if (table) {
                        const i = table.fields.findIndex(f => f.id === target.dataset.field);
                        const ni = i + parseInt(target.dataset.dir);
                        if (ni >= 0 && ni < table.fields.length) { [table.fields[i], table.fields[ni]] = [table.fields[ni], table.fields[i]]; renderFieldList(); }
                    }
                }
                if (target.classList.contains('add-record-btn')) openRecordModal(target.dataset.table);
                if (target.classList.contains('export-table-btn')) openExportModal(target.dataset.table);
                if (target.classList.contains('import-table-btn')) openImportModal(target.dataset.table);
                if (target.classList.contains('view-record-btn')) viewRecord(target.dataset.table, target.dataset.record);
                if (target.classList.contains('edit-record-btn')) openRecordModal(target.dataset.table, target.dataset.record);
                if (target.classList.contains('delete-record-btn')) confirmAction(t('confirmDeleteRecord'), () => { 
                    const tableId = target.dataset.table;
                    const recordId = target.dataset.record;
                    const table = getTableById(tableId); 
                    if (table) {
                        table.records = table.records.filter(r => r.id !== recordId);
                        // Remove from all collections
                        if (database.meta.collections) {
                            database.meta.collections.forEach(col => {
                                if (col.members) col.members = col.members.filter(m => !(m.tableId === tableId && m.recordId === recordId));
                            });
                        }
                    }
                    renderTableContent(tableId); 
                });
                if (target.classList.contains('create-parent-btn')) createParentRecord(target.dataset.targetTable, target.dataset.field);
                if (target.classList.contains('create-child-btn')) createChildRecord(target.dataset.targetTable, target.dataset.parentField, target.dataset.parentRecord);
                if (target.classList.contains('copy-field-btn')) {
                    const value = target.dataset.value;
                    navigator.clipboard.writeText(value).then(() => {
                        const origText = target.textContent;
                        target.textContent = '‚úì';
                        setTimeout(() => { target.textContent = origText; }, 1500);
                    }).catch(() => {
                        // Fallback pro star≈°√≠ prohl√≠≈æeƒçe
                        const ta = document.createElement('textarea');
                        ta.value = value;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                        const origText = target.textContent;
                        target.textContent = '‚úì';
                        setTimeout(() => { target.textContent = origText; }, 1500);
                    });
                }
                // Collections
                if (target.classList.contains('open-add-collection-btn')) openAddToCollectionModal(target.dataset.table, target.dataset.record);
                if (target.classList.contains('open-add-tag-btn')) openAddTagModal(target.dataset.table, target.dataset.record);
                if (target.classList.contains('remove-from-collection-btn')) {
                    toggleCollectionMembership(target.dataset.collection, target.dataset.table, target.dataset.record, false);
                    viewCollectionDetails(target.dataset.collection);
                }
                if (target.classList.contains('remove-tag-btn')) {
                    toggleTagAssignment(target.dataset.tag, target.dataset.table, target.dataset.record, false);
                    viewTagDetails(target.dataset.tag);
                }
                if (target.classList.contains('remove-badge-btn')) {
                    const action = target.dataset.action;
                    if (action === 'removeFromCollection') {
                        toggleCollectionMembership(target.dataset.collection, target.dataset.table, target.dataset.record, false);
                        viewRecord(target.dataset.table, target.dataset.record);
                    } else if (action === 'removeTag') {
                        toggleTagAssignment(target.dataset.tag, target.dataset.table, target.dataset.record, false);
                        viewRecord(target.dataset.table, target.dataset.record);
                    }
                }
                // Back to tables
                if (target.classList.contains('back-to-tables-btn')) {
                    if (database.tables.length > 0) {
                        activeTab = database.tables[0].id;
                        activeTableId = database.tables[0].id;
                        renderAll();
                    } else {
                        activeTab = 'management';
                        renderAll();
                    }
                }
            });
            
            // Event delegation for collection/tag cards
            document.addEventListener('click', e => {
                const collectionCard = e.target.closest('.collection-card');
                if (collectionCard && !e.target.closest('button')) {
                    viewCollectionDetails(collectionCard.dataset.collection);
                    return;
                }
                const tagCard = e.target.closest('.tag-card');
                if (tagCard && !e.target.closest('button')) {
                    viewTagDetails(tagCard.dataset.tag);
                    return;
                }
            });

            // Structure modal tabs
            document.querySelectorAll('.structure-tab').forEach(tab => tab.addEventListener('click', () => {
                document.querySelectorAll('.structure-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.structure-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('structure-' + tab.dataset.structureTab).classList.add('active');
            }));
            
            // Structure tree interactions
            document.getElementById('structureTreeContainer').addEventListener('click', e => {
                const toggle = e.target.closest('.tree-toggle');
                if (toggle && !toggle.classList.contains('empty')) {
                    toggleTreeNode(toggle.dataset.key, toggle.dataset.table, toggle.dataset.record);
                    return;
                }
                const loadMore = e.target.closest('.tree-load-more');
                if (loadMore && loadMore.dataset.action === 'loadAll') {
                    loadAllTreeItems(loadMore.dataset.key);
                    return;
                }
            });
            
            // Structure graph interactions
            document.getElementById('structureGraphContainer').addEventListener('click', e => {
                const node = e.target.closest('.graph-node');
                if (node) {
                    viewRecord(node.dataset.table, node.dataset.record);
                }
            });

            // Event delegation for record links (a tags)
            document.addEventListener('click', e => {
                const link = e.target.closest('a.record-link, a.tree-link');
                if (link) {
                    e.preventDefault();
                    const action = link.dataset.action;
                    const tableId = link.dataset.table;
                    const recordId = link.dataset.record;
                    if (action === 'view') {
                        viewRecord(tableId, recordId);
                    } else if (action === 'viewInModal') {
                        // Keep current modal open, open new record on top
                        viewRecord(tableId, recordId);
                    } else if (action === 'viewFromCollection') {
                        // Keep collection modal open
                        viewRecord(tableId, recordId);
                    } else if (action === 'viewFromTag') {
                        // Keep tag modal open
                        viewRecord(tableId, recordId);
                    } else if (action === 'viewFromStructure') {
                        // Keep structure modal open
                        viewRecord(tableId, recordId);
                    }
                    return;
                }
                // Collection badge/link click - keep current modal open
                const colBadge = e.target.closest('a.collection-badge, a.collection-link');
                if (colBadge) {
                    e.preventDefault();
                    const colId = colBadge.dataset.collection;
                    if (colId) {
                        viewCollectionDetails(colId);
                    }
                    return;
                }
                // Tag badge/link click - keep current modal open
                const tagBadge = e.target.closest('a.tag-badge, a.tag-link');
                if (tagBadge) {
                    e.preventDefault();
                    const tagId = tagBadge.dataset.tag;
                    if (tagId) {
                        viewTagDetails(tagId);
                    }
                    return;
                }
            });

            // Event delegation for bulk selection checkboxes
            document.addEventListener('change', e => {
                const checkbox = e.target.closest('.bulk-checkbox');
                if (!checkbox) return;
                
                const tableId = checkbox.dataset.table;
                if (checkbox.classList.contains('bulk-select-all')) {
                    toggleSelectAll(tableId, checkbox.checked);
                } else if (checkbox.classList.contains('bulk-select-row')) {
                    toggleSelectRow(tableId, checkbox.dataset.record, checkbox.checked);
                }
            });
            
            // Event delegation for bulk action buttons
            document.addEventListener('click', e => {
                const editBtn = e.target.closest('.bulk-edit-field-btn');
                if (editBtn) {
                    openBulkEditModal(editBtn.dataset.table);
                    return;
                }
                const addColBtn = e.target.closest('.bulk-add-collection-btn');
                if (addColBtn) {
                    openBulkAddToCollectionModal(addColBtn.dataset.table);
                    return;
                }
                const addTagBtn = e.target.closest('.bulk-add-tag-btn');
                if (addTagBtn) {
                    openBulkAddTagModal(addTagBtn.dataset.table);
                    return;
                }
                const deleteBtn = e.target.closest('.bulk-delete-btn');
                if (deleteBtn) {
                    bulkDelete(deleteBtn.dataset.table);
                    return;
                }
                const deselectBtn = e.target.closest('.bulk-deselect');
                if (deselectBtn) {
                    clearSelection(deselectBtn.dataset.table);
                    return;
                }
            });

            // Event delegation for group toggle
            document.addEventListener('click', e => {
                const toggle = e.target.closest('.group-toggle');
                if (!toggle) return;
                const tableId = toggle.dataset.table;
                const groupKey = toggle.dataset.group;
                if (!database.meta.groupStates) database.meta.groupStates = {};
                if (!database.meta.groupStates[tableId]) database.meta.groupStates[tableId] = {};
                database.meta.groupStates[tableId][groupKey] = !database.meta.groupStates[tableId][groupKey];
                renderTableContent(tableId);
            });

            document.addEventListener('change', e => {
                if (e.target.classList.contains('table-filter')) {
                    const tableId = e.target.dataset.table;
                    if (!tableFilters[tableId]) tableFilters[tableId] = {};
                    tableFilters[tableId][e.target.dataset.field] = e.target.value;
                    renderTableContent(tableId);
                }
                if (e.target.classList.contains('col-toggle')) {
                    const tableId = e.target.dataset.table;
                    if (!database.meta.columnVisibility[tableId]) database.meta.columnVisibility[tableId] = {};
                    database.meta.columnVisibility[tableId][e.target.dataset.field] = e.target.checked;
                    renderTableContent(tableId);
                }
                // Collection filter
                if (e.target.classList.contains('collection-filter')) {
                    collectionFilter = e.target.value || null;
                    renderTableContent(e.target.dataset.table);
                }
                // Tag filter
                if (e.target.classList.contains('tag-filter')) {
                    tagFilter = e.target.value || null;
                    renderTableContent(e.target.dataset.table);
                }
                // Assign collection checkbox
                if (e.target.classList.contains('assign-collection-cb')) {
                    const tableId = document.getElementById('assignTableId').value;
                    const recordId = document.getElementById('assignRecordId').value;
                    toggleCollectionMembership(e.target.dataset.collection, tableId, recordId, e.target.checked);
                }
                // Assign tag checkbox
                if (e.target.classList.contains('assign-tag-cb')) {
                    const tableId = document.getElementById('assignTableId').value;
                    const recordId = document.getElementById('assignRecordId').value;
                    toggleTagAssignment(e.target.dataset.tag, tableId, recordId, e.target.checked);
                }
            });

            document.addEventListener('input', e => {
                if (e.target.classList.contains('table-search')) {
                    tableSearches[e.target.dataset.table] = e.target.value;
                    renderTableContent(e.target.dataset.table);
                }
                // Sync date picker with text input
                if (e.target.classList.contains('date-picker')) {
                    const textInput = document.getElementById(e.target.id + '_text');
                    if (textInput) textInput.value = e.target.value;
                }
                if (e.target.classList.contains('date-text')) {
                    const dateInput = document.getElementById(e.target.id.replace('_text', ''));
                    if (dateInput && /^\d{4}-\d{2}-\d{2}$/.test(e.target.value)) {
                        dateInput.value = e.target.value;
                    }
                }
            });

            document.getElementById('tableContents').addEventListener('click', e => {
                const th = e.target.closest('th:not(.no-sort)');
                if (th && th.dataset.table && th.dataset.field) {
                    const tableId = th.dataset.table;
                    if (!tableSorts[tableId]) tableSorts[tableId] = { field: null, dir: 'asc' };
                    if (tableSorts[tableId].field === th.dataset.field) tableSorts[tableId].dir = tableSorts[tableId].dir === 'asc' ? 'desc' : 'asc';
                    else { tableSorts[tableId].field = th.dataset.field; tableSorts[tableId].dir = 'asc'; }
                    renderTableContent(tableId);
                }
            });

            document.querySelectorAll('[data-modal-close]').forEach(btn => btn.addEventListener('click', () => { const m = btn.closest('.modal-backdrop'); if (m) closeModal(m.id); }));
            document.querySelectorAll('.modal-backdrop').forEach(bd => bd.addEventListener('click', e => { if (e.target === bd) closeModal(bd.id); }));

            // ========== WIKI INTEGRATION ==========
            
            // Base64 helpers with UTF-8 support
            function base64Encode(str) {
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
            }
            
            function base64Decode(str) {
                return decodeURIComponent(atob(str).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            }
            
            // Find highest ID in database and update counter
            function updateIdCounter(data) {
                let maxTimestamp = 0;
                
                function extractTimestamp(id) {
                    if (!id || typeof id !== 'string') return 0;
                    // ID format: id_[timestamp in base36][random]
                    const match = id.match(/^id_([a-z0-9]+)/i);
                    if (match) {
                        try {
                            const ts = parseInt(match[1].substring(0, 8), 36);
                            return isNaN(ts) ? 0 : ts;
                        } catch (e) {
                            return 0;
                        }
                    }
                    return 0;
                }
                
                // Check all tables
                if (data.tables) {
                    data.tables.forEach(table => {
                        maxTimestamp = Math.max(maxTimestamp, extractTimestamp(table.id));
                        
                        // Check fields
                        if (table.fields) {
                            table.fields.forEach(field => {
                                maxTimestamp = Math.max(maxTimestamp, extractTimestamp(field.id));
                            });
                        }
                        
                        // Check records
                        if (table.records) {
                            table.records.forEach(record => {
                                maxTimestamp = Math.max(maxTimestamp, extractTimestamp(record.id));
                            });
                        }
                    });
                }
                
                // Ensure next generated ID will be higher
                // The generateId function uses Date.now(), so we don't need to do anything
                // as long as current time is higher than max timestamp
                // But if data was from the future (unlikely), we'd have issues
                // For safety, we could override generateId, but it's not necessary
                // as Date.now() will always be current
            }
            
            // Wiki config storage
            let wikiConfig = null;
            
            // Signal that editor is ready for receiving data
            window.jsondbEditorReady = true;
            
            // Listen for data from parent window
            window.addEventListener('message', function(event) {
                if (!event.data) return;
                
                if (event.data.type === 'loadData') {
                    // Store wiki config
                    wikiConfig = {
                        pageId: event.data.pageId,
                        instance: event.data.instance,
                        original: event.data.original
                    };
                    
                    // Show wiki save button, hide file operations
                    document.getElementById('btnSaveWiki').style.display = '';
                    
                    // Decode and load data
                    try {
                        const jsonStr = base64Decode(event.data.data);
                        const data = JSON.parse(jsonStr);
                        
                        // Update ID counter to prevent conflicts
                        updateIdCounter(data);
                        
                        // Load the database
                        loadDatabaseFromJson(data);
                        
                        // Update window title
                        document.title = data.meta?.name || 'Database Editor';
                    } catch (e) {
                        alert('Error loading data: ' + e.message);
                        console.error('Load error:', e);
                    }
                }
                
                if (event.data.type === 'saveSuccess') {
                    alert(t('wikiSaved'));
                    window.close();
                }
                
                if (event.data.type === 'saveError') {
                    alert(t('wikiSaveError') + ' ' + (event.data.error || 'Unknown error'));
                    
                    // Re-enable button
                    const btn = document.getElementById('btnSaveWiki');
                    btn.disabled = false;
                    btn.innerHTML = '<span aria-hidden="true">üì§</span> ' + t('saveToWiki');
                }
            });
            
            // Save to wiki button handler
            document.getElementById('btnSaveWiki').addEventListener('click', function() {
                if (!wikiConfig) {
                    alert('Wiki connection not available');
                    return;
                }
                
                if (!window.opener) {
                    alert('Parent window not available. Please reopen the editor from the wiki page.');
                    return;
                }
                
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<span aria-hidden="true">‚è≥</span> ' + t('wikiSaving');
                
                try {
                    const jsonStr = JSON.stringify(database, null, 2);
                    const newData = base64Encode(jsonStr);
                    
                    // Send to parent window
                    window.opener.postMessage({
                        type: 'saveData',
                        pageId: wikiConfig.pageId,
                        instance: wikiConfig.instance,
                        data: newData,
                        original: wikiConfig.original
                    }, '*');
                    
                } catch (e) {
                    alert(t('wikiSaveError') + ' ' + e.message);
                    btn.disabled = false;
                    btn.innerHTML = '<span aria-hidden="true">üì§</span> ' + t('saveToWiki');
                }
            });
            
            // ========== END WIKI INTEGRATION ==========

            loadAutoSave();
            renderAll();
        });
    </script>
</body>
</html>
