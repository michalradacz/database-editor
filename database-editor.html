<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor datab√°ze</title>
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a8a;
            --primary-dark: #0f1f33;
            --accent: #e67e22;
            --accent-light: #f39c4d;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f1c40f;
            --bg: #f8f9fa;
            --bg-card: #ffffff;
            --text: #2c3e50;
            --text-muted: #7f8c8d;
            --border: #dce1e6;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            --radius: 8px;
            --radius-lg: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }
        .skip-link { position: absolute; top: -40px; left: 0; background: var(--primary); color: white; padding: 8px 16px; z-index: 1000; text-decoration: none; }
        .skip-link:focus { top: 0; }
        .unsaved-banner { background: #fff3cd; color: #856404; padding: 0.75rem 1.5rem; text-align: center; border-bottom: 1px solid #ffc107; font-weight: 500; }
        .unsaved-banner[hidden] { display: none; }
        header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 1rem 2rem; }
        nav { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding: 0 2rem 0.5rem 2rem; }
        .header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        .header-title { font-size: 1.5rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { font-family: inherit; font-size: 0.9rem; padding: 0.5rem 1rem; border: 2px solid transparent; border-radius: var(--radius); cursor: pointer; display: inline-flex; align-items: center; gap: 0.4rem; transition: all 0.2s ease; text-decoration: none; }
        .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-primary:hover, .btn-primary:focus { background: var(--accent-light); }
        .btn-secondary { background: white; color: var(--primary); border-color: var(--border); }
        .btn-secondary:hover, .btn-secondary:focus { background: var(--bg); border-color: var(--primary); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #2ecc71; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #e74c3c; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.85rem; }
        .btn-icon { padding: 0.4rem; min-width: 32px; justify-content: center; }
        button:focus, .btn:focus { outline: 3px solid var(--accent); outline-offset: 2px; }

        /* Table Tabs */
        .table-tabs { display: flex; gap: 0; flex-wrap: wrap; align-items: flex-end; }
        .table-tab { padding: 0.6rem 1.2rem; background: rgba(255,255,255,0.1); border: none; border-radius: var(--radius) var(--radius) 0 0; cursor: pointer; color: rgba(255,255,255,0.8); font-weight: 500; transition: all 0.2s; }
        .table-tab:hover { background: rgba(255,255,255,0.2); color: white; }
        .table-tab.active { background: var(--bg); color: var(--primary); }
        .table-tab.management-tab { background: rgba(230,126,34,0.3); margin-left: auto; }
        .table-tab.management-tab.active { background: var(--accent); color: white; }
        .table-tab.classification-tab { background: rgba(155,89,182,0.3); margin-left: auto; }
        .table-tab.classification-tab.active { background: #9b59b6; color: white; }
        .table-tab.management-tab { margin-left: 0; }

        main { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); margin-bottom: 1.5rem; overflow: hidden; }
        .card-header { background: var(--bg); padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .card-header h2 { font-size: 1.1rem; font-weight: 600; color: var(--primary); }
        .card-body { padding: 1.5rem; }
        .card-footer-actions { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        
        /* Notes */
        .notes-section { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .notes-section h4 { margin: 0 0 0.75rem 0; display: flex; align-items: center; gap: 0.5rem; }
        .notes-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .note-item { padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; }
        .note-item.resolved { opacity: 0.7; background: var(--hover); }
        .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--text-muted); }
        .note-text { white-space: pre-wrap; word-break: break-word; }
        .note-actions { display: flex; gap: 0.25rem; }
        .note-actions button { padding: 0.2rem 0.4rem; font-size: 0.75rem; }
        .note-status { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.75rem; }
        .note-status.resolved { background: var(--success); color: white; }
        .note-status.unresolved { background: var(--warning); color: #000; }
        .add-note-form { margin-top: 0.75rem; }
        .add-note-form textarea { width: 100%; min-height: 60px; margin-bottom: 0.5rem; }
        .notes-table { width: 100%; }
        .notes-table th, .notes-table td { text-align: left; padding: 0.5rem; border-bottom: 1px solid var(--border); }
        .notes-table .note-preview { max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .notes-filter-bar { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .notes-badge { background: var(--danger); color: white; padding: 0.1rem 0.4rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.3rem; }
        
        /* History styles */
        .history-list { display: flex; flex-direction: column; gap: 1rem; max-height: 60vh; overflow-y: auto; }
        .history-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .history-header { display: flex; align-items: center; padding: 0.75rem 1rem; background: linear-gradient(to right, rgba(0,0,0,0.03), transparent); border-bottom: 1px solid var(--border); gap: 1rem; }
        .history-delete-btn { padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-left: auto; }
        .history-timestamp { font-weight: 600; color: var(--primary); font-size: 0.9rem; }
        .history-type { font-size: 0.7rem; padding: 0.25rem 0.6rem; border-radius: 4px; background: var(--primary-light); color: white; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .history-type.create { background: var(--success); }
        .history-type.edit { background: var(--accent); }
        .history-type.bulk { background: #9b59b6; }
        .history-changes { padding: 1rem; }
        .history-changes-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; font-weight: 600; }
        .history-fields-list { list-style: none; padding: 0; margin: 0; }
        .history-fields-list li { padding: 0.5rem 0.75rem; margin: 0.25rem 0; background: var(--bg); border-radius: 4px; border-left: 3px solid var(--primary); }
        .history-field-name { font-weight: 600; color: var(--primary); display: block; font-size: 0.85rem; margin-bottom: 0.2rem; }
        .history-field-value { color: var(--text); word-break: break-word; }
        .history-empty { color: var(--text-muted); font-style: italic; padding: 2rem; text-align: center; }
        .history-count-badge { background: var(--primary); color: white; padding: 0.1rem 0.4rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.3rem; }
        
        /* Markdown export styles */
        .markdown-preview { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; line-height: 1.5; }
        .export-actions { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        
        /* Simple mode - hide advanced features */
        .advanced-mode-toggle { display: flex; align-items: center; gap: 0.4rem; color: white; font-size: 0.85rem; margin-right: 0.5rem; }
        .advanced-mode-toggle input { width: 1rem; height: 1rem; cursor: pointer; }
        .advanced-mode-toggle label { cursor: pointer; white-space: nowrap; }
        body.simple-mode .advanced-only { display: none !important; }
        
        /* Keyboard navigation - selected row */
        .data-table tbody tr.keyboard-selected { background: var(--primary-light, #e3f2fd) !important; outline: 2px solid var(--primary); outline-offset: -2px; }
        .data-table tbody tr:focus { outline: 2px solid var(--primary); outline-offset: -2px; }
        kbd { display: inline-block; padding: 0.2rem 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-family: monospace; font-size: 0.9rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.3rem; font-weight: 500; }
        input[type="text"], input[type="number"], input[type="date"], input[type="search"], textarea, select {
            width: 100%; padding: 0.6rem 0.8rem; border: 2px solid var(--border); border-radius: var(--radius); font-family: inherit; font-size: 1rem; transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30,58,95,0.1); }
        textarea { min-height: 100px; resize: vertical; }
        .checkbox-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        .checkbox-group label { margin-bottom: 0; cursor: pointer; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th, td { padding: 0.8rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg); font-weight: 600; color: var(--primary); white-space: nowrap; cursor: pointer; user-select: none; }
        th:hover { background: #e8ecef; }
        th.sorted-asc::after { content: " ‚ñ≤"; font-size: 0.7rem; }
        th.sorted-desc::after { content: " ‚ñº"; font-size: 0.7rem; }
        th.no-sort { cursor: default; }
        th.no-sort:hover { background: var(--bg); }
        tr:hover { background: rgba(30,58,95,0.02); }
        .actions-cell { white-space: nowrap; display: flex; gap: 0.3rem; }

        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-backdrop[hidden] { display: none; }
        .modal { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); width: 100%; max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { background: var(--primary); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.2rem; font-weight: 600; }
        .modal-close { background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; line-height: 1; }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.5rem; background: var(--bg); }

        .filters-section { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: var(--bg); border-radius: var(--radius); }
        .filter-item { min-width: 150px; flex: 1; max-width: 250px; }
        .filter-item label { font-size: 0.85rem; color: var(--text-muted); }
        .filter-item select { padding: 0.4rem 0.6rem; }
        .search-box { position: relative; flex: 2; min-width: 200px; }
        .search-box input { padding-left: 2.5rem; }
        
        /* Views tabs - accessible */
        .views-bar { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; align-items: center; justify-content: space-between; }
        .views-tabs { display: flex; gap: 0.25rem; flex-wrap: wrap; }
        .views-tabs [role="tab"] { padding: 0.4rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px 6px 0 0; cursor: pointer; font-size: 0.9rem; }
        .views-tabs [role="tab"]:hover { background: var(--hover); }
        .views-tabs [role="tab"]:focus { outline: 2px solid var(--primary); outline-offset: 2px; }
        .views-tabs [role="tab"][aria-selected="true"] { background: var(--primary); color: white; border-color: var(--primary); }
        .views-actions { display: flex; gap: 0.25rem; flex-wrap: wrap; }
        .view-save-btn { padding: 0.4rem 0.6rem; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
        .view-save-btn:hover { opacity: 0.9; }
        .search-box::before { content: "üîç"; position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%); font-size: 0.9rem; }

        details { margin-top: 1rem; }
        summary { cursor: pointer; padding: 0.8rem 1rem; background: var(--bg); border-radius: var(--radius); font-weight: 500; color: var(--primary); list-style: none; display: flex; align-items: center; gap: 0.5rem; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: "‚ñ∂"; font-size: 0.7rem; transition: transform 0.2s; }
        details[open] summary::before { transform: rotate(90deg); }
        .column-toggles { padding: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; background: white; border: 1px solid var(--border); border-top: none; border-radius: 0 0 var(--radius) var(--radius); }

        .field-list { border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .field-item { display: flex; align-items: center; gap: 1rem; padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); background: white; }
        
        /* Management tables */
        .management-table { width: 100%; border-collapse: collapse; }
        .management-table th, .management-table td { padding: 0.6rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
        .management-table th { background: var(--bg); font-weight: 600; color: var(--text-muted); }
        .management-table td { vertical-align: middle; }
        .management-table .col-order { width: 70px; white-space: nowrap; }
        .management-table .col-actions { width: 150px; white-space: nowrap; }
        .management-table .col-order button { margin-right: 0.25rem; }
        .management-table .badge { margin-left: 0.5rem; }
        .field-item:last-child { border-bottom: none; }
        .field-item-info { flex: 1; }
        .field-item-name { font-weight: 600; color: var(--primary); }
        .field-item-meta { font-size: 0.85rem; color: var(--text-muted); }
        .field-item-actions { display: flex; gap: 0.3rem; }
        .move-buttons { display: flex; flex-direction: column; gap: 2px; }
        .move-buttons button { padding: 0.2rem 0.4rem; font-size: 0.75rem; }

        .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        .badge-primary { background: var(--primary-light); color: white; }
        .badge-filter { background: var(--accent); color: white; }
        .badge-group { background: #9b59b6; color: white; }

        .record-link { color: var(--primary); text-decoration: underline; cursor: pointer; background: none; border: none; font: inherit; padding: 0; display: inline; text-align: left; }
        .record-link:hover, .record-link:focus { color: var(--accent); outline: none; }

        .empty-state { text-align: center; padding: 3rem 1.5rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }

        .language-selector select { width: auto; padding: 0.4rem 0.6rem; background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.3); }
        .language-selector select option { color: var(--text); }
        .quick-create-selector select { width: auto; padding: 0.4rem 0.6rem; background: rgba(39,174,96,0.3); color: white; border-color: rgba(255,255,255,0.3); cursor: pointer; }
        .quick-create-selector select option { color: var(--text); }
        
        /* Global search */
        .global-search { position: relative; }
        .global-search input { width: 200px; padding: 0.4rem 0.75rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; background: rgba(255,255,255,0.1); color: white; font-size: 0.9rem; }
        .global-search input::placeholder { color: rgba(255,255,255,0.7); }
        .global-search input:focus { outline: none; background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.5); }
        
        /* Search results modal */
        .search-results-list { max-height: 60vh; overflow-y: auto; }
        .search-result-item { display: block; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); text-decoration: none; color: var(--text); transition: background 0.2s; }
        .search-result-item:hover { background: var(--bg); }
        .search-result-table { font-size: 0.8em; color: var(--text-muted); margin-bottom: 0.25rem; }
        .search-result-name { font-weight: 600; color: var(--primary); }
        .search-result-preview { font-size: 0.9em; color: var(--text-muted); margin-top: 0.25rem; }
        .search-result-highlight { background: rgba(241, 196, 15, 0.3); padding: 0.1em 0.2em; border-radius: 2px; }
        .search-no-results { padding: 2rem; text-align: center; color: var(--text-muted); }
        
        /* Import preview */
        .import-preview-box { margin-top: 1rem; padding: 1rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; }
        .import-preview-box h4 { margin: 0 0 0.75rem 0; font-size: 0.95rem; color: var(--text-muted); }
        .import-mapping-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .import-mapping-table th, .import-mapping-table td { padding: 0.4rem 0.6rem; border: 1px solid var(--border); text-align: left; }
        .import-mapping-table th { background: var(--border); font-weight: 600; }

        .record-count { font-size: 0.9rem; color: var(--text-muted); padding: 0.5rem 0; }
        .record-count strong { color: var(--primary); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Sub tabs for management */
        .sub-tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 1.5rem; }
        .sub-tab { padding: 0.8rem 1.5rem; background: transparent; border: none; border-bottom: 3px solid transparent; margin-bottom: -2px; cursor: pointer; font-weight: 500; color: var(--text-muted); transition: all 0.2s; }
        .sub-tab:hover { color: var(--primary); }
        .sub-tab.active { color: var(--primary); border-bottom-color: var(--accent); }
        .sub-content { display: none; }
        .sub-content.active { display: block; }

        .view-field { margin-bottom: 1.2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .view-field:last-child { border-bottom: none; margin-bottom: 0; }
        .view-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem; }
        .view-field-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .view-field-value { font-size: 1rem; color: var(--text); }
        .view-field-value.empty { font-style: italic; color: var(--text-muted); }
        .copy-field-btn { padding: 0.15rem 0.4rem; font-size: 0.75rem; }

        /* Collections and Tags */
        .tag-badge, .collection-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.15rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            margin: 0.1rem;
            text-decoration: none;
            color: white;
            cursor: pointer;
            white-space: nowrap;
        }
        .tag-badge:hover, .collection-badge:hover { opacity: 0.85; }
        .tag-badge { background: #e74c3c; }
        .collection-badge { background: #4a90d9; }
        .badges-cell { display: flex; flex-wrap: wrap; gap: 0.2rem; }
        .checkbox-list { display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; }
        .checkbox-list label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .checkbox-list .color-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .record-badges { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .record-badges-section { margin-bottom: 0.5rem; }
        .record-badges-section strong { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .related-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .related-group { margin-bottom: 1rem; }
        .related-group-title { font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .related-list { list-style: none; padding: 0; margin: 0 0 0 1rem; }
        .related-list li { padding: 0.25rem 0; }
        .related-table-name { font-size: 0.8rem; color: var(--text-muted); }
        .collection-view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .filters-row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; }
        .date-input-group { display: flex; gap: 0.5rem; align-items: center; }
        .date-input-group .date-picker { flex: 1; min-width: 140px; }
        .date-input-group .date-text { width: 110px; font-family: monospace; text-align: center; }
        .date-input-group .date-clear-btn { padding: 0.4rem 0.6rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 1rem; line-height: 1; }
        .date-input-group .date-clear-btn:hover { background: #fee; border-color: #e74c3c; }
        .date-format-help { margin-top: 0.5rem; font-size: 0.85rem; }
        .date-format-help summary { cursor: pointer; color: var(--primary); }
        .format-help-content { background: var(--bg); padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; }
        .format-help-content p { margin: 0.25rem 0; }
        .format-help-content ul { margin: 0.25rem 0 0 1.5rem; padding: 0; }
        .format-help-content code { background: var(--border); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.9em; }
        
        /* Collections and Tags grid */
        .collections-grid, .tags-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .collection-card, .tag-card { border: 1px solid var(--border); border-radius: 8px; padding: 1rem; background: var(--card-bg); cursor: pointer; transition: box-shadow 0.2s, transform 0.1s; }
        .collection-card:hover, .tag-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .collection-card-header, .tag-card-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
        .collection-card-color { width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0; }
        .collection-card-name, .tag-card-name { font-weight: 600; font-size: 1.1rem; flex: 1; }
        .collection-card-count, .tag-card-count { font-size: 0.85rem; color: var(--text-muted); }
        .collection-card-desc { font-size: 0.9rem; color: var(--text-muted); margin-top: 0.5rem; max-height: 3em; overflow: hidden; text-overflow: ellipsis; }
        
        /* Record badges section */
        .record-classification { margin-bottom: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.03); border-radius: 8px; }
        .record-classification-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .record-classification-row:last-child { margin-bottom: 0; }
        .record-classification-label { font-weight: 600; font-size: 0.85rem; color: var(--text-muted); min-width: 70px; }
        .record-classification-items { display: flex; flex-wrap: wrap; gap: 0.25rem; flex: 1; }
        .add-classification-btn { padding: 0.15rem 0.5rem; font-size: 0.75rem; border-radius: 1rem; }
        
        /* Collection/Tag detail view */
        .collection-detail-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .collection-detail-color { width: 48px; height: 48px; border-radius: 50%; }
        .collection-detail-info { flex: 1; }
        .collection-detail-name { font-size: 1.5rem; font-weight: 600; margin: 0; }
        .collection-detail-count { color: var(--text-muted); }
        .collection-detail-desc { margin: 1rem 0; padding: 1rem; background: rgba(0,0,0,0.03); border-radius: 8px; }
        .collection-members-list { list-style: none; padding: 0; margin: 0; }
        .collection-members-list li { padding: 0.5rem 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .collection-members-list li:last-child { border-bottom: none; }
        .member-table-name { font-size: 0.8rem; color: var(--text-muted); margin-left: 0.5rem; }
        .remove-badge-btn { background: transparent; border: none; color: white; cursor: pointer; padding: 0 0.25rem; margin-left: 0.25rem; font-size: 0.7rem; opacity: 0.7; }
        .remove-badge-btn:hover { opacity: 1; }
        .collection-badge, .tag-badge { display: inline-flex; align-items: center; }
        .children-list { list-style: none; padding: 0; }
        .children-list li { padding: 0.3rem 0; }

        /* Markdown styles */
        .markdown-content { line-height: 1.7; }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { margin: 1rem 0 0.5rem; color: var(--primary); }
        .markdown-content h1 { font-size: 1.5rem; }
        .markdown-content h2 { font-size: 1.3rem; }
        .markdown-content h3 { font-size: 1.1rem; }
        .markdown-content p { margin-bottom: 0.8rem; }
        .markdown-content ul, .markdown-content ol { margin: 0.5rem 0 0.5rem 1.5rem; }
        .markdown-content li { margin-bottom: 0.3rem; }
        .markdown-content code { background: var(--bg); padding: 0.2rem 0.4rem; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 0.9em; }
        .markdown-content pre { background: var(--bg); padding: 1rem; border-radius: var(--radius); overflow-x: auto; margin: 0.5rem 0; }
        .markdown-content pre code { background: none; padding: 0; }
        .markdown-content blockquote { border-left: 4px solid var(--accent); padding-left: 1rem; margin: 0.5rem 0; color: var(--text-muted); }
        .markdown-content a { color: var(--primary); }
        .markdown-content strong { font-weight: 600; }
        .markdown-content em { font-style: italic; }
        .markdown-content hr { border: none; border-top: 1px solid var(--border); margin: 1rem 0; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .stat-card { background: var(--bg); padding: 1.5rem; border-radius: var(--radius); text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; }

        /* Generator */
        .field-buttons { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.5rem; }
        .field-btn { padding: 0.3rem 0.6rem; font-size: 0.8rem; background: var(--primary-light); color: white; border: none; border-radius: var(--radius); cursor: pointer; }
        .field-btn:hover { background: var(--primary); }
        .generator-output { background: var(--bg); padding: 1rem; border-radius: var(--radius); font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; margin-top: 1rem; }

        /* Radio group */
        .radio-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .radio-group label { display: flex; align-items: center; gap: 0.3rem; cursor: pointer; }
        .radio-group input { width: 18px; height: 18px; }

        /* Export/Import tabs */
        .format-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .format-tab { padding: 0.5rem 1rem; background: var(--bg); border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; }
        .format-tab.active { background: var(--primary); color: white; border-color: var(--primary); }

        .inline-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        /* Group styles */
        .group-header th { 
            background: var(--bg); 
            padding: 0; 
            text-align: left;
            border-top: 2px solid var(--border);
        }
        .group-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            text-align: left;
        }
        .group-toggle:hover { background: rgba(0,0,0,0.05); }
        .group-toggle:focus { outline: 2px solid var(--primary); outline-offset: -2px; }
        .group-icon { font-size: 0.75rem; width: 1rem; }
        
        /* URL link styles */
        .url-link { color: var(--primary); text-decoration: underline; }
        .url-link:hover { color: var(--secondary); }

        /* Structure modal styles */
        .structure-modal { max-width: 900px; width: 95vw; max-height: 90vh; display: flex; flex-direction: column; }
        .structure-modal .modal-body { flex: 1; overflow: hidden; padding: 0; }
        .structure-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg); }
        .structure-tab { flex: 1; padding: 0.75rem; border: none; background: none; cursor: pointer; font-size: 0.95rem; border-bottom: 3px solid transparent; }
        .structure-tab:hover { background: rgba(0,0,0,0.05); }
        .structure-tab.active { border-bottom-color: var(--primary); font-weight: 600; }
        .structure-body { height: 60vh; }
        .structure-content { display: none; height: 100%; overflow: auto; padding: 1rem; }
        .structure-content.active { display: block; }
        
        /* Tree styles */
        .tree-root { list-style: none; padding: 0; margin: 0; }
        .tree-item { margin: 0.25rem 0; }
        .tree-toggle { background: none; border: none; cursor: pointer; padding: 0.25rem; margin-right: 0.25rem; font-size: 0.8rem; width: 1.5rem; color: var(--text-muted); }
        .tree-toggle:hover { color: var(--primary); }
        .tree-toggle.empty { visibility: hidden; }
        .tree-link { color: var(--primary); text-decoration: none; }
        .tree-link:hover { text-decoration: underline; }
        .tree-count { color: var(--text-muted); font-size: 0.85rem; margin-left: 0.25rem; }
        .tree-table { color: var(--text-muted); font-size: 0.85rem; margin-left: 0.25rem; }
        .tree-children { list-style: none; padding-left: 1.5rem; margin: 0; border-left: 1px dashed var(--border); margin-left: 0.75rem; }
        .tree-children.collapsed { display: none; }
        .tree-load-more { color: var(--primary); cursor: pointer; font-style: italic; padding: 0.25rem 0; }
        .tree-load-more:hover { text-decoration: underline; }
        .tree-empty { color: var(--text-muted); font-style: italic; }
        
        /* Structure ancestors breadcrumb */
        .structure-ancestors { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem; }
        .ancestors-label { font-weight: 600; color: var(--text-muted); margin-right: 0.5rem; }
        .ancestors-path { display: flex; flex-wrap: wrap; align-items: center; gap: 0.25rem; margin-top: 0.5rem; }
        .ancestor-link { color: var(--primary); text-decoration: none; padding: 0.25rem 0.5rem; border-radius: 4px; background: rgba(74, 144, 217, 0.1); transition: background 0.2s; }
        .ancestor-link:hover { background: rgba(74, 144, 217, 0.2); text-decoration: none; }
        .ancestor-table { font-size: 0.8em; color: var(--text-muted); }
        .ancestor-count { font-size: 0.8em; color: var(--text-muted); margin-left: 0.25rem; }
        .ancestor-separator { color: var(--text-muted); margin: 0 0.25rem; }
        .ancestor-current { font-weight: 600; color: var(--text); padding: 0.25rem 0.5rem; background: var(--primary); color: white; border-radius: 4px; }
        
        /* Tree notes */
        .tree-notes-toggle { background: none; border: none; cursor: pointer; font-size: 0.85rem; color: var(--primary); padding: 0.1rem 0.3rem; margin-left: 0.25rem; border-radius: 3px; }
        .tree-notes-toggle:hover { background: rgba(74, 144, 217, 0.1); }
        .tree-notes-container { background: #fffbe6; border: 1px solid #ffe58f; border-radius: 6px; padding: 0.5rem 0.75rem; margin: 0.25rem 0 0.25rem 1.5rem; font-size: 0.9rem; }
        .tree-note-item { padding: 0.25rem 0; border-bottom: 1px dashed #ffe58f; }
        .tree-note-item:last-child { border-bottom: none; }
        .tree-note-status { margin-right: 0.3rem; }
        .tree-note-text { color: var(--text); }
        .tree-note-resolved { opacity: 0.6; text-decoration: line-through; }
        
        /* Graph styles */
        #structureGraphContainer { width: 100%; height: 100%; overflow: auto; }
        .graph-svg { display: block; }
        .graph-node { cursor: pointer; }
        .graph-node rect { fill: var(--card-bg); stroke: var(--border); stroke-width: 1.5px; rx: 4; }
        .graph-node:hover rect { stroke: var(--primary); stroke-width: 2px; }
        .graph-node text { font-size: 12px; fill: var(--text); }
        .graph-link { fill: none; stroke: var(--border); stroke-width: 1.5px; }
        
        /* Bulk selection styles */
        .bulk-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .bulk-actions-bar { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: var(--primary); color: white; border-radius: 8px; margin-bottom: 1rem; flex-wrap: wrap; }
        .bulk-actions-bar .bulk-count { font-weight: 600; margin-right: 0.5rem; }
        .bulk-actions-bar .btn { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white; }
        .bulk-actions-bar .btn:hover { background: rgba(255,255,255,0.3); }
        .bulk-actions-bar .btn-danger { background: rgba(231,76,60,0.8); }
        .bulk-actions-bar .btn-danger:hover { background: rgba(231,76,60,1); }
        .bulk-deselect { background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; padding: 0.25rem; margin-left: auto; }
        .bulk-deselect:hover { opacity: 0.8; }
        th.checkbox-col, td.checkbox-col { width: 40px; text-align: center; }
        
        /* Bulk edit rows */
        .bulk-edit-row { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; }
        .bulk-edit-row-header { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
        .bulk-edit-row-header select { flex: 1; }
        .bulk-edit-row-header .bulk-edit-remove-row { padding: 0.25rem 0.5rem; }
        .bulk-edit-value-container { margin-top: 0.5rem; }
        .bulk-edit-value-container input, .bulk-edit-value-container select, .bulk-edit-value-container textarea { width: 100%; }
        
        /* View record sections */
        .view-record-section { margin-bottom: 1.5rem; }
        .view-record-section-title { font-size: 1.1rem; font-weight: 600; color: var(--text-muted); margin: 0 0 0.75rem 0; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem; }

        @media (max-width: 768px) {
            header { padding: 1rem; }
            main { padding: 1rem; }
            .card-body { padding: 1rem; }
            .modal { max-height: 95vh; }
            .table-tabs { flex-wrap: nowrap; overflow-x: auto; }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link" data-i18n="skipToContent">P≈ôeskoƒçit na hlavn√≠ obsah</a>
    
    <div id="unsavedBanner" class="unsaved-banner" hidden role="alert">
        <span data-i18n="unsavedChanges">‚ö†Ô∏è Zmƒõnili jste obsah datab√°ze. Nezapome≈àte ji ulo≈æit.</span>
    </div>

    <header>
        <div class="header-top">
            <div class="header-title">
                <span data-i18n="appName">Editor datab√°ze</span>
            </div>
            <div class="header-actions">
                <button type="button" class="btn btn-primary" id="btnSaveWiki" style="display:none;" accesskey="s"><span aria-hidden="true">üì§</span> <span data-i18n="saveToWiki">Ulo≈æit na wiki</span></button>
                <button type="button" class="btn btn-secondary advanced-only" id="btnNew"><span aria-hidden="true">üìÑ</span> <span data-i18n="newDb">Nov√°</span></button>
                <button type="button" class="btn btn-secondary advanced-only" id="btnLoad"><span aria-hidden="true">üìÇ</span> <span data-i18n="load">Naƒç√≠st</span></button>
                <button type="button" class="btn btn-primary" id="btnSave" accesskey="s"><span aria-hidden="true">üíæ</span> <span data-i18n="save">Ulo≈æit</span></button>
                <button type="button" class="btn btn-secondary advanced-only" id="btnCopyJson"><span aria-hidden="true">üìã</span> <span data-i18n="copyJson">Kop√≠rovat JSON</span></button>
                <button type="button" class="btn btn-secondary advanced-only" id="btnPasteJson"><span aria-hidden="true">üì•</span> <span data-i18n="pasteJson">Vlo≈æit JSON</span></button>
                <div class="global-search">
                    <input type="search" id="globalSearchInput" placeholder="üîç Hledat..." data-i18n-placeholder="globalSearchPlaceholder" aria-label="Glob√°ln√≠ vyhled√°v√°n√≠">
                </div>
                <div class="quick-create-selector">
                    <select id="quickCreateSelect" aria-label="Rychl√© vytvo≈ôen√≠ z√°znamu" accesskey="q">
                        <option value="" data-i18n="quickCreate">‚ûï Nov√Ω z√°znam...</option>
                    </select>
                </div>
                <div class="advanced-mode-toggle">
                    <input type="checkbox" id="advancedModeToggle" accesskey="x">
                    <label for="advancedModeToggle" data-i18n="allFeatures">V≈°echny funkce</label>
                </div>
                <div class="language-selector advanced-only">
                    <select id="langSelect" aria-label="Jazyk">
                        <option value="cs">üá®üáø ƒåe≈°tina</option>
                        <option value="en">üá¨üáß English</option>
                    </select>
                </div>
            </div>
        </div>
        <input type="file" id="fileInput" accept=".jsondb" hidden>
    </header>

    <nav aria-label="Tabulky datab√°ze">
        <div class="table-tabs" id="tableTabs" role="tablist"></div>
    </nav>

    <main id="main-content">
        <div id="tableContents"></div>

        <!-- Classification Section (Zat≈ô√≠dƒõn√≠) -->
        <div class="tab-content" id="classification-content">
            <div class="sub-tabs">
                <button type="button" class="sub-tab active" data-subtab="class-collections" data-i18n="collections" accesskey="c">Kolekce</button>
                <button type="button" class="sub-tab" data-subtab="class-tags" data-i18n="tags" accesskey="t">Tagy</button>
                <button type="button" class="sub-tab" data-subtab="class-notes" data-i18n="notes" accesskey="m">Pozn√°mky</button>
            </div>

            <!-- Collections Sub-tab -->
            <div class="sub-content active" id="class-collections">
                <div class="card">
                    <div class="card-header">
                        <h2 data-i18n="collections">Kolekce</h2>
                        <button type="button" class="btn btn-success" id="btnAddCollection"><span aria-hidden="true">‚ûï</span> <span data-i18n="addCollection">P≈ôidat kolekci</span></button>
                    </div>
                    <div class="card-body">
                        <div class="collections-grid" id="collectionsList"></div>
                        <div id="emptyCollections" class="empty-state" hidden>
                            <div class="empty-state-icon">üìÅ</div>
                            <p data-i18n="noCollections">Zat√≠m nem√°te ≈æ√°dn√© kolekce.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tags Sub-tab -->
            <div class="sub-content" id="class-tags">
                <div class="card">
                    <div class="card-header">
                        <h2 data-i18n="tags">Tagy</h2>
                        <button type="button" class="btn btn-success" id="btnAddTag"><span aria-hidden="true">‚ûï</span> <span data-i18n="addTag">P≈ôidat tag</span></button>
                    </div>
                    <div class="card-body">
                        <div class="tags-grid" id="tagsList"></div>
                        <div id="emptyTags" class="empty-state" hidden>
                            <div class="empty-state-icon">üè∑Ô∏è</div>
                            <p data-i18n="noTags">Zat√≠m nem√°te ≈æ√°dn√© tagy.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Notes Sub-tab -->
            <div class="sub-content" id="class-notes">
                <div class="card">
                    <div class="card-header">
                        <h2 data-i18n="notes">Pozn√°mky</h2>
                    </div>
                    <div class="card-body">
                        <div class="notes-filter-bar">
                            <button type="button" class="btn btn-sm btn-secondary notes-filter-btn active" data-filter="all" data-i18n="allNotes">V≈°echny</button>
                            <button type="button" class="btn btn-sm btn-secondary notes-filter-btn" data-filter="unresolved" data-i18n="unresolvedNotes">Nevy≈ô√≠zen√©</button>
                            <button type="button" class="btn btn-sm btn-secondary notes-filter-btn" data-filter="resolved" data-i18n="resolvedNotes">Vy≈ô√≠zen√©</button>
                        </div>
                        <div id="notesListGlobal"></div>
                        <div id="emptyNotes" class="empty-state" hidden>
                            <div class="empty-state-icon">üìù</div>
                            <p data-i18n="noNotesInDatabase">V datab√°zi nejsou ≈æ√°dn√© pozn√°mky.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Management Section -->
        <div class="tab-content" id="management-content">
            <div class="sub-tabs">
                <button type="button" class="sub-tab active" data-subtab="sub-database" data-i18n="database">Datab√°ze</button>
                <button type="button" class="sub-tab" data-subtab="sub-tables" data-i18n="tables">Tabulky</button>
                <button type="button" class="sub-tab" data-subtab="sub-tools" data-i18n="tools">N√°stroje</button>
                <button type="button" class="sub-tab" data-subtab="sub-shortcuts" data-i18n="keyboardShortcuts">Kl√°vesov√© zkratky</button>
            </div>

            <!-- Database Sub-tab -->
            <div class="sub-content active" id="sub-database">
                <div class="card">
                    <div class="card-header"><h2 data-i18n="databaseSettings">Nastaven√≠ datab√°ze</h2></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="dbNameInput" data-i18n="dbName">N√°zev datab√°ze</label>
                            <input type="text" id="dbNameInput" placeholder="N√°zev datab√°ze">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tables Sub-tab -->
            <div class="sub-content" id="sub-tables">
                <div class="card">
                    <div class="card-header">
                        <h2 data-i18n="tablesList">Seznam tabulek</h2>
                        <button type="button" class="btn btn-success" id="btnAddTable"><span aria-hidden="true">‚ûï</span> <span data-i18n="addTable">P≈ôidat tabulku</span></button>
                    </div>
                    <div class="card-body">
                        <div class="field-list" id="tablesList"></div>
                        <div id="emptyTables" class="empty-state" hidden>
                            <div class="empty-state-icon">üìÅ</div>
                            <p data-i18n="noTables">Zat√≠m nem√°te ≈æ√°dn√© tabulky.</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="fieldsCard" hidden>
                    <div class="card-header">
                        <h2><span data-i18n="fieldsFor">Pole pro tabulku:</span> <span id="fieldsTableName"></span></h2>
                        <button type="button" class="btn btn-success" id="btnAddField"><span aria-hidden="true">‚ûï</span> <span data-i18n="addField">P≈ôidat pole</span></button>
                    </div>
                    <div class="card-body">
                        <div class="field-list" id="fieldList"></div>
                        <div id="emptyFields" class="empty-state" hidden>
                            <div class="empty-state-icon">üìù</div>
                            <p data-i18n="noFields">Zat√≠m nem√°te definov√°na ≈æ√°dn√° pole.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tools Sub-tab -->
            <div class="sub-content" id="sub-tools">
                <div class="card">
                    <div class="card-header"><h2 data-i18n="statistics">Statistiky</h2></div>
                    <div class="card-body">
                        <div class="stats-grid" id="statsGrid"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h2 data-i18n="textGenerator">Generov√°n√≠ textu</h2></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="generatorTable" data-i18n="selectTable">Vyberte tabulku</label>
                            <select id="generatorTable"></select>
                        </div>
                        <div class="form-group">
                            <label data-i18n="insertField">Vlo≈æit pole:</label>
                            <div class="field-buttons" id="generatorFieldButtons"></div>
                        </div>
                        <div class="form-group">
                            <label for="generatorTemplate" data-i18n="template">≈†ablona (pou≈æijte {n√°zev_pole})</label>
                            <textarea id="generatorTemplate" rows="4" placeholder="P≈ô√≠klad: {Jm√©no} m√° {Vƒõk} let."></textarea>
                        </div>
                        <div class="form-group">
                            <label data-i18n="recordsToGenerate">Z√°znamy:</label>
                            <div class="radio-group">
                                <label><input type="radio" name="genRecords" value="all" checked> <span data-i18n="allRecords">V≈°echny</span></label>
                                <label><input type="radio" name="genRecords" value="filtered"> <span data-i18n="filteredRecords">Filtrovan√©</span></label>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="btnGenerate"><span aria-hidden="true">‚ö°</span> <span data-i18n="generate">Generovat</span></button>
                        <div class="generator-output" id="generatorOutput" hidden></div>
                        <div class="inline-actions" style="margin-top: 0.5rem;">
                            <button type="button" class="btn btn-sm btn-secondary" id="btnCopyGenerated" hidden><span aria-hidden="true">üìã</span> <span data-i18n="copy">Kop√≠rovat</span></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Keyboard Shortcuts Sub-tab -->
            <div class="sub-content" id="sub-shortcuts">
                <div class="card">
                    <div class="card-header"><h2 data-i18n="keyboardShortcuts">Kl√°vesov√© zkratky</h2></div>
                    <div class="card-body">
                        <p style="margin-bottom: 1rem; color: var(--text-muted);" data-i18n="shortcutDescription">Kl√°vesov√© zkratky pou≈æ√≠vaj√≠ modifik√°tor prohl√≠≈æeƒçe (Alt, Alt+Shift, Ctrl+Option)</p>
                        <table class="management-table">
                            <thead><tr>
                                <th data-i18n="accesskeyModifier">Modifik√°tor + kl√°vesa</th>
                                <th data-i18n="description">Popis</th>
                            </tr></thead>
                            <tbody>
                                <tr><td><kbd>Mod</kbd>+<kbd>S</kbd></td><td data-i18n="shortcutSave">Ulo≈æit datab√°zi</td></tr>
                                <tr><td><kbd>Mod</kbd>+<kbd>X</kbd></td><td data-i18n="shortcutToggleMode">P≈ôepnout re≈æim (z√°kladn√≠/pokroƒçil√Ω)</td></tr>
                                <tr><td><kbd>Mod</kbd>+<kbd>N</kbd></td><td data-i18n="shortcutNewRecord">Nov√Ω z√°znam v aktu√°ln√≠ tabulce</td></tr>
                                <tr><td><kbd>Mod</kbd>+<kbd>Q</kbd></td><td data-i18n="shortcutQuickCreate">Rychl√© vytvo≈ôen√≠ z√°znamu</td></tr>
                                <tr><td><kbd>Mod</kbd>+<kbd>U</kbd></td><td data-i18n="shortcutSaveRecord">Ulo≈æit z√°znam (v mod√°lu)</td></tr>
                                <tr><td><kbd>Mod</kbd>+<kbd>Z</kbd></td><td data-i18n="shortcutClassification">P≈ôej√≠t do zat≈ô√≠dƒõn√≠</td></tr>
                                <tr><td><kbd>Mod</kbd>+<kbd>C</kbd></td><td data-i18n="shortcutCollections">P≈ôej√≠t do kolekc√≠</td></tr>
                                <tr><td><kbd>Mod</kbd>+<kbd>T</kbd></td><td data-i18n="shortcutTags">P≈ôej√≠t do tag≈Ø</td></tr>
                                <tr><td><kbd>Mod</kbd>+<kbd>M</kbd></td><td data-i18n="shortcutNotes">P≈ôej√≠t do pozn√°mek</td></tr>
                            </tbody>
                        </table>
                        <h3 style="margin-top: 1.5rem; margin-bottom: 0.75rem;" data-i18n="directShortcuts">P≈ô√≠m√© zkratky (bez modifik√°toru)</h3>
                        <table class="management-table">
                            <thead><tr>
                                <th data-i18n="key">Kl√°vesa</th>
                                <th data-i18n="description">Popis</th>
                            </tr></thead>
                            <tbody>
                                <tr><td><kbd>‚Üë</kbd> <kbd>‚Üì</kbd></td><td data-i18n="shortcutArrows">Navigace v tabulce</td></tr>
                                <tr><td><kbd>E</kbd></td><td data-i18n="shortcutEdit">Upravit vybran√Ω z√°znam</td></tr>
                                <tr><td><kbd>V</kbd></td><td data-i18n="shortcutView">Zobrazit vybran√Ω z√°znam</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Table Modal -->
    <div class="modal-backdrop" id="tableModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="tableModalTitle" data-i18n="addTable">P≈ôidat tabulku</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="tableName" data-i18n="tableName">N√°zev tabulky</label>
                    <input type="text" id="tableName" required>
                </div>
                <input type="hidden" id="tableId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnSaveTable" data-i18n="save">Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- Field Modal -->
    <div class="modal-backdrop" id="fieldModal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h2 id="fieldModalTitle" data-i18n="addField">P≈ôidat pole</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="fieldName" data-i18n="fieldName">N√°zev pole</label>
                    <input type="text" id="fieldName" required>
                </div>
                <div class="form-group">
                    <label for="fieldType" data-i18n="fieldType">Typ pole</label>
                    <select id="fieldType">
                        <option value="text">Text</option>
                        <option value="textarea">V√≠ce≈ô√°dkov√Ω text / Markdown</option>
                        <option value="number">ƒå√≠slo</option>
                        <option value="date">Datum</option>
                        <option value="url">URL odkaz</option>
                        <option value="boolean">Ano/Ne</option>
                        <option value="select">V√Ωbƒõr ze seznamu</option>
                        <option value="composite">Slo≈æen√Ω</option>
                        <option value="parent">Nad≈ôazen√Ω z√°znam</option>
                        <option value="children">Pod≈ô√≠zen√© z√°znamy</option>
                    </select>
                </div>
                <div class="form-group" id="fieldOptionsGroup" hidden>
                    <label for="fieldOptions" data-i18n="selectOptions">Hodnoty (oddƒõlen√© ƒç√°rkou)</label>
                    <input type="text" id="fieldOptions">
                </div>
                <div class="form-group" id="dateFormatGroup" hidden>
                    <label for="dateFormat" data-i18n="dateFormat">Form√°t data</label>
                    <input type="text" id="dateFormat" placeholder="j. n. Y">
                    <details class="date-format-help">
                        <summary data-i18n="dateFormatHelp">N√°povƒõda k form√°tu</summary>
                        <div class="format-help-content">
                            <p><strong data-i18n="dateFormatDay">Den:</strong> <code>d</code> (01-31), <code>j</code> (1-31)</p>
                            <p><strong data-i18n="dateFormatMonth">Mƒõs√≠c:</strong> <code>m</code> (01-12), <code>n</code> (1-12), <code>M</code> (Led), <code>F</code> (Leden)</p>
                            <p><strong data-i18n="dateFormatYear">Rok:</strong> <code>Y</code> (2024), <code>y</code> (24)</p>
                            <p><strong data-i18n="dateFormatWeekday">Den v t√Ωdnu:</strong> <code>D</code> (Po), <code>l</code> (Pondƒõl√≠), <code>N</code> (1-7)</p>
                            <p><strong data-i18n="dateFormatExamples">P≈ô√≠klady:</strong></p>
                            <ul>
                                <li><code>j. n. Y</code> ‚Üí 5. 1. 2024</li>
                                <li><code>d.m.Y</code> ‚Üí 05.01.2024</li>
                                <li><code>D j. F Y</code> ‚Üí P√° 5. Ledna 2024</li>
                                <li><code>Y-m-d</code> ‚Üí 2024-01-05</li>
                            </ul>
                        </div>
                    </details>
                </div>
                <div class="form-group" id="compositeTemplateGroup" hidden>
                    <label data-i18n="compositeFields">Vlo≈æit pole:</label>
                    <div class="field-buttons" id="compositeFieldButtons"></div>
                    <label for="compositeTemplate" data-i18n="compositeTemplate">≈†ablona slo≈æen√©ho pole</label>
                    <textarea id="compositeTemplate" rows="2" placeholder="{Pole1} - {Pole2}"></textarea>
                </div>
                <div class="form-group" id="targetTableGroup" hidden>
                    <label for="targetTable" data-i18n="targetTable">C√≠lov√° tabulka</label>
                    <select id="targetTable"></select>
                </div>
                <div class="form-group" id="parentFieldGroup" hidden>
                    <label for="parentField" data-i18n="parentFieldSelect">Pole odkazuj√≠c√≠ zpƒõt</label>
                    <select id="parentField"></select>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="fieldPrimary">
                    <label for="fieldPrimary" data-i18n="fieldPrimary">Prim√°rn√≠ (n√°zev z√°znamu)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="fieldFilter">
                    <label for="fieldFilter" data-i18n="fieldFilter">Povolit filtrov√°n√≠</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="fieldGroup">
                    <label for="fieldGroup" data-i18n="fieldGroup">Seskupovat z√°znamy</label>
                </div>
                <input type="hidden" id="fieldId">
                <input type="hidden" id="fieldTableId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnSaveField" data-i18n="save">Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- Record Modal -->
    <div class="modal-backdrop" id="recordModal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h2 id="recordModalTitle" data-i18n="addRecord">P≈ôidat z√°znam</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body"><form id="recordForm"></form></div>
            <div class="modal-footer">
                <div class="checkbox-group" style="margin-right: auto;"><input type="checkbox" id="openAfterSave"><label for="openAfterSave" data-i18n="openAfterSave">Otev≈ô√≠t zobrazen√≠</label></div>
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-secondary" id="btnSaveAndAddAnother" hidden><span aria-hidden="true">‚ûï</span> <span data-i18n="saveAndAddAnother">Ulo≈æit a p≈ôidat dal≈°√≠</span></button>
                <button type="button" class="btn btn-primary" id="btnSaveRecord" data-i18n="save" accesskey="u">Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- View Record Modal -->
    <div class="modal-backdrop" id="viewRecordModal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h2 id="viewRecordModalTitle">Z√°znam</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body" id="viewRecordContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
                <button type="button" class="btn btn-secondary" id="btnRefreshView" title="Obnovit obsah"><span aria-hidden="true">üîÑ</span> <span data-i18n="refresh">Obnovit</span></button>
                <button type="button" class="btn btn-secondary" id="btnStructureFromView"><span aria-hidden="true">üå≥</span> <span data-i18n="structure">Struktura</span></button>
                <button type="button" class="btn btn-secondary" id="btnHistoryView"><span aria-hidden="true">üìú</span> <span data-i18n="history">Historie</span></button>
                <button type="button" class="btn btn-secondary" id="btnExportMarkdown"><span aria-hidden="true">üìÑ</span> <span data-i18n="exportMarkdown">Export MD</span></button>
                <button type="button" class="btn btn-secondary" id="btnDuplicateRecord"><span aria-hidden="true">üìã</span> <span data-i18n="duplicate">Duplikovat</span></button>
                <button type="button" class="btn btn-secondary" id="btnToggleLock"><span aria-hidden="true">üîí</span> <span data-i18n="lockRecord">Zamknout</span></button>
                <button type="button" class="btn btn-primary" id="btnEditFromView" data-i18n="edit">Upravit</button>
            </div>
        </div>
    </div>

    <!-- Collection Modal -->
    <div class="modal-backdrop" id="collectionModal" hidden>
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="collectionModalTitle" data-i18n="addCollection">P≈ôidat kolekci</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="collectionName" data-i18n="collectionName">N√°zev kolekce</label>
                    <input type="text" id="collectionName">
                </div>
                <div class="form-group">
                    <label for="collectionColor" data-i18n="color">Barva</label>
                    <input type="color" id="collectionColor" value="#4a90d9" style="width: 60px; height: 36px;">
                </div>
                <div class="form-group">
                    <label for="collectionDescription" data-i18n="collectionDescription">Popis kolekce</label>
                    <textarea id="collectionDescription" rows="5" placeholder="Markdown podporov√°n..."></textarea>
                </div>
                <input type="hidden" id="collectionId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnSaveCollection" data-i18n="save">Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- Tag Modal -->
    <div class="modal-backdrop" id="tagModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="tagModalTitle" data-i18n="addTag">P≈ôidat tag</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="tagName" data-i18n="tagName">N√°zev tagu</label>
                    <input type="text" id="tagName">
                </div>
                <div class="form-group">
                    <label for="tagColor" data-i18n="color">Barva</label>
                    <input type="color" id="tagColor" value="#e74c3c" style="width: 60px; height: 36px;">
                </div>
                <input type="hidden" id="tagId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnSaveTag" data-i18n="save">Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- View Collection Modal -->
    <div class="modal-backdrop" id="viewCollectionModal" hidden>
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="viewCollectionModalTitle">Kolekce</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body" id="viewCollectionContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
                <button type="button" class="btn btn-secondary" id="btnRefreshCollection" title="Obnovit obsah"><span aria-hidden="true">üîÑ</span></button>
                <button type="button" class="btn btn-danger" id="btnDeleteCollectionFromView" data-i18n="delete">Smazat</button>
                <button type="button" class="btn btn-primary" id="btnEditCollectionFromView" data-i18n="edit">Upravit</button>
            </div>
        </div>
    </div>

    <!-- View Tag Modal -->
    <div class="modal-backdrop" id="viewTagModal" hidden>
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="viewTagModalTitle">Tag</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body" id="viewTagContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
                <button type="button" class="btn btn-secondary" id="btnRefreshTag" title="Obnovit obsah"><span aria-hidden="true">üîÑ</span></button>
                <button type="button" class="btn btn-danger" id="btnDeleteTagFromView" data-i18n="delete">Smazat</button>
                <button type="button" class="btn btn-primary" id="btnEditTagFromView" data-i18n="edit">Upravit</button>
            </div>
        </div>
    </div>

    <!-- Add To Collection Modal -->
    <div class="modal-backdrop" id="addToCollectionModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 data-i18n="addToCollection">P≈ôidat do kolekce</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="selectCollection">Vyberte kolekci</label>
                    <select id="addToCollectionSelect" style="width: 100%;"></select>
                </div>
                <div class="inline-actions" style="margin-top: 0.5rem;">
                    <button type="button" class="btn btn-sm btn-success" id="btnQuickCreateCollection"><span aria-hidden="true">‚ûï</span> <span data-i18n="createNewCollection">Vytvo≈ôit novou kolekci</span></button>
                </div>
                <input type="hidden" id="addToCollectionRecordId">
                <input type="hidden" id="addToCollectionTableId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnConfirmAddToCollection" data-i18n="addToCollection">P≈ôidat do kolekce</button>
            </div>
        </div>
    </div>

    <!-- Add Tag Modal -->
    <div class="modal-backdrop" id="addTagToRecordModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 data-i18n="assignTags">P≈ôi≈ôadit tagy</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="selectTag">Vyberte tag</label>
                    <select id="addTagSelect" style="width: 100%;"></select>
                </div>
                <div class="inline-actions" style="margin-top: 0.5rem;">
                    <button type="button" class="btn btn-sm btn-success" id="btnQuickCreateTag"><span aria-hidden="true">‚ûï</span> <span data-i18n="createNewTag">Vytvo≈ôit nov√Ω tag</span></button>
                </div>
                <input type="hidden" id="addTagRecordId">
                <input type="hidden" id="addTagTableId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnConfirmAddTag" data-i18n="assignTags">P≈ôi≈ôadit tag</button>
            </div>
        </div>
    </div>

    <!-- Global Search Results Modal -->
    <div class="modal-backdrop" id="searchResultsModal" hidden>
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="searchResultsTitle">üîç V√Ωsledky hled√°n√≠</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div id="searchResultsList" class="search-results-list"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div class="modal-backdrop" id="bulkEditModal" hidden>
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h2 data-i18n="bulkEditFields">Hromadn√° √∫prava pol√≠</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div id="bulkEditFieldsContainer"></div>
                <button type="button" class="btn btn-secondary btn-sm" id="btnAddBulkField" style="margin-top: 0.5rem;">‚ûï <span data-i18n="addAnotherField">P≈ôidat dal≈°√≠ pole</span></button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnApplyBulkEdit" data-i18n="apply">Pou≈æ√≠t</button>
            </div>
        </div>
    </div>

    <!-- Bulk Add to Collection Modal -->
    <div class="modal-backdrop" id="bulkAddToCollectionModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 data-i18n="addToCollection">P≈ôidat do kolekce</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="selectCollection">Vyberte kolekci</label>
                    <select id="bulkCollectionSelect"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnApplyBulkCollection" data-i18n="add">P≈ôidat</button>
            </div>
        </div>
    </div>

    <!-- Bulk Add Tag Modal -->
    <div class="modal-backdrop" id="bulkAddTagModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 data-i18n="addTag">P≈ôidat tag</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="selectTag">Vyberte tag</label>
                    <select id="bulkTagSelect"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnApplyBulkTag" data-i18n="add">P≈ôidat</button>
            </div>
        </div>
    </div>

    <!-- Structure Modal -->
    <!-- History Modal -->
    <div class="modal-backdrop" id="historyModal" hidden>
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="historyModalTitle">üìú <span data-i18n="history">Historie zmƒõn</span></h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div id="historyContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
            </div>
        </div>
    </div>

    <!-- Markdown Export Modal -->
    <div class="modal-backdrop" id="markdownExportModal" hidden>
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h2 data-i18n="exportMarkdownTitle">Export z√°znamu do Markdown</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="selectFields">Vyberte pole k exportu:</label>
                    <div id="markdownFieldSelection"></div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="markdownIncludeHistory" checked>
                        <label for="markdownIncludeHistory" data-i18n="includeHistory">Zahrnout historii zmƒõn</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="markdownIncludeNotes" checked>
                        <label for="markdownIncludeNotes" data-i18n="includeNotes">Zahrnout pozn√°mky</label>
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="preview">N√°hled:</label>
                    <pre class="markdown-preview" id="markdownPreview"></pre>
                </div>
                <div class="export-actions">
                    <button type="button" class="btn btn-primary" id="btnCopyMarkdown"><span aria-hidden="true">üìã</span> <span data-i18n="copyMarkdown">Kop√≠rovat do schr√°nky</span></button>
                    <button type="button" class="btn btn-secondary" id="btnSaveMarkdown"><span aria-hidden="true">üíæ</span> <span data-i18n="saveMarkdown">Ulo≈æit jako .md</span></button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="structureModal" hidden>
        <div class="modal structure-modal">
            <div class="modal-header">
                <h2 id="structureModalTitle">üå≥ Struktura</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="structure-tabs">
                <button type="button" class="structure-tab active" data-structure-tab="text">üìù <span data-i18n="textView">Textov√Ω pohled</span></button>
                <button type="button" class="structure-tab" data-structure-tab="graph">üîÄ <span data-i18n="graphView">Grafick√Ω pohled</span></button>
            </div>
            <div class="modal-body structure-body">
                <div class="structure-content active" id="structure-text">
                    <div id="structureTreeContainer"></div>
                </div>
                <div class="structure-content" id="structure-graph">
                    <div id="structureGraphContainer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-backdrop" id="confirmModal" hidden>
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="confirmModalTitle" data-i18n="confirm">Potvrzen√≠</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body"><p id="confirmMessage"></p></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-danger" id="btnConfirmYes" data-i18n="delete">Smazat</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-backdrop" id="exportModal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h2 id="exportModalTitle" data-i18n="export">Export</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="format">Form√°t:</label>
                    <div class="format-tabs">
                        <button type="button" class="format-tab active" data-format="csv">CSV (ƒç√°rka)</button>
                        <button type="button" class="format-tab" data-format="tsv">TSV (tabul√°tor)</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="exportOutput" data-i18n="exportData">Data k exportu:</label>
                    <textarea id="exportOutput" rows="10" readonly style="font-family: monospace;"></textarea>
                </div>
                <div class="inline-actions">
                    <button type="button" class="btn btn-primary" id="btnExportCopy"><span aria-hidden="true">üìã</span> <span data-i18n="copy">Kop√≠rovat</span></button>
                    <button type="button" class="btn btn-success" id="btnExportFile"><span aria-hidden="true">üíæ</span> <span data-i18n="saveFile">Ulo≈æit soubor</span></button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="close">Zav≈ô√≠t</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-backdrop" id="importModal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h2 id="importModalTitle" data-i18n="import">Import</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="format">Form√°t:</label>
                    <div class="format-tabs" id="importFormatTabs">
                        <button type="button" class="format-tab active" data-format="csv">CSV (ƒç√°rka)</button>
                        <button type="button" class="format-tab" data-format="tsv">TSV (tabul√°tor)</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="importFile" data-i18n="loadFile">Naƒç√≠st soubor:</label>
                    <input type="file" id="importFile" accept=".csv,.tsv,.txt">
                </div>
                <div class="form-group">
                    <label for="importInput" data-i18n="orPasteData">Nebo vlo≈æte data:</label>
                    <textarea id="importInput" rows="8" style="font-family: monospace;" placeholder="Vlo≈æte CSV/TSV data..."></textarea>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="importHasHeader" checked>
                    <label for="importHasHeader" data-i18n="hasHeader">Prvn√≠ ≈ô√°dek obsahuje n√°zvy sloupc≈Ø</label>
                </div>
                <button type="button" class="btn btn-sm btn-secondary" id="btnPreviewImport" style="margin-top: 0.5rem;"><span aria-hidden="true">üëÅÔ∏è</span> <span data-i18n="previewImport">Zobrazit n√°hled mapov√°n√≠</span></button>
                <div id="importPreview"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnDoImport" data-i18n="import">Importovat</button>
            </div>
        </div>
    </div>

    <!-- Paste JSON Modal (fallback for mobile) -->
    <div class="modal-backdrop" id="pasteJsonModal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="pasteJson">Vlo≈æit JSON</h2>
                <button type="button" class="modal-close" data-modal-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="pasteJsonInput" data-i18n="pasteJsonHere">Vlo≈æte JSON datab√°ze:</label>
                    <textarea id="pasteJsonInput" rows="12" style="font-family: monospace; font-size: 0.85rem;" placeholder='{"meta":{"name":"..."},"tables":[...]}'></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn btn-primary" id="btnDoPasteJson" data-i18n="load">Naƒç√≠st</button>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            cs: {
                skipToContent: "P≈ôeskoƒçit na obsah", appName: "Editor datab√°ze", dbName: "N√°zev datab√°ze", newDb: "Nov√°", load: "Naƒç√≠st", save: "Ulo≈æit",
                copyJson: "Kop√≠rovat JSON", pasteJson: "Vlo≈æit JSON", pasteJsonHere: "Vlo≈æte JSON datab√°ze:", jsonCopied: "JSON zkop√≠rov√°n do schr√°nky.", jsonPasted: "JSON naƒçten.",
                saveToWiki: "Ulo≈æit na wiki", wikiSaved: "Ulo≈æeno na wiki.", wikiSaveError: "Chyba p≈ôi ukl√°d√°n√≠:", wikiSaving: "Ukl√°d√°m...", unsavedChanges: "‚ö†Ô∏è Zmƒõnili jste obsah datab√°ze. Nezapome≈àte ji ulo≈æit.", confirmUnsavedClose: "M√°te neulo≈æen√© zmƒõny. Opravdu chcete zav≈ô√≠t okno?",
                export: "Export", import: "Import", database: "Datab√°ze", tables: "Tabulky", tools: "N√°stroje",
                databaseSettings: "Nastaven√≠ datab√°ze", tablesList: "Seznam tabulek", addTable: "P≈ôidat tabulku",
                noTables: "Zat√≠m nem√°te ≈æ√°dn√© tabulky.", fieldsFor: "Pole pro tabulku:", addField: "P≈ôidat pole",
                noFields: "Zat√≠m nem√°te definov√°na ≈æ√°dn√° pole.", statistics: "Statistiky", textGenerator: "Generov√°n√≠ textu",
                selectTable: "Vyberte tabulku", insertField: "Vlo≈æit pole:", template: "≈†ablona (pou≈æijte {n√°zev_pole})",
                recordsToGenerate: "Z√°znamy:", allRecords: "V≈°echny", filteredRecords: "Filtrovan√©", generate: "Generovat",
                copy: "Kop√≠rovat", tableName: "N√°zev tabulky", cancel: "Zru≈°it", fieldName: "N√°zev pole", fieldType: "Typ pole",
                selectOptions: "Hodnoty (oddƒõlen√© ƒç√°rkou)", dateFormat: "Form√°t data", dateFormatHelp: "N√°povƒõda k form√°tu", dateFormatDay: "Den:", dateFormatMonth: "Mƒõs√≠c:", dateFormatYear: "Rok:", dateFormatWeekday: "Den v t√Ωdnu:", dateFormatExamples: "P≈ô√≠klady:", clearDate: "Vymazat datum", targetTable: "C√≠lov√° tabulka", parentFieldSelect: "Pole odkazuj√≠c√≠ zpƒõt",
                fieldPrimary: "Prim√°rn√≠ (n√°zev z√°znamu)", fieldFilter: "Povolit filtrov√°n√≠", addRecord: "P≈ôidat z√°znam",
                close: "Zav≈ô√≠t", edit: "Upravit", confirm: "Potvrzen√≠", delete: "Smazat", format: "Form√°t:",
                exportData: "Data k exportu:", saveFile: "Ulo≈æit soubor", loadFile: "Naƒç√≠st soubor:",
                orPasteData: "Nebo vlo≈æte data:", hasHeader: "Prvn√≠ ≈ô√°dek obsahuje n√°zvy sloupc≈Ø",
                searchPlaceholder: "Hledat...", columnVisibility: "Zobrazen√≠ sloupc≈Ø", actions: "Akce",
                noRecords: "Zat√≠m nem√°te ≈æ√°dn√© z√°znamy.", allValues: "V≈°echny hodnoty", noValue: "(bez hodnoty)",
                yes: "Ano", no: "Ne", noParent: "≈Ω√°dn√Ω", noChildren: "≈Ω√°dn√© pod≈ô√≠zen√© z√°znamy",
                confirmDeleteRecord: "Smazat tento z√°znam?", confirmDeleteField: "Smazat toto pole?",
                confirmDeleteTable: "Smazat tuto tabulku?", confirmNewDb: "Vytvo≈ôit novou datab√°zi?",
                jsonCopied: "Zkop√≠rov√°no.", jsonInvalid: "Neplatn√Ω JSON.", importSuccess: "Importov√°no: {count} nov√Ωch, {updated} aktualizovan√Ωch.",
                totalTables: "Tabulek celkem", totalRecords: "Z√°znam≈Ø celkem", recordsInTable: "Z√°znam≈Ø v {name}",
                management: "Spr√°va", rowsPreview: "N√°hled ({count} ≈ô√°dk≈Ø)", selectField: "-- Vyberte --",
                recordsShowing: "Zobrazeno: {filtered} / {total}", typeText: "Text", typeTextarea: "V√≠ce≈ô√°dkov√Ω text / Markdown",
                typeNumber: "ƒå√≠slo", typeDate: "Datum", typeBoolean: "Ano/Ne", typeSelect: "V√Ωbƒõr ze seznamu",
                typeParent: "Nad≈ôazen√Ω z√°znam", typeChildren: "Pod≈ô√≠zen√© z√°znamy", typeComposite: "Slo≈æen√Ω", typeUrl: "URL odkaz", editTable: "Upravit", editField: "Upravit pole",
                compositeFields: "Vlo≈æit pole:", compositeTemplate: "≈†ablona slo≈æen√©ho pole", createNew: "Vytvo≈ôit nov√Ω", fieldGroup: "Seskupovat z√°znamy", groupCollapsed: "sbaleno", groupExpanded: "rozbaleno", addChild: "P≈ôidat pod≈ô√≠zen√Ω", copyField: "Kop√≠rovat", copiedToClipboard: "Zkop√≠rov√°no do schr√°nky",
                collections: "Kolekce", tags: "Tagy", addCollection: "P≈ôidat kolekci", addTag: "P≈ôidat tag", collectionName: "N√°zev kolekce", tagName: "N√°zev tagu", color: "Barva", noCollections: "Zat√≠m nem√°te ≈æ√°dn√© kolekce.", noTags: "Zat√≠m nem√°te ≈æ√°dn√© tagy.", collectionMembers: "z√°znam≈Ø", confirmDeleteCollection: "Smazat tuto kolekci?", confirmDeleteTag: "Smazat tento tag?", addToCollection: "P≈ôidat do kolekce", removeFromCollection: "Odebrat z kolekce", assignTags: "P≈ôi≈ôadit tagy", relatedRecords: "Souvisej√≠c√≠ z√°znamy", inCollection: "V kolekci", withTag: "S tagem", allCollections: "V≈°echny kolekce", allTags: "V≈°echny tagy", viewCollection: "Zobrazit kolekci", collectionContents: "Obsah kolekce", backToTables: "Zpƒõt na tabulky", recordsInCollection: "Z√°znamy v kolekci", noRecordsInCollection: "Kolekce neobsahuje ≈æ√°dn√© z√°znamy.", fromTable: "z tabulky", manageCollections: "Spravovat kolekce", manageTags: "Spravovat tagy", classification: "Zat≈ô√≠dƒõn√≠", description: "Popis", collectionDescription: "Popis kolekce", selectCollection: "Vyberte kolekci", selectTag: "Vyberte tag", createNewCollection: "Vytvo≈ôit novou kolekci", createNewTag: "Vytvo≈ôit nov√Ω tag", removeFromThisCollection: "Odebrat z t√©to kolekce", removeThisTag: "Odebrat tento tag", collectionDetails: "Podrobnosti kolekce", tagDetails: "Podrobnosti tagu", editCollection: "Upravit kolekci", editTag: "Upravit tag", recordsWithTag: "Z√°znamy s tagem", quickCreate: "‚ûï Nov√Ω z√°znam...", structure: "Struktura", textView: "Textov√Ω pohled", graphView: "Grafick√Ω pohled", showStructure: "Zobrazit strukturu", noDescendants: "Tento z√°znam nem√° ≈æ√°dn√© pod≈ô√≠zen√© z√°znamy.", loadMore: "Naƒç√≠st v√≠ce...", loadAll: "Naƒç√≠st v≈°echny", descendants: "potomk≈Ø", selectedRecords: "vybr√°no", bulkEditField: "Upravit pole", clearSelection: "Zru≈°it v√Ωbƒõr", selectAll: "Vybrat v≈°e", newValue: "Nov√° hodnota", apply: "Pou≈æ√≠t", confirmBulkDelete: "Opravdu smazat {count} z√°znam≈Ø?", addedToCollection: "P≈ôid√°no {count} z√°znam≈Ø do kolekce.", addedTag: "Tag p≈ôid√°n k {count} z√°znam≈Øm.", recordFields: "Pole z√°znamu", bulkEditFields: "Hromadn√° √∫prava pol√≠", addAnotherField: "P≈ôidat dal≈°√≠ pole", openAfterSave: "Otev≈ô√≠t zobrazen√≠", ancestors: "P≈ôedci", showStructureFrom: "Zobrazit strukturu od tohoto z√°znamu", order: "Po≈ôad√≠", tableName: "N√°zev tabulky", fields: "Pole", records: "Z√°znamy", manageFields: "Spravovat pole", moveUp: "Posunout nahoru", moveDown: "Posunout dol≈Ø", fieldName: "N√°zev pole", type: "Typ", options: "Mo≈ænosti", primary: "Prim√°rn√≠", filter: "Filtr", group: "Seskupit", duplicate: "Duplikovat", saveAndAddAnother: "Ulo≈æit a p≈ôidat dal≈°√≠", searchResults: "V√Ωsledky hled√°n√≠", noSearchResults: "≈Ω√°dn√© v√Ωsledky nebyly nalezeny.", globalSearchPlaceholder: "üîç Hledat...", refresh: "Obnovit", previewImport: "Zobrazit n√°hled mapov√°n√≠", columnMapping: "Mapov√°n√≠ sloupc≈Ø", targetField: "C√≠lov√© pole", unmapped: "Nenamapov√°no", column: "Sloupec", sampleData: "Uk√°zka dat", rows: "≈ô√°dk≈Ø", noDataToPreview: "Vlo≈æte data pro zobrazen√≠ n√°hledu", allRecords: "V≈°echny z√°znamy", saveView: "Ulo≈æit pohled", viewName: "N√°zev pohledu", newView: "Nov√Ω pohled", updateView: "Aktualizovat pohled", renameView: "P≈ôejmenovat pohled", confirmDeleteView: "Opravdu smazat tento pohled?", lockRecord: "Zamknout z√°znam", unlockRecord: "Odemknout z√°znam", recordLocked: "Tento z√°znam je zamƒçen√Ω a nelze ho upravovat.", savedViews: "Ulo≈æen√© pohledy", notes: "Pozn√°mky", addNote: "P≈ôidat pozn√°mku", editNote: "Upravit pozn√°mku", deleteNote: "Smazat pozn√°mku", noNotes: "≈Ω√°dn√© pozn√°mky", noteText: "Text pozn√°mky", noteResolved: "Vy≈ô√≠zeno", noteUnresolved: "Nevy≈ô√≠zeno", markResolved: "Oznaƒçit jako vy≈ô√≠zen√©", markUnresolved: "Oznaƒçit jako nevy≈ô√≠zen√©", confirmDeleteNote: "Opravdu smazat tuto pozn√°mku?", allNotes: "V≈°echny pozn√°mky", unresolvedNotes: "Nevy≈ô√≠zen√©", resolvedNotes: "Vy≈ô√≠zen√©", noNotesInDatabase: "V datab√°zi nejsou ≈æ√°dn√© pozn√°mky.", noteFor: "Pozn√°mka k", notesCount: "pozn√°mek", allFeatures: "V≈°echny funkce", showInSimpleMode: "Zobrazit v z√°kladn√≠m re≈æimu", keyboardShortcuts: "Kl√°vesov√© zkratky", shortcutSave: "Ulo≈æit datab√°zi", shortcutToggleMode: "P≈ôepnout re≈æim (z√°kladn√≠/pokroƒçil√Ω)", shortcutNewRecord: "Nov√Ω z√°znam v aktu√°ln√≠ tabulce", shortcutQuickCreate: "Rychl√© vytvo≈ôen√≠ z√°znamu", shortcutSaveRecord: "Ulo≈æit z√°znam (v mod√°lu)", shortcutCollections: "P≈ôej√≠t do kolekc√≠", shortcutTags: "P≈ôej√≠t do tag≈Ø", shortcutNotes: "P≈ôej√≠t do pozn√°mek", shortcutClassification: "P≈ôej√≠t do zat≈ô√≠dƒõn√≠", shortcutEdit: "Upravit vybran√Ω z√°znam", shortcutView: "Zobrazit vybran√Ω z√°znam", shortcutArrows: "Navigace v tabulce", shortcutDescription: "Kl√°vesov√© zkratky pou≈æ√≠vaj√≠ modifik√°tor prohl√≠≈æeƒçe (Alt, Alt+Shift, Ctrl+Option)", accesskeyModifier: "Modifik√°tor + kl√°vesa", directShortcuts: "P≈ô√≠m√© zkratky (bez modifik√°toru)", key: "Kl√°vesa", history: "Historie zmƒõn", historyCreate: "Vytvo≈ôen√≠", historyEdit: "√öprava", historyBulk: "Hromadn√° √∫prava", noHistory: "Zat√≠m nejsou k dispozici ≈æ√°dn√© z√°znamy o zmƒõn√°ch.", confirmDeleteHistory: "Opravdu chcete smazat tento z√°znam z historie?", exportMarkdown: "Export do Markdown", exportMarkdownTitle: "Export z√°znamu do Markdown", copyMarkdown: "Kop√≠rovat do schr√°nky", saveMarkdown: "Ulo≈æit jako .md", markdownCopied: "Markdown zkop√≠rov√°n do schr√°nky.", includeHistory: "Zahrnout historii zmƒõn", includeNotes: "Zahrnout pozn√°mky", selectFields: "Vyberte pole k exportu", preview: "N√°hled"
            },
            en: {
                skipToContent: "Skip to content", appName: "Database Editor", dbName: "Database name", newDb: "New", load: "Load", save: "Save",
                copyJson: "Copy JSON", pasteJson: "Paste JSON", pasteJsonHere: "Paste database JSON:", jsonCopied: "JSON copied to clipboard.", jsonPasted: "JSON loaded.",
                saveToWiki: "Save to Wiki", wikiSaved: "Saved to wiki.", wikiSaveError: "Error saving:", wikiSaving: "Saving...", unsavedChanges: "‚ö†Ô∏è You have made changes to the database. Don't forget to save.", confirmUnsavedClose: "You have unsaved changes. Are you sure you want to close?",
                export: "Export", import: "Import", database: "Database", tables: "Tables", tools: "Tools",
                databaseSettings: "Database Settings", tablesList: "Tables List", addTable: "Add Table",
                noTables: "No tables yet.", fieldsFor: "Fields for table:", addField: "Add Field",
                noFields: "No fields defined yet.", statistics: "Statistics", textGenerator: "Text Generator",
                selectTable: "Select table", insertField: "Insert field:", template: "Template (use {field_name})",
                recordsToGenerate: "Records:", allRecords: "All", filteredRecords: "Filtered", generate: "Generate",
                copy: "Copy", tableName: "Table Name", cancel: "Cancel", fieldName: "Field Name", fieldType: "Field Type",
                selectOptions: "Values (comma-separated)", dateFormat: "Date format", dateFormatHelp: "Format help", dateFormatDay: "Day:", dateFormatMonth: "Month:", dateFormatYear: "Year:", dateFormatWeekday: "Weekday:", dateFormatExamples: "Examples:", clearDate: "Clear date", targetTable: "Target Table", parentFieldSelect: "Back-reference field",
                fieldPrimary: "Primary (record name)", fieldFilter: "Enable filtering", addRecord: "Add Record",
                close: "Close", edit: "Edit", confirm: "Confirmation", delete: "Delete", format: "Format:",
                exportData: "Export data:", saveFile: "Save File", loadFile: "Load file:",
                orPasteData: "Or paste data:", hasHeader: "First row contains column names",
                searchPlaceholder: "Search...", columnVisibility: "Column Visibility", actions: "Actions",
                noRecords: "No records yet.", allValues: "All values", noValue: "(no value)",
                yes: "Yes", no: "No", noParent: "None", noChildren: "No child records",
                confirmDeleteRecord: "Delete this record?", confirmDeleteField: "Delete this field?",
                confirmDeleteTable: "Delete this table?", confirmNewDb: "Create new database?",
                jsonCopied: "Copied.", jsonInvalid: "Invalid JSON.", importSuccess: "Imported: {count} new, {updated} updated.",
                totalTables: "Total tables", totalRecords: "Total records", recordsInTable: "Records in {name}",
                management: "Spr√°va", rowsPreview: "Preview ({count} rows)", selectField: "-- Select --",
                recordsShowing: "Showing: {filtered} / {total}", typeText: "Text", typeTextarea: "Multi-line text / Markdown",
                typeNumber: "Number", typeDate: "Date", typeBoolean: "Yes/No", typeSelect: "Select from list",
                typeParent: "Parent record", typeChildren: "Child records", typeComposite: "Composite", typeUrl: "URL link", editTable: "Edit", editField: "Edit field",
                compositeFields: "Insert field:", compositeTemplate: "Composite field template", createNew: "Create new", fieldGroup: "Group records", groupCollapsed: "collapsed", groupExpanded: "expanded", addChild: "Add child", copyField: "Copy", copiedToClipboard: "Copied to clipboard",
                collections: "Collections", tags: "Tags", addCollection: "Add collection", addTag: "Add tag", collectionName: "Collection name", tagName: "Tag name", color: "Color", noCollections: "You have no collections yet.", noTags: "You have no tags yet.", collectionMembers: "records", confirmDeleteCollection: "Delete this collection?", confirmDeleteTag: "Delete this tag?", addToCollection: "Add to collection", removeFromCollection: "Remove from collection", assignTags: "Assign tags", relatedRecords: "Related records", inCollection: "In collection", withTag: "With tag", allCollections: "All collections", allTags: "All tags", viewCollection: "View collection", collectionContents: "Collection contents", backToTables: "Back to tables", recordsInCollection: "Records in collection", noRecordsInCollection: "Collection contains no records.", fromTable: "from table", manageCollections: "Manage collections", manageTags: "Manage tags", classification: "Classification", description: "Description", collectionDescription: "Collection description", selectCollection: "Select collection", selectTag: "Select tag", createNewCollection: "Create new collection", createNewTag: "Create new tag", removeFromThisCollection: "Remove from this collection", removeThisTag: "Remove this tag", collectionDetails: "Collection details", tagDetails: "Tag details", editCollection: "Edit collection", editTag: "Edit tag", recordsWithTag: "Records with tag", quickCreate: "‚ûï New record...", structure: "Structure", textView: "Text view", graphView: "Graph view", showStructure: "Show structure", noDescendants: "This record has no child records.", loadMore: "Load more...", loadAll: "Load all", descendants: "descendants", selectedRecords: "selected", bulkEditField: "Edit field", clearSelection: "Clear selection", selectAll: "Select all", newValue: "New value", apply: "Apply", confirmBulkDelete: "Delete {count} records?", addedToCollection: "Added {count} records to collection.", addedTag: "Tag added to {count} records.", recordFields: "Record fields", bulkEditFields: "Bulk edit fields", addAnotherField: "Add another field", openAfterSave: "Open after save", ancestors: "Ancestors", showStructureFrom: "Show structure from this record", order: "Order", tableName: "Table name", fields: "Fields", records: "Records", manageFields: "Manage fields", moveUp: "Move up", moveDown: "Move down", fieldName: "Field name", type: "Type", options: "Options", primary: "Primary", filter: "Filter", group: "Group", duplicate: "Duplicate", saveAndAddAnother: "Save and add another", searchResults: "Search results", noSearchResults: "No results found.", globalSearchPlaceholder: "üîç Search...", refresh: "Refresh", previewImport: "Preview mapping", columnMapping: "Column mapping", targetField: "Target field", unmapped: "Unmapped", column: "Column", sampleData: "Sample data", rows: "rows", noDataToPreview: "Paste data to see preview", allRecords: "All records", saveView: "Save view", viewName: "View name", newView: "New view", updateView: "Update view", renameView: "Rename view", confirmDeleteView: "Delete this view?", lockRecord: "Lock record", unlockRecord: "Unlock record", recordLocked: "This record is locked and cannot be edited.", savedViews: "Saved views", notes: "Notes", addNote: "Add note", editNote: "Edit note", deleteNote: "Delete note", noNotes: "No notes", noteText: "Note text", noteResolved: "Resolved", noteUnresolved: "Unresolved", markResolved: "Mark as resolved", markUnresolved: "Mark as unresolved", confirmDeleteNote: "Delete this note?", allNotes: "All notes", unresolvedNotes: "Unresolved", resolvedNotes: "Resolved", noNotesInDatabase: "No notes in database.", noteFor: "Note for", notesCount: "notes", allFeatures: "All features", showInSimpleMode: "Show in simple mode", keyboardShortcuts: "Keyboard shortcuts", shortcutSave: "Save database", shortcutToggleMode: "Toggle mode (simple/advanced)", shortcutNewRecord: "New record in current table", shortcutQuickCreate: "Quick create record", shortcutSaveRecord: "Save record (in modal)", shortcutCollections: "Go to collections", shortcutTags: "Go to tags", shortcutNotes: "Go to notes", shortcutClassification: "Go to classification", shortcutEdit: "Edit selected record", shortcutView: "View selected record", shortcutArrows: "Navigate in table", shortcutDescription: "Keyboard shortcuts use browser modifier (Alt, Alt+Shift, Ctrl+Option)", accesskeyModifier: "Modifier + key", directShortcuts: "Direct shortcuts (no modifier)", key: "Key", history: "Change history", historyCreate: "Created", historyEdit: "Edited", historyBulk: "Bulk edit", noHistory: "No change history available yet.", confirmDeleteHistory: "Are you sure you want to delete this history entry?", exportMarkdown: "Export to Markdown", exportMarkdownTitle: "Export record to Markdown", copyMarkdown: "Copy to clipboard", saveMarkdown: "Save as .md", markdownCopied: "Markdown copied to clipboard.", includeHistory: "Include change history", includeNotes: "Include notes", selectFields: "Select fields to export", preview: "Preview"
            }
        };

        let currentLang = localStorage.getItem('db-editor-lang') || 'cs';
        let database = { meta: { name: 'Nov√° datab√°ze', columnVisibility: {}, groupStates: {}, collections: [], tags: [], views: {}, notes: [] }, tables: [] };
        let activeTableId = null;
        let activeTab = 'management';
        let quickCreateMode = false;
        let activeManagementTab = 'database';
        let tableFilters = {};
        let tableSearches = {};
        let tableSorts = {};
        let collectionFilter = null;
        let tagFilter = null;
        let activeViewId = null;
        let advancedMode = false; // Simple mode is default
        let hasUnsavedChanges = false;
        let initialLoadComplete = false;
        let selectedRowIndex = -1; // Keyboard navigation in table
        let selectedRecords = {}; // { tableId: Set of recordIds }
        let editingFieldTableId = null;
        let currentRecordId = null;
        let currentRecordTableId = null;
        let confirmCallback = null;
        let exportFormat = 'csv';
        let importFormat = 'csv';

        const generateId = () => 'id_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        const t = (key, r = {}) => { let s = translations[currentLang]?.[key] || key; for (const [k, v] of Object.entries(r)) s = s.replace(`{${k}}`, v); return s; };
        const escapeHtml = s => s == null ? '' : String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        // Safe attribute escape - handles all special chars including backticks and template literal syntax
        const escapeAttr = s => s == null ? '' : String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/`/g, '&#96;').replace(/\$/g, '&#36;');
        
        // PHP-style date formatting
        const dateLocales = {
            cs: {
                months: ['Ledna', '√önora', 'B≈ôezna', 'Dubna', 'Kvƒõtna', 'ƒåervna', 'ƒåervence', 'Srpna', 'Z√°≈ô√≠', '≈ò√≠jna', 'Listopadu', 'Prosince'],
                monthsShort: ['Led', '√öno', 'B≈ôe', 'Dub', 'Kvƒõ', 'ƒåvn', 'ƒåvc', 'Srp', 'Z√°≈ô', '≈ò√≠j', 'Lis', 'Pro'],
                days: ['Nedƒõle', 'Pondƒõl√≠', '√öter√Ω', 'St≈ôeda', 'ƒåtvrtek', 'P√°tek', 'Sobota'],
                daysShort: ['Ne', 'Po', '√öt', 'St', 'ƒåt', 'P√°', 'So']
            },
            en: {
                months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                monthsShort: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                daysShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
            }
        };
        
        function formatDate(dateStr, format) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr + 'T00:00:00'); // Ensure consistent parsing
                if (isNaN(d.getTime())) return dateStr;
                
                // Default format if none specified
                if (!format) return d.toLocaleDateString(currentLang);
                
                const locale = dateLocales[currentLang] || dateLocales.en;
                const pad = n => n < 10 ? '0' + n : String(n);
                
                const replacements = {
                    'd': pad(d.getDate()),                    // 01-31
                    'j': String(d.getDate()),                 // 1-31
                    'D': locale.daysShort[d.getDay()],        // Mon, Po
                    'l': locale.days[d.getDay()],             // Monday, Pondƒõl√≠
                    'N': d.getDay() === 0 ? '7' : String(d.getDay()), // 1-7 (ISO)
                    'w': String(d.getDay()),                  // 0-6
                    'm': pad(d.getMonth() + 1),               // 01-12
                    'n': String(d.getMonth() + 1),            // 1-12
                    'M': locale.monthsShort[d.getMonth()],    // Jan, Led
                    'F': locale.months[d.getMonth()],         // January, Ledna
                    'Y': String(d.getFullYear()),             // 2024
                    'y': String(d.getFullYear()).slice(-2)    // 24
                };
                
                // Replace format characters (escape backslash-prefixed chars)
                let result = '';
                for (let i = 0; i < format.length; i++) {
                    const char = format[i];
                    if (char === '\\' && i + 1 < format.length) {
                        result += format[++i]; // Escaped character
                    } else if (replacements[char] !== undefined) {
                        result += replacements[char];
                    } else {
                        result += char;
                    }
                }
                return result;
            } catch (e) {
                return dateStr;
            }
        }
        const getTableById = id => database.tables.find(tb => tb.id === id);
        const getRecordById = (tId, rId) => getTableById(tId)?.records.find(r => r.id === rId);
        function getPrimaryFieldValue(table, record) { 
            const pf = table.fields.find(f => f.primary); 
            if (!pf) return `#${record.id.substr(0, 6)}`;
            if (pf.type === 'composite') return evaluateCompositeField(table, pf, record) || `#${record.id.substr(0, 6)}`;
            return record.values[pf.id] ? record.values[pf.id] : `#${record.id.substr(0, 6)}`; 
        }
        const getChildRecords = (tableId, recordId) => { const ch = []; database.tables.forEach(tb => { tb.fields.filter(f => f.type === 'parent' && f.targetTableId === tableId).forEach(field => { tb.records.forEach(rec => { if (rec.values[field.id] === recordId) ch.push({ table: tb, record: rec, field }); }); }); }); return ch; };

        function updateDocumentTitle() {
            const dbName = database.meta.name;
            const table = getTableById(activeTableId);
            const tableName = table?.name || '';
            let title = t('appName');
            if (dbName && dbName.trim()) {
                title = (currentLang === 'cs' ? 'Datab√°ze: ' : 'Database: ') + dbName;
                if (tableName && activeTab !== 'management') {
                    title += ' | ' + tableName;
                }
            }
            document.title = title;
        }

        function autoSave() {
            try {
                // Use sessionStorage so each tab has its own database
                sessionStorage.setItem('db-editor-autosave', JSON.stringify(database));
                sessionStorage.setItem('db-editor-autosave-tab', activeTab);
                // Mark as having unsaved changes (after initial load)
                if (initialLoadComplete) {
                    hasUnsavedChanges = true;
                    updateUnsavedBanner();
                }
            } catch (e) {
                console.warn('Auto-save failed:', e);
            }
        }
        
        function markAsSaved() {
            hasUnsavedChanges = false;
            updateUnsavedBanner();
        }
        
        function updateUnsavedBanner() {
            const banner = document.getElementById('unsavedBanner');
            if (banner) {
                banner.hidden = !hasUnsavedChanges;
            }
        }

        function loadAutoSave() {
            try {
                // Use sessionStorage so each tab has its own database
                const saved = sessionStorage.getItem('db-editor-autosave');
                if (saved) {
                    const data = JSON.parse(saved);
                    database = { 
                        meta: { 
                            name: data.meta?.name || '', 
                            columnVisibility: data.meta?.columnVisibility || {},
                            groupStates: data.meta?.groupStates || {},
                            collections: data.meta?.collections || [],
                            tags: data.meta?.tags || [],
                            views: data.meta?.views || {},
                            notes: data.meta?.notes || []
                        }, 
                        tables: data.tables || [] 
                    };
                    const savedTab = sessionStorage.getItem('db-editor-autosave-tab');
                    if (savedTab && (savedTab === 'management' || getTableById(savedTab))) {
                        activeTab = savedTab;
                        activeTableId = savedTab !== 'management' ? savedTab : (database.tables[0]?.id || null);
                    } else {
                        activeTab = database.tables.length > 0 ? database.tables[0].id : 'management';
                        activeTableId = database.tables[0]?.id || null;
                    }
                    return true;
                }
            } catch (e) {
                console.warn('Auto-load failed:', e);
            }
            return false;
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = t(el.getAttribute('data-i18n')));
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = t(el.getAttribute('data-i18n-placeholder')));
            document.documentElement.lang = currentLang;
        }

        function openModal(id) { 
            document.getElementById(id).hidden = false; 
            document.body.style.overflow = 'hidden';
            // Autofocus on first input/textarea (skip view modals)
            const noFocusModals = ['viewRecordModal', 'viewCollectionModal', 'viewTagModal', 'confirmModal', 'structureModal', 'searchResultsModal', 'historyModal'];
            if (!noFocusModals.includes(id)) {
                setTimeout(() => {
                    const modal = document.getElementById(id);
                    const firstInput = modal.querySelector('input:not([type="hidden"]):not([type="checkbox"]):not([type="radio"]), textarea, select');
                    if (firstInput) firstInput.focus();
                }, 50);
            }
        }
        function closeModal(id) { 
            document.getElementById(id).hidden = true; 
            document.body.style.overflow = ''; 
            if (id === 'recordModal') quickCreateMode = false;
        }
        function confirmAction(msg, cb) { document.getElementById('confirmMessage').textContent = msg; confirmCallback = cb; openModal('confirmModal'); }

        // Simple Markdown parser
        function parseMarkdown(text) {
            if (!text) return '';
            let html = escapeHtml(text);
            // Code blocks
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Headers
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            // Bold and italic
            html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            html = html.replace(/___(.+?)___/g, '<strong><em>$1</em></strong>');
            html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
            html = html.replace(/_(.+?)_/g, '<em>$1</em>');
            // Blockquotes
            html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
            // Links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            // Horizontal rule
            html = html.replace(/^---$/gm, '<hr>');
            // Unordered lists
            html = html.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            // Ordered lists
            html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            // Paragraphs
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            html = '<p>' + html + '</p>';
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[123]>)/g, '$1');
            html = html.replace(/(<\/h[123]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1');
            html = html.replace(/(<\/ul>)<\/p>/g, '$1');
            html = html.replace(/<p>(<blockquote>)/g, '$1');
            html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');
            html = html.replace(/<p>(<pre>)/g, '$1');
            html = html.replace(/(<\/pre>)<\/p>/g, '$1');
            html = html.replace(/<p>(<hr>)<\/p>/g, '$1');
            return html;
        }

        function renderTableTabs() {
            const container = document.getElementById('tableTabs');
            let html = database.tables.map(tb => {
                // In simple mode, hide tables with showInSimpleMode=false
                const hideInSimple = !advancedMode && tb.showInSimpleMode === false;
                return `<button type="button" class="table-tab ${activeTab === tb.id ? 'active' : ''}" data-table-id="${tb.id}"${hideInSimple ? ' hidden' : ''}>${escapeHtml(tb.name)}</button>`;
            }).join('');
            const unresolvedNotesCount = (database.meta.notes || []).filter(n => !n.resolved).length;
            const notesBadge = unresolvedNotesCount > 0 ? `<span class="notes-badge">${unresolvedNotesCount}</span>` : '';
            html += `<button type="button" class="table-tab classification-tab ${activeTab === 'classification' ? 'active' : ''}" data-table-id="classification" accesskey="z">üè∑Ô∏è ${t('classification')}${notesBadge}</button>`;
            // Management tab - hidden in simple mode
            const hideManagement = !advancedMode;
            html += `<button type="button" class="table-tab management-tab ${activeTab === 'management' ? 'active' : ''}" data-table-id="management"${hideManagement ? ' hidden' : ''}>‚öôÔ∏è ${t('management')}</button>`;
            container.innerHTML = html;
        }
        
        // Bulk selection functions
        function getSelectedRecords(tableId) {
            return selectedRecords[tableId] || new Set();
        }
        
        function getSelectedCount(tableId) {
            return getSelectedRecords(tableId).size;
        }
        
        function toggleSelectAll(tableId, checked) {
            const table = getTableById(tableId);
            if (!table) return;
            if (!selectedRecords[tableId]) selectedRecords[tableId] = new Set();
            
            // Get currently filtered records
            const filtered = table._filteredRecords || table.records;
            if (checked) {
                filtered.forEach(r => selectedRecords[tableId].add(r.id));
            } else {
                filtered.forEach(r => selectedRecords[tableId].delete(r.id));
            }
            renderTableContent(tableId);
        }
        
        function toggleSelectRow(tableId, recordId, checked) {
            if (!selectedRecords[tableId]) selectedRecords[tableId] = new Set();
            if (checked) {
                selectedRecords[tableId].add(recordId);
            } else {
                selectedRecords[tableId].delete(recordId);
            }
            renderTableContent(tableId);
        }
        
        function clearSelection(tableId) {
            if (selectedRecords[tableId]) {
                selectedRecords[tableId].clear();
            }
            renderTableContent(tableId);
        }
        
        function renderBulkActionsBar(tableId) {
            const count = getSelectedCount(tableId);
            if (count === 0) return '';
            
            return `<div class="bulk-actions-bar">
                <span class="bulk-count">${count} ${t('selectedRecords')}</span>
                <button type="button" class="btn btn-sm bulk-edit-field-btn" data-table="${tableId}">‚úèÔ∏è ${t('bulkEditField')}</button>
                <button type="button" class="btn btn-sm bulk-add-collection-btn" data-table="${tableId}">üìÅ ${t('addToCollection')}</button>
                <button type="button" class="btn btn-sm bulk-add-tag-btn" data-table="${tableId}">üè∑Ô∏è ${t('addTag')}</button>
                <button type="button" class="btn btn-sm btn-danger bulk-delete-btn" data-table="${tableId}">üóëÔ∏è ${t('delete')}</button>
                <button type="button" class="bulk-deselect" data-table="${tableId}" title="${t('clearSelection')}">‚úï</button>
            </div>`;
        }
        
        // Bulk edit field
        let bulkEditTableId = null;
        
        function openBulkEditModal(tableId) {
            bulkEditTableId = tableId;
            const table = getTableById(tableId);
            if (!table) return;
            
            // Clear and add first row
            document.getElementById('bulkEditFieldsContainer').innerHTML = '';
            addBulkEditRow();
            openModal('bulkEditModal');
        }
        
        let bulkEditRowCounter = 0;
        
        function addBulkEditRow() {
            const table = getTableById(bulkEditTableId);
            if (!table) return;
            
            const editableFields = table.fields.filter(f => f.type !== 'children' && f.type !== 'composite');
            const rowId = ++bulkEditRowCounter;
            
            let optionsHtml = `<option value="">${t('selectField')}</option>`;
            editableFields.forEach(f => {
                optionsHtml += `<option value="${f.id}">${escapeHtml(f.name)}</option>`;
            });
            
            const rowHtml = `<div class="bulk-edit-row" data-row="${rowId}">
                <div class="bulk-edit-row-header">
                    <select class="bulk-edit-field-select" data-row="${rowId}">${optionsHtml}</select>
                    <button type="button" class="btn btn-sm btn-danger bulk-edit-remove-row" data-row="${rowId}" title="${t('remove')}">‚úï</button>
                </div>
                <div class="bulk-edit-value-container" data-row="${rowId}"></div>
            </div>`;
            
            document.getElementById('bulkEditFieldsContainer').insertAdjacentHTML('beforeend', rowHtml);
        }
        
        function removeBulkEditRow(rowId) {
            const row = document.querySelector(`.bulk-edit-row[data-row="${rowId}"]`);
            if (row) row.remove();
            
            // Ensure at least one row
            if (document.querySelectorAll('.bulk-edit-row').length === 0) {
                addBulkEditRow();
            }
        }
        
        function updateBulkEditValueInput(rowId) {
            const select = document.querySelector(`.bulk-edit-field-select[data-row="${rowId}"]`);
            const container = document.querySelector(`.bulk-edit-value-container[data-row="${rowId}"]`);
            if (!select || !container) return;
            
            const fieldId = select.value;
            const table = getTableById(bulkEditTableId);
            if (!table || !fieldId) {
                container.innerHTML = '';
                return;
            }
            
            const field = table.fields.find(f => f.id === fieldId);
            if (!field) return;
            
            let inputHtml = '';
            const inputId = `bulkEditValue_${rowId}`;
            switch (field.type) {
                case 'text':
                    inputHtml = `<input type="text" id="${inputId}" class="bulk-edit-value" data-row="${rowId}">`;
                    break;
                case 'textarea':
                    inputHtml = `<textarea id="${inputId}" class="bulk-edit-value" data-row="${rowId}" rows="2"></textarea>`;
                    break;
                case 'number':
                    inputHtml = `<input type="number" id="${inputId}" class="bulk-edit-value" data-row="${rowId}" step="any">`;
                    break;
                case 'date':
                    inputHtml = `<input type="date" id="${inputId}" class="bulk-edit-value" data-row="${rowId}">`;
                    break;
                case 'url':
                    inputHtml = `<input type="url" id="${inputId}" class="bulk-edit-value" data-row="${rowId}" placeholder="https://">`;
                    break;
                case 'boolean':
                    inputHtml = `<select id="${inputId}" class="bulk-edit-value" data-row="${rowId}"><option value="true">${t('yes')}</option><option value="false">${t('no')}</option></select>`;
                    break;
                case 'select':
                    const opts = (field.options || '').split(',').map(o => o.trim()).filter(o => o);
                    inputHtml = `<select id="${inputId}" class="bulk-edit-value" data-row="${rowId}"><option value="">-- ${t('selectField')} --</option>${opts.map(o => `<option value="${escapeAttr(o)}">${escapeHtml(o)}</option>`).join('')}</select>`;
                    break;
                case 'parent':
                    const tt = getTableById(field.targetTableId);
                    if (tt) {
                        const sortedRecs = tt.records.map(r => ({ id: r.id, name: getPrimaryFieldValue(tt, r) })).sort((a, b) => a.name.localeCompare(b.name, currentLang));
                        inputHtml = `<select id="${inputId}" class="bulk-edit-value" data-row="${rowId}"><option value="">${t('noParent')}</option>${sortedRecs.map(o => `<option value="${o.id}">${escapeHtml(o.name)}</option>`).join('')}</select>`;
                    }
                    break;
                default:
                    inputHtml = `<input type="text" id="${inputId}" class="bulk-edit-value" data-row="${rowId}">`;
            }
            
            container.innerHTML = inputHtml;
        }
        
        function applyBulkEdit() {
            const table = getTableById(bulkEditTableId);
            if (!table) return;
            
            // Collect all field changes
            const changes = [];
            document.querySelectorAll('.bulk-edit-row').forEach(row => {
                const rowId = row.dataset.row;
                const select = row.querySelector('.bulk-edit-field-select');
                const valueEl = row.querySelector('.bulk-edit-value');
                
                if (!select || !select.value) return;
                
                const fieldId = select.value;
                const field = table.fields.find(f => f.id === fieldId);
                if (!field) return;
                
                let value = valueEl ? valueEl.value : '';
                if (field.type === 'boolean') {
                    value = value === 'true';
                } else if (field.type === 'number') {
                    value = value ? parseFloat(value) : null;
                }
                
                changes.push({ fieldId, value });
            });
            
            if (changes.length === 0) {
                closeModal('bulkEditModal');
                return;
            }
            
            // Apply changes to all selected records
            const selected = getSelectedRecords(bulkEditTableId);
            selected.forEach(recordId => {
                const record = getRecordById(bulkEditTableId, recordId);
                if (record) {
                    changes.forEach(({ fieldId, value }) => {
                        record.values[fieldId] = value;
                    });
                }
            });
            
            closeModal('bulkEditModal');
            clearSelection(bulkEditTableId);
            autoSave();
        }
        
        // Bulk add to collection
        function openBulkAddToCollectionModal(tableId) {
            bulkEditTableId = tableId;
            if (!database.meta.collections || database.meta.collections.length === 0) {
                alert(t('noCollections'));
                return;
            }
            
            let optionsHtml = `<option value="">${t('selectCollection')}</option>`;
            const sortedCols = [...database.meta.collections].sort((a, b) => a.name.localeCompare(b.name, currentLang));
            sortedCols.forEach(col => {
                optionsHtml += `<option value="${col.id}">${escapeHtml(col.name)}</option>`;
            });
            
            document.getElementById('bulkCollectionSelect').innerHTML = optionsHtml;
            openModal('bulkAddToCollectionModal');
        }
        
        function applyBulkAddToCollection() {
            const colId = document.getElementById('bulkCollectionSelect').value;
            if (!colId) return;
            
            const col = database.meta.collections?.find(c => c.id === colId);
            if (!col) return;
            
            if (!col.members) col.members = [];
            
            const selected = getSelectedRecords(bulkEditTableId);
            let added = 0;
            selected.forEach(recordId => {
                // Skip if already in collection
                if (!col.members.some(m => m.tableId === bulkEditTableId && m.recordId === recordId)) {
                    col.members.push({ tableId: bulkEditTableId, recordId });
                    added++;
                }
            });
            
            closeModal('bulkAddToCollectionModal');
            clearSelection(bulkEditTableId);
            autoSave();
            alert(t('addedToCollection', { count: added }));
        }
        
        // Bulk add tag
        function openBulkAddTagModal(tableId) {
            bulkEditTableId = tableId;
            if (!database.meta.tags || database.meta.tags.length === 0) {
                alert(t('noTags'));
                return;
            }
            
            let optionsHtml = `<option value="">${t('selectTag')}</option>`;
            const sortedTags = [...database.meta.tags].sort((a, b) => a.name.localeCompare(b.name, currentLang));
            sortedTags.forEach(tag => {
                optionsHtml += `<option value="${tag.id}">${escapeHtml(tag.name)}</option>`;
            });
            
            document.getElementById('bulkTagSelect').innerHTML = optionsHtml;
            openModal('bulkAddTagModal');
        }
        
        function applyBulkAddTag() {
            const tagId = document.getElementById('bulkTagSelect').value;
            if (!tagId) return;
            
            const selected = getSelectedRecords(bulkEditTableId);
            let added = 0;
            selected.forEach(recordId => {
                const record = getRecordById(bulkEditTableId, recordId);
                if (record) {
                    if (!record.tags) record.tags = [];
                    if (!record.tags.includes(tagId)) {
                        record.tags.push(tagId);
                        added++;
                    }
                }
            });
            
            closeModal('bulkAddTagModal');
            clearSelection(bulkEditTableId);
            autoSave();
            alert(t('addedTag', { count: added }));
        }
        
        // Bulk delete
        function bulkDelete(tableId) {
            const count = getSelectedCount(tableId);
            if (count === 0) return;
            
            confirmAction(t('confirmBulkDelete', { count }), () => {
                const table = getTableById(tableId);
                if (!table) return;
                
                const selected = getSelectedRecords(tableId);
                table.records = table.records.filter(r => !selected.has(r.id));
                
                // Remove from collections
                if (database.meta.collections) {
                    database.meta.collections.forEach(col => {
                        if (col.members) {
                            col.members = col.members.filter(m => !(m.tableId === tableId && selected.has(m.recordId)));
                        }
                    });
                }
                
                clearSelection(tableId);
                autoSave();
            });
        }

        // Global search
        function performGlobalSearch(query) {
            if (!query || query.length < 2) return [];
            
            const results = [];
            const q = query.toLowerCase();
            
            database.tables.forEach(table => {
                table.records.forEach(record => {
                    let matchedFields = [];
                    let matchScore = 0;
                    
                    table.fields.forEach(field => {
                        if (field.type === 'children' || field.type === 'composite') return;
                        
                        let value = record.values[field.id];
                        if (value == null) return;
                        
                        // For parent fields, get the display name
                        if (field.type === 'parent' && value) {
                            const tt = getTableById(field.targetTableId);
                            const pr = tt ? getRecordById(field.targetTableId, value) : null;
                            if (pr && tt) value = getPrimaryFieldValue(tt, pr);
                        }
                        
                        const strValue = String(value).toLowerCase();
                        if (strValue.includes(q)) {
                            matchedFields.push({ field, value: String(value) });
                            matchScore += field.primary ? 10 : 1;
                        }
                    });
                    
                    if (matchedFields.length > 0) {
                        results.push({
                            table,
                            record,
                            matchedFields,
                            matchScore,
                            primaryValue: getPrimaryFieldValue(table, record)
                        });
                    }
                });
            });
            
            // Sort by score (primary field matches first) and then by name
            results.sort((a, b) => {
                if (b.matchScore !== a.matchScore) return b.matchScore - a.matchScore;
                return a.primaryValue.localeCompare(b.primaryValue, currentLang);
            });
            
            return results.slice(0, 50); // Limit to 50 results
        }
        
        function showSearchResults(query) {
            const results = performGlobalSearch(query);
            const container = document.getElementById('searchResultsList');
            
            document.getElementById('searchResultsTitle').textContent = `üîç ${t('searchResults')}: "${query}"`;
            
            if (results.length === 0) {
                container.innerHTML = `<div class="search-no-results">${t('noSearchResults')}</div>`;
            } else {
                const q = query.toLowerCase();
                container.innerHTML = results.map(r => {
                    // Create preview from matched fields
                    const preview = r.matchedFields.slice(0, 2).map(mf => {
                        const val = mf.value;
                        // Highlight matching part
                        const idx = val.toLowerCase().indexOf(q);
                        if (idx >= 0) {
                            const before = escapeHtml(val.substring(Math.max(0, idx - 20), idx));
                            const match = escapeHtml(val.substring(idx, idx + query.length));
                            const after = escapeHtml(val.substring(idx + query.length, idx + query.length + 30));
                            return `${mf.field.name}: ...${before}<span class="search-result-highlight">${match}</span>${after}...`;
                        }
                        return `${mf.field.name}: ${escapeHtml(val.substring(0, 50))}`;
                    }).join(' | ');
                    
                    return `<a href="#" class="search-result-item" data-action="viewFromSearch" data-table="${r.table.id}" data-record="${r.record.id}">
                        <div class="search-result-table">${escapeHtml(r.table.name)}</div>
                        <div class="search-result-name">${escapeHtml(r.primaryValue)}</div>
                        <div class="search-result-preview">${preview}</div>
                    </a>`;
                }).join('');
            }
            
            openModal('searchResultsModal');
        }

        function updateQuickCreateOptions() {
            const select = document.getElementById('quickCreateSelect');
            let html = `<option value="">${t('quickCreate')}</option>`;
            database.tables.forEach(tb => {
                html += `<option value="${tb.id}">${escapeHtml(tb.name)}</option>`;
            });
            select.innerHTML = html;
        }

        function renderTableContent(tableId) {
            const container = document.getElementById('tableContents');
            // Ensure management and classification are hidden when showing table content
            document.getElementById('management-content').classList.remove('active');
            document.getElementById('classification-content').classList.remove('active');
            
            const table = getTableById(tableId);
            if (!table) { container.innerHTML = ''; return; }

            const filters = tableFilters[tableId] || {};
            const searchQuery = tableSearches[tableId] || '';
            const sort = tableSorts[tableId] || { field: null, dir: 'asc' };
            const cv = database.meta.columnVisibility[tableId] || {};
            const visibleFields = table.fields.filter(f => {
                if (cv[f.id] === false) return false;
                if (f.type === 'children' && cv[f.id] !== true) return false; // children mus√≠ b√Ωt explicitnƒõ povoleno
                return true;
            });

            // Build filters HTML - search box always visible, select filters only in advanced mode
            const searchHtml = `<div class="search-box"><input type="search" class="table-search" data-table="${tableId}" placeholder="${t('searchPlaceholder')}" value="${escapeAttr(searchQuery)}"></div>`;
            let selectFiltersHtml = '';
            table.fields.filter(f => f.filter && f.type !== 'children').forEach(f => {
                const vals = new Set(); let hasEmpty = false;
                table.records.forEach(r => { const v = r.values[f.id]; if (v == null || v === '') hasEmpty = true; else vals.add(String(v)); });
                const sorted = Array.from(vals).sort((a, b) => {
                    // For parent fields, sort by display name
                    if (f.type === 'parent' && f.targetTableId) {
                        const ttA = getTableById(f.targetTableId);
                        const recA = ttA ? getRecordById(f.targetTableId, a) : null;
                        const recB = ttA ? getRecordById(f.targetTableId, b) : null;
                        const nameA = recA ? getPrimaryFieldValue(ttA, recA) : a;
                        const nameB = recB ? getPrimaryFieldValue(ttA, recB) : b;
                        return nameA.localeCompare(nameB, currentLang);
                    }
                    return a.localeCompare(b, currentLang);
                });
                const cv = filters[f.id] || '';
                
                // Build options with proper display names
                const optionsHtml = sorted.map(v => {
                    let displayValue = v;
                    if (f.type === 'parent' && f.targetTableId) {
                        const tt = getTableById(f.targetTableId);
                        const rec = tt ? getRecordById(f.targetTableId, v) : null;
                        displayValue = rec ? getPrimaryFieldValue(tt, rec) : v;
                    } else if (f.type === 'boolean') {
                        displayValue = v === 'true' ? t('yes') : t('no');
                    }
                    return `<option value="${escapeAttr(v)}" ${cv === v ? 'selected' : ''}>${escapeHtml(displayValue)}</option>`;
                }).join('');
                
                selectFiltersHtml += `<div class="filter-item"><label>${escapeHtml(f.name)}</label><select class="table-filter" data-table="${tableId}" data-field="${f.id}"><option value="">${t('allValues')}</option>${hasEmpty ? `<option value="__null__" ${cv === '__null__' ? 'selected' : ''}>${t('noValue')}</option>` : ''}${optionsHtml}</select></div>`;
            });
            
            // Collection filter
            if (database.meta.collections?.length > 0) {
                const colFilterVal = collectionFilter || '';
                const sortedCols = [...database.meta.collections].sort((a, b) => a.name.localeCompare(b.name, currentLang));
                selectFiltersHtml += `<div class="filter-item"><label>${t('inCollection')}</label><select class="collection-filter" data-table="${tableId}"><option value="">${t('allCollections')}</option>${sortedCols.map(col => `<option value="${col.id}" ${colFilterVal === col.id ? 'selected' : ''}>${escapeHtml(col.name)}</option>`).join('')}</select></div>`;
            }
            
            // Tag filter
            if (database.meta.tags?.length > 0) {
                const tagFilterVal = tagFilter || '';
                const sortedTags = [...database.meta.tags].sort((a, b) => a.name.localeCompare(b.name, currentLang));
                selectFiltersHtml += `<div class="filter-item"><label>${t('withTag')}</label><select class="tag-filter" data-table="${tableId}"><option value="">${t('allTags')}</option>${sortedTags.map(tag => `<option value="${tag.id}" ${tagFilterVal === tag.id ? 'selected' : ''}>${escapeHtml(tag.name)}</option>`).join('')}</select></div>`;
            }
            
            // Combine: search always, select filters only in advanced mode
            const filtersHtml = searchHtml + (advancedMode ? selectFiltersHtml : '');

            // Filter records
            let filtered = table.records.filter(r => {
                for (const [fid, fv] of Object.entries(filters)) {
                    if (!fv) continue;
                    const v = r.values[fid];
                    if (fv === '__null__') { if (v != null && v !== '') return false; }
                    else { if (String(v) !== fv) return false; }
                }
                if (searchQuery) {
                    const sq = searchQuery.toLowerCase();
                    if (!table.fields.some(f => { const v = r.values[f.id]; return v != null && String(v).toLowerCase().includes(sq); })) return false;
                }
                // Collection filter
                if (collectionFilter) {
                    const col = database.meta.collections?.find(c => c.id === collectionFilter);
                    if (!col || !col.members?.some(m => m.tableId === tableId && m.recordId === r.id)) return false;
                }
                // Tag filter
                if (tagFilter) {
                    if (!r.tags || !r.tags.includes(tagFilter)) return false;
                }
                return true;
            });

            // Sort
            if (sort.field) {
                const sf = table.fields.find(f => f.id === sort.field);
                filtered.sort((a, b) => {
                    let va, vb;
                    if (sf?.type === 'composite') {
                        va = evaluateCompositeField(table, sf, a);
                        vb = evaluateCompositeField(table, sf, b);
                    } else {
                        va = a.values[sort.field] ?? '';
                        vb = b.values[sort.field] ?? '';
                    }
                    if (sf?.type === 'number') { va = parseFloat(va) || 0; vb = parseFloat(vb) || 0; }
                    else if (sf?.type === 'date') { va = new Date(va).getTime() || 0; vb = new Date(vb).getTime() || 0; }
                    else { va = String(va).toLowerCase(); vb = String(vb).toLowerCase(); }
                    if (va < vb) return sort.dir === 'asc' ? -1 : 1;
                    if (va > vb) return sort.dir === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Column toggles - include Collections and Tags
            const showCollections = cv['__collections__'] !== false;
            const showTags = cv['__tags__'] !== false;
            
            let togglesHtml = table.fields.map(f => {
                const isVisible = f.type === 'children' ? cv[f.id] === true : cv[f.id] !== false;
                return `<div class="checkbox-group"><input type="checkbox" class="col-toggle" data-table="${tableId}" data-field="${f.id}" ${isVisible ? 'checked' : ''}><label>${escapeHtml(f.name)}</label></div>`;
            }).join('');
            togglesHtml += `<div class="checkbox-group"><input type="checkbox" class="col-toggle" data-table="${tableId}" data-field="__collections__" ${showCollections ? 'checked' : ''}><label>${t('collections')}</label></div>`;
            togglesHtml += `<div class="checkbox-group"><input type="checkbox" class="col-toggle" data-table="${tableId}" data-field="__tags__" ${showTags ? 'checked' : ''}><label>${t('tags')}</label></div>`;

            // Table HTML
            let tableHtml = '';
            const groupField = table.fields.find(f => f.group);
            const groupStates = database.meta.groupStates?.[tableId] || {};
            
            // Helper to render Collections and Tags cells
            const renderCollectionsCell = (recordId) => {
                if (!showCollections) return '';
                const cols = getRecordCollections(tableId, recordId);
                if (cols.length === 0) return '<td>-</td>';
                return `<td class="badges-cell">${cols.map(c => `<a href="#" class="collection-badge" style="background:${c.color || '#4a90d9'}" data-action="viewCollection" data-collection="${c.id}">${escapeHtml(c.name)}</a>`).join('')}</td>`;
            };
            const renderTagsCell = (recordId) => {
                if (!showTags) return '';
                const tgs = getRecordTags(tableId, recordId);
                if (tgs.length === 0) return '<td>-</td>';
                return `<td class="badges-cell">${tgs.map(tg => `<a href="#" class="tag-badge" style="background:${tg.color || '#e74c3c'}" data-action="viewTag" data-tag="${tg.id}">${escapeHtml(tg.name)}</a>`).join('')}</td>`;
            };
            
            if (table.fields.length === 0) {
                tableHtml = `<div class="empty-state"><div class="empty-state-icon">üìù</div><p>${t('noFields')}</p></div>`;
            } else if (filtered.length === 0) {
                tableHtml = `<div class="empty-state"><div class="empty-state-icon">üìã</div><p>${t('noRecords')}</p></div>`;
            } else if (groupField) {
                // Grouped view
                const selected = selectedRecords[tableId] || new Set();
                const allSelected = filtered.length > 0 && filtered.every(r => selected.has(r.id));
                let headerCells = `<th class="checkbox-col no-sort"><input type="checkbox" class="bulk-checkbox bulk-select-all" data-table="${tableId}" ${allSelected ? 'checked' : ''} title="${t('selectAll')}"></th>`;
                headerCells += visibleFields.map(f => {
                    const isSorted = sort.field === f.id;
                    const cls = isSorted ? (sort.dir === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                    return `<th class="${cls}" data-table="${tableId}" data-field="${f.id}">${escapeHtml(f.name)}</th>`;
                }).join('');
                if (showCollections) headerCells += `<th class="no-sort">${t('collections')}</th>`;
                if (showTags) headerCells += `<th class="no-sort">${t('tags')}</th>`;
                headerCells += `<th class="no-sort">${t('actions')}</th>`;

                // Group records by groupField value
                const groups = new Map();
                filtered.forEach(r => {
                    let groupKey = r.values[groupField.id] ?? '';
                    let groupDisplay = groupKey;
                    
                    if (groupField.type === 'parent' && groupKey) {
                        const tt = getTableById(groupField.targetTableId);
                        const pr = tt ? getRecordById(groupField.targetTableId, groupKey) : null;
                        groupDisplay = pr && tt ? getPrimaryFieldValue(tt, pr) : groupKey;
                    } else if (groupField.type === 'boolean') {
                        groupDisplay = groupKey ? t('yes') : t('no');
                        groupKey = String(groupKey);
                    } else if (groupKey === '' || groupKey === null || groupKey === undefined) {
                        groupKey = '__empty__';
                        groupDisplay = t('noValue');
                    }
                    
                    if (!groups.has(groupKey)) groups.set(groupKey, { display: groupDisplay, records: [] });
                    groups.get(groupKey).records.push(r);
                });

                // Sort groups by display name
                const sortedGroups = Array.from(groups.entries()).sort((a, b) => {
                    if (a[0] === '__empty__') return 1;
                    if (b[0] === '__empty__') return -1;
                    return String(a[1].display).localeCompare(String(b[1].display), currentLang);
                });

                let groupedHtml = '';
                const colCount = visibleFields.length + (showCollections ? 1 : 0) + (showTags ? 1 : 0) + 2; // +2 for checkbox and actions
                
                sortedGroups.forEach(([groupKey, group]) => {
                    const isCollapsed = groupStates[groupKey] === true;
                    const groupId = `group_${tableId}_${groupKey.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    
                    groupedHtml += `<tbody class="record-group">`;
                    groupedHtml += `<tr class="group-header">
                        <th colspan="${colCount}" scope="colgroup">
                            <button type="button" class="group-toggle" data-table="${tableId}" data-group="${escapeHtml(groupKey)}" aria-expanded="${!isCollapsed}" aria-controls="${groupId}">
                                <span class="group-icon" aria-hidden="true">${isCollapsed ? '‚ñ∂' : '‚ñº'}</span>
                                ${escapeHtml(group.display)} (${group.records.length})
                            </button>
                        </th>
                    </tr>`;
                    
                    if (!isCollapsed) {
                        group.records.forEach(r => {
                            const isSelected = selected.has(r.id);
                            const lockIcon = r.locked ? '<span class="lock-icon" title="' + t('recordLocked') + '">üîí</span> ' : '';
                            const cells = visibleFields.map(f => `<td>${f.primary ? lockIcon : ''}${formatFieldValue(table, f, r.values[f.id], r)}</td>`).join('');
                            groupedHtml += `<tr id="${groupId}"><td class="checkbox-col"><input type="checkbox" class="bulk-checkbox bulk-select-row" data-table="${tableId}" data-record="${r.id}" ${isSelected ? 'checked' : ''}></td>${cells}${renderCollectionsCell(r.id)}${renderTagsCell(r.id)}<td class="actions-cell"><button type="button" class="btn btn-sm btn-secondary btn-icon view-record-btn" data-table="${tableId}" data-record="${r.id}" title="${t('view')}">üëÅÔ∏è</button><button type="button" class="btn btn-sm btn-secondary btn-icon edit-record-btn" data-table="${tableId}" data-record="${r.id}" title="${t('edit')}"${r.locked ? ' disabled' : ''}>‚úèÔ∏è</button><button type="button" class="btn btn-sm btn-danger btn-icon delete-record-btn" data-table="${tableId}" data-record="${r.id}" title="${t('delete')}"${r.locked ? ' disabled' : ''}>üóëÔ∏è</button></td></tr>`;
                        });
                    }
                    groupedHtml += `</tbody>`;
                });

                tableHtml = `<div class="table-wrapper"><table><thead><tr>${headerCells}</tr></thead>${groupedHtml}</table></div>`;
            } else {
                // Normal view without grouping
                const selected = selectedRecords[tableId] || new Set();
                const allSelected = filtered.length > 0 && filtered.every(r => selected.has(r.id));
                let headerCells = `<th class="checkbox-col no-sort"><input type="checkbox" class="bulk-checkbox bulk-select-all" data-table="${tableId}" ${allSelected ? 'checked' : ''} title="${t('selectAll')}"></th>`;
                headerCells += visibleFields.map(f => {
                    const isSorted = sort.field === f.id;
                    const cls = isSorted ? (sort.dir === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                    return `<th class="${cls}" data-table="${tableId}" data-field="${f.id}">${escapeHtml(f.name)}</th>`;
                }).join('');
                if (showCollections) headerCells += `<th class="no-sort">${t('collections')}</th>`;
                if (showTags) headerCells += `<th class="no-sort">${t('tags')}</th>`;
                headerCells += `<th class="no-sort">${t('actions')}</th>`;

                const bodyRows = filtered.map(r => {
                    const isSelected = selected.has(r.id);
                    const lockIcon = r.locked ? '<span class="lock-icon" title="' + t('recordLocked') + '">üîí</span> ' : '';
                    const cells = visibleFields.map(f => `<td>${f.primary ? lockIcon : ''}${formatFieldValue(table, f, r.values[f.id], r)}</td>`).join('');
                    return `<tr><td class="checkbox-col"><input type="checkbox" class="bulk-checkbox bulk-select-row" data-table="${tableId}" data-record="${r.id}" ${isSelected ? 'checked' : ''}></td>${cells}${renderCollectionsCell(r.id)}${renderTagsCell(r.id)}<td class="actions-cell"><button type="button" class="btn btn-sm btn-secondary btn-icon view-record-btn" data-table="${tableId}" data-record="${r.id}" title="${t('view')}">üëÅÔ∏è</button><button type="button" class="btn btn-sm btn-secondary btn-icon edit-record-btn" data-table="${tableId}" data-record="${r.id}" title="${t('edit')}"${r.locked ? ' disabled' : ''}>‚úèÔ∏è</button><button type="button" class="btn btn-sm btn-danger btn-icon delete-record-btn" data-table="${tableId}" data-record="${r.id}" title="${t('delete')}"${r.locked ? ' disabled' : ''}>üóëÔ∏è</button></td></tr>`;
                }).join('');

                tableHtml = `<div class="table-wrapper"><table><thead><tr>${headerCells}</tr></thead><tbody>${bodyRows}</tbody></table></div>`;
            }

            // Build views bar (accessible tabs)
            const views = getTableViews(tableId);
            const hasActiveView = activeViewId && views.some(v => v.id === activeViewId);
            
            let viewsHtml = '<div class="views-bar">';
            viewsHtml += '<div class="views-tabs" role="tablist" aria-label="' + t('savedViews') + '">';
            viewsHtml += `<button type="button" role="tab" aria-selected="${!activeViewId}" tabindex="${!activeViewId ? '0' : '-1'}" data-view="" data-table="${tableId}">${t('allRecords')}</button>`;
            views.forEach((v, idx) => {
                const isActive = activeViewId === v.id;
                viewsHtml += `<button type="button" role="tab" aria-selected="${isActive}" tabindex="${isActive ? '0' : '-1'}" data-view="${v.id}" data-table="${tableId}">${escapeHtml(v.name)}</button>`;
            });
            viewsHtml += '</div>';
            
            // View actions toolbar - hidden in simple mode using CSS class
            if (advancedMode) {
                viewsHtml += '<div class="views-actions">';
                viewsHtml += `<button type="button" class="btn btn-sm btn-success view-save-btn" data-table="${tableId}" title="${t('saveView')}"><span aria-hidden="true">‚ûï</span> ${t('saveView')}</button>`;
                viewsHtml += `<button type="button" class="btn btn-sm btn-secondary view-update-btn" data-table="${tableId}" ${!hasActiveView ? 'disabled' : ''} title="${t('updateView')}"><span aria-hidden="true">üíæ</span> ${t('updateView')}</button>`;
                viewsHtml += `<button type="button" class="btn btn-sm btn-secondary view-rename-btn" data-table="${tableId}" ${!hasActiveView ? 'disabled' : ''} title="${t('renameView')}"><span aria-hidden="true">‚úèÔ∏è</span> ${t('renameView')}</button>`;
                viewsHtml += `<button type="button" class="btn btn-sm btn-danger view-delete-btn" data-table="${tableId}" ${!hasActiveView ? 'disabled' : ''} title="${t('delete')}"><span aria-hidden="true">üóëÔ∏è</span> ${t('delete')}</button>`;
                viewsHtml += '</div>';
            }
            viewsHtml += '</div>';

            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2>${escapeHtml(table.name)}</h2>
                        <div class="inline-actions">
                            <button type="button" class="btn btn-sm btn-secondary export-table-btn advanced-only" data-table="${tableId}"><span aria-hidden="true">üì§</span> ${t('export')}</button>
                            <button type="button" class="btn btn-sm btn-secondary import-table-btn advanced-only" data-table="${tableId}"><span aria-hidden="true">üì•</span> ${t('import')}</button>
                            <button type="button" class="btn btn-success add-record-btn" data-table="${tableId}" accesskey="n"><span aria-hidden="true">‚ûï</span> ${t('addRecord')}</button>
                        </div>
                    </div>
                    <div class="card-body">
                        ${viewsHtml}
                        <div class="filters-section">${filtersHtml}</div>
                        ${renderBulkActionsBar(tableId)}
                        <div class="record-count">${t('recordsShowing', { filtered: filtered.length, total: table.records.length })}</div>
                        ${tableHtml}
                        <details><summary>${t('columnVisibility')}</summary><div class="column-toggles">${togglesHtml}</div></details>
                        <div class="card-footer-actions">
                            <button type="button" class="btn btn-success add-record-btn" data-table="${tableId}"><span aria-hidden="true">‚ûï</span> ${t('addRecord')}</button>
                        </div>
                    </div>
                </div>
            `;

            // Store filtered records for generator
            table._filteredRecords = filtered;
        }

        function formatFieldValue(table, field, value, record) {
            // For composite and children, value is computed, not stored
            if (field.type !== 'composite' && field.type !== 'children' && (value == null || value === '')) {
                return '<span class="view-field-value empty">-</span>';
            }
            switch (field.type) {
                case 'boolean': return value ? t('yes') : t('no');
                case 'date': return formatDate(value, field.dateFormat);
                case 'textarea': return `<span title="${escapeHtml(value)}">${escapeHtml(value.length > 50 ? value.substr(0, 50) + '...' : value)}</span>`;
                case 'url': 
                    const urlText = value.length > 40 ? value.substr(0, 40) + '...' : value;
                    return `<a href="${escapeHtml(value)}" target="_blank" rel="noopener noreferrer" class="url-link">${escapeHtml(urlText)}</a>`;
                case 'parent':
                    const tt = getTableById(field.targetTableId);
                    const pr = tt ? getRecordById(field.targetTableId, value) : null;
                    if (pr && tt) return `<a href="#" class="record-link" data-action="view" data-table="${field.targetTableId}" data-record="${value}">${escapeHtml(getPrimaryFieldValue(tt, pr))}</a>`;
                    return `<span class="view-field-value empty">${t('noParent')}</span>`;
                case 'children':
                    const ch = getChildRecords(table.id, record.id).filter(c => {
                        if (field.targetTableId && c.table.id !== field.targetTableId) return false;
                        if (field.parentFieldId && c.field.id !== field.parentFieldId) return false;
                        return true;
                    });
                    if (ch.length === 0) return `<span class="view-field-value empty">${t('noChildren')}</span>`;
                    return ch.map(c => `<a href="#" class="record-link" data-action="view" data-table="${c.table.id}" data-record="${c.record.id}">${escapeHtml(getPrimaryFieldValue(c.table, c.record))}</a>`).join(', ');
                case 'composite':
                    const compVal = evaluateCompositeField(table, field, record);
                    if (field.primary) return `<a href="#" class="record-link" data-action="view" data-table="${table.id}" data-record="${record.id}">${escapeHtml(compVal)}</a>`;
                    return escapeHtml(compVal);
                default:
                    if (field.primary) return `<a href="#" class="record-link" data-action="view" data-table="${table.id}" data-record="${record.id}">${escapeHtml(String(value))}</a>`;
                    return escapeHtml(String(value));
            }
        }

        function evaluateCompositeField(table, field, record) {
            if (!field.compositeTemplate) return '';
            let result = field.compositeTemplate;
            table.fields.forEach(f => {
                if (f.id === field.id) return; // skip self
                let val = record.values[f.id] ?? '';
                if (f.type === 'boolean') val = val ? t('yes') : t('no');
                else if (f.type === 'date' && val) val = formatDate(val, f.dateFormat);
                else if (f.type === 'parent' && val) {
                    const tt = getTableById(f.targetTableId);
                    const pr = tt ? getRecordById(f.targetTableId, val) : null;
                    val = pr && tt ? getPrimaryFieldValue(tt, pr) : val;
                }
                result = result.replace(new RegExp(`\\{${f.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\}`, 'g'), val);
            });
            return result;
        }

        function renderManagement() {
            // Ensure classification and table contents are hidden when showing management
            document.getElementById('classification-content').classList.remove('active');
            document.getElementById('tableContents').innerHTML = '';
            document.getElementById('management-content').classList.add('active');
            renderTablesList();
            renderStats();
            renderGeneratorTable();
            renderCollectionsList();
            renderTagsList();
            document.getElementById('dbNameInput').value = database.meta.name;
        }

        function renderCollectionsList() {
            if (!database.meta.collections) database.meta.collections = [];
            const container = document.getElementById('collectionsList');
            const empty = document.getElementById('emptyCollections');
            if (database.meta.collections.length === 0) { container.innerHTML = ''; empty.hidden = false; return; }
            empty.hidden = true;
            const sortedCols = [...database.meta.collections].sort((a, b) => a.name.localeCompare(b.name, currentLang));
            container.innerHTML = sortedCols.map(col => {
                const count = col.members?.length || 0;
                const descPreview = col.description ? escapeHtml(col.description.substring(0, 100)) + (col.description.length > 100 ? '...' : '') : '';
                return `
                <div class="collection-card" data-collection="${col.id}">
                    <div class="collection-card-header">
                        <div class="collection-card-color" style="background: ${col.color || '#4a90d9'}"></div>
                        <div class="collection-card-name">${escapeHtml(col.name)}</div>
                        <div class="collection-card-count">${count} ${t('collectionMembers')}</div>
                    </div>
                    ${descPreview ? `<div class="collection-card-desc">${descPreview}</div>` : ''}
                </div>`;
            }).join('');
        }

        function renderTagsList() {
            if (!database.meta.tags) database.meta.tags = [];
            const container = document.getElementById('tagsList');
            const empty = document.getElementById('emptyTags');
            if (database.meta.tags.length === 0) { container.innerHTML = ''; empty.hidden = false; return; }
            empty.hidden = true;
            const sortedTags = [...database.meta.tags].sort((a, b) => a.name.localeCompare(b.name, currentLang));
            container.innerHTML = sortedTags.map(tag => {
                // Count records with this tag
                let count = 0;
                database.tables.forEach(tb => {
                    tb.records.forEach(r => {
                        if (r.tags && r.tags.includes(tag.id)) count++;
                    });
                });
                return `
                <div class="tag-card" data-tag="${tag.id}">
                    <div class="tag-card-header">
                        <div class="collection-card-color" style="background: ${tag.color || '#e74c3c'}"></div>
                        <div class="tag-card-name">${escapeHtml(tag.name)}</div>
                        <div class="tag-card-count">${count} ${t('collectionMembers')}</div>
                    </div>
                </div>`;
            }).join('');
        }
        
        // Notes management
        let notesFilter = 'all';
        
        function getRecordNotes(tableId, recordId) {
            if (!database.meta.notes) database.meta.notes = [];
            return database.meta.notes.filter(n => n.tableId === tableId && n.recordId === recordId);
        }
        
        function addNote(tableId, recordId, text) {
            if (!database.meta.notes) database.meta.notes = [];
            const note = {
                id: generateId(),
                tableId: tableId,
                recordId: recordId,
                text: text,
                createdAt: Date.now(),
                resolved: false
            };
            database.meta.notes.push(note);
            autoSave();
            return note;
        }
        
        function updateNote(noteId, text) {
            const note = database.meta.notes?.find(n => n.id === noteId);
            if (note) {
                note.text = text;
                autoSave();
            }
        }
        
        function deleteNote(noteId) {
            if (!database.meta.notes) return;
            const idx = database.meta.notes.findIndex(n => n.id === noteId);
            if (idx !== -1) {
                database.meta.notes.splice(idx, 1);
                autoSave();
            }
        }
        
        function toggleNoteResolved(noteId) {
            const note = database.meta.notes?.find(n => n.id === noteId);
            if (note) {
                note.resolved = !note.resolved;
                autoSave();
            }
        }
        
        function renderNotesSection(tableId, recordId, container) {
            const notes = getRecordNotes(tableId, recordId);
            let html = `<div class="notes-section">
                <h4><span aria-hidden="true">üìù</span> ${t('notes')} (${notes.length})</h4>`;
            
            if (notes.length > 0) {
                html += '<div class="notes-list">';
                notes.sort((a, b) => b.createdAt - a.createdAt).forEach(note => {
                    const date = new Date(note.createdAt).toLocaleString(currentLang);
                    const statusClass = note.resolved ? 'resolved' : 'unresolved';
                    const statusText = note.resolved ? t('noteResolved') : t('noteUnresolved');
                    const toggleText = note.resolved ? t('markUnresolved') : t('markResolved');
                    html += `
                        <div class="note-item ${statusClass}" data-note="${note.id}">
                            <div class="note-header">
                                <span class="note-status ${statusClass}">${note.resolved ? '‚úì' : '‚óã'} ${statusText}</span>
                                <span class="note-date">${date}</span>
                            </div>
                            <div class="note-text">${escapeHtml(note.text)}</div>
                            <div class="note-actions">
                                <button type="button" class="btn btn-sm btn-secondary note-toggle-btn" data-note="${note.id}" title="${toggleText}">${note.resolved ? '‚Ü©Ô∏è' : '‚úì'}</button>
                                <button type="button" class="btn btn-sm btn-secondary note-edit-btn" data-note="${note.id}" title="${t('editNote')}">‚úèÔ∏è</button>
                                <button type="button" class="btn btn-sm btn-danger note-delete-btn" data-note="${note.id}" title="${t('deleteNote')}">üóëÔ∏è</button>
                            </div>
                        </div>`;
                });
                html += '</div>';
            } else {
                html += `<p style="color: var(--text-muted); font-style: italic;">${t('noNotes')}</p>`;
            }
            
            // Add note form
            html += `
                <div class="add-note-form">
                    <textarea id="newNoteText" placeholder="${t('noteText')}..." rows="2"></textarea>
                    <button type="button" class="btn btn-sm btn-success" id="btnAddNote" data-table="${tableId}" data-record="${recordId}">
                        <span aria-hidden="true">‚ûï</span> ${t('addNote')}
                    </button>
                </div>
            </div>`;
            
            container.innerHTML = html;
        }
        
        function renderGlobalNotesList() {
            if (!database.meta.notes) database.meta.notes = [];
            const container = document.getElementById('notesListGlobal');
            const empty = document.getElementById('emptyNotes');
            
            // Filter notes
            let notes = database.meta.notes.slice();
            if (notesFilter === 'unresolved') notes = notes.filter(n => !n.resolved);
            else if (notesFilter === 'resolved') notes = notes.filter(n => n.resolved);
            
            if (notes.length === 0) { 
                container.innerHTML = ''; 
                empty.hidden = false; 
                return; 
            }
            empty.hidden = true;
            
            // Sort by date (newest first)
            notes.sort((a, b) => b.createdAt - a.createdAt);
            
            let html = '<table class="notes-table"><thead><tr>';
            html += `<th>${t('noteText')}</th>`;
            html += `<th>${t('record')}</th>`;
            html += `<th>${t('table')}</th>`;
            html += `<th>${t('date')}</th>`;
            html += `<th>${t('status')}</th>`;
            html += `<th>${t('actions')}</th>`;
            html += '</tr></thead><tbody>';
            
            notes.forEach(note => {
                const table = getTableById(note.tableId);
                const record = getRecordById(note.tableId, note.recordId);
                const tableName = table ? table.name : '?';
                const recordName = record && table ? getPrimaryFieldValue(table, record) : '?';
                const date = new Date(note.createdAt).toLocaleDateString(currentLang);
                const statusClass = note.resolved ? 'resolved' : 'unresolved';
                const statusText = note.resolved ? t('noteResolved') : t('noteUnresolved');
                const toggleText = note.resolved ? t('markUnresolved') : t('markResolved');
                const previewText = note.text.length > 50 ? note.text.substring(0, 50) + '...' : note.text;
                
                html += `<tr>
                    <td class="note-preview" title="${escapeAttr(note.text)}">${escapeHtml(previewText)}</td>
                    <td><a href="#" class="record-link" data-action="view" data-table="${note.tableId}" data-record="${note.recordId}">${escapeHtml(recordName)}</a></td>
                    <td>${escapeHtml(tableName)}</td>
                    <td>${date}</td>
                    <td><span class="note-status ${statusClass}">${note.resolved ? '‚úì' : '‚óã'} ${statusText}</span></td>
                    <td class="note-actions">
                        <button type="button" class="btn btn-sm btn-secondary note-toggle-btn" data-note="${note.id}" title="${toggleText}">${note.resolved ? '‚Ü©Ô∏è' : '‚úì'}</button>
                        <button type="button" class="btn btn-sm btn-danger note-delete-btn" data-note="${note.id}" title="${t('deleteNote')}">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderTablesList() {
            const container = document.getElementById('tablesList');
            const empty = document.getElementById('emptyTables');
            if (database.tables.length === 0) { container.innerHTML = ''; empty.hidden = false; document.getElementById('fieldsCard').hidden = true; return; }
            empty.hidden = true;
            let html = `<table class="management-table">
                <thead><tr>
                    <th class="col-order">${t('order')}</th>
                    <th>${t('tableName')}</th>
                    <th>${t('fields')}</th>
                    <th>${t('records')}</th>
                    <th>${t('showInSimpleMode')}</th>
                    <th class="col-actions">${t('actions')}</th>
                </tr></thead><tbody>`;
            database.tables.forEach((tb, i) => {
                const showInSimple = tb.showInSimpleMode !== false; // default true
                html += `<tr>
                    <td class="col-order">
                        <button type="button" class="btn btn-sm btn-secondary btn-icon move-table-btn" data-table="${tb.id}" data-dir="-1" ${i === 0 ? 'disabled' : ''} title="${t('moveUp')}">‚ñ≤</button>
                        <button type="button" class="btn btn-sm btn-secondary btn-icon move-table-btn" data-table="${tb.id}" data-dir="1" ${i === database.tables.length - 1 ? 'disabled' : ''} title="${t('moveDown')}">‚ñº</button>
                    </td>
                    <td><strong>${escapeHtml(tb.name)}</strong></td>
                    <td>${tb.fields.length}</td>
                    <td>${tb.records.length}</td>
                    <td><input type="checkbox" class="table-simple-mode-toggle" data-table="${tb.id}" ${showInSimple ? 'checked' : ''} aria-label="${t('showInSimpleMode')}"></td>
                    <td class="col-actions">
                        <button type="button" class="btn btn-sm btn-secondary show-fields-btn" data-table="${tb.id}" title="${t('manageFields')}">üìã ${t('fields')}</button>
                        <button type="button" class="btn btn-sm btn-secondary edit-table-btn" data-table="${tb.id}" title="${t('edit')}">‚úèÔ∏è</button>
                        <button type="button" class="btn btn-sm btn-danger delete-table-btn" data-table="${tb.id}" title="${t('delete')}">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showFieldsForTable(tableId) {
            editingFieldTableId = tableId;
            const table = getTableById(tableId);
            if (!table) return;
            document.getElementById('fieldsCard').hidden = false;
            document.getElementById('fieldsTableName').textContent = table.name;
            renderFieldList();
        }

        function renderFieldList() {
            const table = getTableById(editingFieldTableId);
            const container = document.getElementById('fieldList');
            const empty = document.getElementById('emptyFields');
            if (!table || table.fields.length === 0) { container.innerHTML = ''; empty.hidden = false; return; }
            empty.hidden = true;
            const typeNames = { text: t('typeText'), textarea: t('typeTextarea'), number: t('typeNumber'), date: t('typeDate'), url: t('typeUrl'), boolean: t('typeBoolean'), select: t('typeSelect'), composite: t('typeComposite'), parent: t('typeParent'), children: t('typeChildren') };
            
            let html = `<table class="management-table">
                <thead><tr>
                    <th class="col-order">${t('order')}</th>
                    <th>${t('fieldName')}</th>
                    <th>${t('type')}</th>
                    <th>${t('options')}</th>
                    <th class="col-actions">${t('actions')}</th>
                </tr></thead><tbody>`;
            
            table.fields.forEach((f, i) => {
                const badges = [];
                if (f.primary) badges.push(`<span class="badge badge-primary">${t('primary')}</span>`);
                if (f.filter) badges.push(`<span class="badge badge-filter">${t('filter')}</span>`);
                if (f.group) badges.push(`<span class="badge badge-group">${t('group')}</span>`);
                
                let targetInfo = '';
                if ((f.type === 'parent' || f.type === 'children') && f.targetTableId) {
                    const tt = getTableById(f.targetTableId);
                    targetInfo = `‚Üí ${tt?.name || '?'}`;
                }
                
                let optionsInfo = '';
                if (f.type === 'select' && f.options) optionsInfo = escapeHtml(f.options);
                else if (targetInfo) optionsInfo = targetInfo;
                
                html += `<tr>
                    <td class="col-order">
                        <button type="button" class="btn btn-sm btn-secondary btn-icon move-field-btn" data-field="${f.id}" data-dir="-1" ${i === 0 ? 'disabled' : ''} title="${t('moveUp')}">‚ñ≤</button>
                        <button type="button" class="btn btn-sm btn-secondary btn-icon move-field-btn" data-field="${f.id}" data-dir="1" ${i === table.fields.length - 1 ? 'disabled' : ''} title="${t('moveDown')}">‚ñº</button>
                    </td>
                    <td><strong>${escapeHtml(f.name)}</strong> ${badges.join(' ')}</td>
                    <td>${typeNames[f.type] || f.type}</td>
                    <td>${optionsInfo}</td>
                    <td class="col-actions">
                        <button type="button" class="btn btn-sm btn-secondary edit-field-btn" data-field="${f.id}" title="${t('edit')}">‚úèÔ∏è</button>
                        <button type="button" class="btn btn-sm btn-danger delete-field-btn" data-field="${f.id}" title="${t('delete')}">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderStats() {
            const totalRecords = database.tables.reduce((sum, tb) => sum + tb.records.length, 0);
            let html = `<div class="stat-card"><div class="stat-value">${database.tables.length}</div><div class="stat-label">${t('totalTables')}</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${totalRecords}</div><div class="stat-label">${t('totalRecords')}</div></div>`;
            database.tables.forEach(tb => {
                html += `<div class="stat-card"><div class="stat-value">${tb.records.length}</div><div class="stat-label">${t('recordsInTable', { name: tb.name })}</div></div>`;
            });
            document.getElementById('statsGrid').innerHTML = html;
        }

        function renderGeneratorTable() {
            const sel = document.getElementById('generatorTable');
            sel.innerHTML = database.tables.map(tb => `<option value="${tb.id}">${escapeHtml(tb.name)}</option>`).join('');
            updateGeneratorFields();
        }

        function updateGeneratorFields() {
            const tableId = document.getElementById('generatorTable').value;
            const table = getTableById(tableId);
            const container = document.getElementById('generatorFieldButtons');
            if (!table) { container.innerHTML = ''; return; }
            container.innerHTML = table.fields.filter(f => f.type !== 'children').map(f => `<button type="button" class="field-btn" data-field="{${f.name}}">{${escapeHtml(f.name)}}</button>`).join('');
        }

        function generateText() {
            const tableId = document.getElementById('generatorTable').value;
            const table = getTableById(tableId);
            const template = document.getElementById('generatorTemplate').value;
            const useFiltered = document.querySelector('input[name="genRecords"]:checked').value === 'filtered';
            if (!table || !template) return;

            const records = useFiltered && table._filteredRecords ? table._filteredRecords : table.records;
            const output = records.map(r => {
                let line = template;
                table.fields.forEach(f => {
                    let val = r.values[f.id] ?? '';
                    if (f.type === 'boolean') val = val ? t('yes') : t('no');
                    else if (f.type === 'date' && val) val = formatDate(val, f.dateFormat);
                    else if (f.type === 'parent' && val) {
                        const tt = getTableById(f.targetTableId);
                        const pr = tt ? getRecordById(f.targetTableId, val) : null;
                        val = pr && tt ? getPrimaryFieldValue(tt, pr) : val;
                    }
                    line = line.replace(new RegExp(`\\{${f.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\}`, 'g'), val);
                });
                return line;
            }).join('\n');

            document.getElementById('generatorOutput').textContent = output;
            document.getElementById('generatorOutput').hidden = false;
            document.getElementById('btnCopyGenerated').hidden = false;
        }

        function switchTab(tabId) {
            activeTab = tabId;
            activeViewId = null; // Reset view when switching tables
            document.querySelectorAll('.table-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.table-tab[data-table-id="${tabId}"]`)?.classList.add('active');
            document.getElementById('management-content').classList.remove('active');
            document.getElementById('classification-content').classList.remove('active');
            document.getElementById('tableContents').innerHTML = '';
            
            if (tabId === 'management') {
                renderManagement();
            } else if (tabId === 'classification') {
                renderClassification();
            } else {
                activeTableId = tabId;
                renderTableContent(tabId);
            }
        }
        
        // Views management
        function getTableViews(tableId) {
            if (!database.meta.views) database.meta.views = {};
            if (!database.meta.views[tableId]) database.meta.views[tableId] = [];
            return database.meta.views[tableId];
        }
        
        function saveCurrentView(tableId) {
            const name = prompt(t('viewName'), t('newView'));
            if (!name) return;
            
            const views = getTableViews(tableId);
            const view = {
                id: generateId(),
                name: name,
                filters: JSON.parse(JSON.stringify(tableFilters[tableId] || {})),
                search: tableSearches[tableId] || '',
                sort: JSON.parse(JSON.stringify(tableSorts[tableId] || { field: null, dir: 'asc' })),
                columnVisibility: JSON.parse(JSON.stringify(database.meta.columnVisibility[tableId] || {})),
                collectionFilter: collectionFilter,
                tagFilter: tagFilter
            };
            views.push(view);
            activeViewId = view.id;
            autoSave();
            renderTableContent(tableId);
        }
        
        function loadView(tableId, viewId) {
            const views = getTableViews(tableId);
            const view = views.find(v => v.id === viewId);
            if (!view) return;
            
            activeViewId = viewId;
            tableFilters[tableId] = JSON.parse(JSON.stringify(view.filters || {}));
            tableSearches[tableId] = view.search || '';
            tableSorts[tableId] = JSON.parse(JSON.stringify(view.sort || { field: null, dir: 'asc' }));
            database.meta.columnVisibility[tableId] = JSON.parse(JSON.stringify(view.columnVisibility || {}));
            collectionFilter = view.collectionFilter || null;
            tagFilter = view.tagFilter || null;
            renderTableContent(tableId);
        }
        
        function clearView(tableId) {
            activeViewId = null;
            tableFilters[tableId] = {};
            tableSearches[tableId] = '';
            tableSorts[tableId] = { field: null, dir: 'asc' };
            collectionFilter = null;
            tagFilter = null;
            renderTableContent(tableId);
        }
        
        function updateView(tableId, viewId) {
            const views = getTableViews(tableId);
            const view = views.find(v => v.id === viewId);
            if (!view) return;
            
            view.filters = JSON.parse(JSON.stringify(tableFilters[tableId] || {}));
            view.search = tableSearches[tableId] || '';
            view.sort = JSON.parse(JSON.stringify(tableSorts[tableId] || { field: null, dir: 'asc' }));
            view.columnVisibility = JSON.parse(JSON.stringify(database.meta.columnVisibility[tableId] || {}));
            view.collectionFilter = collectionFilter;
            view.tagFilter = tagFilter;
            autoSave();
            renderTableContent(tableId);
        }
        
        function renameView(tableId, viewId) {
            const views = getTableViews(tableId);
            const view = views.find(v => v.id === viewId);
            if (!view) return;
            
            const name = prompt(t('viewName'), view.name);
            if (!name) return;
            view.name = name;
            autoSave();
            renderTableContent(tableId);
        }
        
        function deleteView(tableId, viewId) {
            if (!confirm(t('confirmDeleteView'))) return;
            const views = getTableViews(tableId);
            const idx = views.findIndex(v => v.id === viewId);
            if (idx !== -1) views.splice(idx, 1);
            if (activeViewId === viewId) activeViewId = null;
            autoSave();
            renderTableContent(tableId);
        }
        
        function renderClassification() {
            // Ensure management and table contents are hidden when showing classification
            document.getElementById('management-content').classList.remove('active');
            document.getElementById('tableContents').innerHTML = '';
            document.getElementById('classification-content').classList.add('active');
            renderCollectionsList();
            renderTagsList();
            renderGlobalNotesList();
        }

        // Table Modal
        function openTableModal(tableId = null) {
            document.getElementById('tableName').value = '';
            document.getElementById('tableId').value = '';
            if (tableId) {
                const tb = getTableById(tableId);
                if (tb) { document.getElementById('tableModalTitle').textContent = t('editTable'); document.getElementById('tableId').value = tb.id; document.getElementById('tableName').value = tb.name; }
            } else { document.getElementById('tableModalTitle').textContent = t('addTable'); }
            openModal('tableModal');
            setTimeout(() => document.getElementById('tableName').focus(), 50);
        }

        function saveTable() {
            const id = document.getElementById('tableId').value;
            const name = document.getElementById('tableName').value.trim();
            if (!name) return;
            if (id) { const tb = getTableById(id); if (tb) tb.name = name; }
            else { database.tables.push({ id: generateId(), name, fields: [], records: [] }); }
            closeModal('tableModal');
            renderAll();
        }

        // Collection Modal
        function openCollectionModal(collectionId = null) {
            if (!database.meta.collections) database.meta.collections = [];
            document.getElementById('collectionName').value = '';
            document.getElementById('collectionColor').value = '#4a90d9';
            document.getElementById('collectionDescription').value = '';
            document.getElementById('collectionId').value = '';
            if (collectionId) {
                const col = database.meta.collections.find(c => c.id === collectionId);
                if (col) {
                    document.getElementById('collectionModalTitle').textContent = t('editCollection');
                    document.getElementById('collectionId').value = col.id;
                    document.getElementById('collectionName').value = col.name;
                    document.getElementById('collectionColor').value = col.color || '#4a90d9';
                    document.getElementById('collectionDescription').value = col.description || '';
                }
            } else {
                document.getElementById('collectionModalTitle').textContent = t('addCollection');
            }
            openModal('collectionModal');
            setTimeout(() => document.getElementById('collectionName').focus(), 50);
        }

        function saveCollection() {
            if (!database.meta.collections) database.meta.collections = [];
            const id = document.getElementById('collectionId').value;
            const name = document.getElementById('collectionName').value.trim();
            const color = document.getElementById('collectionColor').value;
            const description = document.getElementById('collectionDescription').value;
            if (!name) return;
            if (id) {
                const col = database.meta.collections.find(c => c.id === id);
                if (col) { col.name = name; col.color = color; col.description = description; }
            } else {
                database.meta.collections.push({ id: generateId(), name, color, description, members: [] });
            }
            closeModal('collectionModal');
            renderCollectionsList();
        }

        function deleteCollection(collectionId) {
            confirmAction(t('confirmDeleteCollection'), () => {
                database.meta.collections = database.meta.collections.filter(c => c.id !== collectionId);
                closeModal('viewCollectionModal');
                renderCollectionsList();
            });
        }

        let currentViewCollectionId = null;
        
        function viewCollectionDetails(collectionId) {
            const col = database.meta.collections?.find(c => c.id === collectionId);
            if (!col) return;
            currentViewCollectionId = collectionId;
            
            document.getElementById('viewCollectionModalTitle').innerHTML = `üìÅ <span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:${col.color || '#4a90d9'};vertical-align:middle;margin-right:8px;"></span>${escapeHtml(col.name)}`;
            
            let html = '';
            
            // Description
            if (col.description) {
                html += `<div class="collection-detail-desc"><div class="markdown-content">${parseMarkdown(col.description)}</div></div>`;
            }
            
            // Members grouped by table
            html += `<h3>${t('recordsInCollection')} (${col.members?.length || 0})</h3>`;
            if (!col.members || col.members.length === 0) {
                html += `<p style="color: var(--text-muted); font-style: italic;">${t('noRecordsInCollection')}</p>`;
            } else {
                // Group by table
                const byTable = {};
                col.members.forEach(m => {
                    if (!byTable[m.tableId]) byTable[m.tableId] = [];
                    byTable[m.tableId].push(m.recordId);
                });
                
                Object.entries(byTable).forEach(([tableId, recordIds]) => {
                    const table = getTableById(tableId);
                    if (!table) return;
                    
                    html += `<h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">${escapeHtml(table.name)}</h4>`;
                    html += '<ul class="collection-members-list">';
                    recordIds.forEach(recordId => {
                        const record = getRecordById(tableId, recordId);
                        if (!record) return;
                        html += `<li>
                            <span><a href="#" class="record-link" data-action="viewFromCollection" data-table="${tableId}" data-record="${recordId}">${escapeHtml(getPrimaryFieldValue(table, record))}</a></span>
                            <button type="button" class="btn btn-sm btn-danger remove-from-collection-btn" data-collection="${collectionId}" data-table="${tableId}" data-record="${recordId}" title="${t('removeFromCollection')}">‚úï</button>
                        </li>`;
                    });
                    html += '</ul>';
                });
            }
            
            document.getElementById('viewCollectionContent').innerHTML = html;
            // Store collection id for refresh
            document.getElementById('viewCollectionModal').dataset.collectionId = collectionId;
            openModal('viewCollectionModal');
        }

        let currentViewTagId = null;
        
        function viewTagDetails(tagId) {
            const tag = database.meta.tags?.find(t => t.id === tagId);
            if (!tag) return;
            currentViewTagId = tagId;
            
            document.getElementById('viewTagModalTitle').innerHTML = `üè∑Ô∏è <span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:${tag.color || '#e74c3c'};vertical-align:middle;margin-right:8px;"></span>${escapeHtml(tag.name)}`;
            
            // Find all records with this tag, grouped by table
            const byTable = {};
            let totalCount = 0;
            database.tables.forEach(tb => {
                tb.records.forEach(r => {
                    if (r.tags && r.tags.includes(tagId)) {
                        if (!byTable[tb.id]) byTable[tb.id] = { table: tb, records: [] };
                        byTable[tb.id].records.push(r);
                        totalCount++;
                    }
                });
            });
            
            let html = `<h3>${t('recordsWithTag')} (${totalCount})</h3>`;
            if (totalCount === 0) {
                html += `<p style="color: var(--text-muted); font-style: italic;">${t('noRecords')}</p>`;
            } else {
                Object.values(byTable).forEach(({ table, records }) => {
                    html += `<h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">${escapeHtml(table.name)}</h4>`;
                    html += '<ul class="collection-members-list">';
                    records.forEach(record => {
                        html += `<li>
                            <span><a href="#" class="record-link" data-action="viewFromTag" data-table="${table.id}" data-record="${record.id}">${escapeHtml(getPrimaryFieldValue(table, record))}</a></span>
                            <button type="button" class="btn btn-sm btn-danger remove-tag-btn" data-tag="${tagId}" data-table="${table.id}" data-record="${record.id}" title="${t('removeThisTag')}">‚úï</button>
                        </li>`;
                    });
                    html += '</ul>';
                });
            }
            
            document.getElementById('viewTagContent').innerHTML = html;
            // Store tag id for refresh
            document.getElementById('viewTagModal').dataset.tagId = tagId;
            openModal('viewTagModal');
        }

        // Tag Modal
        function openTagModal(tagId = null) {
            if (!database.meta.tags) database.meta.tags = [];
            document.getElementById('tagName').value = '';
            document.getElementById('tagColor').value = '#e74c3c';
            document.getElementById('tagId').value = '';
            if (tagId) {
                const tag = database.meta.tags.find(t => t.id === tagId);
                if (tag) {
                    document.getElementById('tagModalTitle').textContent = t('editTable');
                    document.getElementById('tagId').value = tag.id;
                    document.getElementById('tagName').value = tag.name;
                    document.getElementById('tagColor').value = tag.color || '#e74c3c';
                }
            } else {
                document.getElementById('tagModalTitle').textContent = t('addTag');
            }
            openModal('tagModal');
            setTimeout(() => document.getElementById('tagName').focus(), 50);
        }

        function saveTag() {
            if (!database.meta.tags) database.meta.tags = [];
            const id = document.getElementById('tagId').value;
            const name = document.getElementById('tagName').value.trim();
            const color = document.getElementById('tagColor').value;
            if (!name) return;
            if (id) {
                const tag = database.meta.tags.find(t => t.id === id);
                if (tag) { tag.name = name; tag.color = color; }
            } else {
                database.meta.tags.push({ id: generateId(), name, color });
            }
            closeModal('tagModal');
            renderTagsList();
        }

        function deleteTag(tagId) {
            confirmAction(t('confirmDeleteTag'), () => {
                database.meta.tags = database.meta.tags.filter(t => t.id !== tagId);
                // Remove tag from all records
                database.tables.forEach(tb => {
                    tb.records.forEach(r => {
                        if (r.tags) r.tags = r.tags.filter(t => t !== tagId);
                    });
                });
                renderTagsList();
            });
        }

        // Add to collection modal
        let addToCollectionContext = { tableId: null, recordId: null };
        
        function openAddToCollectionModal(tableId, recordId) {
            addToCollectionContext = { tableId, recordId };
            document.getElementById('addToCollectionTableId').value = tableId;
            document.getElementById('addToCollectionRecordId').value = recordId;
            
            const select = document.getElementById('addToCollectionSelect');
            const existingCollections = getRecordCollections(tableId, recordId);
            const existingIds = existingCollections.map(c => c.id);
            
            // Filter out collections the record is already in, then sort
            const availableCollections = (database.meta.collections || []).filter(c => !existingIds.includes(c.id)).sort((a, b) => a.name.localeCompare(b.name, currentLang));
            
            if (availableCollections.length === 0) {
                select.innerHTML = `<option value="">${t('noCollections')}</option>`;
            } else {
                select.innerHTML = `<option value="">-- ${t('selectCollection')} --</option>` + 
                    availableCollections.map(col => `<option value="${col.id}">${escapeHtml(col.name)}</option>`).join('');
            }
            
            openModal('addToCollectionModal');
        }
        
        function confirmAddToCollection() {
            const collectionId = document.getElementById('addToCollectionSelect').value;
            if (!collectionId) return;
            
            const { tableId, recordId } = addToCollectionContext;
            toggleCollectionMembership(collectionId, tableId, recordId, true);
            closeModal('addToCollectionModal');
            
            // Refresh view if open
            if (currentRecordId === recordId && currentRecordTableId === tableId) {
                viewRecord(tableId, recordId);
            }
        }

        // Add tag to record modal
        let addTagContext = { tableId: null, recordId: null };
        
        function openAddTagModal(tableId, recordId) {
            addTagContext = { tableId, recordId };
            document.getElementById('addTagTableId').value = tableId;
            document.getElementById('addTagRecordId').value = recordId;
            
            const select = document.getElementById('addTagSelect');
            const existingTags = getRecordTags(tableId, recordId);
            const existingIds = existingTags.map(t => t.id);
            
            // Filter out tags the record already has, then sort
            const availableTags = (database.meta.tags || []).filter(t => !existingIds.includes(t.id)).sort((a, b) => a.name.localeCompare(b.name, currentLang));
            
            if (availableTags.length === 0) {
                select.innerHTML = `<option value="">${t('noTags')}</option>`;
            } else {
                select.innerHTML = `<option value="">-- ${t('selectTag')} --</option>` + 
                    availableTags.map(tag => `<option value="${tag.id}">${escapeHtml(tag.name)}</option>`).join('');
            }
            
            openModal('addTagToRecordModal');
        }
        
        function confirmAddTag() {
            const tagId = document.getElementById('addTagSelect').value;
            if (!tagId) return;
            
            const { tableId, recordId } = addTagContext;
            toggleTagAssignment(tagId, tableId, recordId, true);
            closeModal('addTagToRecordModal');
            
            // Refresh view if open
            if (currentRecordId === recordId && currentRecordTableId === tableId) {
                viewRecord(tableId, recordId);
            }
        }

        function toggleCollectionMembership(collectionId, tableId, recordId, add) {
            const col = database.meta.collections.find(c => c.id === collectionId);
            if (!col) return;
            if (!col.members) col.members = [];
            
            if (add) {
                if (!col.members.some(m => m.tableId === tableId && m.recordId === recordId)) {
                    col.members.push({ tableId, recordId });
                }
            } else {
                col.members = col.members.filter(m => !(m.tableId === tableId && m.recordId === recordId));
            }
        }

        function toggleTagAssignment(tagId, tableId, recordId, add) {
            const record = getRecordById(tableId, recordId);
            if (!record) return;
            if (!record.tags) record.tags = [];
            
            if (add) {
                if (!record.tags.includes(tagId)) {
                    record.tags.push(tagId);
                }
            } else {
                record.tags = record.tags.filter(t => t !== tagId);
            }
        }

        // Get collections for a record
        function getRecordCollections(tableId, recordId) {
            if (!database.meta.collections) return [];
            return database.meta.collections.filter(col => 
                col.members?.some(m => m.tableId === tableId && m.recordId === recordId)
            );
        }

        // Get tags for a record
        function getRecordTags(tableId, recordId) {
            if (!database.meta.tags) return [];
            const record = getRecordById(tableId, recordId);
            if (!record || !record.tags) return [];
            return database.meta.tags.filter(tag => record.tags.includes(tag.id));
        }

        // Structure view functions
        let structureRootTableId = null;
        let structureRootRecordId = null;
        let structureExpandedNodes = new Set();
        let structureLoadedAll = new Set();
        let structureExpandedNotes = new Set();
        const STRUCTURE_MAX_DEPTH = 4;
        const STRUCTURE_MAX_ITEMS = 10;
        
        function getDirectChildren(tableId, recordId) {
            // Find all records that have this record as parent
            const children = [];
            database.tables.forEach(tb => {
                tb.fields.filter(f => f.type === 'parent').forEach(parentField => {
                    tb.records.forEach(r => {
                        if (r.values[parentField.id] === recordId) {
                            children.push({ table: tb, record: r, parentField });
                        }
                    });
                });
            });
            return children;
        }
        
        function getAncestors(tableId, recordId, visited = new Set()) {
            // Get all ancestors (parents, grandparents, etc.) of a record
            const key = `${tableId}_${recordId}`;
            if (visited.has(key)) return []; // Prevent cycles
            visited.add(key);
            
            const ancestors = [];
            const table = getTableById(tableId);
            const record = getRecordById(tableId, recordId);
            if (!table || !record) return ancestors;
            
            // Find parent fields in this table
            table.fields.filter(f => f.type === 'parent').forEach(parentField => {
                const parentId = record.values[parentField.id];
                if (parentId && parentField.targetTableId) {
                    const parentTable = getTableById(parentField.targetTableId);
                    const parentRecord = getRecordById(parentField.targetTableId, parentId);
                    if (parentTable && parentRecord) {
                        // Get ancestors of parent first (for correct order)
                        const higherAncestors = getAncestors(parentField.targetTableId, parentId, visited);
                        ancestors.push(...higherAncestors);
                        ancestors.push({ table: parentTable, record: parentRecord, field: parentField });
                    }
                }
            });
            
            return ancestors;
        }
        
        function countAllDescendants(tableId, recordId, visited = new Set()) {
            const key = `${tableId}_${recordId}`;
            if (visited.has(key)) return 0; // Prevent cycles
            visited.add(key);
            
            const children = getDirectChildren(tableId, recordId);
            let count = children.length;
            children.forEach(child => {
                count += countAllDescendants(child.table.id, child.record.id, visited);
            });
            return count;
        }
        
        function openStructureModal(tableId, recordId) {
            structureRootTableId = tableId;
            structureRootRecordId = recordId;
            structureExpandedNodes = new Set();
            structureLoadedAll = new Set();
            structureExpandedNotes = new Set();
            
            const table = getTableById(tableId);
            const record = getRecordById(tableId, recordId);
            if (!table || !record) return;
            
            const name = getPrimaryFieldValue(table, record);
            document.getElementById('structureModalTitle').innerHTML = `üå≥ ${t('structure')}: ${escapeHtml(name)}`;
            
            renderStructureTree();
            renderStructureGraph();
            openModal('structureModal');
        }
        
        function renderStructureTree() {
            const container = document.getElementById('structureTreeContainer');
            const table = getTableById(structureRootTableId);
            const record = getRecordById(structureRootTableId, structureRootRecordId);
            
            if (!table || !record) {
                container.innerHTML = `<p class="tree-empty">${t('noDescendants')}</p>`;
                return;
            }
            
            let html = '';
            
            // Get and render ancestors as breadcrumb
            const ancestors = getAncestors(structureRootTableId, structureRootRecordId);
            if (ancestors.length > 0) {
                html += '<div class="structure-ancestors">';
                html += `<span class="ancestors-label">üìç ${t('ancestors')}:</span>`;
                html += '<div class="ancestors-path">';
                ancestors.forEach((anc, idx) => {
                    const ancName = getPrimaryFieldValue(anc.table, anc.record);
                    const ancDescCount = countAllDescendants(anc.table.id, anc.record.id);
                    html += `<a href="#" class="ancestor-link" data-action="switchStructureRoot" data-table="${anc.table.id}" data-record="${anc.record.id}" title="${t('showStructureFrom')}">
                        ${escapeHtml(ancName)} <span class="ancestor-table">(${escapeHtml(anc.table.name)})</span>
                        <span class="ancestor-count">[${ancDescCount}]</span>
                    </a>`;
                    html += '<span class="ancestor-separator">‚Üí</span>';
                });
                // Current record (not clickable, it's the current root)
                const currentName = getPrimaryFieldValue(table, record);
                html += `<span class="ancestor-current">${escapeHtml(currentName)}</span>`;
                html += '</div></div>';
            }
            
            const children = getDirectChildren(structureRootTableId, structureRootRecordId);
            if (children.length === 0) {
                html += `<p class="tree-empty">${t('noDescendants')}</p>`;
                container.innerHTML = html;
                return;
            }
            
            const rootKey = `${structureRootTableId}_${structureRootRecordId}`;
            structureExpandedNodes.add(rootKey); // Root is always expanded
            
            html += '<ul class="tree-root">';
            html += renderTreeNode(structureRootTableId, structureRootRecordId, 0, true);
            html += '</ul>';
            
            container.innerHTML = html;
        }
        
        function renderTreeNode(tableId, recordId, depth, isRoot = false) {
            const table = getTableById(tableId);
            const record = getRecordById(tableId, recordId);
            if (!table || !record) return '';
            
            const key = `${tableId}_${recordId}`;
            const children = getDirectChildren(tableId, recordId);
            const totalDescendants = countAllDescendants(tableId, recordId);
            const hasChildren = children.length > 0;
            const isExpanded = structureExpandedNodes.has(key);
            const showAll = structureLoadedAll.has(key);
            const name = getPrimaryFieldValue(table, record);
            
            let html = '';
            
            if (!isRoot) {
                html += '<li class="tree-item">';
                html += `<button type="button" class="tree-toggle ${hasChildren ? '' : 'empty'}" data-key="${key}" data-table="${tableId}" data-record="${recordId}">${hasChildren ? (isExpanded ? '‚ñº' : '‚ñ∂') : ''}</button>`;
                html += `<a href="#" class="tree-link" data-action="viewFromStructure" data-table="${tableId}" data-record="${recordId}">${escapeHtml(name)}</a>`;
                html += `<span class="tree-table">(${escapeHtml(table.name)})</span>`;
                if (totalDescendants > 0) {
                    html += `<span class="tree-count">[${totalDescendants} ${t('descendants')}]</span>`;
                }
                // Notes button
                const recordNotes = getRecordNotes(tableId, recordId);
                if (recordNotes.length > 0) {
                    const notesKey = `notes_${tableId}_${recordId}`;
                    const notesExpanded = structureExpandedNotes.has(notesKey);
                    html += `<button type="button" class="tree-notes-toggle" data-action="toggleTreeNotes" data-key="${notesKey}" data-table="${tableId}" data-record="${recordId}" title="${t('notes')}">üìù ${recordNotes.length}</button>`;
                    if (notesExpanded) {
                        html += '<div class="tree-notes-container">';
                        recordNotes.forEach(note => {
                            const statusIcon = note.resolved ? '‚úì' : '‚óã';
                            const resolvedClass = note.resolved ? ' tree-note-resolved' : '';
                            html += `<div class="tree-note-item${resolvedClass}"><span class="tree-note-status">${statusIcon}</span><span class="tree-note-text">${escapeHtml(note.text)}</span></div>`;
                        });
                        html += '</div>';
                    }
                }
            }
            
            if (hasChildren && (isExpanded || isRoot)) {
                const maxDepthReached = depth >= STRUCTURE_MAX_DEPTH && !showAll;
                const itemsToShow = showAll ? children.length : Math.min(children.length, STRUCTURE_MAX_ITEMS);
                
                html += `<ul class="tree-children ${isExpanded || isRoot ? '' : 'collapsed'}">`;
                
                for (let i = 0; i < itemsToShow; i++) {
                    const child = children[i];
                    if (maxDepthReached) {
                        // Just show item without children
                        const childName = getPrimaryFieldValue(child.table, child.record);
                        const childDescendants = countAllDescendants(child.table.id, child.record.id);
                        html += '<li class="tree-item">';
                        html += `<button type="button" class="tree-toggle empty"></button>`;
                        html += `<a href="#" class="tree-link" data-action="viewFromStructure" data-table="${child.table.id}" data-record="${child.record.id}">${escapeHtml(childName)}</a>`;
                        html += `<span class="tree-table">(${escapeHtml(child.table.name)})</span>`;
                        if (childDescendants > 0) {
                            html += `<span class="tree-count">[${childDescendants} ${t('descendants')}]</span>`;
                        }
                        // Notes button for maxDepthReached items
                        const childNotes = getRecordNotes(child.table.id, child.record.id);
                        if (childNotes.length > 0) {
                            const notesKey = `notes_${child.table.id}_${child.record.id}`;
                            const notesExpanded = structureExpandedNotes.has(notesKey);
                            html += `<button type="button" class="tree-notes-toggle" data-action="toggleTreeNotes" data-key="${notesKey}" data-table="${child.table.id}" data-record="${child.record.id}" title="${t('notes')}">üìù ${childNotes.length}</button>`;
                            if (notesExpanded) {
                                html += '<div class="tree-notes-container">';
                                childNotes.forEach(note => {
                                    const statusIcon = note.resolved ? '‚úì' : '‚óã';
                                    const resolvedClass = note.resolved ? ' tree-note-resolved' : '';
                                    html += `<div class="tree-note-item${resolvedClass}"><span class="tree-note-status">${statusIcon}</span><span class="tree-note-text">${escapeHtml(note.text)}</span></div>`;
                                });
                                html += '</div>';
                            }
                        }
                        html += '</li>';
                    } else {
                        html += renderTreeNode(child.table.id, child.record.id, depth + 1);
                    }
                }
                
                if (children.length > STRUCTURE_MAX_ITEMS && !showAll) {
                    html += `<li class="tree-item"><span class="tree-load-more" data-key="${key}" data-action="loadAll">... ${t('loadAll')} (${children.length - STRUCTURE_MAX_ITEMS} ${t('loadMore').replace('...', '')})</span></li>`;
                }
                
                html += '</ul>';
            }
            
            if (!isRoot) {
                html += '</li>';
            }
            
            return html;
        }
        
        function toggleTreeNode(key, tableId, recordId) {
            if (structureExpandedNodes.has(key)) {
                structureExpandedNodes.delete(key);
            } else {
                structureExpandedNodes.add(key);
            }
            renderStructureTree();
        }
        
        function loadAllTreeItems(key) {
            structureLoadedAll.add(key);
            renderStructureTree();
        }
        
        function renderStructureGraph() {
            const container = document.getElementById('structureGraphContainer');
            const table = getTableById(structureRootTableId);
            const record = getRecordById(structureRootTableId, structureRootRecordId);
            
            if (!table || !record) {
                container.innerHTML = `<p class="tree-empty">${t('noDescendants')}</p>`;
                return;
            }
            
            let html = '';
            
            // Get and render ancestors as breadcrumb (same as tree view)
            const ancestors = getAncestors(structureRootTableId, structureRootRecordId);
            if (ancestors.length > 0) {
                html += '<div class="structure-ancestors">';
                html += `<span class="ancestors-label">üìç ${t('ancestors')}:</span>`;
                html += '<div class="ancestors-path">';
                ancestors.forEach((anc, idx) => {
                    const ancName = getPrimaryFieldValue(anc.table, anc.record);
                    const ancDescCount = countAllDescendants(anc.table.id, anc.record.id);
                    html += `<a href="#" class="ancestor-link" data-action="switchStructureRoot" data-table="${anc.table.id}" data-record="${anc.record.id}" title="${t('showStructureFrom')}">
                        ${escapeHtml(ancName)} <span class="ancestor-table">(${escapeHtml(anc.table.name)})</span>
                        <span class="ancestor-count">[${ancDescCount}]</span>
                    </a>`;
                    html += '<span class="ancestor-separator">‚Üí</span>';
                });
                const currentName = getPrimaryFieldValue(table, record);
                html += `<span class="ancestor-current">${escapeHtml(currentName)}</span>`;
                html += '</div></div>';
            }
            
            // Build tree data structure
            const treeData = buildTreeData(structureRootTableId, structureRootRecordId, 0, new Set());
            
            if (!treeData.children || treeData.children.length === 0) {
                container.innerHTML = html + `<p class="tree-empty">${t('noDescendants')}</p>`;
                return;
            }
            
            // Calculate tree layout
            const nodeWidth = 150;
            const nodeHeight = 30;
            const levelGap = 180;
            const nodeGap = 10;
            
            // Assign positions
            const positions = [];
            let maxY = 0;
            
            function assignPositions(node, x, y) {
                node.x = x;
                node.y = y;
                positions.push(node);
                maxY = Math.max(maxY, y);
                
                if (node.children && node.children.length > 0) {
                    const childX = x + levelGap;
                    let currentY = y - ((node.children.length - 1) * (nodeHeight + nodeGap)) / 2;
                    
                    node.children.forEach(child => {
                        assignPositions(child, childX, currentY);
                        currentY += nodeHeight + nodeGap;
                    });
                }
            }
            
            // First pass: calculate subtree heights
            function calcSubtreeHeight(node) {
                if (!node.children || node.children.length === 0) {
                    node.subtreeHeight = nodeHeight;
                    return node.subtreeHeight;
                }
                let totalHeight = 0;
                node.children.forEach(child => {
                    totalHeight += calcSubtreeHeight(child) + nodeGap;
                });
                totalHeight -= nodeGap;
                node.subtreeHeight = Math.max(nodeHeight, totalHeight);
                return node.subtreeHeight;
            }
            
            function assignPositions2(node, x, yStart, yEnd) {
                const yMid = (yStart + yEnd) / 2;
                node.x = x;
                node.y = yMid;
                positions.push(node);
                maxY = Math.max(maxY, yEnd);
                
                if (node.children && node.children.length > 0) {
                    const childX = x + levelGap;
                    let currentY = yStart;
                    
                    node.children.forEach(child => {
                        const childEnd = currentY + child.subtreeHeight;
                        assignPositions2(child, childX, currentY, childEnd);
                        currentY = childEnd + nodeGap;
                    });
                }
            }
            
            calcSubtreeHeight(treeData);
            assignPositions2(treeData, 40, 40, 40 + treeData.subtreeHeight);
            
            // Calculate SVG size
            const maxX = Math.max(...positions.map(p => p.x)) + nodeWidth + 40;
            const svgHeight = maxY + 40;
            const svgWidth = Math.max(maxX, 400);
            
            // Generate table colors
            const tableColors = {};
            const colorPalette = ['#3498db', '#e74c3c', '#2ecc71', '#9b59b6', '#f39c12', '#1abc9c', '#e67e22', '#34495e'];
            let colorIndex = 0;
            database.tables.forEach(tb => {
                tableColors[tb.id] = colorPalette[colorIndex % colorPalette.length];
                colorIndex++;
            });
            
            // Build SVG
            let svg = `<svg class="graph-svg" width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}">`;
            
            // Draw links first (behind nodes)
            function drawLinks(node) {
                if (node.children) {
                    node.children.forEach(child => {
                        const startX = node.x + nodeWidth;
                        const startY = node.y + nodeHeight / 2;
                        const endX = child.x;
                        const endY = child.y + nodeHeight / 2;
                        const midX = (startX + endX) / 2;
                        svg += `<path class="graph-link" d="M${startX},${startY} C${midX},${startY} ${midX},${endY} ${endX},${endY}"/>`;
                        drawLinks(child);
                    });
                }
            }
            drawLinks(treeData);
            
            // Draw nodes
            positions.forEach(node => {
                const color = tableColors[node.tableId] || '#3498db';
                const textWidth = Math.min(node.name.length * 7, nodeWidth - 10);
                const displayName = node.name.length > 20 ? node.name.substring(0, 18) + '...' : node.name;
                
                svg += `<g class="graph-node" data-table="${node.tableId}" data-record="${node.recordId}">`;
                svg += `<rect x="${node.x}" y="${node.y}" width="${nodeWidth}" height="${nodeHeight}" style="stroke: ${color}"/>`;
                svg += `<text x="${node.x + 8}" y="${node.y + nodeHeight/2 + 4}" style="fill: ${color}">${escapeHtml(displayName)}</text>`;
                svg += '</g>';
            });
            
            svg += '</svg>';
            container.innerHTML = html + svg;
        }
        
        function buildTreeData(tableId, recordId, depth, visited) {
            const key = `${tableId}_${recordId}`;
            if (visited.has(key)) return null; // Prevent cycles
            visited.add(key);
            
            const table = getTableById(tableId);
            const record = getRecordById(tableId, recordId);
            if (!table || !record) return null;
            
            const node = {
                tableId,
                recordId,
                name: getPrimaryFieldValue(table, record),
                tableName: table.name,
                children: []
            };
            
            // Limit depth for graph
            if (depth < STRUCTURE_MAX_DEPTH) {
                const children = getDirectChildren(tableId, recordId);
                // Limit items for graph
                const itemsToShow = Math.min(children.length, STRUCTURE_MAX_ITEMS);
                for (let i = 0; i < itemsToShow; i++) {
                    const child = children[i];
                    const childNode = buildTreeData(child.table.id, child.record.id, depth + 1, new Set(visited));
                    if (childNode) {
                        node.children.push(childNode);
                    }
                }
            }
            
            return node;
        }

        // View collection contents
        function openFieldModal(fieldId = null) {
            const table = getTableById(editingFieldTableId);
            if (!table) return;
            document.getElementById('fieldName').value = '';
            document.getElementById('fieldType').value = 'text';
            document.getElementById('fieldOptions').value = '';
            document.getElementById('compositeTemplate').value = '';
            document.getElementById('dateFormat').value = '';
            document.getElementById('fieldPrimary').checked = false;
            document.getElementById('fieldFilter').checked = false;
            document.getElementById('fieldGroup').checked = false;
            document.getElementById('fieldId').value = '';
            document.getElementById('fieldTableId').value = editingFieldTableId;
            document.getElementById('fieldOptionsGroup').hidden = true;
            document.getElementById('dateFormatGroup').hidden = true;
            document.getElementById('compositeTemplateGroup').hidden = true;
            document.getElementById('targetTableGroup').hidden = true;
            document.getElementById('parentFieldGroup').hidden = true;
            populateTargetTableSelect();
            if (fieldId) {
                const f = table.fields.find(x => x.id === fieldId);
                if (f) {
                    document.getElementById('fieldModalTitle').textContent = t('editField');
                    document.getElementById('fieldId').value = f.id;
                    document.getElementById('fieldName').value = f.name;
                    document.getElementById('fieldType').value = f.type;
                    document.getElementById('fieldOptions').value = f.options || '';
                    document.getElementById('compositeTemplate').value = f.compositeTemplate || '';
                    document.getElementById('dateFormat').value = f.dateFormat || '';
                    document.getElementById('fieldPrimary').checked = f.primary;
                    document.getElementById('fieldFilter').checked = f.filter;
                    document.getElementById('fieldGroup').checked = f.group;
                    if (f.type === 'select') document.getElementById('fieldOptionsGroup').hidden = false;
                    if (f.type === 'date') document.getElementById('dateFormatGroup').hidden = false;
                    if (f.type === 'composite') {
                        document.getElementById('compositeTemplateGroup').hidden = false;
                        populateCompositeFieldButtons();
                    }
                    if (f.type === 'parent' || f.type === 'children') {
                        document.getElementById('targetTableGroup').hidden = false;
                        populateTargetTableSelect(f.targetTableId);
                        if (f.type === 'children') {
                            document.getElementById('parentFieldGroup').hidden = false;
                            populateParentFieldSelect(f.targetTableId, f.parentFieldId);
                        }
                    }
                }
            } else { document.getElementById('fieldModalTitle').textContent = t('addField'); }
            openModal('fieldModal');
            setTimeout(() => document.getElementById('fieldName').focus(), 50);
        }

        function populateTargetTableSelect(selId = '') {
            document.getElementById('targetTable').innerHTML = `<option value="">${t('selectField')}</option>` + database.tables.map(tb => `<option value="${tb.id}" ${tb.id === selId ? 'selected' : ''}>${escapeHtml(tb.name)}</option>`).join('');
        }

        function populateParentFieldSelect(targetTableId, selId = '') {
            const sel = document.getElementById('parentField');
            const tt = getTableById(targetTableId);
            if (!tt) { sel.innerHTML = `<option value="">${t('selectField')}</option>`; return; }
            const pfs = tt.fields.filter(f => f.type === 'parent' && f.targetTableId === editingFieldTableId);
            sel.innerHTML = `<option value="">${t('selectField')}</option>` + pfs.map(f => `<option value="${f.id}" ${f.id === selId ? 'selected' : ''}>${escapeHtml(f.name)}</option>`).join('');
        }

        function populateCompositeFieldButtons() {
            const table = getTableById(editingFieldTableId);
            const container = document.getElementById('compositeFieldButtons');
            if (!table) { container.innerHTML = ''; return; }
            const currentFieldId = document.getElementById('fieldId').value;
            container.innerHTML = table.fields.filter(f => f.id !== currentFieldId && f.type !== 'children' && f.type !== 'composite').map(f => `<button type="button" class="field-btn" data-field="{${f.name}}">{${escapeHtml(f.name)}}</button>`).join('');
        }

        function saveField() {
            const tableId = document.getElementById('fieldTableId').value;
            const table = getTableById(tableId);
            if (!table) return;
            const id = document.getElementById('fieldId').value;
            const name = document.getElementById('fieldName').value.trim();
            const type = document.getElementById('fieldType').value;
            const options = document.getElementById('fieldOptions').value.trim();
            const compositeTemplate = document.getElementById('compositeTemplate').value;
            const dateFormat = document.getElementById('dateFormat').value.trim();
            const primary = document.getElementById('fieldPrimary').checked;
            const filter = document.getElementById('fieldFilter').checked;
            const group = document.getElementById('fieldGroup').checked;
            const targetTableId = document.getElementById('targetTable').value;
            const parentFieldId = document.getElementById('parentField').value;
            if (!name) return;
            if (primary) table.fields.forEach(f => f.primary = false);
            if (group) table.fields.forEach(f => f.group = false); // jen jedno pole m≈Ø≈æe b√Ωt pro seskupov√°n√≠
            if (id) {
                const f = table.fields.find(x => x.id === id);
                if (f) { f.name = name; f.type = type; f.options = options; f.compositeTemplate = compositeTemplate; f.dateFormat = dateFormat; f.primary = primary; f.filter = filter; f.group = group; f.targetTableId = targetTableId; f.parentFieldId = parentFieldId; }
            } else {
                table.fields.push({ id: generateId(), name, type, options, compositeTemplate, dateFormat, primary, filter, group, targetTableId, parentFieldId });
            }
            closeModal('fieldModal');
            renderFieldList();
            renderTableTabs();
        }

        // Record Modal
        function openRecordModal(tableId, recordId = null) {
            const table = getTableById(tableId);
            if (!table) return;
            currentRecordTableId = tableId;
            currentRecordId = recordId;
            document.getElementById('recordModalTitle').textContent = recordId ? `${t('edit')}: ${table.name}` : `${t('addRecord')}: ${table.name}`;
            const record = recordId ? getRecordById(tableId, recordId) : null;
            const isNewRecord = !recordId;
            document.getElementById('recordForm').innerHTML = table.fields.filter(f => f.type !== 'children' && f.type !== 'composite').map(f => buildFormField(table, f, record?.values[f.id] ?? '', record, isNewRecord)).join('');
            // Show "Save and add another" only when creating new record
            document.getElementById('btnSaveAndAddAnother').hidden = !!recordId;
            openModal('recordModal');
            // Focus first editable field
            setTimeout(() => {
                const firstInput = document.querySelector('#recordForm input:not([disabled]):not([type="checkbox"]):not([type="hidden"]), #recordForm textarea:not([disabled]), #recordForm select:not([disabled])');
                if (firstInput) firstInput.focus();
            }, 50);
        }

        function buildFormField(table, field, value, record, isNewRecord = false) {
            const id = `record_${field.id}`;
            let input = '';
            switch (field.type) {
                case 'text': input = `<input type="text" id="${id}" value="${escapeAttr(value)}">`; break;
                case 'textarea': input = `<textarea id="${id}" rows="5">${escapeAttr(value)}</textarea>`; break;
                case 'number': input = `<input type="number" id="${id}" value="${escapeAttr(value)}" step="any">`; break;
                case 'date': 
                    // Default to today's date for new records
                    const dateValue = (isNewRecord && !value) ? new Date().toISOString().split('T')[0] : value;
                    input = `<div class="date-input-group"><input type="date" id="${id}" value="${escapeAttr(dateValue)}" class="date-picker"><input type="text" id="${id}_text" value="${escapeAttr(dateValue)}" placeholder="yyyy-mm-dd" pattern="\\d{4}-\\d{2}-\\d{2}" class="date-text" title="Form√°t: yyyy-mm-dd"><button type="button" class="date-clear-btn" data-date-field="${id}" title="${t('clearDate')}">‚úï</button></div>`; 
                    break;
                case 'url': input = `<input type="url" id="${id}" value="${escapeAttr(value)}" placeholder="https://">`; break;
                case 'boolean': return `<div class="form-group"><div class="checkbox-group"><input type="checkbox" id="${id}" ${value ? 'checked' : ''}><label for="${id}">${escapeHtml(field.name)}</label></div></div>`;
                case 'select':
                    const opts = (field.options || '').split(',').map(o => o.trim()).filter(o => o);
                    input = `<select id="${id}"><option value="">-- ${t('selectField')} --</option>${opts.map(o => `<option value="${escapeAttr(o)}" ${value === o ? 'selected' : ''}>${escapeHtml(o)}</option>`).join('')}</select>`;
                    break;
                case 'composite':
                    const compVal = record ? evaluateCompositeField(table, field, record) : '';
                    input = `<input type="text" id="${id}" value="${escapeAttr(compVal)}" readonly disabled style="background: var(--bg); cursor: not-allowed;">`;
                    break;
                case 'parent':
                    const tt = getTableById(field.targetTableId);
                    const ros = tt ? tt.records.filter(r => r.id !== currentRecordId).map(r => ({ id: r.id, name: getPrimaryFieldValue(tt, r) })).sort((a, b) => a.name.localeCompare(b.name, currentLang)) : [];
                    input = `<div style="display: flex; gap: 0.5rem;"><select id="${id}" style="flex: 1;"><option value="">${t('noParent')}</option>${ros.map(o => `<option value="${o.id}" ${value === o.id ? 'selected' : ''}>${escapeHtml(o.name)}</option>`).join('')}</select><button type="button" class="btn btn-sm btn-success create-parent-btn" data-field="${field.id}" data-target-table="${field.targetTableId}" title="${t('createNew')}">‚ûï</button></div>`;
                    break;
            }
            return `<div class="form-group"><label for="${id}">${escapeHtml(field.name)}</label>${input}</div>`;
        }

        // Variables for nested record creation
        let pendingParentCreation = null;

        function saveFormState() {
            const table = getTableById(currentRecordTableId);
            if (!table) return null;
            const values = {};
            table.fields.filter(f => f.type !== 'children' && f.type !== 'composite').forEach(f => {
                const el = document.getElementById(`record_${f.id}`);
                if (!el) return;
                if (f.type === 'boolean') values[f.id] = el.checked;
                else if (f.type === 'number') values[f.id] = el.value ? parseFloat(el.value) : null;
                else values[f.id] = el.value;
            });
            return { tableId: currentRecordTableId, recordId: currentRecordId, values };
        }

        function restoreFormState(state, newParentId, parentFieldId) {
            if (!state) return;
            currentRecordTableId = state.tableId;
            currentRecordId = state.recordId;
            const table = getTableById(state.tableId);
            if (!table) return;
            // Merge saved values with new parent ID
            if (newParentId && parentFieldId) {
                state.values[parentFieldId] = newParentId;
            }
            const record = state.recordId ? getRecordById(state.tableId, state.recordId) : { values: state.values };
            document.getElementById('recordModalTitle').textContent = state.recordId ? t('edit') : t('addRecord');
            document.getElementById('recordForm').innerHTML = table.fields.filter(f => f.type !== 'children' && f.type !== 'composite').map(f => {
                const val = state.values[f.id] !== undefined ? state.values[f.id] : (record?.values[f.id] ?? '');
                return buildFormField(table, f, val, record);
            }).join('');
            openModal('recordModal');
        }

        function createParentRecord(targetTableId, parentFieldId) {
            // Save current form state
            pendingParentCreation = {
                formState: saveFormState(),
                parentFieldId: parentFieldId
            };
            // Open new record modal for target table
            closeModal('recordModal');
            openRecordModal(targetTableId, null);
        }

        function createChildRecord(targetTableId, parentFieldId, parentRecordId) {
            // Remember to return to view modal after saving
            pendingChildCreation = {
                returnToTableId: currentRecordTableId,
                returnToRecordId: currentRecordId
            };
            // Open new record modal with pre-filled parent (keep view modal open)
            openRecordModalWithParent(targetTableId, parentFieldId, parentRecordId);
        }

        function openRecordModalWithParent(tableId, parentFieldId, parentRecordId) {
            const table = getTableById(tableId);
            if (!table) return;
            currentRecordTableId = tableId;
            currentRecordId = null;
            document.getElementById('recordModalTitle').textContent = t('addRecord');
            // Create a temporary record object with pre-filled parent
            const prefilledValues = {};
            prefilledValues[parentFieldId] = parentRecordId;
            document.getElementById('recordForm').innerHTML = table.fields.filter(f => f.type !== 'children' && f.type !== 'composite').map(f => {
                const val = prefilledValues[f.id] ?? '';
                return buildFormField(table, f, val, null, true); // isNewRecord = true
            }).join('');
            openModal('recordModal');
        }

        function saveAndAddAnother() {
            const table = getTableById(currentRecordTableId);
            if (!table) return;
            const values = {};
            table.fields.filter(f => f.type !== 'children' && f.type !== 'composite').forEach(f => {
                const el = document.getElementById(`record_${f.id}`);
                if (!el) return;
                if (f.type === 'boolean') values[f.id] = el.checked;
                else if (f.type === 'number') values[f.id] = el.value ? parseFloat(el.value) : null;
                else values[f.id] = el.value;
            });
            
            // Save current record
            const newRecordId = generateId();
            table.records.push({ id: newRecordId, values: JSON.parse(JSON.stringify(values)) });
            autoSave();
            
            // Update table content in background
            if (activeTab !== 'management' && activeTab !== 'classification') renderTableContent(currentRecordTableId);
            
            // Reset for new record but keep values in form
            currentRecordId = null;
            document.getElementById('recordModalTitle').textContent = `${t('addRecord')}: ${table.name}`;
            
            // Flash effect to indicate save
            const modal = document.querySelector('#recordModal .modal');
            modal.style.boxShadow = '0 0 20px rgba(39, 174, 96, 0.5)';
            setTimeout(() => { modal.style.boxShadow = ''; }, 300);
        }

        // History functions
        function addHistoryEntry(tableId, recordId, type, changedFields) {
            if (!database.meta.recordHistory) database.meta.recordHistory = {};
            var key = tableId + '_' + recordId;
            if (!database.meta.recordHistory[key]) database.meta.recordHistory[key] = [];
            
            // Only save non-empty fields
            var fields = {};
            for (var fieldId in changedFields) {
                var value = changedFields[fieldId];
                if (value !== null && value !== '' && value !== undefined) {
                    fields[fieldId] = value;
                }
            }
            
            // Only add entry if there are any fields
            if (Object.keys(fields).length > 0 || type === 'create') {
                database.meta.recordHistory[key].push({
                    id: generateId(),
                    timestamp: new Date().toISOString(),
                    type: type,
                    fields: fields
                });
            }
        }
        
        function getRecordHistory(tableId, recordId) {
            if (!database.meta.recordHistory) return [];
            var key = tableId + '_' + recordId;
            return database.meta.recordHistory[key] || [];
        }
        
        function renderHistoryModal(tableId, recordId) {
            var table = getTableById(tableId);
            var record = getRecordById(tableId, recordId);
            if (!table || !record) return;
            
            var history = getRecordHistory(tableId, recordId);
            var container = document.getElementById('historyContent');
            
            container.dataset.tableId = tableId;
            container.dataset.recordId = recordId;
            
            document.getElementById('historyModalTitle').innerHTML = 'üìú ' + t('history') + ': ' + escapeHtml(getPrimaryFieldValue(table, record));
            
            if (history.length === 0) {
                container.innerHTML = '<div class="history-empty">' + t('noHistory') + '</div>';
                openModal('historyModal');
                return;
            }
            
            var sorted = history.slice().sort(function(a, b) { 
                return new Date(b.timestamp) - new Date(a.timestamp); 
            });
            
            var html = '<div class="history-list">';
            for (var i = 0; i < sorted.length; i++) {
                var entry = sorted[i];
                var date = new Date(entry.timestamp);
                var dateStr = date.toLocaleString(currentLang === 'cs' ? 'cs-CZ' : 'en-US');
                var typeLabel = entry.type === 'create' ? t('historyCreate') : 
                                entry.type === 'bulk' ? t('historyBulk') : t('historyEdit');
                var typeClass = entry.type;
                
                html += '<div class="history-item">';
                html += '<div class="history-header">';
                html += '<span class="history-timestamp">üìÖ ' + escapeHtml(dateStr) + '</span>';
                html += '<span class="history-type ' + typeClass + '">' + escapeHtml(typeLabel) + '</span>';
                if (advancedMode) {
                    html += '<button type="button" class="btn btn-danger btn-small history-delete-btn" data-history-id="' + entry.id + '" title="' + t('delete') + '">üóëÔ∏è</button>';
                }
                html += '</div>';
                html += '<div class="history-changes">';
                
                var fieldIds = Object.keys(entry.fields || {});
                if (fieldIds.length === 0) {
                    html += '<div class="history-empty" style="padding: 0.5rem;">‚Äî</div>';
                } else {
                    html += '<ul class="history-fields-list">';
                    for (var j = 0; j < fieldIds.length; j++) {
                        var fieldId = fieldIds[j];
                        var field = table.fields.find(function(f) { return f.id === fieldId; });
                        var fieldName = field ? field.name : fieldId;
                        var value = entry.fields[fieldId];
                        
                        if (field) {
                            if (field.type === 'boolean') {
                                value = value ? t('yes') : t('no');
                            } else if (field.type === 'date' && value) {
                                value = formatDate(value, field.dateFormat);
                            } else if (field.type === 'parent' && value) {
                                var targetTable = getTableById(field.targetTableId);
                                var targetRecord = targetTable ? getRecordById(field.targetTableId, value) : null;
                                value = targetRecord && targetTable ? getPrimaryFieldValue(targetTable, targetRecord) : value;
                            }
                        }
                        
                        // Zkr√°tit dlouh√© hodnoty
                        var displayValue = String(value);
                        if (displayValue.length > 200) {
                            displayValue = displayValue.substring(0, 200) + '...';
                        }
                        
                        html += '<li>';
                        html += '<span class="history-field-name">' + escapeHtml(fieldName) + ':</span>';
                        html += '<span class="history-field-value">' + escapeHtml(displayValue) + '</span>';
                        if (advancedMode) {
                            html += '<button type="button" class="btn btn-danger btn-small history-delete-field-btn" data-history-id="' + entry.id + '" data-field-id="' + fieldId + '" title="' + t('delete') + '" style="float:right;margin-top:-1.5rem;">‚úï</button>';
                        }
                        html += '</li>';
                    }
                    html += '</ul>';
                }
                
                html += '</div></div>';
            }
            html += '</div>';
            
            container.innerHTML = html;
            
            // Delete buttons event listeners
            var deleteButtons = container.querySelectorAll('.history-delete-btn');
            for (var k = 0; k < deleteButtons.length; k++) {
                deleteButtons[k].addEventListener('click', function(e) {
                    e.stopPropagation();
                    var historyId = this.dataset.historyId;
                    if (confirm(t('confirmDeleteHistory'))) {
                        deleteHistoryEntry(container.dataset.tableId, container.dataset.recordId, historyId);
                        renderHistoryModal(container.dataset.tableId, container.dataset.recordId);
                    }
                });
            }
            
            // Delete field buttons event listeners
            var deleteFieldButtons = container.querySelectorAll('.history-delete-field-btn');
            for (var m = 0; m < deleteFieldButtons.length; m++) {
                deleteFieldButtons[m].addEventListener('click', function(e) {
                    e.stopPropagation();
                    var historyId = this.dataset.historyId;
                    var fieldId = this.dataset.fieldId;
                    deleteHistoryField(container.dataset.tableId, container.dataset.recordId, historyId, fieldId);
                    renderHistoryModal(container.dataset.tableId, container.dataset.recordId);
                });
            }
            
            openModal('historyModal');
        }
        
        function deleteHistoryEntry(tableId, recordId, historyId) {
            var key = tableId + '_' + recordId;
            if (!database.meta.recordHistory[key]) return;
            
            database.meta.recordHistory[key] = database.meta.recordHistory[key].filter(function(e) { 
                return e.id !== historyId; 
            });
            
            if (database.meta.recordHistory[key].length === 0) {
                delete database.meta.recordHistory[key];
            }
            
            autoSave();
        }
        
        function deleteHistoryField(tableId, recordId, historyId, fieldId) {
            var key = tableId + '_' + recordId;
            if (!database.meta.recordHistory[key]) return;
            
            for (var i = 0; i < database.meta.recordHistory[key].length; i++) {
                var entry = database.meta.recordHistory[key][i];
                if (entry.id === historyId) {
                    delete entry.fields[fieldId];
                    // Pokud nezbyly ≈æ√°dn√° pole, smazat cel√Ω z√°znam
                    if (Object.keys(entry.fields).length === 0) {
                        database.meta.recordHistory[key].splice(i, 1);
                        if (database.meta.recordHistory[key].length === 0) {
                            delete database.meta.recordHistory[key];
                        }
                    }
                    break;
                }
            }
            
            autoSave();
        }

        function saveRecord() {
            const table = getTableById(currentRecordTableId);
            if (!table) return;
            const values = {};
            table.fields.filter(f => f.type !== 'children' && f.type !== 'composite').forEach(f => {
                const el = document.getElementById(`record_${f.id}`);
                if (!el) return;
                if (f.type === 'boolean') values[f.id] = el.checked;
                else if (f.type === 'number') values[f.id] = el.value ? parseFloat(el.value) : null;
                else values[f.id] = el.value;
            });
            const openAfterSave = document.getElementById('openAfterSave').checked;
            let newRecordId = null;
            if (currentRecordId) { 
                const r = getRecordById(currentRecordTableId, currentRecordId); 
                if (r) {
                    // Ulo≈æit jen zmƒõnƒõn√° pole
                    var changedFields = {};
                    for (var fieldId in values) {
                        var oldVal = r.values[fieldId];
                        var newVal = values[fieldId];
                        // Normalizovat pro porovn√°n√≠
                        if (oldVal === undefined) oldVal = '';
                        if (oldVal === null) oldVal = '';
                        if (newVal === undefined) newVal = '';
                        if (newVal === null) newVal = '';
                        if (String(oldVal) !== String(newVal)) {
                            changedFields[fieldId] = newVal;
                        }
                    }
                    if (Object.keys(changedFields).length > 0) {
                        addHistoryEntry(currentRecordTableId, currentRecordId, 'edit', changedFields);
                    }
                    r.values = values;
                }
            } else {
                newRecordId = generateId();
                table.records.push({ id: newRecordId, values });
                addHistoryEntry(currentRecordTableId, newRecordId, 'create', values);
            }
            const savedTableId = currentRecordTableId;
            const savedRecordId = currentRecordId || newRecordId;
            closeModal('recordModal');
            
            // Check if we were creating a parent record
            if (pendingParentCreation) {
                const pending = pendingParentCreation;
                pendingParentCreation = null;
                restoreFormState(pending.formState, newRecordId, pending.parentFieldId);
                return;
            }
            
            // Quick create mode - just close modal, don't change view
            if (quickCreateMode) {
                quickCreateMode = false;
                currentRecordId = null;
                currentRecordTableId = null;
                autoSave();
                // Open view if requested
                if (openAfterSave && savedRecordId) {
                    viewRecord(savedTableId, savedRecordId);
                }
                return;
            }
            
            currentRecordId = null;
            if (activeTab !== 'management' && activeTab !== 'classification') renderTableContent(currentRecordTableId);
            else renderStats();
            currentRecordTableId = null;
            
            // Open view if requested
            if (openAfterSave && savedRecordId) {
                viewRecord(savedTableId, savedRecordId);
            }
        }

        // Markdown export functions
        var markdownExportTableId = null;
        var markdownExportRecordId = null;
        var markdownSelectedFields = {};
        
        function openMarkdownExportModal(tableId, recordId) {
            markdownExportTableId = tableId;
            markdownExportRecordId = recordId;
            var table = getTableById(tableId);
            if (!table) return;
            
            // Build field selection checkboxes
            markdownSelectedFields = {};
            var html = '<div class="checkbox-group" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
            table.fields.forEach(function(f) {
                if (f.type === 'children') return;
                markdownSelectedFields[f.id] = true;
                html += '<label style="display: flex; align-items: center; gap: 0.25rem; margin-right: 1rem;">';
                html += '<input type="checkbox" class="markdown-field-checkbox" data-field-id="' + f.id + '" checked>';
                html += escapeHtml(f.name) + '</label>';
            });
            html += '</div>';
            document.getElementById('markdownFieldSelection').innerHTML = html;
            
            // Add event listeners to checkboxes
            var checkboxes = document.querySelectorAll('.markdown-field-checkbox');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].addEventListener('change', function() {
                    markdownSelectedFields[this.dataset.fieldId] = this.checked;
                    updateMarkdownPreview();
                });
            }
            
            document.getElementById('markdownIncludeHistory').checked = true;
            document.getElementById('markdownIncludeNotes').checked = true;
            updateMarkdownPreview();
            openModal('markdownExportModal');
        }
        
        function updateMarkdownPreview() {
            var includeHistory = document.getElementById('markdownIncludeHistory').checked;
            var includeNotes = document.getElementById('markdownIncludeNotes').checked;
            var markdown = generateRecordMarkdown(markdownExportTableId, markdownExportRecordId, includeHistory, includeNotes);
            document.getElementById('markdownPreview').textContent = markdown;
        }
        
        function generateRecordMarkdown(tableId, recordId, includeHistory, includeNotes) {
            var table = getTableById(tableId);
            var record = getRecordById(tableId, recordId);
            if (!table || !record) return '';
            
            var md = '';
            var recordName = getPrimaryFieldValue(table, record);
            
            // Header
            md += '# ' + recordName + '\n\n';
            md += '**' + t('tableName') + ':** ' + table.name + '\n\n';
            
            // Fields section - first simple fields, then multiline fields
            md += '## ' + t('recordFields') + '\n\n';
            
            // Separate fields into simple and multiline
            var simpleFields = [];
            var multilineFields = [];
            var childrenFields = [];
            
            table.fields.forEach(function(f) {
                if (!markdownSelectedFields[f.id]) return;
                if (f.type === 'children') {
                    childrenFields.push(f);
                } else if (f.type === 'textarea') {
                    multilineFields.push(f);
                } else {
                    simpleFields.push(f);
                }
            });
            
            // Render simple fields first
            simpleFields.forEach(function(f) {
                var v = record.values[f.id];
                var displayValue = '';
                
                switch (f.type) {
                    case 'boolean':
                        displayValue = v ? t('yes') : t('no');
                        break;
                    case 'date':
                        displayValue = v ? formatDate(v, f.dateFormat) : '';
                        break;
                    case 'url':
                        displayValue = v ? '[' + v + '](' + v + ')' : '';
                        break;
                    case 'composite':
                        displayValue = evaluateCompositeField(table, f, record) || '';
                        break;
                    case 'parent':
                        if (v) {
                            var targetTable = getTableById(f.targetTableId);
                            var targetRecord = targetTable ? getRecordById(f.targetTableId, v) : null;
                            displayValue = targetRecord && targetTable ? getPrimaryFieldValue(targetTable, targetRecord) : v;
                        }
                        break;
                    default:
                        displayValue = v != null ? String(v) : '';
                }
                
                if (displayValue) {
                    md += '**' + f.name + ':** ' + displayValue + '\n\n';
                }
            });
            
            // Render children fields as bullet lists
            childrenFields.forEach(function(f) {
                var ch = getChildRecords(tableId, recordId).filter(function(c) {
                    if (f.targetTableId && c.table.id !== f.targetTableId) return false;
                    if (f.parentFieldId && c.field.id !== f.parentFieldId) return false;
                    return true;
                });
                
                if (ch.length > 0) {
                    md += '**' + f.name + ':**\n\n';
                    ch.forEach(function(c) {
                        md += '- ' + getPrimaryFieldValue(c.table, c.record) + '\n';
                    });
                    md += '\n';
                }
            });
            
            // Render multiline fields with headers
            multilineFields.forEach(function(f) {
                var v = record.values[f.id];
                if (!v) return;
                
                md += '### ' + f.name + '\n\n';
                md += v + '\n\n';
            });
            
            // Collections and tags
            var collections = getRecordCollections(tableId, recordId);
            var tags = getRecordTags(tableId, recordId);
            
            if (collections.length > 0 || tags.length > 0) {
                md += '## ' + t('classification') + '\n\n';
                
                if (collections.length > 0) {
                    md += '**' + t('collections') + ':** ' + collections.map(function(c) { return c.name; }).join(', ') + '\n\n';
                }
                
                if (tags.length > 0) {
                    md += '**' + t('tags') + ':** ' + tags.map(function(tg) { return tg.name; }).join(', ') + '\n\n';
                }
            }
            
            // Notes section
            if (includeNotes) {
                var notes = getRecordNotes(tableId, recordId);
                if (notes.length > 0) {
                    md += '## ' + t('notes') + '\n\n';
                    notes.forEach(function(note) {
                        var date = new Date(note.createdAt);
                        var dateStr = date.toLocaleString(currentLang === 'cs' ? 'cs-CZ' : 'en-US');
                        var statusIcon = note.resolved ? '‚úì' : '‚óã';
                        var statusText = note.resolved ? t('noteResolved') : t('noteUnresolved');
                        md += '- ' + statusIcon + ' **[' + statusText + ']** [' + dateStr + '] ' + note.text + '\n';
                    });
                    md += '\n';
                }
            }
            
            // History section
            if (includeHistory) {
                var history = getRecordHistory(tableId, recordId);
                if (history.length > 0) {
                    md += '## ' + t('history') + '\n\n';
                    
                    // Sort by timestamp descending
                    var sorted = history.slice().sort(function(a, b) { 
                        return new Date(b.timestamp) - new Date(a.timestamp); 
                    });
                    
                    sorted.forEach(function(entry) {
                        var date = new Date(entry.timestamp);
                        var dateStr = date.toLocaleString(currentLang === 'cs' ? 'cs-CZ' : 'en-US');
                        var typeLabel = entry.type === 'create' ? t('historyCreate') : 
                                        entry.type === 'bulk' ? t('historyBulk') : t('historyEdit');
                        
                        md += '### ' + dateStr + ' (' + typeLabel + ')\n\n';
                        
                        var fieldIds = Object.keys(entry.fields);
                        if (fieldIds.length > 0) {
                            fieldIds.forEach(function(fieldId) {
                                var field = table.fields.find(function(f) { return f.id === fieldId; });
                                var fieldName = field ? field.name : fieldId;
                                var value = entry.fields[fieldId];
                                
                                // Format special types
                                if (field) {
                                    if (field.type === 'boolean') {
                                        value = value ? t('yes') : t('no');
                                    } else if (field.type === 'date' && value) {
                                        value = formatDate(value, field.dateFormat);
                                    } else if (field.type === 'parent' && value) {
                                        var tgtTable = getTableById(field.targetTableId);
                                        var tgtRecord = tgtTable ? getRecordById(field.targetTableId, value) : null;
                                        value = tgtRecord && tgtTable ? getPrimaryFieldValue(tgtTable, tgtRecord) : value;
                                    }
                                }
                                
                                md += '- **' + fieldName + ':** ' + value + '\n';
                            });
                            md += '\n';
                        }
                    });
                }
            }
            
            return md;
        }

        function duplicateRecord(tableId, recordId) {
            const table = getTableById(tableId);
            const record = getRecordById(tableId, recordId);
            if (!table || !record) return;
            
            // Create a copy of values
            const newValues = JSON.parse(JSON.stringify(record.values));
            const newId = generateId();
            
            // Add the duplicate
            table.records.push({ id: newId, values: newValues, tags: record.tags ? [...record.tags] : [] });
            
            // Close view modal and open edit modal for the new record
            closeModal('viewRecordModal');
            autoSave();
            
            // Open the duplicated record for viewing
            viewRecord(tableId, newId);
        }

        function viewRecord(tableId, recordId) {
            const table = getTableById(tableId);
            const record = getRecordById(tableId, recordId);
            if (!table || !record) return;
            currentRecordTableId = tableId;
            currentRecordId = recordId;
            document.getElementById('viewRecordModalTitle').innerHTML = `üìù ${escapeHtml(table.name)}: ${escapeHtml(getPrimaryFieldValue(table, record))}`;
            
            // Build fields HTML
            let fieldsHtml = table.fields.map(f => {
                const v = record.values[f.id];
                let dv = '';
                let rawValue = ''; // Pro kop√≠rov√°n√≠
                let isEmpty = false;
                
                switch (f.type) {
                    case 'boolean': 
                        dv = v ? t('yes') : t('no'); 
                        rawValue = dv;
                        break;
                    case 'date': 
                        if (v) {
                            dv = formatDate(v, f.dateFormat);
                            rawValue = dv;
                        } else {
                            isEmpty = true;
                        }
                        break;
                    case 'textarea': 
                        if (v) {
                            dv = `<div class="markdown-content">${parseMarkdown(v)}</div>`;
                            rawValue = v;
                        } else {
                            isEmpty = true;
                        }
                        break;
                    case 'url': 
                        if (v) {
                            dv = `<a href="${escapeHtml(v)}" target="_blank" rel="noopener noreferrer" class="url-link">${escapeHtml(v)}</a>`;
                            rawValue = v;
                        } else {
                            isEmpty = true;
                        }
                        break;
                    case 'composite': 
                        const compVal = evaluateCompositeField(table, f, record);
                        if (compVal) {
                            dv = escapeHtml(compVal).replace(/\n/g, '<br>');
                            rawValue = compVal;
                        } else {
                            isEmpty = true;
                        }
                        break;
                    case 'parent':
                        const tt = getTableById(f.targetTableId);
                        const pr = v && tt ? getRecordById(f.targetTableId, v) : null;
                        if (pr && tt) {
                            const parentName = getPrimaryFieldValue(tt, pr);
                            dv = `<a href="#" class="record-link" data-action="viewInModal" data-table="${f.targetTableId}" data-record="${v}">${escapeHtml(parentName)}</a>`;
                            rawValue = parentName;
                        } else {
                            isEmpty = true;
                        }
                        break;
                    case 'children':
                        const ch = getChildRecords(tableId, recordId).filter(c => { if (f.targetTableId && c.table.id !== f.targetTableId) return false; if (f.parentFieldId && c.field.id !== f.parentFieldId) return false; return true; });
                        if (ch.length > 0) {
                            dv = `<ul class="children-list">${ch.map(c => `<li><a href="#" class="record-link" data-action="viewInModal" data-table="${c.table.id}" data-record="${c.record.id}">${escapeHtml(getPrimaryFieldValue(c.table, c.record))}</a></li>`).join('')}</ul>`;
                            rawValue = ch.map(c => getPrimaryFieldValue(c.table, c.record)).join('\n');
                        } else {
                            isEmpty = true;
                        }
                        // Add button to create new child if targetTableId and parentFieldId are set
                        if (f.targetTableId && f.parentFieldId) {
                            if (isEmpty) dv = '';
                            dv += `<button type="button" class="btn btn-sm btn-success create-child-btn" data-target-table="${f.targetTableId}" data-parent-field="${f.parentFieldId}" data-parent-record="${recordId}" style="margin-top: 0.5rem;"><span aria-hidden="true">‚ûï</span> ${t('addChild')}</button>`;
                            isEmpty = false; // V≈ædy zobrazit kv≈Øli tlaƒç√≠tku
                        }
                        break;
                    default: 
                        if (v != null && v !== '') {
                            dv = escapeHtml(String(v));
                            rawValue = String(v);
                        } else {
                            isEmpty = true;
                        }
                }
                
                // Skr√Ωt pr√°zdn√° pole (kromƒõ children s tlaƒç√≠tkem)
                if (isEmpty) return '';
                
                // Tlaƒç√≠tko pro kop√≠rov√°n√≠ (ne pro children)
                const copyBtn = f.type !== 'children' && rawValue ? `<button type="button" class="btn btn-sm btn-secondary copy-field-btn" data-value="${escapeAttr(rawValue)}" title="${t('copyField')}">üìã</button>` : '';
                
                return `<div class="view-field"><div class="view-field-header"><span class="view-field-label">${escapeHtml(f.name)}</span>${copyBtn}</div><div class="view-field-value">${dv}</div></div>`;
            }).join('');
            
            // Collections and Tags section  
            const collections = getRecordCollections(tableId, recordId);
            const tags = getRecordTags(tableId, recordId);
            
            // Section: Record fields
            let contentHtml = '<div class="view-record-section">';
            contentHtml += `<h3 class="view-record-section-title">üìã ${t('recordFields')}</h3>`;
            contentHtml += fieldsHtml || `<p style="color: var(--text-muted); font-style: italic;">${t('noFields')}</p>`;
            contentHtml += '</div>';
            
            // Section: Classification (Collections & Tags)
            contentHtml += '<div class="view-record-section">';
            contentHtml += `<h3 class="view-record-section-title">üè∑Ô∏è ${t('classification')}</h3>`;
            contentHtml += '<div class="record-classification">';
            
            // Collections row
            contentHtml += '<div class="record-classification-row">';
            contentHtml += `<span class="record-classification-label">${t('collections')}:</span>`;
            contentHtml += '<div class="record-classification-items">';
            if (collections.length > 0) {
                collections.forEach(col => {
                    contentHtml += `<span class="collection-badge" style="background: ${col.color || '#4a90d9'}">
                        <a href="#" class="collection-link" data-collection="${col.id}" style="color: white; text-decoration: none;">${escapeHtml(col.name)}</a>
                        <button type="button" class="remove-badge-btn" data-action="removeFromCollection" data-collection="${col.id}" data-table="${tableId}" data-record="${recordId}" title="${t('removeFromCollection')}">‚úï</button>
                    </span>`;
                });
            }
            contentHtml += `<button type="button" class="btn btn-sm btn-success add-classification-btn open-add-collection-btn" data-table="${tableId}" data-record="${recordId}">‚ûï</button>`;
            contentHtml += '</div></div>';
            
            // Tags row
            contentHtml += '<div class="record-classification-row">';
            contentHtml += `<span class="record-classification-label">${t('tags')}:</span>`;
            contentHtml += '<div class="record-classification-items">';
            if (tags.length > 0) {
                tags.forEach(tag => {
                    contentHtml += `<span class="tag-badge" style="background: ${tag.color || '#e74c3c'}">
                        <a href="#" class="tag-link" data-tag="${tag.id}" style="color: white; text-decoration: none;">${escapeHtml(tag.name)}</a>
                        <button type="button" class="remove-badge-btn" data-action="removeTag" data-tag="${tag.id}" data-table="${tableId}" data-record="${recordId}" title="${t('removeThisTag')}">‚úï</button>
                    </span>`;
                });
            }
            contentHtml += `<button type="button" class="btn btn-sm btn-success add-classification-btn open-add-tag-btn" data-table="${tableId}" data-record="${recordId}">‚ûï</button>`;
            contentHtml += '</div></div>';
            
            contentHtml += '</div></div>';
            
            // Section: Related records (from collections)
            if (collections.length > 0) {
                let hasRelated = false;
                let relatedContent = '';
                collections.forEach(col => {
                    const otherMembers = col.members?.filter(m => !(m.tableId === tableId && m.recordId === recordId)) || [];
                    if (otherMembers.length > 0) {
                        hasRelated = true;
                        relatedContent += `<div class="related-group">`;
                        relatedContent += `<div class="related-group-title"><span class="color-dot" style="background: ${col.color || '#4a90d9'}"></span>${escapeHtml(col.name)}</div>`;
                        relatedContent += '<ul class="related-list">';
                        otherMembers.forEach(m => {
                            const relTable = getTableById(m.tableId);
                            const relRecord = relTable ? getRecordById(m.tableId, m.recordId) : null;
                            if (relTable && relRecord) {
                                relatedContent += `<li><a href="#" class="record-link" data-action="viewInModal" data-table="${m.tableId}" data-record="${m.recordId}">${escapeHtml(getPrimaryFieldValue(relTable, relRecord))}</a> <span class="related-table-name">(${escapeHtml(relTable.name)})</span></li>`;
                            }
                        });
                        relatedContent += '</ul></div>';
                    }
                });
                if (hasRelated) {
                    contentHtml += '<div class="view-record-section">';
                    contentHtml += `<h3 class="view-record-section-title">üîó ${t('relatedRecords')}</h3>`;
                    contentHtml += relatedContent;
                    contentHtml += '</div>';
                }
            }
            
            // Notes section container
            contentHtml += '<div id="viewRecordNotesContainer"></div>';
            
            document.getElementById('viewRecordContent').innerHTML = contentHtml;
            
            // Render notes section
            renderNotesSection(tableId, recordId, document.getElementById('viewRecordNotesContainer'));
            
            // Store record info on modal for refresh
            const modal = document.getElementById('viewRecordModal');
            modal.dataset.tableId = tableId;
            modal.dataset.recordId = recordId;
            
            // Update lock button and edit button based on lock state
            const isLocked = record.locked === true;
            const lockBtn = document.getElementById('btnToggleLock');
            const editBtn = document.getElementById('btnEditFromView');
            lockBtn.innerHTML = isLocked 
                ? `<span aria-hidden="true">üîì</span> <span data-i18n="unlockRecord">${t('unlockRecord')}</span>`
                : `<span aria-hidden="true">üîí</span> <span data-i18n="lockRecord">${t('lockRecord')}</span>`;
            editBtn.disabled = isLocked;
            editBtn.title = isLocked ? t('recordLocked') : '';
            
            // Update title with lock icon
            const lockIcon = isLocked ? 'üîí ' : '';
            document.getElementById('viewRecordModalTitle').innerHTML = `${lockIcon}üìù ${escapeHtml(table.name)}: ${escapeHtml(getPrimaryFieldValue(table, record))}`;
            
            openModal('viewRecordModal');
        }

        // Export/Import
        function openExportModal(tableId) {
            if (!tableId) { alert('Nejd≈ô√≠ve vyberte tabulku.'); return; }
            activeTableId = tableId;
            exportFormat = 'csv';
            document.querySelectorAll('#exportModal .format-tab').forEach(t => t.classList.toggle('active', t.dataset.format === 'csv'));
            updateExportOutput();
            openModal('exportModal');
        }

        function updateExportOutput() {
            const table = getTableById(activeTableId);
            if (!table) return;
            const delim = exportFormat === 'csv' ? ',' : '\t';
            const fields = table.fields.filter(f => f.type !== 'children' && f.type !== 'parent');
            const escD = (s, d) => { s = String(s); return s.includes(d) || s.includes('"') || s.includes('\n') ? '"' + s.replace(/"/g, '""') + '"' : s; };
            let csv = fields.map(f => escD(f.name, delim)).join(delim) + '\n';
            table.records.forEach(r => { csv += fields.map(f => { let v = r.values[f.id] ?? ''; if (f.type === 'boolean') v = v ? t('yes') : t('no'); return escD(v, delim); }).join(delim) + '\n'; });
            document.getElementById('exportOutput').value = csv;
        }

        function openImportModal(tableId) {
            if (!tableId) { alert('Nejd≈ô√≠ve vyberte tabulku.'); return; }
            activeTableId = tableId;
            importFormat = 'csv';
            document.querySelectorAll('#importModal .format-tab').forEach(t => t.classList.toggle('active', t.dataset.format === 'csv'));
            document.getElementById('importFile').value = '';
            document.getElementById('importInput').value = '';
            document.getElementById('importPreview').innerHTML = '';
            openModal('importModal');
        }
        
        function previewImport() {
            const table = getTableById(activeTableId);
            if (!table) return;
            const text = document.getElementById('importInput').value;
            if (!text.trim()) {
                document.getElementById('importPreview').innerHTML = `<p style="color: var(--text-muted); font-style: italic;">${t('noDataToPreview')}</p>`;
                return;
            }
            
            const delim = importFormat === 'csv' ? ',' : '\t';
            const hasHeader = document.getElementById('importHasHeader').checked;
            const rows = parseDelimited(text, delim);
            
            if (rows.length === 0) return;
            
            const fields = table.fields.filter(f => f.type !== 'children');
            
            let html = '<div class="import-preview-box">';
            html += `<h4>${t('columnMapping')}</h4>`;
            html += '<table class="import-mapping-table"><thead><tr><th>CSV</th><th>‚Üí</th><th>${t("targetField")}</th></tr></thead><tbody>';
            
            if (hasHeader && rows.length > 0) {
                const headerRow = rows[0];
                headerRow.forEach((headerName, i) => {
                    const normalizedHeader = headerName.trim().toLowerCase();
                    const matchedField = fields.find(f => f.name.toLowerCase() === normalizedHeader);
                    const status = matchedField ? '‚úÖ' : '‚ö†Ô∏è';
                    let targetName = matchedField ? escapeHtml(matchedField.name) : `<span style="color: var(--danger);">${t('unmapped')}</span>`;
                    if (matchedField && matchedField.type === 'parent') {
                        const tt = getTableById(matchedField.targetTableId);
                        targetName += tt ? ` <small style="color: var(--text-muted);">(‚Üí ${escapeHtml(tt.name)})</small>` : '';
                    }
                    html += `<tr><td>${escapeHtml(headerName)}</td><td>${status}</td><td>${targetName}</td></tr>`;
                });
            } else {
                const firstRow = rows[0];
                firstRow.forEach((_, i) => {
                    const field = fields[i];
                    let targetName = field ? escapeHtml(field.name) : `<span style="color: var(--danger);">${t('unmapped')}</span>`;
                    if (field && field.type === 'parent') {
                        const tt = getTableById(field.targetTableId);
                        targetName += tt ? ` <small style="color: var(--text-muted);">(‚Üí ${escapeHtml(tt.name)})</small>` : '';
                    }
                    const status = field ? '‚úÖ' : '‚ö†Ô∏è';
                    html += `<tr><td>${t('column')} ${i + 1}</td><td>${status}</td><td>${targetName}</td></tr>`;
                });
            }
            
            html += '</tbody></table>';
            
            // Show sample data
            const dataRows = hasHeader ? rows.slice(1) : rows;
            const sampleRows = dataRows.slice(0, 3);
            if (sampleRows.length > 0) {
                html += `<h4 style="margin-top: 1rem;">${t('sampleData')} (${dataRows.length} ${t('rows')})</h4>`;
                html += '<table class="import-mapping-table"><tbody>';
                sampleRows.forEach(row => {
                    html += '<tr>' + row.map(c => `<td>${escapeHtml(c.substring(0, 30))}${c.length > 30 ? '...' : ''}</td>`).join('') + '</tr>';
                });
                html += '</tbody></table>';
            }
            
            html += '</div>';
            document.getElementById('importPreview').innerHTML = html;
        }

        function parseDelimited(text, delim) {
            const lines = []; let cur = '', inQ = false;
            for (let i = 0; i < text.length; i++) { const c = text[i]; if (c === '"') { if (inQ && text[i + 1] === '"') { cur += '"'; i++; } else inQ = !inQ; } else if ((c === '\n' || c === '\r') && !inQ) { if (cur || lines.length > 0) lines.push(cur); cur = ''; if (c === '\r' && text[i + 1] === '\n') i++; } else cur += c; }
            if (cur) lines.push(cur);
            return lines.map(line => { const cells = []; let cell = '', iq = false; for (let i = 0; i < line.length; i++) { const ch = line[i]; if (ch === '"') { if (iq && line[i + 1] === '"') { cell += '"'; i++; } else iq = !iq; } else if (ch === delim && !iq) { cells.push(cell); cell = ''; } else cell += ch; } cells.push(cell); return cells; });
        }

        function doImport() {
            const table = getTableById(activeTableId);
            if (!table) return;
            const text = document.getElementById('importInput').value;
            if (!text.trim()) return;
            const delim = importFormat === 'csv' ? ',' : '\t';
            const hasHeader = document.getElementById('importHasHeader').checked;
            const rows = parseDelimited(text, delim);
            
            if (rows.length === 0) return;
            
            // Get importable fields (exclude children only, parent is now supported)
            const fields = table.fields.filter(f => f.type !== 'children');
            const primaryField = fields.find(f => f.primary);
            
            // Build column-to-field mapping
            let columnMapping = []; // Array of field objects (or null if no match)
            
            if (hasHeader && rows.length > 0) {
                // Map by header names
                const headerRow = rows[0];
                columnMapping = headerRow.map(headerName => {
                    const normalizedHeader = headerName.trim().toLowerCase();
                    // Find field by name (case-insensitive)
                    return fields.find(f => f.name.toLowerCase() === normalizedHeader) || null;
                });
            } else {
                // Map by position
                columnMapping = fields.slice(0, rows[0]?.length || 0);
            }
            
            const dataRows = hasHeader ? rows.slice(1) : rows;
            let countNew = 0, countUpdated = 0, countSkipped = 0;
            
            dataRows.forEach(row => {
                if (row.every(c => !c.trim())) return; // Skip empty rows
                
                const values = {};
                let hasAnyValue = false;
                
                row.forEach((cellValue, colIndex) => {
                    const field = columnMapping[colIndex];
                    if (!field) return; // No mapping for this column
                    
                    const trimmedValue = cellValue.trim();
                    if (trimmedValue === '') return; // Skip empty cells
                    
                    hasAnyValue = true;
                    
                    if (field.type === 'number') {
                        const num = parseFloat(trimmedValue.replace(',', '.'));
                        values[field.id] = isNaN(num) ? null : num;
                    } else if (field.type === 'boolean') {
                        const lower = trimmedValue.toLowerCase();
                        values[field.id] = lower === t('yes').toLowerCase() || lower === '1' || lower === 'true' || lower === 'ano';
                    } else if (field.type === 'parent' && field.targetTableId) {
                        // For parent fields, find record by primary field value
                        const targetTable = getTableById(field.targetTableId);
                        if (targetTable) {
                            const targetPrimaryField = targetTable.fields.find(f => f.primary);
                            if (targetPrimaryField) {
                                // Find record where primary field matches imported value
                                const matchingRecord = targetTable.records.find(r => {
                                    const primaryValue = r.values[targetPrimaryField.id];
                                    return primaryValue && String(primaryValue).toLowerCase() === trimmedValue.toLowerCase();
                                });
                                if (matchingRecord) {
                                    values[field.id] = matchingRecord.id;
                                }
                                // If no match found, skip this field (don't set invalid value)
                            }
                        }
                    } else {
                        values[field.id] = trimmedValue;
                    }
                });
                
                if (!hasAnyValue) {
                    countSkipped++;
                    return;
                }
                
                // Upsert: find existing record by primary field
                let existingRecord = null;
                if (primaryField && values[primaryField.id]) {
                    existingRecord = table.records.find(r => r.values[primaryField.id] === values[primaryField.id]);
                }
                
                if (existingRecord) {
                    // Update existing record (merge values) - but only if not locked
                    if (!existingRecord.locked) {
                        Object.assign(existingRecord.values, values);
                        countUpdated++;
                    } else {
                        countSkipped++;
                    }
                } else {
                    // Create new record
                    table.records.push({ id: generateId(), values });
                    countNew++;
                }
            });
            
            closeModal('importModal');
            alert(t('importSuccess', { count: countNew, updated: countUpdated }));
            renderTableContent(activeTableId);
        }

        // File operations
        function createNewDatabase() {
            confirmAction(t('confirmNewDb'), () => {
                database = { meta: { name: '', columnVisibility: {}, groupStates: {}, collections: [], tags: [], views: {}, notes: [] }, tables: [] };
                activeTab = 'management';
                activeTableId = null;
                tableFilters = {};
                tableSearches = {};
                tableSorts = {};
                collectionFilter = null;
                tagFilter = null;
                activeViewId = null;
                renderAll();
            });
        }

        function loadDatabase() { document.getElementById('fileInput').click(); }

        function handleFileLoad(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => { try { loadDatabaseFromJson(JSON.parse(ev.target.result)); } catch { alert(t('jsonInvalid')); } };
            reader.readAsText(file);
            e.target.value = '';
        }

        function loadDatabaseFromJson(data) {
            database = { 
                meta: { 
                    name: data.meta?.name || '', 
                    columnVisibility: data.meta?.columnVisibility || {},
                    groupStates: data.meta?.groupStates || {},
                    collections: data.meta?.collections || [],
                    tags: data.meta?.tags || [],
                    views: data.meta?.views || {},
                    notes: data.meta?.notes || []
                }, 
                tables: data.tables || [] 
            };
            activeTab = database.tables.length > 0 ? database.tables[0].id : 'management';
            activeTableId = database.tables[0]?.id || null;
            tableFilters = {};
            tableSearches = {};
            tableSorts = {};
            collectionFilter = null;
            tagFilter = null;
            activeViewId = null; // Reset active view
            document.getElementById('dbNameInput').value = database.meta.name;
            renderAll();
        }

        // Universal file save with File System Access API (progressive enhancement)
        async function saveFileWithDialog(content, filename, mimeType, extensions) {
            // Try modern File System Access API first
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{
                            description: filename.split('.').pop().toUpperCase() + ' file',
                            accept: { [mimeType]: extensions }
                        }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(content);
                    await writable.close();
                    return true;
                } catch (e) {
                    if (e.name === 'AbortError') return false; // User cancelled
                    // Fall through to classic download on other errors
                }
            }
            
            // Classic fallback for browsers without File System Access API
            const blob = new Blob([content], { type: mimeType });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
            return true;
        }

        async function saveDatabase() {
            database.meta.name = document.getElementById('dbNameInput')?.value || database.meta.name;
            updateDocumentTitle();
            const content = JSON.stringify(database, null, 2);
            const filename = (database.meta.name || 'database') + '.jsondb';
            const saved = await saveFileWithDialog(content, filename, 'application/json', ['.jsondb', '.json']);
            if (saved) markAsSaved();
        }

        async function copyJsonToClipboard() {
            database.meta.name = document.getElementById('dbNameInput')?.value || database.meta.name;
            try {
                await navigator.clipboard.writeText(JSON.stringify(database, null, 2));
                alert(t('jsonCopied'));
            } catch {
                const ta = document.createElement('textarea');
                ta.value = JSON.stringify(database, null, 2);
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                alert(t('jsonCopied'));
            }
        }

        async function pasteJsonFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                const data = JSON.parse(text);
                loadDatabaseFromJson(data);
                alert(t('jsonPasted'));
            } catch (e) {
                // Clipboard API failed - open modal as fallback
                document.getElementById('pasteJsonInput').value = '';
                openModal('pasteJsonModal');
            }
        }

        function doPasteJson() {
            const text = document.getElementById('pasteJsonInput').value.trim();
            if (!text) return;
            try {
                const data = JSON.parse(text);
                loadDatabaseFromJson(data);
                closeModal('pasteJsonModal');
                alert(t('jsonPasted'));
            } catch (e) {
                alert(t('jsonInvalid') + '\n' + e.message);
            }
        }

        function renderAll() {
            renderTableTabs();
            updateQuickCreateOptions();
            if (activeTab === 'management') renderManagement();
            else if (activeTab === 'classification') renderClassification();
            else renderTableContent(activeTab);
            applyTranslations();
            updateDocumentTitle();
            autoSave();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize simple mode (default)
            document.body.classList.add('simple-mode');
            const advancedToggle = document.getElementById('advancedModeToggle');
            advancedToggle.checked = false;
            advancedToggle.addEventListener('change', e => {
                advancedMode = e.target.checked;
                if (advancedMode) {
                    document.body.classList.remove('simple-mode');
                } else {
                    document.body.classList.add('simple-mode');
                }
                renderTableTabs();
                if (activeTableId) renderTableContent(activeTableId);
            });
            
            const langSelect = document.getElementById('langSelect');
            langSelect.value = currentLang;
            langSelect.addEventListener('change', e => { currentLang = e.target.value; localStorage.setItem('db-editor-lang', currentLang); renderAll(); });

            // Quick create select
            // Global search
            let searchTimeout = null;
            document.getElementById('globalSearchInput').addEventListener('input', e => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                if (query.length >= 2) {
                    searchTimeout = setTimeout(() => showSearchResults(query), 300);
                }
            });
            document.getElementById('globalSearchInput').addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = e.target.value.trim();
                    if (query.length >= 2) {
                        clearTimeout(searchTimeout);
                        showSearchResults(query);
                    }
                }
            });
            
            // Search results click
            document.getElementById('searchResultsList').addEventListener('click', e => {
                const item = e.target.closest('.search-result-item');
                if (item) {
                    e.preventDefault();
                    viewRecord(item.dataset.table, item.dataset.record);
                }
            });

            document.getElementById('quickCreateSelect').addEventListener('change', e => {
                const tableId = e.target.value;
                if (tableId) {
                    quickCreateMode = true;
                    openRecordModal(tableId);
                    e.target.value = ''; // Reset select
                }
            });

            document.getElementById('tableTabs').addEventListener('click', e => {
                const tab = e.target.closest('.table-tab');
                if (tab) switchTab(tab.dataset.tableId);
            });

            document.querySelectorAll('.sub-tab').forEach(tab => tab.addEventListener('click', () => {
                document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.sub-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.subtab).classList.add('active');
            }));

            document.getElementById('dbNameInput').addEventListener('input', e => {
                database.meta.name = e.target.value;
                updateDocumentTitle();
            });

            document.getElementById('btnNew').addEventListener('click', createNewDatabase);
            document.getElementById('btnLoad').addEventListener('click', loadDatabase);
            document.getElementById('fileInput').addEventListener('change', handleFileLoad);
            document.getElementById('btnSave').addEventListener('click', saveDatabase);
            document.getElementById('btnCopyJson').addEventListener('click', copyJsonToClipboard);
            document.getElementById('btnPasteJson').addEventListener('click', pasteJsonFromClipboard);

            document.getElementById('btnAddTable').addEventListener('click', () => openTableModal());
            document.getElementById('btnSaveTable').addEventListener('click', saveTable);
            document.getElementById('btnAddField').addEventListener('click', () => openFieldModal());
            document.getElementById('btnSaveField').addEventListener('click', saveField);
            document.getElementById('btnSaveRecord').addEventListener('click', saveRecord);
            document.getElementById('btnSaveAndAddAnother').addEventListener('click', saveAndAddAnother);
            document.getElementById('btnEditFromView').addEventListener('click', () => { 
                const modal = document.getElementById('viewRecordModal');
                const record = getRecordById(modal.dataset.tableId, modal.dataset.recordId);
                if (record?.locked) {
                    alert(t('recordLocked'));
                    return;
                }
                openRecordModal(modal.dataset.tableId, modal.dataset.recordId); 
            });
            document.getElementById('btnToggleLock').addEventListener('click', () => {
                const modal = document.getElementById('viewRecordModal');
                const tableId = modal.dataset.tableId;
                const recordId = modal.dataset.recordId;
                const record = getRecordById(tableId, recordId);
                if (record) {
                    record.locked = !record.locked;
                    autoSave();
                    viewRecord(tableId, recordId);
                    if (activeTableId === tableId) renderTableContent(tableId);
                }
            });
            document.getElementById('btnDuplicateRecord').addEventListener('click', () => { 
                const modal = document.getElementById('viewRecordModal');
                duplicateRecord(modal.dataset.tableId, modal.dataset.recordId); 
            });
            document.getElementById('btnRefreshView').addEventListener('click', () => { 
                const modal = document.getElementById('viewRecordModal');
                const tableId = modal.dataset.tableId;
                const recordId = modal.dataset.recordId;
                if (tableId && recordId) {
                    viewRecord(tableId, recordId);
                }
            });
            document.getElementById('btnStructureFromView').addEventListener('click', () => { 
                const modal = document.getElementById('viewRecordModal');
                openStructureModal(modal.dataset.tableId, modal.dataset.recordId); 
            });
            
            document.getElementById('btnHistoryView').addEventListener('click', () => {
                const modal = document.getElementById('viewRecordModal');
                renderHistoryModal(modal.dataset.tableId, modal.dataset.recordId);
            });
            
            // Markdown export button
            document.getElementById('btnExportMarkdown').addEventListener('click', function() {
                var modal = document.getElementById('viewRecordModal');
                openMarkdownExportModal(modal.dataset.tableId, modal.dataset.recordId);
            });
            
            // Markdown export modal event handlers
            document.getElementById('markdownIncludeHistory').addEventListener('change', function() {
                updateMarkdownPreview();
            });
            
            document.getElementById('markdownIncludeNotes').addEventListener('change', function() {
                updateMarkdownPreview();
            });
            
            document.getElementById('btnCopyMarkdown').addEventListener('click', function() {
                var preview = document.getElementById('markdownPreview').textContent;
                navigator.clipboard.writeText(preview).then(function() {
                    alert(t('markdownCopied'));
                }).catch(function(err) {
                    var textarea = document.createElement('textarea');
                    textarea.value = preview;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert(t('markdownCopied'));
                });
            });
            
            document.getElementById('btnSaveMarkdown').addEventListener('click', function() {
                var preview = document.getElementById('markdownPreview').textContent;
                var table = getTableById(markdownExportTableId);
                var record = getRecordById(markdownExportTableId, markdownExportRecordId);
                var filename = table && record ? getPrimaryFieldValue(table, record).replace(/[^a-z0-9]/gi, '_') + '.md' : 'record.md';
                
                var blob = new Blob([preview], { type: 'text/markdown;charset=utf-8' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            // Notes event handlers in viewRecordModal
            document.getElementById('viewRecordContent').addEventListener('click', e => {
                const modal = document.getElementById('viewRecordModal');
                const tableId = modal.dataset.tableId;
                const recordId = modal.dataset.recordId;
                
                // Add note
                if (e.target.closest('#btnAddNote')) {
                    const textarea = document.getElementById('newNoteText');
                    const text = textarea.value.trim();
                    if (text) {
                        addNote(tableId, recordId, text);
                        renderNotesSection(tableId, recordId, document.getElementById('viewRecordNotesContainer'));
                    }
                    return;
                }
                
                // Toggle note resolved
                if (e.target.closest('.note-toggle-btn')) {
                    const noteId = e.target.closest('.note-toggle-btn').dataset.note;
                    toggleNoteResolved(noteId);
                    renderNotesSection(tableId, recordId, document.getElementById('viewRecordNotesContainer'));
                    return;
                }
                
                // Edit note
                if (e.target.closest('.note-edit-btn')) {
                    const noteId = e.target.closest('.note-edit-btn').dataset.note;
                    const note = database.meta.notes?.find(n => n.id === noteId);
                    if (note) {
                        const newText = prompt(t('editNote'), note.text);
                        if (newText !== null && newText.trim()) {
                            updateNote(noteId, newText.trim());
                            renderNotesSection(tableId, recordId, document.getElementById('viewRecordNotesContainer'));
                        }
                    }
                    return;
                }
                
                // Delete note
                if (e.target.closest('.note-delete-btn')) {
                    const noteId = e.target.closest('.note-delete-btn').dataset.note;
                    if (confirm(t('confirmDeleteNote'))) {
                        deleteNote(noteId);
                        renderNotesSection(tableId, recordId, document.getElementById('viewRecordNotesContainer'));
                    }
                    return;
                }
            });
            
            // Notes filter in classification
            document.getElementById('class-notes').addEventListener('click', e => {
                // Filter buttons
                if (e.target.closest('.notes-filter-btn')) {
                    const filter = e.target.closest('.notes-filter-btn').dataset.filter;
                    notesFilter = filter;
                    document.querySelectorAll('.notes-filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === filter));
                    renderGlobalNotesList();
                    return;
                }
                
                // Toggle note resolved
                if (e.target.closest('.note-toggle-btn')) {
                    const noteId = e.target.closest('.note-toggle-btn').dataset.note;
                    toggleNoteResolved(noteId);
                    renderGlobalNotesList();
                    return;
                }
                
                // Delete note
                if (e.target.closest('.note-delete-btn')) {
                    const noteId = e.target.closest('.note-delete-btn').dataset.note;
                    if (confirm(t('confirmDeleteNote'))) {
                        deleteNote(noteId);
                        renderGlobalNotesList();
                    }
                    return;
                }
            });
            
            // Bulk edit modal
            // Bulk edit modal - dynamic rows
            document.getElementById('btnAddBulkField').addEventListener('click', addBulkEditRow);
            document.getElementById('bulkEditFieldsContainer').addEventListener('change', e => {
                const select = e.target.closest('.bulk-edit-field-select');
                if (select) {
                    updateBulkEditValueInput(select.dataset.row);
                }
            });
            document.getElementById('bulkEditFieldsContainer').addEventListener('click', e => {
                const removeBtn = e.target.closest('.bulk-edit-remove-row');
                if (removeBtn) {
                    removeBulkEditRow(removeBtn.dataset.row);
                }
            });
            document.getElementById('btnApplyBulkEdit').addEventListener('click', applyBulkEdit);
            document.getElementById('btnApplyBulkCollection').addEventListener('click', applyBulkAddToCollection);
            document.getElementById('btnApplyBulkTag').addEventListener('click', applyBulkAddTag);
            document.getElementById('btnConfirmYes').addEventListener('click', () => { closeModal('confirmModal'); if (confirmCallback) { confirmCallback(); confirmCallback = null; } });

            document.getElementById('fieldType').addEventListener('change', e => {
                const t = e.target.value;
                document.getElementById('fieldOptionsGroup').hidden = t !== 'select';
                document.getElementById('dateFormatGroup').hidden = t !== 'date';
                document.getElementById('compositeTemplateGroup').hidden = t !== 'composite';
                document.getElementById('targetTableGroup').hidden = t !== 'parent' && t !== 'children';
                document.getElementById('parentFieldGroup').hidden = t !== 'children';
                if (t === 'parent' || t === 'children') populateTargetTableSelect();
                if (t === 'composite') populateCompositeFieldButtons();
            });
            document.getElementById('targetTable').addEventListener('change', e => { if (document.getElementById('fieldType').value === 'children') populateParentFieldSelect(e.target.value); });

            // Composite field buttons
            document.getElementById('compositeFieldButtons').addEventListener('click', e => {
                if (e.target.classList.contains('field-btn')) {
                    const ta = document.getElementById('compositeTemplate');
                    const start = ta.selectionStart, end = ta.selectionEnd;
                    const text = ta.value;
                    ta.value = text.substring(0, start) + e.target.dataset.field + text.substring(end);
                    ta.focus();
                    ta.setSelectionRange(start + e.target.dataset.field.length, start + e.target.dataset.field.length);
                }
            });

            document.getElementById('generatorTable').addEventListener('change', updateGeneratorFields);
            document.getElementById('generatorFieldButtons').addEventListener('click', e => {
                if (e.target.classList.contains('field-btn')) {
                    const ta = document.getElementById('generatorTemplate');
                    const start = ta.selectionStart, end = ta.selectionEnd;
                    const text = ta.value;
                    ta.value = text.substring(0, start) + e.target.dataset.field + text.substring(end);
                    ta.focus();
                    ta.setSelectionRange(start + e.target.dataset.field.length, start + e.target.dataset.field.length);
                }
            });
            document.getElementById('btnGenerate').addEventListener('click', generateText);
            document.getElementById('btnCopyGenerated').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('generatorOutput').textContent); alert(t('jsonCopied')); });

            // Collections and Tags
            document.getElementById('btnAddCollection').addEventListener('click', () => openCollectionModal());
            document.getElementById('btnSaveCollection').addEventListener('click', saveCollection);
            document.getElementById('btnAddTag').addEventListener('click', () => openTagModal());
            document.getElementById('btnSaveTag').addEventListener('click', saveTag);
            
            // View/Edit/Delete collection from modal
            document.getElementById('btnEditCollectionFromView').addEventListener('click', () => {
                openCollectionModal(currentViewCollectionId);
            });
            document.getElementById('btnDeleteCollectionFromView').addEventListener('click', () => {
                deleteCollection(currentViewCollectionId);
            });
            document.getElementById('btnRefreshCollection').addEventListener('click', () => {
                const collectionId = document.getElementById('viewCollectionModal').dataset.collectionId;
                if (collectionId) viewCollectionDetails(collectionId);
            });
            
            // View/Edit/Delete tag from modal
            document.getElementById('btnEditTagFromView').addEventListener('click', () => {
                openTagModal(currentViewTagId);
            });
            document.getElementById('btnDeleteTagFromView').addEventListener('click', () => {
                deleteTag(currentViewTagId);
                closeModal('viewTagModal');
            });
            document.getElementById('btnRefreshTag').addEventListener('click', () => {
                const tagId = document.getElementById('viewTagModal').dataset.tagId;
                if (tagId) viewTagDetails(tagId);
            });
            
            // Add to collection modal
            document.getElementById('btnConfirmAddToCollection').addEventListener('click', confirmAddToCollection);
            document.getElementById('btnQuickCreateCollection').addEventListener('click', () => {
                openCollectionModal();
            });
            
            // Add tag modal
            document.getElementById('btnConfirmAddTag').addEventListener('click', confirmAddTag);
            document.getElementById('btnQuickCreateTag').addEventListener('click', () => {
                openTagModal();
            });

            // Export modal
            document.querySelectorAll('#exportModal .format-tab').forEach(tab => tab.addEventListener('click', () => {
                exportFormat = tab.dataset.format;
                document.querySelectorAll('#exportModal .format-tab').forEach(t => t.classList.toggle('active', t === tab));
                updateExportOutput();
            }));
            document.getElementById('btnExportCopy').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('exportOutput').value); alert(t('jsonCopied')); });
            document.getElementById('btnExportFile').addEventListener('click', async () => {
                const table = getTableById(activeTableId);
                const content = document.getElementById('exportOutput').value;
                const filename = `${table?.name || 'export'}.${exportFormat}`;
                const mimeType = exportFormat === 'csv' ? 'text/csv' : 'text/tab-separated-values';
                const ext = exportFormat === 'csv' ? ['.csv'] : ['.tsv', '.txt'];
                await saveFileWithDialog(content, filename, mimeType, ext);
            });

            // Import modal
            document.querySelectorAll('#importModal .format-tab').forEach(tab => tab.addEventListener('click', () => {
                importFormat = tab.dataset.format;
                document.querySelectorAll('#importModal .format-tab').forEach(t => t.classList.toggle('active', t === tab));
            }));
            document.getElementById('importFile').addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = ev => { document.getElementById('importInput').value = ev.target.result; };
                reader.readAsText(file);
            });
            document.getElementById('btnDoImport').addEventListener('click', doImport);
            document.getElementById('btnPreviewImport').addEventListener('click', previewImport);
            document.getElementById('btnDoPasteJson').addEventListener('click', doPasteJson);

            // Delegation for dynamic elements
            document.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;

                if (target.classList.contains('edit-table-btn')) openTableModal(target.dataset.table);
                if (target.classList.contains('delete-table-btn')) confirmAction(t('confirmDeleteTable'), () => { 
                    const tableId = target.dataset.table;
                    database.tables = database.tables.filter(tb => tb.id !== tableId); 
                    // Remove notes for this table
                    if (database.meta.notes) {
                        database.meta.notes = database.meta.notes.filter(n => n.tableId !== tableId);
                    }
                    // Remove collection members for this table
                    if (database.meta.collections) {
                        database.meta.collections.forEach(col => {
                            if (col.members) col.members = col.members.filter(m => m.tableId !== tableId);
                        });
                    }
                    if (activeTab === tableId) activeTab = 'management'; 
                    renderAll(); 
                });
                if (target.classList.contains('move-table-btn')) {
                    const i = database.tables.findIndex(tb => tb.id === target.dataset.table);
                    const ni = i + parseInt(target.dataset.dir);
                    if (ni >= 0 && ni < database.tables.length) { [database.tables[i], database.tables[ni]] = [database.tables[ni], database.tables[i]]; renderAll(); }
                }
                if (target.classList.contains('show-fields-btn')) showFieldsForTable(target.dataset.table);
                if (target.classList.contains('edit-field-btn')) openFieldModal(target.dataset.field);
                if (target.classList.contains('delete-field-btn')) confirmAction(t('confirmDeleteField'), () => { const table = getTableById(editingFieldTableId); if (table) { table.fields = table.fields.filter(f => f.id !== target.dataset.field); table.records.forEach(r => delete r.values[target.dataset.field]); } renderFieldList(); });
                if (target.classList.contains('move-field-btn')) {
                    const table = getTableById(editingFieldTableId);
                    if (table) {
                        const i = table.fields.findIndex(f => f.id === target.dataset.field);
                        const ni = i + parseInt(target.dataset.dir);
                        if (ni >= 0 && ni < table.fields.length) { [table.fields[i], table.fields[ni]] = [table.fields[ni], table.fields[i]]; renderFieldList(); }
                    }
                }
                if (target.classList.contains('add-record-btn')) openRecordModal(target.dataset.table);
                if (target.classList.contains('export-table-btn')) openExportModal(target.dataset.table);
                if (target.classList.contains('import-table-btn')) openImportModal(target.dataset.table);
                if (target.classList.contains('view-record-btn')) viewRecord(target.dataset.table, target.dataset.record);
                if (target.classList.contains('edit-record-btn')) {
                    const record = getRecordById(target.dataset.table, target.dataset.record);
                    if (record?.locked) {
                        alert(t('recordLocked'));
                        return;
                    }
                    openRecordModal(target.dataset.table, target.dataset.record);
                }
                if (target.classList.contains('delete-record-btn')) {
                    const record = getRecordById(target.dataset.table, target.dataset.record);
                    if (record?.locked) {
                        alert(t('recordLocked'));
                        return;
                    }
                    confirmAction(t('confirmDeleteRecord'), () => { 
                    const tableId = target.dataset.table;
                    const recordId = target.dataset.record;
                    const table = getTableById(tableId); 
                    if (table) {
                        table.records = table.records.filter(r => r.id !== recordId);
                        // Remove from all collections
                        if (database.meta.collections) {
                            database.meta.collections.forEach(col => {
                                if (col.members) col.members = col.members.filter(m => !(m.tableId === tableId && m.recordId === recordId));
                            });
                        }
                        // Remove all notes for this record
                        if (database.meta.notes) {
                            database.meta.notes = database.meta.notes.filter(n => !(n.tableId === tableId && n.recordId === recordId));
                        }
                    }
                    renderTableContent(tableId); 
                    });
                }
                if (target.classList.contains('create-parent-btn')) createParentRecord(target.dataset.targetTable, target.dataset.field);
                if (target.classList.contains('create-child-btn')) createChildRecord(target.dataset.targetTable, target.dataset.parentField, target.dataset.parentRecord);
                if (target.classList.contains('copy-field-btn')) {
                    const value = target.dataset.value;
                    navigator.clipboard.writeText(value).then(() => {
                        const origText = target.textContent;
                        target.textContent = '‚úì';
                        setTimeout(() => { target.textContent = origText; }, 1500);
                    }).catch(() => {
                        // Fallback pro star≈°√≠ prohl√≠≈æeƒçe
                        const ta = document.createElement('textarea');
                        ta.value = value;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                        const origText = target.textContent;
                        target.textContent = '‚úì';
                        setTimeout(() => { target.textContent = origText; }, 1500);
                    });
                }
                // Collections
                if (target.classList.contains('open-add-collection-btn')) openAddToCollectionModal(target.dataset.table, target.dataset.record);
                if (target.classList.contains('open-add-tag-btn')) openAddTagModal(target.dataset.table, target.dataset.record);
                if (target.classList.contains('remove-from-collection-btn')) {
                    toggleCollectionMembership(target.dataset.collection, target.dataset.table, target.dataset.record, false);
                    viewCollectionDetails(target.dataset.collection);
                }
                if (target.classList.contains('remove-tag-btn')) {
                    toggleTagAssignment(target.dataset.tag, target.dataset.table, target.dataset.record, false);
                    viewTagDetails(target.dataset.tag);
                }
                if (target.classList.contains('remove-badge-btn')) {
                    const action = target.dataset.action;
                    if (action === 'removeFromCollection') {
                        toggleCollectionMembership(target.dataset.collection, target.dataset.table, target.dataset.record, false);
                        viewRecord(target.dataset.table, target.dataset.record);
                    } else if (action === 'removeTag') {
                        toggleTagAssignment(target.dataset.tag, target.dataset.table, target.dataset.record, false);
                        viewRecord(target.dataset.table, target.dataset.record);
                    }
                }
                // Back to tables
                if (target.classList.contains('back-to-tables-btn')) {
                    if (database.tables.length > 0) {
                        activeTab = database.tables[0].id;
                        activeTableId = database.tables[0].id;
                        renderAll();
                    } else {
                        activeTab = 'management';
                        renderAll();
                    }
                }
            });
            
            // Event delegation for collection/tag cards
            document.addEventListener('click', e => {
                const collectionCard = e.target.closest('.collection-card');
                if (collectionCard && !e.target.closest('button')) {
                    viewCollectionDetails(collectionCard.dataset.collection);
                    return;
                }
                const tagCard = e.target.closest('.tag-card');
                if (tagCard && !e.target.closest('button')) {
                    viewTagDetails(tagCard.dataset.tag);
                    return;
                }
            });

            // Structure modal tabs
            document.querySelectorAll('.structure-tab').forEach(tab => tab.addEventListener('click', () => {
                document.querySelectorAll('.structure-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.structure-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('structure-' + tab.dataset.structureTab).classList.add('active');
            }));
            
            // Structure tree interactions
            document.getElementById('structureTreeContainer').addEventListener('click', e => {
                const toggle = e.target.closest('.tree-toggle');
                if (toggle && !toggle.classList.contains('empty')) {
                    toggleTreeNode(toggle.dataset.key, toggle.dataset.table, toggle.dataset.record);
                    return;
                }
                const loadMore = e.target.closest('.tree-load-more');
                if (loadMore && loadMore.dataset.action === 'loadAll') {
                    loadAllTreeItems(loadMore.dataset.key);
                    return;
                }
                const notesToggle = e.target.closest('.tree-notes-toggle');
                if (notesToggle && notesToggle.dataset.action === 'toggleTreeNotes') {
                    const notesKey = notesToggle.dataset.key;
                    if (structureExpandedNotes.has(notesKey)) {
                        structureExpandedNotes.delete(notesKey);
                    } else {
                        structureExpandedNotes.add(notesKey);
                    }
                    renderStructureTree();
                    return;
                }
                const ancestorLink = e.target.closest('.ancestor-link');
                if (ancestorLink) {
                    e.preventDefault();
                    // Switch structure root to this ancestor
                    structureRootTableId = ancestorLink.dataset.table;
                    structureRootRecordId = ancestorLink.dataset.record;
                    structureExpandedNodes = new Set();
                    structureLoadedAll = new Set();
                    structureExpandedNotes = new Set();
                    
                    const table = getTableById(structureRootTableId);
                    const record = getRecordById(structureRootTableId, structureRootRecordId);
                    if (table && record) {
                        const name = getPrimaryFieldValue(table, record);
                        document.getElementById('structureModalTitle').innerHTML = `üå≥ ${t('structure')}: ${escapeHtml(name)}`;
                    }
                    
                    renderStructureTree();
                    renderStructureGraph();
                    return;
                }
            });
            
            // Structure graph interactions
            document.getElementById('structureGraphContainer').addEventListener('click', e => {
                const node = e.target.closest('.graph-node');
                if (node) {
                    viewRecord(node.dataset.table, node.dataset.record);
                    return;
                }
                const ancestorLink = e.target.closest('.ancestor-link');
                if (ancestorLink) {
                    e.preventDefault();
                    // Switch structure root to this ancestor
                    structureRootTableId = ancestorLink.dataset.table;
                    structureRootRecordId = ancestorLink.dataset.record;
                    structureExpandedNodes = new Set();
                    structureLoadedAll = new Set();
                    structureExpandedNotes = new Set();
                    
                    const table = getTableById(structureRootTableId);
                    const record = getRecordById(structureRootTableId, structureRootRecordId);
                    if (table && record) {
                        const name = getPrimaryFieldValue(table, record);
                        document.getElementById('structureModalTitle').innerHTML = `üå≥ ${t('structure')}: ${escapeHtml(name)}`;
                    }
                    
                    renderStructureTree();
                    renderStructureGraph();
                    return;
                }
            });

            // Event delegation for record links (a tags)
            document.addEventListener('click', e => {
                const link = e.target.closest('a.record-link, a.tree-link');
                if (link) {
                    e.preventDefault();
                    const action = link.dataset.action;
                    const tableId = link.dataset.table;
                    const recordId = link.dataset.record;
                    if (action === 'view') {
                        viewRecord(tableId, recordId);
                    } else if (action === 'viewInModal') {
                        // Keep current modal open, open new record on top
                        viewRecord(tableId, recordId);
                    } else if (action === 'viewFromCollection') {
                        // Keep collection modal open
                        viewRecord(tableId, recordId);
                    } else if (action === 'viewFromTag') {
                        // Keep tag modal open
                        viewRecord(tableId, recordId);
                    } else if (action === 'viewFromStructure') {
                        // Keep structure modal open
                        viewRecord(tableId, recordId);
                    }
                    return;
                }
                // Collection badge/link click - keep current modal open
                const colBadge = e.target.closest('a.collection-badge, a.collection-link');
                if (colBadge) {
                    e.preventDefault();
                    const colId = colBadge.dataset.collection;
                    if (colId) {
                        viewCollectionDetails(colId);
                    }
                    return;
                }
                // Tag badge/link click - keep current modal open
                const tagBadge = e.target.closest('a.tag-badge, a.tag-link');
                if (tagBadge) {
                    e.preventDefault();
                    const tagId = tagBadge.dataset.tag;
                    if (tagId) {
                        viewTagDetails(tagId);
                    }
                    return;
                }
            });

            // Event delegation for bulk selection checkboxes
            document.addEventListener('change', e => {
                const checkbox = e.target.closest('.bulk-checkbox');
                if (!checkbox) return;
                
                const tableId = checkbox.dataset.table;
                if (checkbox.classList.contains('bulk-select-all')) {
                    toggleSelectAll(tableId, checkbox.checked);
                } else if (checkbox.classList.contains('bulk-select-row')) {
                    toggleSelectRow(tableId, checkbox.dataset.record, checkbox.checked);
                }
            });
            
            // Event delegation for bulk action buttons
            document.addEventListener('click', e => {
                const editBtn = e.target.closest('.bulk-edit-field-btn');
                if (editBtn) {
                    openBulkEditModal(editBtn.dataset.table);
                    return;
                }
                const addColBtn = e.target.closest('.bulk-add-collection-btn');
                if (addColBtn) {
                    openBulkAddToCollectionModal(addColBtn.dataset.table);
                    return;
                }
                const addTagBtn = e.target.closest('.bulk-add-tag-btn');
                if (addTagBtn) {
                    openBulkAddTagModal(addTagBtn.dataset.table);
                    return;
                }
                const deleteBtn = e.target.closest('.bulk-delete-btn');
                if (deleteBtn) {
                    bulkDelete(deleteBtn.dataset.table);
                    return;
                }
                const deselectBtn = e.target.closest('.bulk-deselect');
                if (deselectBtn) {
                    clearSelection(deselectBtn.dataset.table);
                    return;
                }
            });

            // Event delegation for group toggle
            document.addEventListener('click', e => {
                const toggle = e.target.closest('.group-toggle');
                if (!toggle) return;
                const tableId = toggle.dataset.table;
                const groupKey = toggle.dataset.group;
                if (!database.meta.groupStates) database.meta.groupStates = {};
                if (!database.meta.groupStates[tableId]) database.meta.groupStates[tableId] = {};
                database.meta.groupStates[tableId][groupKey] = !database.meta.groupStates[tableId][groupKey];
                renderTableContent(tableId);
            });

            document.addEventListener('change', e => {
                if (e.target.classList.contains('table-filter')) {
                    const tableId = e.target.dataset.table;
                    if (!tableFilters[tableId]) tableFilters[tableId] = {};
                    tableFilters[tableId][e.target.dataset.field] = e.target.value;
                    renderTableContent(tableId);
                }
                if (e.target.classList.contains('table-simple-mode-toggle')) {
                    const tableId = e.target.dataset.table;
                    const table = getTableById(tableId);
                    if (table) {
                        table.showInSimpleMode = e.target.checked;
                        autoSave();
                        renderTableTabs();
                    }
                }
                if (e.target.classList.contains('col-toggle')) {
                    const tableId = e.target.dataset.table;
                    if (!database.meta.columnVisibility[tableId]) database.meta.columnVisibility[tableId] = {};
                    database.meta.columnVisibility[tableId][e.target.dataset.field] = e.target.checked;
                    // Remember details open state before re-render
                    const detailsEl = document.querySelector('#tableContents details');
                    const wasOpen = detailsEl?.open;
                    renderTableContent(tableId);
                    // Restore details open state
                    if (wasOpen) {
                        const newDetails = document.querySelector('#tableContents details');
                        if (newDetails) newDetails.open = true;
                    }
                }
                // Collection filter
                if (e.target.classList.contains('collection-filter')) {
                    collectionFilter = e.target.value || null;
                    renderTableContent(e.target.dataset.table);
                }
                // Tag filter
                if (e.target.classList.contains('tag-filter')) {
                    tagFilter = e.target.value || null;
                    renderTableContent(e.target.dataset.table);
                }
                // Assign collection checkbox
                if (e.target.classList.contains('assign-collection-cb')) {
                    const tableId = document.getElementById('assignTableId').value;
                    const recordId = document.getElementById('assignRecordId').value;
                    toggleCollectionMembership(e.target.dataset.collection, tableId, recordId, e.target.checked);
                }
                // Assign tag checkbox
                if (e.target.classList.contains('assign-tag-cb')) {
                    const tableId = document.getElementById('assignTableId').value;
                    const recordId = document.getElementById('assignRecordId').value;
                    toggleTagAssignment(e.target.dataset.tag, tableId, recordId, e.target.checked);
                }
            });

            document.addEventListener('input', e => {
                if (e.target.classList.contains('table-search')) {
                    tableSearches[e.target.dataset.table] = e.target.value;
                    renderTableContent(e.target.dataset.table);
                }
                // Sync date picker with text input
                if (e.target.classList.contains('date-picker')) {
                    const textInput = document.getElementById(e.target.id + '_text');
                    if (textInput) textInput.value = e.target.value;
                }
                if (e.target.classList.contains('date-text')) {
                    const dateInput = document.getElementById(e.target.id.replace('_text', ''));
                    if (dateInput && /^\d{4}-\d{2}-\d{2}$/.test(e.target.value)) {
                        dateInput.value = e.target.value;
                    }
                }
            });
            
            // Clear date button handler
            document.addEventListener('click', e => {
                if (e.target.classList.contains('date-clear-btn')) {
                    const fieldId = e.target.dataset.dateField;
                    if (fieldId) {
                        const dateInput = document.getElementById(fieldId);
                        const textInput = document.getElementById(fieldId + '_text');
                        if (dateInput) dateInput.value = '';
                        if (textInput) textInput.value = '';
                    }
                }
            });

            document.getElementById('tableContents').addEventListener('click', e => {
                // Sort by column header
                const th = e.target.closest('th:not(.no-sort)');
                if (th && th.dataset.table && th.dataset.field) {
                    const tableId = th.dataset.table;
                    if (!tableSorts[tableId]) tableSorts[tableId] = { field: null, dir: 'asc' };
                    if (tableSorts[tableId].field === th.dataset.field) tableSorts[tableId].dir = tableSorts[tableId].dir === 'asc' ? 'desc' : 'asc';
                    else { tableSorts[tableId].field = th.dataset.field; tableSorts[tableId].dir = 'asc'; }
                    renderTableContent(tableId);
                    return;
                }
                
                // Views bar - save view
                if (e.target.closest('.view-save-btn')) {
                    const btn = e.target.closest('.view-save-btn');
                    saveCurrentView(btn.dataset.table);
                    return;
                }
                
                // Views bar - switch view (click on tab)
                const viewTab = e.target.closest('[role="tab"]');
                if (viewTab) {
                    const tableId = viewTab.dataset.table;
                    const viewId = viewTab.dataset.view;
                    if (viewId) {
                        loadView(tableId, viewId);
                    } else {
                        clearView(tableId);
                    }
                    return;
                }
                
                // Views bar - update view (uses activeViewId)
                if (e.target.closest('.view-update-btn')) {
                    if (activeViewId) {
                        updateView(activeTableId, activeViewId);
                    }
                    return;
                }
                
                // Views bar - rename view (uses activeViewId)
                if (e.target.closest('.view-rename-btn')) {
                    if (activeViewId) {
                        renameView(activeTableId, activeViewId);
                    }
                    return;
                }
                
                // Views bar - delete view (uses activeViewId)
                if (e.target.closest('.view-delete-btn')) {
                    if (activeViewId) {
                        deleteView(activeTableId, activeViewId);
                    }
                    return;
                }
            });
            
            // Keyboard navigation for view tabs
            document.getElementById('tableContents').addEventListener('keydown', e => {
                const tab = e.target.closest('[role="tab"]');
                if (!tab) return;
                
                const tablist = tab.closest('[role="tablist"]');
                if (!tablist) return;
                
                const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
                const currentIndex = tabs.indexOf(tab);
                
                let newIndex = currentIndex;
                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    newIndex = (currentIndex + 1) % tabs.length;
                    e.preventDefault();
                } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    newIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                    e.preventDefault();
                } else if (e.key === 'Home') {
                    newIndex = 0;
                    e.preventDefault();
                } else if (e.key === 'End') {
                    newIndex = tabs.length - 1;
                    e.preventDefault();
                }
                
                if (newIndex !== currentIndex) {
                    tabs[newIndex].focus();
                }
            });

            document.querySelectorAll('[data-modal-close]').forEach(btn => btn.addEventListener('click', () => { const m = btn.closest('.modal-backdrop'); if (m) closeModal(m.id); }));
            document.querySelectorAll('.modal-backdrop').forEach(bd => bd.addEventListener('click', e => { if (e.target === bd) closeModal(bd.id); }));

            // ========== WIKI INTEGRATION ==========
            
            // Base64 helpers with UTF-8 support
            function base64Encode(str) {
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
            }
            
            function base64Decode(str) {
                return decodeURIComponent(atob(str).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            }
            
            // Find highest ID in database and update counter
            function updateIdCounter(data) {
                let maxTimestamp = 0;
                
                function extractTimestamp(id) {
                    if (!id || typeof id !== 'string') return 0;
                    // ID format: id_[timestamp in base36][random]
                    const match = id.match(/^id_([a-z0-9]+)/i);
                    if (match) {
                        try {
                            const ts = parseInt(match[1].substring(0, 8), 36);
                            return isNaN(ts) ? 0 : ts;
                        } catch (e) {
                            return 0;
                        }
                    }
                    return 0;
                }
                
                // Check all tables
                if (data.tables) {
                    data.tables.forEach(table => {
                        maxTimestamp = Math.max(maxTimestamp, extractTimestamp(table.id));
                        
                        // Check fields
                        if (table.fields) {
                            table.fields.forEach(field => {
                                maxTimestamp = Math.max(maxTimestamp, extractTimestamp(field.id));
                            });
                        }
                        
                        // Check records
                        if (table.records) {
                            table.records.forEach(record => {
                                maxTimestamp = Math.max(maxTimestamp, extractTimestamp(record.id));
                            });
                        }
                    });
                }
                
                // Ensure next generated ID will be higher
                // The generateId function uses Date.now(), so we don't need to do anything
                // as long as current time is higher than max timestamp
                // But if data was from the future (unlikely), we'd have issues
                // For safety, we could override generateId, but it's not necessary
                // as Date.now() will always be current
            }
            
            // Wiki config storage
            let wikiConfig = null;
            
            // Signal that editor is ready for receiving data
            window.jsondbEditorReady = true;
            
            // Listen for data from parent window
            window.addEventListener('message', function(event) {
                if (!event.data) return;
                
                if (event.data.type === 'loadData') {
                    // Store wiki config
                    wikiConfig = {
                        pageId: event.data.pageId,
                        instance: event.data.instance,
                        original: event.data.original
                    };
                    
                    // Show wiki save button, hide file operations
                    document.getElementById('btnSaveWiki').style.display = '';
                    // Remove accesskey from regular save button (wiki button has priority)
                    document.getElementById('btnSave').removeAttribute('accesskey');
                    // In wiki mode, file save is advanced-only (hidden in simple mode)
                    document.getElementById('btnSave').classList.add('advanced-only');
                    
                    // Decode and load data
                    try {
                        const jsonStr = base64Decode(event.data.data);
                        const data = JSON.parse(jsonStr);
                        
                        // Update ID counter to prevent conflicts
                        updateIdCounter(data);
                        
                        // Load the database
                        loadDatabaseFromJson(data);
                        
                        // Update window title
                        document.title = data.meta?.name || 'Database Editor';
                    } catch (e) {
                        alert('Error loading data: ' + e.message);
                        console.error('Load error:', e);
                    }
                }
                
                if (event.data.type === 'saveSuccess') {
                    // Success - mark as saved and close the window
                    markAsSaved();
                    window.close();
                }
                
                if (event.data.type === 'saveError') {
                    alert(t('wikiSaveError') + ' ' + (event.data.error || 'Unknown error'));
                    
                    // Re-enable button
                    const btn = document.getElementById('btnSaveWiki');
                    btn.disabled = false;
                    btn.innerHTML = '<span aria-hidden="true">üì§</span> ' + t('saveToWiki');
                }
            });
            
            // Save to wiki button handler
            document.getElementById('btnSaveWiki').addEventListener('click', function() {
                if (!wikiConfig) {
                    alert('Wiki connection not available');
                    return;
                }
                
                if (!window.opener) {
                    alert('Parent window not available. Please reopen the editor from the wiki page.');
                    return;
                }
                
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<span aria-hidden="true">‚è≥</span> ' + t('wikiSaving');
                
                try {
                    const jsonStr = JSON.stringify(database, null, 2);
                    const newData = base64Encode(jsonStr);
                    
                    // Send to parent window
                    window.opener.postMessage({
                        type: 'saveData',
                        pageId: wikiConfig.pageId,
                        instance: wikiConfig.instance,
                        data: newData,
                        original: wikiConfig.original
                    }, '*');
                    
                } catch (e) {
                    alert(t('wikiSaveError') + ' ' + e.message);
                    btn.disabled = false;
                    btn.innerHTML = '<span aria-hidden="true">üì§</span> ' + t('saveToWiki');
                }
            });
            
            // ========== END WIKI INTEGRATION ==========
            
            // ========== KEYBOARD SHORTCUTS ==========
            // Accesskey shortcuts: S (save), X (toggle mode), Q (quick create), D (save record)
            // Additional shortcuts handled here: N (new record), C/T/M (navigation), arrows (table nav), E/V (edit/view)
            
            document.addEventListener('keydown', e => {
                // Don't trigger shortcuts when typing in inputs
                const activeEl = document.activeElement;
                const isTyping = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.tagName === 'SELECT' || activeEl.isContentEditable);
                
                // Skip if inside a modal (except for D which saves)
                const inModal = activeEl && activeEl.closest('.modal-backdrop:not([hidden])');
                
                // Arrow navigation in data table
                if (!isTyping && !inModal && activeTableId && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) {
                    const table = document.querySelector('.data-table tbody');
                    if (!table) return;
                    const rows = Array.from(table.querySelectorAll('tr:not([hidden])'));
                    if (rows.length === 0) return;
                    
                    e.preventDefault();
                    
                    // Remove previous selection
                    rows.forEach(r => r.classList.remove('keyboard-selected'));
                    
                    if (e.key === 'ArrowDown') {
                        selectedRowIndex = Math.min(selectedRowIndex + 1, rows.length - 1);
                    } else {
                        selectedRowIndex = Math.max(selectedRowIndex - 1, 0);
                    }
                    
                    if (selectedRowIndex >= 0 && selectedRowIndex < rows.length) {
                        rows[selectedRowIndex].classList.add('keyboard-selected');
                        rows[selectedRowIndex].scrollIntoView({ block: 'nearest' });
                    }
                    return;
                }
                
                // E = Edit selected record, V = View selected record
                if (!isTyping && !inModal && (e.key === 'e' || e.key === 'E' || e.key === 'v' || e.key === 'V')) {
                    const selectedRow = document.querySelector('.data-table tbody tr.keyboard-selected');
                    if (selectedRow) {
                        const btn = e.key.toLowerCase() === 'e' 
                            ? selectedRow.querySelector('.edit-record-btn')
                            : selectedRow.querySelector('.view-record-btn');
                        if (btn && !btn.disabled) {
                            e.preventDefault();
                            btn.click();
                        }
                    }
                    return;
                }
            });
            
            // Reset selected row when table changes
            const origRenderTableContent = renderTableContent;
            renderTableContent = function(tableId) {
                selectedRowIndex = -1;
                origRenderTableContent(tableId);
            };
            // ========== END KEYBOARD SHORTCUTS ==========

            loadAutoSave();
            renderAll();
            
            // Mark initial load complete (changes after this will be tracked)
            initialLoadComplete = true;
            
            // Warn before closing with unsaved changes
            window.addEventListener('beforeunload', e => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = t('confirmUnsavedClose');
                    return e.returnValue;
                }
            });
        });
    </script>
</body>
</html>
